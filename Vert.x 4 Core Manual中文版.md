# Vert.x 4 Core Manualä¸­æ–‡ç‰ˆ

> ç¿»è¯‘: ç™½çŸ³(https://github.com/wjw465150/Vert.x-Core-Manual)

Vert.xçš„Coreæ˜¯ä¸€ç»„Java API,æˆ‘ä»¬ç§°ä¸º**Vert.x Core**

[Repository](https://github.com/eclipse/vert.x).

Vert.xæ ¸å¿ƒä¸ºä»¥ä¸‹äº‹æƒ…æä¾›åŠŸèƒ½:

- ç¼–å†™TCPå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨
- ç¼–å†™HTTPå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨,åŒ…æ‹¬å¯¹WebSocketsçš„æ”¯æŒ
- äº‹ä»¶æ€»çº¿
- å…±äº«æ•°æ® - -æœ¬åœ°æ˜ å°„å’Œé›†ç¾¤åˆ†å¸ƒå¼æ˜ å°„
- å‘¨æœŸæ€§å’Œå»¶è¿ŸåŠ¨ä½œ
- éƒ¨ç½²å’Œå–æ¶ˆéƒ¨ç½²Verticles
- æ•°æ®æŠ¥å¥—æ¥å­—
- DNSå®¢æˆ·ç«¯
- æ–‡ä»¶ç³»ç»Ÿè®¿é—®
- é«˜å¯ç”¨æ€§
- æœ¬åœ°ä¼ è¾“
- é›†ç¾¤

æ ¸å¿ƒåŠŸèƒ½ç›¸å½“ä½çº§-åœ¨è¿™é‡Œæ‰¾ä¸åˆ°æ•°æ®åº“è®¿é—®,æˆæƒæˆ–é«˜çº§WebåŠŸèƒ½ä¹‹ç±»çš„ä¸œè¥¿-åœ¨**Vert.x ext**(æ‰©å±•)ä¸­å¯ä»¥æ‰¾åˆ°.

Vert.x å†…æ ¸å°å·§è½»ä¾¿. ä½ åªéœ€ä½¿ç”¨ä½ æƒ³è¦çš„éƒ¨åˆ†. å®ƒè¿˜å¯ä»¥å®Œå…¨åµŒå…¥åˆ°æ‚¨ç°æœ‰çš„åº”ç”¨ç¨‹åºä¸­ - æˆ‘ä»¬ä¸ä¼šå¼ºè¿«æ‚¨ä»¥ç‰¹æ®Šçš„æ–¹å¼æ„å»ºåº”ç”¨ç¨‹åº,ä»¥ä¾¿æ‚¨å¯ä»¥ä½¿ç”¨ Vert.x.

æ‚¨å¯ä»¥ä½¿ç”¨æ¥è‡ªVert.xæ”¯æŒçš„ä»»ä½•å…¶ä»–è¯­è¨€çš„æ ¸å¿ƒ. ä½†è¿™å¾ˆé…·-æˆ‘ä»¬ä¸ä¼šå¼ºè¿«æ‚¨ç›´æ¥ä»JavaScriptæˆ–Rubyä¸­ä½¿ç”¨Java API-æ¯•ç«Ÿ,ä¸åŒçš„è¯­è¨€æœ‰ä¸åŒçš„çº¦å®šå’Œæƒ¯ç”¨è¯­ï¼Œä¾‹å¦‚å¦‚æœå°† Java æƒ¯ç”¨è¯­å¼ºåŠ ç»™ Ruby å¼€å‘äººå‘˜å°±ä¼šå¾ˆå¥‡æ€ªçš„. ç›¸å,æˆ‘ä»¬ä¼šä¸ºæ¯ç§è¯­è¨€è‡ªåŠ¨ç”Ÿæˆç­‰æ•ˆäºæ ¸å¿ƒJava APIçš„"æƒ¯ç”¨è¯­è¨€".

ä»ç°åœ¨å¼€å§‹,æˆ‘ä»¬å°†ä»…ä½¿ç”¨**core**ä¸€è¯æ¥æŒ‡ä»£Vert.xæ ¸å¿ƒ.

å¦‚æœä½¿ç”¨çš„æ˜¯Mavenæˆ–Gradle,è¯·å°†ä»¥ä¸‹ä¾èµ–é¡¹æ·»åŠ åˆ°é¡¹ç›®æè¿°ç¬¦çš„*dependencies*éƒ¨åˆ†,ä»¥è®¿é—®Vert.x Core API:

- Maven (åœ¨æ‚¨çš„`pom.xml`ä¸­):

```xml
<dependency>
 <groupId>io.vertx</groupId>
 <artifactId>vertx-core</artifactId>
 <version>4.2.4</version>
</dependency>
```

- Gradle (åœ¨æ‚¨çš„`build.gradle`æ–‡ä»¶ä¸­):

```groovy
dependencies {
 compile 'io.vertx:vertx-core:4.2.4'
}
```

è®©æˆ‘ä»¬è®¨è®ºcoreä¸­çš„ä¸åŒæ¦‚å¿µå’ŒåŠŸèƒ½.

## å¼€å§‹åˆ›å»ºVert.x

é™¤éæ‚¨å¯ä»¥ä¸ `Vertx` å¯¹è±¡é€šä¿¡,å¦åˆ™æ‚¨åœ¨ Vert.xå¤©åœ°ä¸­æ— æ³•åšå¤ªå¤šäº‹æƒ…!

å®ƒæ˜¯ Vert.x çš„æ§åˆ¶ä¸­å¿ƒ,æ˜¯ä½ åšå‡ ä¹æ‰€æœ‰äº‹æƒ…çš„æ–¹å¼,åŒ…æ‹¬åˆ›å»ºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨,è·å–å¯¹äº‹ä»¶æ€»çº¿çš„å¼•ç”¨,è®¾ç½®è®¡æ—¶å™¨ä»¥åŠè®¸å¤šå…¶ä»–äº‹æƒ….

é‚£ä¹ˆå¦‚ä½•è·å–å®ä¾‹å‘¢?

å¦‚æœæ‚¨è¦åµŒå…¥ Vert.x,é‚£ä¹ˆæ‚¨åªéœ€åˆ›å»ºä¸€ä¸ªå®ä¾‹,å¦‚ä¸‹æ‰€ç¤º:

```java
Vertx vertx = Vertx.vertx();
```

> **ğŸ·æ³¨æ„:** å¤§å¤šæ•°åº”ç”¨ç¨‹åºåªéœ€è¦ä¸€ä¸ª Vert.x å®ä¾‹,ä½†å¦‚æœæ‚¨éœ€è¦éš”ç¦»äº‹ä»¶æ€»çº¿æˆ–ä¸åŒçš„æœåŠ¡å™¨ç»„å’Œå®¢æˆ·ç«¯,åˆ™å¯ä»¥åˆ›å»ºå¤šä¸ª Vert.x å®ä¾‹.

### åˆ›å»ºVert.xå¯¹è±¡æ—¶æŒ‡å®šé€‰é¡¹

åˆ›å»ºVert.xå¯¹è±¡æ—¶,å¦‚æœé»˜è®¤å€¼ä¸é€‚åˆæ‚¨,æ‚¨è¿˜å¯ä»¥æŒ‡å®šé€‰é¡¹:

```java
Vertx vertx = Vertx.vertx(new VertxOptions().setWorkerPoolSize(40));
```

`VertxOptions`å¯¹è±¡æœ‰è®¸å¤šè®¾ç½®,å…è®¸æ‚¨é…ç½®é›†ç¾¤,é«˜å¯ç”¨æ€§,æ± å¤§å°å’Œå„ç§å…¶ä»–è®¾ç½®.

### åˆ›å»ºé›†ç¾¤çš„Vert.xå¯¹è±¡

å¦‚æœæ‚¨è¦åˆ›å»º**é›†ç¾¤Vert.x**(è¯·å‚é˜…[äº‹ä»¶æ€»çº¿](#event_bus)ä¸Šçš„éƒ¨åˆ†,ä»¥è·å¾—å…³äºé›†ç¾¤äº‹ä»¶æ€»çº¿çš„æ›´å¤šä¿¡æ¯),ç„¶åæ‚¨å°†é€šå¸¸ä½¿ç”¨å¼‚æ­¥å˜é‡æ¥åˆ›å»ºVert.xå¯¹è±¡.

è¿™æ˜¯å› ä¸ºé›†ç¾¤ä¸­çš„ä¸åŒVert.xå®ä¾‹é€šå¸¸éœ€è¦èŠ±è´¹ä¸€äº›æ—¶é—´(å¯èƒ½æ˜¯å‡ ç§’é’Ÿ)æ¥ç»„åˆåœ¨ä¸€èµ·. åœ¨æ­¤æœŸé—´,æˆ‘ä»¬ä¸æƒ³é˜»å¡è°ƒç”¨çº¿ç¨‹,å› æ­¤æˆ‘ä»¬å°†ç»“æœå¼‚æ­¥åœ°æä¾›ç»™æ‚¨.

## ä½ æ˜¯fluentçš„å—?

æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°,åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ä½¿ç”¨äº†**fluent** API.

åœ¨`fluent` APIä¸­,å¯ä»¥å°†å¤šä¸ªæ–¹æ³•è°ƒç”¨é“¾æ¥åœ¨ä¸€èµ·.ä¾‹å¦‚:

```java
request.response().putHeader("Content-Type", "text/plain").end("some text");
```

è¿™æ˜¯æ•´ä¸ªVert.x APIçš„é€šç”¨æ¨¡å¼,å› æ­¤è¯·ä¹ æƒ¯ä½¿ç”¨å®ƒ.

åƒè¿™æ ·çš„é“¾å¼è°ƒç”¨å…è®¸æ‚¨ç¼–å†™ç¨å¾®ä¸é‚£ä¹ˆå†—é•¿çš„ä»£ç .å½“ç„¶,å¦‚æœæ‚¨ä¸å–œæ¬¢fluentæ–¹æ³•**æˆ‘ä»¬ä¸ä¼šå¼ºè¿«æ‚¨**è¿™æ ·åš,å¦‚æœæ‚¨æ„¿æ„,æ‚¨å¯ä»¥æ„‰å¿«åœ°å¿½ç•¥å®ƒ,å¹¶åƒè¿™æ ·ç¼–å†™æ‚¨çš„ä»£ç :

```java
HttpServerResponse response = request.response();
response.putHeader("Content-Type", "text/plain");
response.write("some text");
response.end();
```

## åˆ«Callæˆ‘ä»¬,æˆ‘ä»¬ä¼šCallä½ .

Vert.x APIåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæ˜¯**äº‹ä»¶é©±åŠ¨**çš„. è¿™æ„å‘³ç€å½“æ‚¨æ„Ÿå…´è¶£çš„Vert.xä¸­å‘ç”Ÿä»»ä½•äº‹æƒ…æ—¶,Vert.xä¼šé€šè¿‡å‘æ‚¨å‘é€äº‹ä»¶æ¥å‘¼å«æ‚¨.

ä¸€äº›ç¤ºä¾‹äº‹ä»¶æ˜¯:

- è®¡æ—¶å™¨å·²è§¦å‘
- ä¸€äº›æ•°æ®å·²ç»åˆ°è¾¾å¥—æ¥å­—
- ä»ç£ç›˜è¯»å–äº†ä¸€äº›æ•°æ®
- å‘ç”Ÿå¼‚å¸¸
- HTTPæœåŠ¡å™¨å·²æ”¶åˆ°è¯·æ±‚

æ‚¨å¯ä»¥é€šè¿‡å‘Vert.x APIæä¾›*handlers*æ¥å¤„ç†äº‹ä»¶. ä¾‹å¦‚,è¦æ¯ç§’æ¥æ”¶ä¸€ä¸ªè®¡æ—¶å™¨äº‹ä»¶,æ‚¨å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œ:

```java
vertx.setPeriodic(1000, id -> {
  // This handler will get called every second
  System.out.println("timer fired!");
});
```

æˆ–æ¥æ”¶HTTPè¯·æ±‚:

```java
server.requestHandler(request -> {
  // This handler will be called every time an HTTP request is received at the server
  request.response().end("hello world!");
});
```

è¿‡äº†ä¸€æ®µæ—¶é—´,å½“Vert.xæœ‰ä¸€ä¸ªäº‹ä»¶ä¼ é€’ç»™æ‚¨çš„å¤„ç†å™¨æ—¶,Vert.xä¼š**å¼‚æ­¥åœ°**è°ƒç”¨å®ƒ.

è¿™ä½¿æˆ‘ä»¬æƒ³åˆ°äº†Vert.xä¸­çš„ä¸€äº›é‡è¦æ¦‚å¿µ:

## ä¸è¦é˜»å¡æˆ‘!

é™¤äº†æå°‘æ•°ä¾‹å¤–(å³æŸäº›ä»¥"Sync"ç»“å°¾çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œ),Vert.x ä¸­çš„ä»»ä½• API éƒ½ä¸ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹.

å¦‚æœå¯ä»¥ç«‹å³æä¾›ç»“æœ,åˆ™å°†ç«‹å³è¿”å›ç»“æœ,å¦åˆ™é€šå¸¸ä¼šåœ¨ä¸€æ®µæ—¶é—´åæä¾›å¤„ç†å™¨ä»¥æ¥æ”¶äº‹ä»¶.

å› ä¸ºæ²¡æœ‰Vert.x APIä¼šé˜»å¡çº¿ç¨‹,è¿™æ„å‘³ç€æ‚¨å¯ä»¥ä½¿Vert.xä»…ä½¿ç”¨å°‘é‡çº¿ç¨‹æ¥å¤„ç†å¤§é‡å¹¶å‘.

ä½¿ç”¨ä¼ ç»Ÿçš„é˜»æ­¢API,åœ¨ä»¥ä¸‹æƒ…å†µä¸‹,è°ƒç”¨çº¿ç¨‹å¯èƒ½ä¼šé˜»æ­¢:

- ä»å¥—æ¥å­—è¯»å–æ•°æ®
- å°†æ•°æ®å†™å…¥ç£ç›˜
- å‘æ”¶ä»¶äººå‘é€æ¶ˆæ¯å¹¶ç­‰å¾…å›å¤.
- â€¦ è®¸å¤šå…¶ä»–æƒ…å†µ

åœ¨ä¸Šè¿°æ‰€æœ‰æƒ…å†µä¸‹,å½“æ‚¨çš„çº¿ç¨‹æ­£åœ¨ç­‰å¾…ç»“æœæ—¶,å®ƒæ— èƒ½ä¸ºåŠ›-å®ƒå®é™…ä¸Šæ˜¯æ— ç”¨çš„.

è¿™æ„å‘³ç€,å¦‚æœè¦ä½¿ç”¨é˜»å¡APIè¿›è¡Œå¤§é‡å¹¶å‘æ“ä½œ,åˆ™éœ€è¦å¤§é‡çº¿ç¨‹æ¥é˜²æ­¢åº”ç”¨ç¨‹åºåœæ­¢è¿è¡Œ.

çº¿ç¨‹åœ¨å…¶æ‰€éœ€çš„å†…å­˜(ä¾‹å¦‚ç”¨äºå †æ ˆ)å’Œä¸Šä¸‹æ–‡åˆ‡æ¢æ–¹é¢éƒ½æœ‰å¼€é”€.

å¯¹äºè®¸å¤šç°ä»£åº”ç”¨ç¨‹åºæ‰€éœ€çš„å¹¶å‘çº§åˆ«,é˜»å¡æ–¹æ³•æ ¹æœ¬æ— æ³•æ‰©å±•.

## Reactor & å¤šMulti-Reactor

æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡Vert.x APIæ˜¯äº‹ä»¶é©±åŠ¨çš„ - Vert.xåœ¨äº‹ä»¶å¯ç”¨æ—¶å°†äº‹ä»¶ä¼ é€’ç»™å¤„ç†å™¨.

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹,Vert.xä½¿ç”¨ç§°ä¸º **event loop(äº‹ä»¶å¾ªç¯)** çš„çº¿ç¨‹è°ƒç”¨å¤„ç†å™¨.

ç”±äº Vert.x æˆ–æ‚¨çš„åº”ç”¨ç¨‹åºå—ä¸­æ²¡æœ‰ä»»ä½•å†…å®¹,äº‹ä»¶å¾ªç¯å¯ä»¥æ„‰å¿«åœ°è¿è¡Œ,åœ¨äº‹ä»¶åˆ°è¾¾æ—¶è¿ç»­å°†äº‹ä»¶ä¼ é€’ç»™ä¸åŒçš„å¤„ç†å™¨.

å› ä¸ºæ²¡æœ‰é˜»å¡,äº‹ä»¶å¾ªç¯å¯èƒ½ä¼šåœ¨çŸ­æ—¶é—´å†…ä¼ é€’å¤§é‡äº‹ä»¶. ä¾‹å¦‚,å•ä¸ªäº‹ä»¶å¾ªç¯å¯ä»¥éå¸¸å¿«é€Ÿåœ°å¤„ç†æ•°åƒä¸ª HTTP è¯·æ±‚.

æˆ‘ä»¬ç§°ä¹‹ä¸º [Reactor Pattern(ååº”å™¨æ¨¡å¼)](https://en.wikipedia.org/wiki/Reactor_pattern).

ä½ å¯èƒ½ä»¥å‰å¬è¯´è¿‡è¿™ä¸ª - ä¾‹å¦‚ Node.js å®ç°äº†è¿™ä¸ªæ¨¡å¼.

åœ¨æ ‡å‡†çš„ååº”å™¨å®ç°ä¸­,æœ‰ä¸€ä¸ª **single event loop(å•ä¸ªäº‹ä»¶å¾ªç¯)** çº¿ç¨‹,è¯¥çº¿ç¨‹åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è¿è¡Œ,å°†æ‰€æœ‰äº‹ä»¶åˆ°è¾¾æ—¶çš„æ‰€æœ‰äº‹ä»¶ä¼ é€’ç»™æ‰€æœ‰å¤„ç†å™¨.

å•çº¿ç¨‹çš„é—®é¢˜æ˜¯å®ƒåœ¨ä»»ä½•æ—¶å€™éƒ½åªèƒ½åœ¨å•æ ¸ä¸Šè¿è¡Œ,æ‰€ä»¥å¦‚æœä½ æƒ³è®©ä½ çš„å•çº¿ç¨‹ååº”å™¨åº”ç”¨ç¨‹åº(ä¾‹å¦‚ä½ çš„ Node.js åº”ç”¨ç¨‹åº)åœ¨ä½ çš„å¤šæ ¸æœåŠ¡å™¨ä¸Šæ‰©å±•,ä½ å¿…é¡»å¯åŠ¨å¹¶ç®¡ç†è®¸å¤šä¸åŒçš„è¿›ç¨‹.

Vert.x åœ¨è¿™é‡Œçš„å·¥ä½œæ–¹å¼ä¸åŒ. æ¯ä¸ª Vert.x å®ä¾‹éƒ½ç»´æŠ¤ **å‡ ä¸ªäº‹ä»¶å¾ªç¯** ,è€Œä¸æ˜¯å•ä¸ªäº‹ä»¶å¾ªç¯. é»˜è®¤æƒ…å†µä¸‹,æˆ‘ä»¬æ ¹æ®æœºå™¨ä¸Šå¯ç”¨å†…æ ¸çš„æ•°é‡æ¥é€‰æ‹©,ä½†è¿™å¯ä»¥è¢«è¦†ç›–.

è¿™æ„å‘³ç€ä¸ Node.js ä¸åŒ,å•ä¸ª Vert.x è¿›ç¨‹å¯ä»¥è·¨æœåŠ¡å™¨æ‰©å±•.

æˆ‘ä»¬å°†æ­¤æ¨¡å¼ç§°ä¸º **Multi-Reactor Pattern(å¤šååº”å™¨æ¨¡å¼)** ,ä»¥å°†å…¶ä¸å•çº¿ç¨‹ååº”å™¨æ¨¡å¼åŒºåˆ†å¼€.

> <mark>**ğŸ·æ³¨æ„:**</mark> å°½ç®¡Vertxå®ä¾‹ç»´æŠ¤å¤šä¸ªäº‹ä»¶å¾ªç¯,ä½†ä»»ä½•ç‰¹å®šçš„å¤„ç†å™¨æ°¸è¿œä¸ä¼šå¹¶å‘æ‰§è¡Œ,å¹¶ä¸”åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹(é™¤äº† [worker verticles](#Worker_verticles))æ€»æ˜¯ä½¿ç”¨**å®Œå…¨ç›¸åŒçš„äº‹ä»¶å¾ªç¯**è°ƒç”¨.

<a name="golden_rule"></a>

## é»„é‡‘æ³•åˆ™ - ä¸è¦é˜»å¡äº‹ä»¶å¾ªç¯

æˆ‘ä»¬å·²ç»çŸ¥é“ Vert.x API æ˜¯éé˜»å¡çš„,ä¸ä¼šé˜»å¡äº‹ä»¶å¾ªç¯,ä½†å¦‚æœæ‚¨åœ¨å¤„ç†å™¨ä¸­è‡ªå·±é˜»å¡äº‹ä»¶å¾ªç¯,è¿™å¹¶æ²¡æœ‰å¤šå¤§å¸®åŠ©.

å¦‚æœè¿™æ ·åš,åˆ™åœ¨é˜»å¡æœŸé—´è¯¥äº‹ä»¶å¾ªç¯å°†æ— æ³•æ‰§è¡Œä»»ä½•å…¶ä»–æ“ä½œ.å¦‚æœæ‚¨é˜»å¡äº†Vertxå®ä¾‹ä¸­çš„æ‰€æœ‰äº‹ä»¶å¾ªç¯,é‚£ä¹ˆæ‚¨çš„åº”ç”¨ç¨‹åºå°†å®Œå…¨åœæ­¢!

æ‰€ä»¥ä¸è¦è¿™æ ·åš! **æˆ‘å·²ç»è­¦å‘Šè¿‡ä½ äº†**.

é˜»å¡çš„ä¾‹å­åŒ…æ‹¬:

- Thread.sleep()
- ç­‰å¾…é”
- ç­‰å¾…äº’æ–¥æˆ–ç›‘è§†å™¨(ä¾‹å¦‚: synchronized æ®µ)
- è¿›è¡Œé•¿æ—¶é—´çš„æ•°æ®åº“æ“ä½œå¹¶ç­‰å¾…ç»“æœ
- è¿›è¡Œå¤æ‚çš„è®¡ç®—éœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´.
- å¾ªç¯è¿è¡Œ

å¦‚æœä»¥ä¸Šä»»ä½•ä¸€ç§æƒ…å†µä½¿äº‹ä»¶å¾ªç¯åœ¨**ç›¸å½“é•¿çš„æ—¶é—´å†…**åœæ­¢æ‰§è¡Œä»»ä½•å…¶ä»–æ“ä½œ,é‚£ä¹ˆæ‚¨åº”è¯¥ç«‹å³è½¬åˆ°naughty(ä¸å¦¥å½“)çš„æ­¥éª¤,å¹¶ç­‰å¾…è¿›ä¸€æ­¥çš„æŒ‡ç¤º.

é‚£ä¹ˆ,ä»€ä¹ˆæ˜¯**ç›¸å½“é•¿çš„æ—¶é—´å†…**?

ä¸€ä¸ªæ—¶é—´ç‰‡åˆ°åº•æ˜¯å¤šé•¿?è¿™å®é™…ä¸Šå–å†³äºæ‚¨çš„åº”ç”¨ç¨‹åºå’Œæ‰€éœ€çš„å¹¶å‘æ•°é‡.

å¦‚æœæ‚¨æœ‰ä¸€ä¸ªå•ç‹¬çš„äº‹ä»¶å¾ªç¯,å¹¶ä¸”å¸Œæœ›æ¯ç§’å¤„ç†10000ä¸ªhttpè¯·æ±‚,é‚£ä¹ˆå¾ˆæ˜æ˜¾,æ¯ä¸ªè¯·æ±‚çš„å¤„ç†æ—¶é—´ä¸èƒ½è¶…è¿‡0.1æ¯«ç§’,å› æ­¤æ‚¨ä¸èƒ½é˜»å¡è¶…è¿‡0.1æ¯«ç§’çš„æ—¶é—´.

**è¿™é“æ•°å­¦é¢˜ä¸éš¾,ç•™ç»™è¯»è€…ä½œä¸ºç»ƒä¹ .**

å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºæ²¡æœ‰å“åº”,åˆ™å¯èƒ½è¡¨æ˜æ‚¨åœ¨æŸå¤„é˜»å¡äº†äº‹ä»¶å¾ªç¯. ä¸ºäº†å¸®åŠ©æ‚¨è¯Šæ–­æ­¤ç±»é—®é¢˜,å¦‚æœ Vert.x æ£€æµ‹åˆ°äº‹ä»¶å¾ªç¯æœ‰ä¸€æ®µæ—¶é—´æ²¡æœ‰è¿”å›,å®ƒä¼šè‡ªåŠ¨è®°å½•è­¦å‘Š. å¦‚æœæ‚¨åœ¨æ—¥å¿—ä¸­çœ‹åˆ°æ­¤ç±»è­¦å‘Š,é‚£ä¹ˆæ‚¨åº”è¯¥è¿›è¡Œè°ƒæŸ¥.

```
Thread vertx-eventloop-thread-3 has been blocked for 20458 ms
```

Vert.xè¿˜å°†æä¾›å †æ ˆè·Ÿè¸ª,ä»¥ç²¾ç¡®å®šä½é˜»å¡å‘ç”Ÿçš„ä½ç½®.

å¦‚æœæ‚¨æƒ³å…³é—­è¿™äº›è­¦å‘Šæˆ–æ›´æ”¹è®¾ç½®,æ‚¨å¯ä»¥åœ¨åˆ›å»º Vert.x å¯¹è±¡ä¹‹å‰åœ¨ `VertxOptions` å¯¹è±¡æ”¹å˜ç¼ºçœè®¾ç½®.

## Futureçš„ç»“æœ

Vert.x 4 ä½¿ç”¨futuresæ¥è¡¨ç¤ºå¼‚æ­¥ç»“æœ.

ä»»ä½•å¼‚æ­¥æ–¹æ³•éƒ½ä¼šä¸ºè°ƒç”¨ç»“æœè¿”å›ä¸€ä¸ª`Future`å¯¹è±¡:ä¸€ä¸ª*success* æˆ–è€… *failure*.

æ‚¨ä¸èƒ½ç›´æ¥ä¸futureçš„ç»“æœè¿›è¡Œäº¤äº’,è€Œæ˜¯éœ€è¦è®¾ç½®ä¸€ä¸ªå¤„ç†å™¨,å½“futureå®Œæˆå¹¶ä¸”ç»“æœå¯ç”¨æ—¶å°†è°ƒç”¨è¯¥å¤„ç†å™¨,å°±åƒä»»ä½•å…¶ä»–ç±»å‹çš„äº‹ä»¶ä¸€æ ·.

```java
FileSystem fs = vertx.fileSystem();

Future<FileProps> future = fs.props("/my_file.txt");

future.onComplete((AsyncResult<FileProps> ar) -> {
  if (ar.succeeded()) {
    FileProps props = ar.result();
    System.out.println("File size = " + props.size());
  } else {
    System.out.println("Failure: " + ar.cause().getMessage());
  }
});

```

> **ğŸ·æ³¨æ„:** Vert.x 3 ä»…æä¾›äº†ä¸€ä¸ªå›è°ƒæ¨¡å‹. ä¸ºäº†è½»æ¾è¿ç§»åˆ° Vert.x 4,æˆ‘ä»¬å†³å®šæ¯ä¸ªå¼‚æ­¥æ–¹æ³•ä¹Ÿæœ‰ä¸€ä¸ªå›è°ƒç‰ˆæœ¬. ä¸Šé¢çš„ `props` æ–¹æ³•è¿˜æœ‰ä¸€ä¸ª `props` ç‰ˆæœ¬,å…¶ä¸­å›è°ƒä½œä¸ºæ–¹æ³•å‚æ•°.

## Futureçš„composition(ç»„åˆ)

`compose` å¯ç”¨äºfuturesçš„é“¾å¼è°ƒç”¨:

- åœ¨å½“å‰futureæˆåŠŸæ—¶,åº”ç”¨ç»™å®šçš„å‡½æ•°,è¿”å›ä¸€ä¸ªfuture.å½“è¿”å›çš„futureå®Œæˆæ—¶,compositionæˆåŠŸ.
- åœ¨å½“å‰futureå¤±è´¥æ—¶,compositionå¤±è´¥

```java
FileSystem fs = vertx.fileSystem();

Future<Void> future = fs
  .createFile("/foo")
  .compose(v -> {
    // When the file is created (fut1), execute this:
    return fs.writeFile("/foo", Buffer.buffer());
  })
  .compose(v -> {
    // When the file is written (fut2), execute this:
    return fs.move("/foo", "/bar");
  });
```

åœ¨æ­¤ç¤ºä¾‹ä¸­,3 ä¸ªæ“ä½œé“¾æ¥åœ¨ä¸€èµ·:

1. åˆ›å»ºä¸€ä¸ªæ–‡ä»¶
2. æ•°æ®å†™å…¥æ­¤æ–‡ä»¶
3. æ–‡ä»¶è¢«ç§»åŠ¨

å½“è¿™ 3 ä¸ªæ­¥éª¤æˆåŠŸæ—¶,æœ€ç»ˆçš„`future`å°†æˆåŠŸ. ä½†æ˜¯,å¦‚æœå…¶ä¸­ä¸€ä¸ªæ­¥éª¤å¤±è´¥,æœ€ç»ˆçš„`future`å°†å¤±è´¥.

é™¤æ­¤ä¹‹å¤–,`Future` æä¾›äº†æ›´å¤š:`map`,`recover`,`otherwise` ç”šè‡³æ˜¯`compose` çš„åˆ«å`flatMap`

## Futureçš„coordination(åè°ƒ)

ä½¿ç”¨ Vert.xçš„ `futures` å¯ä»¥å®ç°å¤šä¸ªfutureçš„åè°ƒ. å®ƒæ”¯æŒå¹¶å‘ç»„åˆ(å¹¶è¡Œè¿è¡Œå¤šä¸ªå¼‚æ­¥æ“ä½œ)å’Œé¡ºåºç»„åˆ(é“¾å¼å¼‚æ­¥æ“ä½œ).

`CompositeFuture.all` æ¥å—å¤šä¸ªfutureä½œä¸ºå‚æ•°(æœ€å¤š 6 ä¸ª),å¹¶åœ¨æ‰€æœ‰future*æˆåŠŸ*æ—¶è¿”å›*æˆåŠŸ*,å½“è‡³å°‘ä¸€ä¸ªfutureå¤±è´¥æ—¶è¿”å›*å¤±è´¥*:

```java
Future<HttpServer> httpServerFuture = httpServer.listen();

Future<NetServer> netServerFuture = netServer.listen();

CompositeFuture.all(httpServerFuture, netServerFuture).onComplete(ar -> {
  if (ar.succeeded()) {
    // All servers started
  } else {
    // At least one server failed
  }
});
```

è¿™äº›æ“ä½œåŒæ—¶è¿è¡Œ,é™„åŠ åˆ°è¿”å›çš„futureçš„"å¤„ç†å™¨"åœ¨ç»„åˆå®Œæˆæ—¶è¢«è°ƒç”¨. å½“å…¶ä¸­ä¸€é¡¹æ“ä½œå¤±è´¥(é€šè¿‡çš„futureä¹‹ä¸€è¢«æ ‡è®°ä¸ºå¤±è´¥)æ—¶,ç”Ÿæˆçš„futureä¹Ÿè¢«æ ‡è®°ä¸ºå¤±è´¥. å½“æ‰€æœ‰æ“ä½œéƒ½æˆåŠŸæ—¶,ç”±æ­¤äº§ç”Ÿçš„futureå°±æˆåŠŸå®Œæˆäº†.

æˆ–è€…,æ‚¨å¯ä»¥ä¼ é€’futureåˆ—è¡¨(å¯èƒ½ä¸ºç©º):

```java
CompositeFuture.all(Arrays.asList(future1, future2, future3));
```

è™½ç„¶ `all` ç»„åˆ *ç­‰å¾…* ç›´åˆ°æ‰€æœ‰futureéƒ½æˆåŠŸ(æˆ–ä¸€ä¸ªå¤±è´¥),ä½† `any` ç»„åˆ *ç­‰å¾…*  ç¬¬ä¸€ä¸ªæˆåŠŸçš„future.

`CompositeFuture.any` æ¥å—å¤šä¸ªfutureä½œä¸ºå‚æ•°(æœ€å¤š 6 ä¸ª)å¹¶è¿”å›ä¸€ä¸ªfuture,å½“å…¶ä¸­ä¸€ä¸ªfutureæˆåŠŸæ—¶æˆåŠŸ,å½“æ‰€æœ‰futureéƒ½å¤±è´¥æ—¶å¤±è´¥:

```java
CompositeFuture.any(future1, future2).onComplete(ar -> {
  if (ar.succeeded()) {
    // At least one is succeeded
  } else {
    // All failed
  }
});
```

ä¹Ÿå¯ä»¥ä½¿ç”¨futureåˆ—è¡¨:

```java
CompositeFuture.any(Arrays.asList(f1, f2, f3));
```

`join` ç»„åˆ *ç­‰å¾…* ç›´åˆ°æ‰€æœ‰futureéƒ½å®Œæˆ,æ— è®ºæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥. `CompositeFuture.join` æ¥å—å¤šä¸ªfutureä½œä¸ºå‚æ•°(æœ€å¤š 6 ä¸ª)å¹¶è¿”å›ä¸€ä¸ªfuture,å½“æ‰€æœ‰futureéƒ½æˆåŠŸæ—¶æˆåŠŸ,å½“æ‰€æœ‰future,éƒ½å®Œæˆä¸”è‡³å°‘å…¶ä¸­ä¸€ä¸ªå¤±è´¥æ—¶å¤±è´¥:

```java
CompositeFuture.join(future1, future2, future3).onComplete(ar -> {
  if (ar.succeeded()) {
    // All succeeded
  } else {
    // All completed and at least one failed
  }
});
```

ä¹Ÿå¯ä»¥ä½¿ç”¨futureåˆ—è¡¨:

```java
CompositeFuture.join(Arrays.asList(future1, future2, future3));
```

### ä¸JDKè‡ªå¸¦çš„CompletionStageçš„äº’æ“ä½œæ€§

Vert.x `Future` API æä¾›å…¼å®¹æ€§ *from* å’Œ *to*  `CompletionStage`,CompletionStageæ˜¯ç”¨äºå¯ç»„åˆå¼‚æ­¥æ“ä½œçš„ JDK æ¥å£.

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `toCompletionStage` æ–¹æ³•ä» Vert.x `Future` è½¬åˆ° `CompletionStage`,å¦‚ä¸‹æ‰€ç¤º:

```java
Future<String> future = vertx.createDnsClient().lookup("vertx.io");
future.toCompletionStage().whenComplete((ip, err) -> {
  if (err != null) {
    System.err.println("Could not resolve vertx.io");
    err.printStackTrace();
  } else {
    System.out.println("vertx.io => " + ip);
  }
});
```

ç›¸å,æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `Future.fromCompletionStage` ä» `CompletionStage` è½¬åˆ° Vert.xçš„ `Future`. æœ‰ 2 ç§å˜ä½“:

1. ç¬¬ä¸€ä¸ªå˜ä½“åªæ¥å—ä¸€ä¸ª`CompletionStage`å¹¶ä»è§£æ`CompletionStage`å®ä¾‹çš„çº¿ç¨‹è°ƒç”¨`Future`æ–¹æ³•
2. ç¬¬äºŒä¸ªå˜ä½“é‡‡ç”¨é¢å¤–çš„ `Context` å‚æ•°æ¥è°ƒç”¨ Vert.x ä¸Šä¸‹æ–‡ä¸­çš„ `Future` æ–¹æ³•.

> **âš é‡è¦:**  åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹,å¸¦æœ‰ `CompletionStage` å’Œ `Context` çš„å˜ä½“æ˜¯æ‚¨æƒ³è¦ç”¨æ¥å°Šé‡ Vert.x çº¿ç¨‹æ¨¡å‹çš„å˜ä½“,å› ä¸º Vert.x `Future` æ›´æœ‰å¯èƒ½ä¸ Vert.x çš„ä»£ç ,åº“å’Œå®¢æˆ·ç«¯ä¸€èµ·ä½¿ç”¨.

ä¸‹é¢æ˜¯ä¸€ä¸ªä» `CompletionStage` åˆ° Vert.x `Future` å¹¶åœ¨ä¸Šä¸‹æ–‡ä¸­è°ƒåº¦çš„ç¤ºä¾‹:

```java
Future.fromCompletionStage(completionStage, vertx.getOrCreateContext())
  .flatMap(str -> {
    String key = UUID.randomUUID().toString();
    return storeInDb(key, str);
  })
  .onSuccess(str -> {
    System.out.println("We have a result: " + str);
  })
  .onFailure(err -> {
    System.err.println("We have a problem");
    err.printStackTrace();
  });
```

## Verticles

Vert.x å¸¦æœ‰ä¸€ä¸ªç®€å•çš„,å¯æ‰©å±•çš„,*actor-like* éƒ¨ç½²å’Œå¼€ç®±å³ç”¨çš„å¹¶å‘æ¨¡å‹,æ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥èŠ‚çœæ‚¨è‡ªå·±ç¼–å†™çš„ä»£ç .

**æ­¤æ¨¡å‹å®Œå…¨æ˜¯å¯é€‰çš„,å¦‚æœæ‚¨ä¸æƒ³è¿™æ ·åš,Vert.x ä¸ä¼šå¼ºè¿«æ‚¨ä»¥è¿™ç§æ–¹å¼åˆ›å»ºåº”ç”¨ç¨‹åº.**

è¯¥æ¨¡å‹å¹¶ä¸å£°ç§°æ˜¯ä¸¥æ ¼çš„`actor-model`å®ç°,ä½†å®ƒç¡®å®å…·æœ‰ç›¸ä¼¼ä¹‹å¤„,å°¤å…¶æ˜¯åœ¨å¹¶å‘æ€§,æ‰©å±•æ€§å’Œéƒ¨ç½²æ–¹é¢.

è¦ä½¿ç”¨æ­¤æ¨¡å‹,æ‚¨å°†ä»£ç ç¼–å†™ä¸ºä¸€ç»„ **verticles**.

Verticle æ˜¯ç”± Vert.x éƒ¨ç½²å’Œè¿è¡Œçš„ä»£ç å—. ä¸€ä¸ª Vert.x å®ä¾‹é»˜è®¤ç»´æŠ¤ N ä¸ªäº‹ä»¶å¾ªç¯çº¿ç¨‹(å…¶ä¸­ N é»˜è®¤ä¸º `core*2`). Verticle å¯ä»¥ç”¨ Vert.x æ”¯æŒçš„ä»»ä½•è¯­è¨€ç¼–å†™,å•ä¸ªåº”ç”¨ç¨‹åºå¯ä»¥åŒ…å«ç”¨å¤šç§è¯­è¨€ç¼–å†™çš„ Verticle.

æ‚¨å¯ä»¥å°†verticleè§†ä¸ºæœ‰ç‚¹åƒ [Actor Model] (https://en.wikipedia.org/wiki/Actor_model) ä¸­çš„æ¼”å‘˜.

ä¸€ä¸ªåº”ç”¨ç¨‹åºé€šå¸¸ç”±åŒæ—¶åœ¨åŒä¸€ä¸ª Vert.x å®ä¾‹ä¸­è¿è¡Œçš„å¤šä¸ª Verticle å®ä¾‹ç»„æˆ. ä¸åŒçš„verticleå®ä¾‹é€šè¿‡åœ¨[event bus](#event_bus)ä¸Šå‘é€æ¶ˆæ¯ç›¸äº’é€šä¿¡.

### ç¼–å†™Verticles

Verticleç±»å¿…é¡»å®ç°`Verticle`æ¥å£.

å¦‚æœæ‚¨æ„¿æ„,ä»–ä»¬å¯ä»¥ç›´æ¥å®ç°å®ƒ,ä½†é€šå¸¸æ‰©å±•æŠ½è±¡ç±»`AbstractVerticle`æ›´ç®€å•.

è¿™æ˜¯ä¸€ä¸ªverticleçš„ç¤ºä¾‹:

```java
public class MyVerticle extends AbstractVerticle {

 // Called when verticle is deployed
 public void start() {
 }

 // Optional - called when verticle is undeployed
 public void stop() {
 }

}
```

é€šå¸¸ä½ ä¼šåƒä¸Šé¢çš„ä¾‹å­ä¸€æ ·è¦†ç›– start æ–¹æ³•.

å½“ Vert.x éƒ¨ç½² Verticle æ—¶,å®ƒä¼šè°ƒç”¨ start æ–¹æ³•,å½“è¯¥æ–¹æ³•å®Œæˆæ—¶,Verticle å°†è¢«è§†ä¸ºå·²å¯åŠ¨.

æ‚¨è¿˜å¯ä»¥é€‰æ‹©è¦†ç›– stop æ–¹æ³•. è¿™å°†åœ¨ Vert.x å–æ¶ˆéƒ¨ç½²æ—¶è°ƒç”¨,å¹¶ä¸”å½“æ–¹æ³•å®Œæˆæ—¶,Verticle å°†è¢«è§†ä¸ºå·²åœæ­¢.

### å¼‚æ­¥çš„Verticle start å’Œ stop

æœ‰æ—¶ä½ æƒ³åœ¨ä½ çš„ verticle å¯åŠ¨ä¸­åšä¸€äº›éœ€è¦ä¸€äº›æ—¶é—´çš„äº‹æƒ…,å¹¶ä¸”ä½ ä¸å¸Œæœ›åœ¨è¿™ç§æƒ…å†µå‘ç”Ÿä¹‹å‰è€ƒè™‘éƒ¨ç½² verticle. ä¾‹å¦‚,æ‚¨å¯èƒ½å¸Œæœ›åœ¨ start æ–¹æ³•ä¸­å¯åŠ¨ HTTP æœåŠ¡å™¨å¹¶ä¼ æ’­æœåŠ¡å™¨`listen`æ–¹æ³•çš„å¼‚æ­¥ç»“æœ.

ä½ ä¸èƒ½ç”¨é˜»å¡çš„æ–¹å¼ç­‰å¾…HTTPæœåŠ¡å™¨ç»‘å®šåœ¨ä½ çš„startæ–¹æ³•ä¸­,å› ä¸ºè¿™å°†æ‰“ç ´[é»„é‡‘æ³•åˆ™](#golden_rule).

é‚£ä¹ˆè¯¥æ€ä¹ˆèƒ½å‘¢?

å®ç°çš„æ–¹æ³•æ˜¯å®ç°**å¼‚æ­¥çš„**startæ–¹æ³•.è¿™ä¸ªç‰ˆæœ¬çš„æ–¹æ³•ä»¥Futureä½œä¸ºå‚æ•°.å½“è¯¥æ–¹æ³•è¿”å›æ—¶,å°†**ä¸**è¢«è®¤ä¸ºå·²ç»è¢«éƒ¨ç½².

ä¸€æ®µæ—¶é—´å,åœ¨ä½ å®Œæˆäº†ä½ éœ€è¦åšçš„æ‰€æœ‰äº‹æƒ…(ä¾‹å¦‚å¯åŠ¨ HTTP æœåŠ¡å™¨)ä¹‹å,ä½ å¯ä»¥åœ¨ Future ä¸Šè°ƒç”¨ complete(æˆ– fail)æ¥è¡¨ç¤ºä½ å·²ç»å®Œæˆäº†.

è¿™æ˜¯ä¸€ä¸ªä¾‹å­:

```java
public class MyVerticle extends AbstractVerticle {

 private HttpServer server;

 public void start(Promise<Void> startPromise) {
   server = vertx.createHttpServer().requestHandler(req -> {
     req.response()
       .putHeader("content-type", "text/plain")
       .end("Hello from Vert.x!");
     });

   // Now bind the server:
   server.listen(8080, res -> {
     if (res.succeeded()) {
       startPromise.complete();
     } else {
       startPromise.fail(res.cause());
     }
   });
 }
}
```

åŒæ ·,ä¹Ÿæœ‰ä¸€ä¸ªå¼‚æ­¥ç‰ˆæœ¬çš„ stop æ–¹æ³•. å¦‚æœä½ æƒ³åšä¸€äº›éœ€è¦ä¸€äº›æ—¶é—´çš„verticle æ¸…ç†,ä½ å¯ä»¥ä½¿ç”¨å®ƒ.

```java
public class MyVerticle extends AbstractVerticle {

 public void start() {
   // Do something
 }

 public void stop(Promise<Void> stopPromise) {
   obj.doSomethingThatTakesTime(res -> {
     if (res.succeeded()) {
       stopPromise.complete();
     } else {
       stopPromise.fail();
     }
   });
 }
}
```

> **ğŸ’¡æç¤º:** æ‚¨ä¸éœ€è¦åœ¨ verticle çš„ stop æ–¹æ³•ä¸­æ‰‹åŠ¨åœæ­¢ç”± verticle å¯åŠ¨çš„ HTTP æœåŠ¡å™¨. å½“ Verticle å–æ¶ˆéƒ¨ç½²æ—¶,Vert.x å°†è‡ªåŠ¨åœæ­¢ä»»ä½•æ­£åœ¨è¿è¡Œçš„æœåŠ¡å™¨.

### Verticle ç±»å‹

æœ‰ä¸¤ç§ä¸åŒç±»å‹çš„verticles:

- æ ‡å‡† Verticles

  è¿™äº›æ˜¯æœ€å¸¸è§å’Œæœ€æœ‰ç”¨çš„ç±»å‹-å®ƒä»¬æ€»æ˜¯ä½¿ç”¨<mark>**äº‹ä»¶å¾ªç¯çº¿ç¨‹**</mark>æ‰§è¡Œ. æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­å¯¹æ­¤è¿›è¡Œæ›´å¤šè®¨è®º.

- å·¥ä½œ Verticles

  è¿™äº›ä½¿ç”¨<mark>**å·¥ä½œæ± ä¸­çš„çº¿ç¨‹**</mark>è¿è¡Œ. ä¸€ä¸ªVerticleå®ä¾‹æ°¸è¿œä¸ä¼šè¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ,ä½†å¯ä»¥åœ¨ä¸åŒçš„æ—¶é—´ç”±ä¸åŒçš„çº¿ç¨‹æ‰§è¡Œ.

### æ ‡å‡† verticles

æ ‡å‡† Verticle åœ¨åˆ›å»ºæ—¶è¢«åˆ†é…ä¸€ä¸ªäº‹ä»¶å¾ªç¯çº¿ç¨‹,å¹¶ä½¿ç”¨è¯¥äº‹ä»¶å¾ªç¯è°ƒç”¨ `start` æ–¹æ³•. å½“æ‚¨ä»äº‹ä»¶å¾ªç¯è°ƒç”¨ä»»ä½•å…¶ä»–åœ¨æ ¸å¿ƒ API ä¸Šè·å–å¤„ç†å™¨çš„æ–¹æ³•æ—¶,Vert.x å°†ä¿è¯è¿™äº›å¤„ç†å™¨åœ¨è¢«è°ƒç”¨æ—¶å°†åœ¨åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸Šæ‰§è¡Œ.

è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä¿è¯æ‚¨çš„ Verticle å®ä¾‹ä¸­çš„æ‰€æœ‰ä»£ç å§‹ç»ˆåœ¨åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸Šæ‰§è¡Œ(åªè¦æ‚¨ä¸åˆ›å»ºè‡ªå·±çš„çº¿ç¨‹å¹¶è°ƒç”¨å®ƒ!).

è¿™æ„å‘³ç€æ‚¨å¯ä»¥å°†åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰ä»£ç ç¼–å†™ä¸ºå•çº¿ç¨‹,å¹¶è®© Vert.x æ¥ç®¡ç†çº¿ç¨‹å’Œä¼¸ç¼©æ€§. ä½ ä¸å†æ‹…å¿ƒ**åŒæ­¥**å’Œ**æ˜“å¤±æ€§**,å¹¶ä¸”æ‚¨è¿˜å¯ä»¥é¿å…åœ¨è¿›è¡Œæ‰‹åŠ¨"ä¼ ç»Ÿ"å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºå¼€å‘æ—¶å¦‚æ­¤æ™®éçš„è®¸å¤šå…¶ä»–ç«äº‰æ¡ä»¶å’Œæ­»é”æƒ…å†µ.

<a name="Worker_verticles"></a>

### å·¥ä½œ verticles

ä¸€ä¸ªworker verticleå°±åƒä¸€ä¸ªæ ‡å‡†çš„verticle,ä½†å®ƒæ˜¯ä½¿ç”¨Vert.xå·¥ä½œçº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œçš„,è€Œä¸æ˜¯ä½¿ç”¨ä¸€ä¸ªäº‹ä»¶å¾ªç¯.

Worker Verticle æ˜¯ä¸ºè°ƒç”¨é˜»å¡ä»£ç è€Œè®¾è®¡çš„,å› ä¸ºå®ƒä»¬ä¸ä¼šé˜»å¡ä»»ä½•äº‹ä»¶å¾ªç¯.

å¦‚æœä½ ä¸æƒ³ä½¿ç”¨ worker verticle æ¥è¿è¡Œé˜»å¡ä»£ç ,ä½ ä¹Ÿå¯ä»¥åœ¨äº‹ä»¶å¾ªç¯ä¸­ç›´æ¥è¿è¡Œ [inline blocking code](#Running_blocking_code).

å¦‚æœä½ æƒ³å°†ä¸€ä¸ªverticleéƒ¨ç½²ä¸ºä¸€ä¸ªworker verticle,ä½ å¯ä»¥ä½¿ç”¨`setWorker`æ¥å®ç°.

```java
DeploymentOptions options = new DeploymentOptions().setWorker(true);
vertx.deployVerticle("com.mycompany.MyOrderProcessorVerticle", options);
```

Worker verticleå®ä¾‹ **æ°¸è¿œä¸ä¼š** è¢«Vert.xçš„å¤šä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œ,ä½†å¯ä»¥åœ¨ä¸åŒçš„æ—¶é—´ç”±ä¸åŒçš„çº¿ç¨‹æ‰§è¡Œ.
> **è¯‘è€…æ³¨:** worker verticleå¤„ç†äº‹ä»¶çš„æ–¹å¼ä¸event-loop verticleå¤„ç†äº‹ä»¶çš„æ–¹å¼åŸºæœ¬ç›¸åŒï¼Œä¸åŒä¹‹å¤„åœ¨äºå®ƒå¯ä»¥èŠ±è´¹ä»»æ„é•¿çš„æ—¶é—´æ¥å®Œæˆè¿™ä¸€æ“ä½œã€‚é‡è¦çš„æ˜¯è¦äº†è§£ï¼š
> 1. worker verticleä¸ç»‘å®šåˆ°å•ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œå› æ­¤ä¸event-loop verticle ä¸åŒï¼Œåç»­äº‹ä»¶å¯èƒ½ä¸ä¼šåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œ
> 2. worker verticlesåœ¨ç»™å®šçš„æ—¶é—´å†…åªèƒ½é€šè¿‡ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€worker threadã€‘è®¿é—®åˆ°
> 
> ç®€å•åœ°è¯´ï¼š
> 
> + ç›¸åŒç‚¹ï¼šä¸event-loop verticle ç›¸åŒçš„æ˜¯ï¼Œ worker verticleæ˜¯å•çº¿ç¨‹çš„
> + ä¸åŒç‚¹ï¼šä¸event-loop verticle ä¸åŒçš„æ˜¯ï¼Œçº¿ç¨‹å¯èƒ½ä¸æ€»æ˜¯ç›¸åŒçš„


### ä»¥ç¼–ç¨‹æ–¹å¼éƒ¨ç½²Verticle

æ‚¨å¯ä»¥ä½¿ç”¨ `deployVerticle` æ–¹æ³•éƒ¨ç½²ä¸€ä¸ªverticle,æŒ‡å®šä¸€ä¸ªverticleåç§°,æˆ–è€…ä½ å¯ä»¥ä¼ å…¥ä¸€ä¸ªä½ å·²ç»åˆ›å»ºçš„verticleå®ä¾‹.

> **ğŸ·æ³¨æ„:** åªæœ‰Javaæ”¯æŒ**instances**çš„æ–¹å¼æ¥éƒ¨ç½²Verticle.

```java
Verticle myVerticle = new MyVerticle();
vertx.deployVerticle(myVerticle);
```

æ‚¨è¿˜å¯ä»¥é€šè¿‡æŒ‡å®š Verticle **name** æ¥éƒ¨ç½² Verticle.

verticle åç§°ç”¨äºæŸ¥æ‰¾ç‰¹å®šçš„ `VerticleFactory`,ç”¨äºå®ä¾‹åŒ–å®é™…çš„ verticle å®ä¾‹.

ä¸åŒçš„verticleå·¥å‚å¯ç”¨äºä»¥ä¸åŒçš„è¯­è¨€å®ä¾‹åŒ–verticleä»¥åŠå‡ºäºå„ç§å…¶ä»–åŸå› ,ä¾‹å¦‚åœ¨è¿è¡Œæ—¶åŠ è½½æœåŠ¡å’Œä» Maven è·å–verticles.

è¿™å…è®¸æ‚¨éƒ¨ç½²ä»¥ä»»ä½•è¯­è¨€ç¼–å†™çš„ Vert.x æ”¯æŒçš„ä»»ä½•å…¶ä»–è¯­è¨€çš„ Verticle.

ä¸‹é¢æ˜¯éƒ¨ç½²ä¸€äº›ä¸åŒè¯­è¨€å†™çš„ Verticle çš„ç¤ºä¾‹:

```java
vertx.deployVerticle("com.mycompany.MyOrderProcessorVerticle");

// Deploy a JavaScript verticle
vertx.deployVerticle("verticles/myverticle.js");

// Deploy a Ruby verticle verticle
vertx.deployVerticle("verticles/my_verticle.rb");
```

### å°† Verticle åç§°æ˜ å°„åˆ° Verticle å·¥å‚çš„è§„åˆ™

ä½¿ç”¨åç§°éƒ¨ç½² verticle(s) æ—¶,è¯¥åç§°ç”¨äºé€‰æ‹©å°†å®ä¾‹åŒ– verticle(s) çš„å®é™…çš„verticleå·¥å‚.

Verticleåç§°å¯ä»¥æœ‰ä¸€ä¸ªå‰ç¼€ - å®ƒæ˜¯ä¸€ä¸ªåè·Ÿå†’å·çš„å­—ç¬¦ä¸²,å¦‚æœå­˜åœ¨å°†ç”¨äºæŸ¥æ‰¾å·¥å‚,ä¾‹å¦‚:

`js:foo.js` // ä½¿ç”¨ JavaScript verticle å·¥å‚
`groovy:com.mycompany.SomeGroovyCompiledVerticle` // ä½¿ç”¨ Groovy verticle å·¥å‚
`service:com.mycompany:myorderservice` // ä½¿ç”¨ service verticle å·¥å‚

å¦‚æœä¸å­˜åœ¨å‰ç¼€,Vert.x å°†æŸ¥æ‰¾åç¼€å¹¶ä½¿ç”¨å®ƒæ¥æŸ¥æ‰¾å·¥å‚,ä¾‹å¦‚:

`foo.js` // ä¹Ÿå°†ä½¿ç”¨ JavaScript verticle å·¥å‚
`SomeScript.groovy` // å°†ä½¿ç”¨ Groovy verticle å·¥å‚

å¦‚æœä¸å­˜åœ¨å‰ç¼€æˆ–åç¼€,Vert.x å°†å‡å®šå®ƒæ˜¯ Java å®Œå…¨é™å®šç±»å (FQCN) å¹¶å°è¯•å®ä¾‹åŒ–å®ƒ.

### Verticleå·¥å‚å¦‚ä½•å®šä½?

å¤§å¤šæ•° Verticle å·¥å‚éƒ½æ˜¯ä»ç±»è·¯å¾„åŠ è½½å¹¶åœ¨ Vert.x å¯åŠ¨æ—¶æ³¨å†Œçš„.

å¦‚æœæ‚¨æ„¿æ„,è¿˜å¯ä»¥ä½¿ç”¨ `registerVerticleFactory` å’Œ `unregisterVerticleFactory` ä»¥ç¼–ç¨‹æ–¹å¼æ³¨å†Œå’Œæ³¨é”€ Verticle å·¥å‚.

### ç­‰å¾…éƒ¨ç½²å®Œæˆ

Verticle éƒ¨ç½²æ˜¯å¼‚æ­¥çš„,å¯èƒ½ä¼šåœ¨éƒ¨ç½²è°ƒç”¨è¿”å›åçš„ä¸€æ®µæ—¶é—´å†…å®Œæˆ.

å¦‚æœæ‚¨æƒ³åœ¨éƒ¨ç½²å®Œæˆæ—¶æ”¶åˆ°é€šçŸ¥,æ‚¨å¯ä»¥éƒ¨ç½²æ—¶æŒ‡å®šå®Œæˆå¤„ç†å™¨:

```java
vertx.deployVerticle("com.mycompany.MyOrderProcessorVerticle", res -> {
  if (res.succeeded()) {
    System.out.println("Deployment id is: " + res.result());
  } else {
    System.out.println("Deployment failed!");
  }
});
```

å¦‚æœéƒ¨ç½²æˆåŠŸ,å®Œæˆå¤„ç†å™¨å°†ä¼ é€’ä¸€ä¸ªåŒ…å«éƒ¨ç½² ID å­—ç¬¦ä¸²çš„ç»“æœ.

å¦‚æœæ‚¨æƒ³å–æ¶ˆéƒ¨ç½²,ä»¥åå¯ä»¥ä½¿ç”¨æ­¤éƒ¨ç½² ID.

### å–æ¶ˆå·²ç»éƒ¨ç½²çš„verticle

å¯ä»¥ä½¿ç”¨ `undeploy` å–æ¶ˆéƒ¨ç½².

å–æ¶ˆéƒ¨ç½²æœ¬èº«æ˜¯å¼‚æ­¥çš„,å› æ­¤å¦‚æœæ‚¨æƒ³åœ¨å–æ¶ˆéƒ¨ç½²å®Œæˆæ—¶æ”¶åˆ°é€šçŸ¥,æ‚¨å¯ä»¥undeployæ—¶æŒ‡å®šå®Œæˆå¤„ç†å™¨:

```java
vertx.undeploy(deploymentID, res -> {
  if (res.succeeded()) {
    System.out.println("Undeployed ok");
  } else {
    System.out.println("Undeploy failed!");
  }
});
```

### æŒ‡å®šverticleå®ä¾‹çš„æ•°é‡

ä½¿ç”¨verticleåç§°éƒ¨ç½²verticleæ—¶,æ‚¨å¯ä»¥æŒ‡å®šè¦éƒ¨ç½²çš„verticleå®ä¾‹çš„æ•°é‡:

```java
DeploymentOptions options = new DeploymentOptions().setInstances(16);
vertx.deployVerticle("com.mycompany.MyOrderProcessorVerticle", options);
```

è¿™å¯¹äºè·¨å¤šä¸ªå†…æ ¸è½»æ¾æ‰©å±•å¾ˆæœ‰ç”¨. ä¾‹å¦‚,æ‚¨å¯èƒ½åœ¨ä¸€ä¸ªæœ‰å¾ˆå¤šæ ¸çš„æœåŠ¡å™¨ä¸Šéƒ¨ç½²WebæœåŠ¡Verticle,å› æ­¤æ‚¨å¸Œæœ›éƒ¨ç½²å¤šä¸ªå®ä¾‹ä»¥åˆ©ç”¨æ‰€æœ‰æ ¸å¿ƒ.

<a name="passing_configuration_to_a_verticle"></a>
### å°†é…ç½®ä¼ é€’ç»™verticle

JSONå½¢å¼çš„é…ç½®å¯ä»¥åœ¨éƒ¨ç½²æ—¶ä¼ é€’ç»™ä¸€ä¸ªverticleå¯¹è±¡:

```java
JsonObject config = new JsonObject().put("name", "tim").put("directory", "/blah");
DeploymentOptions options = new DeploymentOptions().setConfig(config);
vertx.deployVerticle("com.mycompany.MyOrderProcessorVerticle", options);
```

ç„¶ååœ¨verticleé‡Œå¯ä»¥é€šè¿‡ `AbstractVerticle.context` å¯¹è±¡æˆ–ç›´æ¥ä½¿ç”¨ `AbstractVerticle.config()` æ–¹æ³•è·å¾—æ­¤é…ç½®. é…ç½®ä½œä¸º JSON å¯¹è±¡è¿”å›,å› æ­¤æ‚¨å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼æ£€ç´¢æ•°æ®:

```java
System.out.println("Configuration: " + config().getString("name"));
```

### è®¿é—® Verticle ä¸­çš„ç¯å¢ƒå˜é‡

å¯ä»¥ä½¿ç”¨ Java API è®¿é—®ç¯å¢ƒå˜é‡å’Œç³»ç»Ÿå±æ€§:

```java
System.getProperty("prop");
System.getenv("HOME");
```

### é«˜å¯ç”¨æ€§

å¯ä»¥åœ¨å¯ç”¨é«˜å¯ç”¨æ€§ (HA) çš„æƒ…å†µä¸‹éƒ¨ç½² Verticles. åœ¨è¿™ç§æƒ…å†µä¸‹,å½“ä¸€ä¸ª verticle éƒ¨ç½²åœ¨ä¸€ä¸ªçªç„¶æ­»äº¡çš„ vert.x å®ä¾‹ä¸Šæ—¶,è¯¥ verticle ä¼šé‡æ–°éƒ¨ç½²åˆ°é›†ç¾¤ä¸­çš„å¦ä¸€ä¸ª vert.x å®ä¾‹ä¸Š.

è¦è¿è¡Œå¯ç”¨äº†é«˜å¯ç”¨æ€§çš„ Verticle,åªéœ€é™„åŠ  `-ha` å¼€å…³:

```bash
vertx run my-verticle.js -ha
```

å¯ç”¨é«˜å¯ç”¨æ€§æ—¶,æ— éœ€æ·»åŠ  `-cluster`.

[é«˜å¯ç”¨æ€§å’Œæ•…éšœè½¬ç§»](#high_availability_and_fail_over) éƒ¨åˆ†ä¸­æœ‰å…³é«˜å¯ç”¨æ€§åŠŸèƒ½å’Œé…ç½®çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

### ä»å‘½ä»¤è¡Œè¿è¡Œ Verticles

ä½ å¯ä»¥åœ¨ä½ çš„Mavenæˆ–Gradleé¡¹ç›®ä¸­ç›´æ¥ä½¿ç”¨Vert.x,åªè¦æ·»åŠ ä¸€ä¸ªVert.xæ ¸å¿ƒåº“çš„ä¾èµ–,ç„¶åä»é‚£é‡Œå…¥æ‰‹.

ä½†æ˜¯,å¦‚æœæ‚¨æ„¿æ„,ä¹Ÿå¯ä»¥ç›´æ¥ä»å‘½ä»¤è¡Œè¿è¡Œ Vert.x çš„ verticles.

ä¸ºæ­¤,æ‚¨éœ€è¦ä¸‹è½½å¹¶å®‰è£… Vert.x å‘è¡Œç‰ˆ(`https://repo1.maven.org/maven2/io/vertx/vertx-stack-manager/4.2.4/`),å¹¶å°†å®‰è£…çš„ `bin` ç›®å½•æ·»åŠ åˆ° `PATH` ç¯å¢ƒå˜é‡ä¸­. è¿˜è¦ç¡®ä¿ä½ çš„ `PATH` ä¸Šæœ‰ä¸€ä¸ª Java JDK.

Vert.x æ”¯æŒJavaç‰ˆæœ¬ä» 8 åˆ° 17.

> **ğŸ·æ³¨æ„:** éœ€è¦JDKæ¥æ”¯æŒJavaä»£ç çš„åŠ¨æ€ç¼–è¯‘.

æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨ `vertex run` å‘½ä»¤è¿è¡Œverticles . è¿™é‡Œæœ‰äº›ä¾‹å­:

```bash
# Run a JavaScript verticle
vertx run my_verticle.js

# Run a Ruby verticle
vertx run a_n_other_verticle.rb

# Run a Groovy script verticle, clustered
vertx run FooVerticle.groovy -cluster
```

æ‚¨ç”šè‡³å¯ä»¥åœ¨ä¸å…ˆç¼–è¯‘å®ƒä»¬çš„æƒ…å†µä¸‹è¿è¡ŒVerticleçš„Javaæºä»£ç  !

```bash
vertx run SomeJavaSourceFile.java
```

Vert.x å°†åœ¨è¿è¡Œä¹‹å‰å³æ—¶ç¼–è¯‘ Java æºæ–‡ä»¶. è¿™å¯¹äºå¿«é€Ÿåˆ¶ä½œ Verticle åŸå‹éå¸¸æœ‰ç”¨,éå¸¸é€‚åˆæ¼”ç¤º. æ— éœ€å…ˆè®¾ç½® Maven æˆ– Gradle æ„å»ºå³å¯å¼€å§‹!

æœ‰å…³åœ¨å‘½ä»¤è¡Œä¸Šæ‰§è¡Œ `vertx` æ—¶å¯ç”¨çš„å„ç§é€‰é¡¹çš„å®Œæ•´ä¿¡æ¯,è¯·åœ¨å‘½ä»¤è¡Œä¸­é”®å…¥ `vertx`.

### ä½¿ Vert.x é€€å‡º

Vert.x å®ä¾‹ç»´æŠ¤çš„çº¿ç¨‹ä¸æ˜¯å®ˆæŠ¤çº¿ç¨‹,å› æ­¤å®ƒä»¬ä¼šé˜»æ­¢ JVM é€€å‡º.

å¦‚æœä½ æ­£åœ¨åµŒå…¥ Vert.x å¹¶ä¸”ä½ å·²ç»å®Œæˆäº†å®ƒ,ä½ å¯ä»¥è°ƒç”¨Vert.x çš„ `close` æ–¹æ³•æ¥å…³é—­å®ƒ.

è¿™å°†å…³é—­æ‰€æœ‰å†…éƒ¨çº¿ç¨‹æ± å¹¶å…³é—­å…¶ä»–èµ„æº,å¹¶å…è®¸ JVM é€€å‡º.

### Context(ä¸Šä¸‹æ–‡) å¯¹è±¡

å½“Vert.xæä¾›ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨æˆ–è°ƒç”¨`Verticle`çš„startæˆ–stopæ–¹æ³•æ—¶,ä¸`Context`ç›¸å…³è”. é€šå¸¸ä¸€ä¸ªä¸Šä¸‹æ–‡æ˜¯ä¸€ä¸ª**äº‹ä»¶å¾ªç¯ä¸Šä¸‹æ–‡**å¹¶ä¸”ç»‘å®šåˆ°ä¸€ä¸ªç‰¹å®šçš„äº‹ä»¶å¾ªç¯çº¿ç¨‹. å› æ­¤,å¯¹è¯¥ä¸Šä¸‹æ–‡çš„æ‰§è¡Œæ€»æ˜¯å‘ç”Ÿåœ¨å®Œå…¨ç›¸åŒçš„äº‹ä»¶å¾ªç¯çº¿ç¨‹ä¸Š. åœ¨å·¥ä½œçº¿ç¨‹å’Œè¿è¡Œå†…è”é˜»å¡ä»£ç çš„æƒ…å†µä¸‹,å·¥ä½œä¸Šä¸‹æ–‡å°†ä¸ä½¿ç”¨å·¥ä½œçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹çš„æ‰§è¡Œç¯å¢ƒç›¸å…³è”.

è¦è·å–ä¸Šä¸‹æ–‡,è¯·ä½¿ç”¨ `getOrCreateContext` æ–¹æ³•:

```java
Context context = vertx.getOrCreateContext();
```

å¦‚æœå½“å‰çº¿ç¨‹æœ‰ä¸ä¹‹å…³è”çš„ä¸Šä¸‹æ–‡,å®ƒä¼šé‡ç”¨ä¸Šä¸‹æ–‡å¯¹è±¡. å¦‚æœæ²¡æœ‰åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸Šä¸‹æ–‡å®ä¾‹. æ‚¨å¯ä»¥æµ‹è¯•æ‚¨æ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡çš„ *type*:

```java
Context context = vertx.getOrCreateContext();
if (context.isEventLoopContext()) {
  System.out.println("Context attached to Event Loop");
} else if (context.isWorkerContext()) {
  System.out.println("Context attached to Worker Thread");
} else if (! Context.isOnVertxThread()) {  //That's either a worker thread or an event loop thread
  System.out.println("Context not attached to a thread managed by vert.x");
}
```
> **è¯‘è€…æ³¨:** å½“ä½¿ç”¨ `Vertx.executeBlocking(Handler, Handler)` ä»æ ‡å‡†ï¼ˆé workerï¼‰verticle è¿è¡Œé˜»å¡ä»£ç æ—¶ï¼Œä¸Šä¸‹æ–‡ä»å°†æ˜¯äº‹ä»¶å¾ªç¯ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”æ­¤ `this#isWorkerContext()` å°†è¿”å› `false`ã€‚å‚è§: [è¿è¡Œé˜»å¡ä»£ç ](#Running_blocking_code)

  
æ£€ç´¢åˆ°ä¸Šä¸‹æ–‡å¯¹è±¡å,æ‚¨å¯ä»¥åœ¨æ­¤ä¸Šä¸‹æ–‡ä¸­å¼‚æ­¥è¿è¡Œä»£ç . æ¢å¥è¯è¯´,æ‚¨æäº¤çš„ä»»åŠ¡æœ€ç»ˆå°†åœ¨ç›¸åŒçš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œ(æœ‰å¯èƒ½ä¼šåœ¨ç¨åçš„æ—¶é—´é‡Œ):

```java
vertx.getOrCreateContext().runOnContext( (v) -> {
  System.out.println("This will be executed asynchronously in the same context");
});
```

å½“å¤šä¸ªhandlersåœ¨åŒä¸€ä¸Šä¸‹æ–‡ä¸­è¿è¡Œæ—¶,å®ƒä»¬å¯èƒ½å¸Œæœ›å…±äº«æ•°æ®. ä¸Šä¸‹æ–‡å¯¹è±¡æä¾›äº†å­˜å‚¨å’Œæ£€ç´¢åœ¨ä¸Šä¸‹æ–‡ä¸­å…±äº«çš„æ•°æ®çš„æ–¹æ³•. ä¾‹å¦‚,å®ƒå…è®¸æ‚¨å°†æ•°æ®ä¼ é€’ç»™ä½¿ç”¨ `runOnContext` è¿è¡Œçš„æŸäº›æ“ä½œ:

```java
final Context context = vertx.getOrCreateContext();
context.put("data", "hello");
context.runOnContext((v) -> {
  String hello = context.get("data");
});
```

ä¸Šä¸‹æ–‡å¯¹è±¡è¿˜å…è®¸æ‚¨ä½¿ç”¨ `config` æ–¹æ³•è®¿é—® Verticle é…ç½®. æŸ¥çœ‹[å°†é…ç½®ä¼ é€’ç»™verticle](#passing_configuration_to_a_verticle) éƒ¨åˆ†ä»¥äº†è§£æœ‰å…³æ­¤é…ç½®çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯.

### æ‰§è¡Œå®šæœŸå’Œå»¶è¿Ÿçš„æ“ä½œ

åœ¨ Vert.x ä¸­,æƒ³è¦åœ¨å»¶è¿Ÿåæˆ–å®šæœŸæ‰§è¡Œæ“ä½œæ˜¯å¾ˆå¸¸è§çš„.

åœ¨æ ‡å‡† Verticle ä¸­,ä½ ä¸èƒ½ä»…ä»…è®©çº¿ç¨‹ä¼‘çœ æ¥å¼•å…¥å»¶è¿Ÿ,å› ä¸ºè¿™ä¼šé˜»å¡äº‹ä»¶å¾ªç¯çº¿ç¨‹.

ç›¸å,æ‚¨ä½¿ç”¨ Vert.x è®¡æ—¶å™¨. è®¡æ—¶å™¨å¯ä»¥æ˜¯**ä¸€æ¬¡æ€§**æˆ–**å‘¨æœŸæ€§**. ä¸¤è€…æˆ‘ä»¬éƒ½è®¨è®º

#### ä¸€æ¬¡æ€§è®¡æ—¶å™¨

å•æ¬¡è®¡æ—¶å™¨åœ¨ä¸€å®šå»¶è¿Ÿåè°ƒç”¨äº‹ä»¶å¤„ç†å™¨,ä»¥æ¯«ç§’ä¸ºå•ä½.

ä¸€æ—¦ä½ ä½¿ç”¨ä¼ å…¥å»¶è¿Ÿå’Œå¤„ç†å™¨çš„`setTimer`æ–¹æ³•æ¥è®¾ç½®å®šæ—¶å™¨è§¦å‘

```java
long timerID = vertx.setTimer(1000, id -> {
  System.out.println("And one second later this is printed");
});

System.out.println("First this is printed");
```

è¿”å›å€¼æ˜¯ä¸€ä¸ªå”¯ä¸€çš„è®¡æ—¶å™¨ ID,ç¨åå¯ç”¨äºå–æ¶ˆè®¡æ—¶å™¨. å¤„ç†å™¨è¿˜ä¼ é€’äº†è®¡æ—¶å™¨ ID.

#### å‘¨æœŸæ€§è®¡æ—¶å™¨

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ `setPeriodic` è®¾ç½®ä¸€ä¸ªå®šæœŸè§¦å‘çš„è®¡æ—¶å™¨.

å°†æœ‰ä¸€ä¸ªä¸å‘¨æœŸç›¸ç­‰çš„åˆå§‹å»¶è¿Ÿ.

`setPeriodic` çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå”¯ä¸€çš„è®¡æ—¶å™¨ `ID(long)`. å¦‚æœéœ€è¦å–æ¶ˆè®¡æ—¶å™¨,è¿™å¯ä»¥åœ¨ä»¥åä½¿ç”¨.

ä¼ é€’ç»™å®šæ—¶å™¨äº‹ä»¶å¤„ç†å™¨çš„å‚æ•°ä¹Ÿæ˜¯å”¯ä¸€çš„å®šæ—¶å™¨ id:

è¯·è®°ä½,è®¡æ—¶å™¨å°†å®šæœŸè§¦å‘. å¦‚æœæ‚¨çš„å‘¨æœŸæ€§å¤„ç†éœ€è¦å¾ˆé•¿æ—¶é—´æ‰èƒ½å®Œæˆ,æ‚¨çš„è®¡æ—¶å™¨äº‹ä»¶å¯èƒ½ä¼šè¿ç»­è¿è¡Œ,ç”šè‡³æ›´ç³Ÿ:å †ç§¯.

åœ¨è¿™ç§æƒ…å†µä¸‹,æ‚¨åº”è¯¥è€ƒè™‘æ”¹ç”¨ `setTimer`. ä»»åŠ¡å®Œæˆå,æ‚¨å¯ä»¥å†è®¾ç½®ä¸‹ä¸€ä¸ªè®¡æ—¶å™¨.

```java
long timerID = vertx.setPeriodic(1000, id -> {
  System.out.println("And every second this is printed");
});

System.out.println("First this is printed");
```

#### å–æ¶ˆè®¡æ—¶å™¨

è¦å–æ¶ˆå®šæœŸè®¡æ—¶å™¨,è¯·è°ƒç”¨æŒ‡å®šè®¡æ—¶å™¨ id çš„`cancelTimer`æ–¹æ³•. ä¾‹å¦‚:

```java
vertx.cancelTimer(timerID);
```

#### Verticleä¸­çš„è‡ªåŠ¨æ¸…ç†

å¦‚æœæ‚¨ä» Verticle å†…éƒ¨åˆ›å»ºè®¡æ—¶å™¨,è¿™äº›è®¡æ—¶å™¨å°†åœ¨ Verticle å–æ¶ˆéƒ¨ç½²æ—¶è‡ªåŠ¨å…³é—­.

<a name="worker_verticles"></a>
### Verticle å·¥ä½œæ± 

Verticle ä½¿ç”¨ Vert.x å·¥ä½œæ± æ¥æ‰§è¡Œé˜»å¡æ“ä½œ,å³ `executeBlocking` æˆ– å·¥ä½œVerticle.

å¯ä»¥åœ¨éƒ¨ç½²é€‰é¡¹ä¸­æŒ‡å®šä¸åŒçš„å·¥ä½œæ± :

```java
vertx.deployVerticle("the-verticle", new DeploymentOptions().setWorkerPoolName("the-specific-pool"));
```

<a name="event_bus"></a>

## The Event Bus(äº‹ä»¶æ€»çº¿)

`event bus` æ˜¯ Vert.x çš„ **ç¥ç»ç³»ç»Ÿ** .

æ¯ä¸ª Vert.x å®ä¾‹éƒ½æœ‰ä¸€ä¸ªäº‹ä»¶æ€»çº¿å®ä¾‹,å®ƒæ˜¯ä½¿ç”¨ `eventBus` æ–¹æ³•è·å¾—çš„.

äº‹ä»¶æ€»çº¿å…è®¸åº”ç”¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†ç›¸äº’é€šä¿¡,æ— è®ºå®ƒä»¬æ˜¯ç”¨ä»€ä¹ˆè¯­è¨€ç¼–å†™çš„,ä¹Ÿä¸ç®¡å®ƒä»¬æ˜¯åœ¨åŒä¸€ä¸ª Vert.x å®ä¾‹ä¸­,è¿˜æ˜¯åœ¨ä¸åŒçš„ Vert.x å®ä¾‹ä¸­.

å®ƒç”šè‡³å¯ä»¥æ¡¥æ¥ä»¥å…è®¸åœ¨æµè§ˆå™¨ä¸­è¿è¡Œçš„JavaScriptå®¢æˆ·ç«¯åœ¨åŒä¸€äº‹ä»¶æ€»çº¿ä¸Šè¿›è¡Œé€šä¿¡.

äº‹ä»¶æ€»çº¿å½¢æˆäº†ä¸€ä¸ªè·¨è¶Šå¤šä¸ªæœåŠ¡å™¨èŠ‚ç‚¹å’Œå¤šä¸ªæµè§ˆå™¨çš„åˆ†å¸ƒå¼peer-to-peer(ç«¯åˆ°ç«¯)çš„æ¶ˆæ¯ä¼ é€’ç³»ç»Ÿ.

äº‹ä»¶æ€»çº¿æ”¯æŒ`å‘å¸ƒ/è®¢é˜…`, `ç‚¹å¯¹ç‚¹` å’Œ `è¯·æ±‚-å“åº”` æ¶ˆæ¯ä¼ é€’.

äº‹ä»¶æ€»çº¿ API éå¸¸ç®€å•. å®ƒä¸»è¦æ¶‰åŠæ³¨å†Œå¤„ç†å™¨,å–æ¶ˆæ³¨å†Œå¤„ç†å™¨ä»¥åŠå‘é€å’Œå‘å¸ƒæ¶ˆæ¯.

é¦–å…ˆæ˜¯ä¸€äº›ç†è®º:

### ç†è®º

#### Addressing(å¯»å€)

æ¶ˆæ¯é€šè¿‡äº‹ä»¶æ€»çº¿å‘é€åˆ°çš„ç›®çš„ **åœ°å€**.

Vert.x ä¸åšä»»ä½•èŠ±å“¨çš„å¯»å€æ–¹æ¡ˆ. åœ¨ Vert.x ä¸­,åœ°å€åªæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸². ä»»ä½•å­—ç¬¦ä¸²éƒ½æ˜¯æœ‰æ•ˆçš„. ç„¶è€Œ,ä½¿ç”¨æŸç§æ–¹æ¡ˆæ˜¯æ˜æ™ºçš„,*ä¾‹å¦‚*ä½¿ç”¨å¥ç‚¹æ¥åˆ’åˆ†å‘½åç©ºé—´.

æœ‰æ•ˆåœ°å€çš„ä¸€äº›ç¤ºä¾‹åŒ…æ‹¬ `europe.news.feed1`,`acme.games.pacman`,`sausages` å’Œ `X`.

#### Handlers(å¤„ç†å™¨)

æ¶ˆæ¯ç”±å¤„ç†å™¨æ¥æ”¶. ä½ åœ¨ä¸€ä¸ªåœ°å€ä¸Šæ³¨å†Œä¸€ä¸ªå¤„ç†å™¨.

è®¸å¤šä¸åŒçš„å¤„ç†å™¨å¯ä»¥åœ¨åŒä¸€åœ°å€ä¸Šæ³¨å†Œ.

å•ä¸ªå¤„ç†å™¨å¯ä»¥åœ¨è®¸å¤šä¸åŒçš„åœ°å€ä¸Šæ³¨å†Œ.

#### å‘å¸ƒ/è®¢é˜…æ¶ˆæ¯

äº‹ä»¶æ€»çº¿æ”¯æŒ **å‘å¸ƒ** æ¶ˆæ¯.

æ¶ˆæ¯è¢«å‘å¸ƒåˆ°ä¸€ä¸ªåœ°å€. å‘å¸ƒæ„å‘³ç€å°†æ¶ˆæ¯ä¼ é€’ç»™åœ¨è¯¥åœ°å€æ³¨å†Œçš„æ‰€æœ‰å¤„ç†å™¨.

è¿™æ˜¯ç†Ÿæ‚‰çš„ **publish/subscribe** æ¶ˆæ¯ä¼ é€’æ¨¡å¼.

#### ç‚¹å¯¹ç‚¹ å’Œ è¯·æ±‚-å“åº” æ¶ˆæ¯

äº‹ä»¶æ€»çº¿è¿˜æ”¯æŒ **point-to-point** æ¶ˆæ¯ä¼ é€’.

æ¶ˆæ¯è¢«å‘é€åˆ°ä¸€ä¸ªåœ°å€. ç„¶å Vert.x ä¼šå°†å®ƒä»¬è·¯ç”±åˆ°åœ¨è¯¥åœ°å€æ³¨å†Œçš„å¤„ç†å™¨ä¹‹ä¸€.

å¦‚æœåœ¨è¯¥åœ°å€æ³¨å†Œäº†å¤šä¸ªå¤„ç†å™¨,åˆ™å°†ä½¿ç”¨éä¸¥æ ¼çš„å¾ªç¯ç®—æ³• **é€‰æ‹©ä¸€ä¸ª** .

ä½¿ç”¨ç‚¹å¯¹ç‚¹æ¶ˆæ¯ä¼ é€’æ—¶,å¯ä»¥åœ¨å‘é€æ¶ˆæ¯æ—¶æŒ‡å®šå¯é€‰çš„å›å¤å¤„ç†å™¨.

å½“æ¶ˆæ¯è¢«æ¥æ”¶æ–¹æ¥æ”¶å¹¶å¾—åˆ°å¤„ç†å,æ¥æ”¶æ–¹å¯ä»¥é€‰æ‹©æ˜¯å¦å›å¤è¯¥æ¶ˆæ¯.å¦‚æœå®ƒä»¬è¿™æ ·åš,å°†è°ƒç”¨å›å¤å¤„ç†å™¨.

å½“å‘é€æ–¹æ”¶åˆ°å›å¤æ—¶,ä¹Ÿå¯ä»¥å¯¹å…¶è¿›è¡Œå›å¤.è¿™å¯ä»¥æ— é™é‡å¤,å¹¶å…è®¸åœ¨ä¸¤ä¸ªä¸åŒçš„verticlesä¹‹é—´å»ºç«‹å¯¹è¯.

è¿™æ˜¯ä¸€ç§å¸¸è§çš„æ¶ˆæ¯ä¼ é€’æ¨¡å¼,ç§°ä¸º **request-response** æ¨¡å¼.

#### Best-effort delivery(å°½æœ€å¤§åŠªåŠ›äº¤ä»˜)

Vert.x å°½æœ€å¤§åŠªåŠ›ä¼ é€’æ¶ˆæ¯,ä¸ä¼šæœ‰æ„è¯†åœ°ä¸¢å¼ƒå®ƒä»¬. è¿™ç§°ä¸º **best-effort** äº¤ä»˜.

ä½†æ˜¯,å¦‚æœäº‹ä»¶æ€»çº¿çš„å…¨éƒ¨æˆ–éƒ¨åˆ†å‘ç”Ÿæ•…éšœ,åˆ™æ¶ˆæ¯å¯èƒ½ä¼šä¸¢å¤±.

å¦‚æœåº”ç”¨ç¨‹åºå…³å¿ƒä¸¢å¤±çš„æ¶ˆæ¯,åˆ™åº”è¯¥å°†å¤„ç†å™¨ç¼–å†™ä¸ºå¹‚ç­‰çš„,å¹¶å°†å‘é€ç¨‹åºç¼–å†™ä¸ºåœ¨æ¢å¤åé‡è¯•.

#### æ¶ˆæ¯ç±»å‹

å¼€ç®±å³ç”¨çš„ Vert.x å…è®¸ä»»ä½• åŸå§‹/ç®€å•ç±»å‹,å­—ç¬¦ä¸² æˆ– `buffers`ä½œä¸ºæ¶ˆæ¯å‘é€.

ä½†æ˜¯,åœ¨ Vert.x ä¸­,å°†æ¶ˆæ¯å‘é€ä¸º [JSON](https://json.org/) æ˜¯ä¸€ç§æƒ¯ä¾‹

JSON åœ¨ Vert.x æ”¯æŒçš„æ‰€æœ‰è¯­è¨€ä¸­éƒ½éå¸¸å®¹æ˜“åˆ›å»º,è¯»å–å’Œè§£æ,å› æ­¤å®ƒå·²æˆä¸º Vert.x çš„ä¸€ç§*é€šç”¨è¯­*.

ä½†æ˜¯,å¦‚æœæ‚¨ä¸æƒ³ä½¿ç”¨ JSON,åˆ™ä¸å¿…å¼ºåˆ¶ä½¿ç”¨.

äº‹ä»¶æ€»çº¿éå¸¸çµæ´»,è¿˜æ”¯æŒé€šè¿‡äº‹ä»¶æ€»çº¿å‘é€ä»»æ„å¯¹è±¡. æ‚¨å¯ä»¥é€šè¿‡ä¸ºè¦å‘é€çš„å¯¹è±¡å®šä¹‰"ç¼–è§£ç å™¨"æ¥åšåˆ°è¿™ä¸€ç‚¹.

### äº‹ä»¶æ€»çº¿API

è®©æˆ‘ä»¬è¿›å…¥äº‹ä»¶æ€»çº¿API.

#### è·å–äº‹ä»¶æ€»çº¿

æ‚¨å°†è·å¾—å¯¹äº‹ä»¶æ€»çº¿çš„å¼•ç”¨,å¦‚ä¸‹æ‰€ç¤º:

```java
EventBus eb = vertx.eventBus();
```

æ¯ä¸ª Vert.x å®ä¾‹éƒ½æœ‰ä¸€ä¸ªäº‹ä»¶æ€»çº¿å®ä¾‹.

#### æ³¨å†Œå¤„ç†å™¨

æ³¨å†Œå¤„ç†å™¨çš„æœ€ç®€å•æ–¹æ³•æ˜¯ä½¿ç”¨`consumer`. è¿™æ˜¯ä¸€ä¸ªä¾‹å­:

```java
EventBus eb = vertx.eventBus();

eb.consumer("news.uk.sport", message -> {
  System.out.println("I have received a message: " + message.body());
});
```

å½“æ¶ˆæ¯åˆ°è¾¾æ‚¨çš„å¤„ç†å™¨æ—¶,æ‚¨çš„å¤„ç†å™¨å°†è¢«è°ƒç”¨,å¹¶ä¼ å…¥"æ¶ˆæ¯".

è°ƒç”¨ `consumer()` è¿”å›çš„å¯¹è±¡æ˜¯ `MessageConsumer` çš„ä¸€ä¸ªå®ä¾‹.

è¯¥å¯¹è±¡éšåå¯ç”¨äºå–æ¶ˆæ³¨å†Œå¤„ç†å™¨,æˆ–å°†å¤„ç†å™¨ç”¨ä½œæµ.

æˆ–è€…,æ‚¨å¯ä»¥ä½¿ç”¨ `consumer` è¿”å›æ²¡æœ‰è®¾ç½®å¤„ç†å™¨çš„ `MessageConsumer`,ç„¶ååœ¨å…¶ä¸Šè®¾ç½®å¤„ç†å™¨. ä¾‹å¦‚:

```java
EventBus eb = vertx.eventBus();

MessageConsumer<String> consumer = eb.consumer("news.uk.sport");
consumer.handler(message -> {
  System.out.println("I have received a message: " + message.body());
});
```

åœ¨é›†ç¾¤äº‹ä»¶æ€»çº¿ä¸Šæ³¨å†Œå¤„ç†å™¨æ—¶,æ³¨å†Œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´æ‰èƒ½åˆ°è¾¾é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹.

å¦‚æœæ‚¨æƒ³åœ¨å®Œæˆæ—¶æ”¶åˆ°é€šçŸ¥,æ‚¨å¯ä»¥åœ¨ MessageConsumer å¯¹è±¡ä¸Šæ³¨å†Œä¸€ä¸ª"å®Œæˆå¤„ç†å™¨".

```java
consumer.completionHandler(res -> {
  if (res.succeeded()) {
    System.out.println("The handler registration has reached all nodes");
  } else {
    System.out.println("Registration failed!");
  }
});
```

#### å–æ¶ˆæ³¨å†Œå¤„ç†å™¨

è¦å–æ¶ˆæ³¨å†Œå¤„ç†å™¨,è¯·è°ƒç”¨ `unregister`.

å¦‚æœæ‚¨åœ¨é›†ç¾¤äº‹ä»¶æ€»çº¿ä¸Š,åˆ™å–æ¶ˆæ³¨å†Œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´æ‰èƒ½åœ¨èŠ‚ç‚¹é—´ä¼ æ’­. å¦‚æœæ‚¨æƒ³åœ¨å®Œæˆæ—¶æ”¶åˆ°é€šçŸ¥,è¯·ä½¿ç”¨"`unregister`.

```java
consumer.unregister(res -> {
  if (res.succeeded()) {
    System.out.println("The handler un-registration has reached all nodes");
  } else {
    System.out.println("Un-registration failed!");
  }
});
```

#### å‘å¸ƒæ¶ˆæ¯

å‘å¸ƒæ¶ˆæ¯å¾ˆç®€å•. åªéœ€ä½¿ç”¨ `publish` æŒ‡å®šå°†å…¶å‘å¸ƒåˆ°çš„åœ°å€.

```java
eventBus.publish("news.uk.sport", "Yay! Someone kicked a ball");
```

ç„¶å,è¯¥æ¶ˆæ¯å°†è¢«ä¼ é€’ç»™é’ˆå¯¹åœ°å€"news.uk.sport" æ³¨å†Œçš„**æ‰€æœ‰**å¤„ç†å™¨.

#### å‘é€æ¶ˆæ¯

å‘é€æ¶ˆæ¯å°†å¯¼è‡´åªæœ‰ä¸€ä¸ªåœ¨æ¥æ”¶æ¶ˆæ¯çš„åœ°å€æ³¨å†Œçš„å¤„ç†å™¨æ¥æ”¶åˆ°. è¿™æ˜¯ç‚¹å¯¹ç‚¹æ¶ˆæ¯ä¼ é€’æ¨¡å¼. å¤„ç†å™¨ä»¥éä¸¥æ ¼çš„å¾ªç¯æ–¹å¼é€‰æ‹©.

æ‚¨å¯ä»¥ä½¿ç”¨ `send` å‘é€æ¶ˆæ¯.

```java
eventBus.send("news.uk.sport", "Yay! Someone kicked a ball");
```

#### åœ¨æ¶ˆæ¯ä¸Šè®¾ç½®æ ‡é¢˜

é€šè¿‡äº‹ä»¶æ€»çº¿å‘é€çš„æ¶ˆæ¯ä¹Ÿå¯ä»¥åŒ…å«æ ‡å¤´. è¿™å¯ä»¥é€šè¿‡åœ¨å‘é€æˆ–å‘å¸ƒæ—¶æä¾› `DeliveryOptions` æ¥æŒ‡å®š:

```java
DeliveryOptions options = new DeliveryOptions();
options.addHeader("some-header", "some-value");
eventBus.send("news.uk.sport", "Yay! Someone kicked a ball", options);
```

#### æ¶ˆæ¯é¡ºåº

Vert.x å°†æŒ‰ç…§ä»ä»»ä½•ç‰¹å®šå‘é€è€…å‘é€æ¶ˆæ¯çš„ç›¸åŒé¡ºåºå°†æ¶ˆæ¯ä¼ é€’ç»™ä»»ä½•ç‰¹å®šå¤„ç†å™¨.

#### æ¶ˆæ¯å¯¹è±¡

æ‚¨åœ¨æ¶ˆæ¯å¤„ç†å™¨ä¸­æ”¶åˆ°çš„å¯¹è±¡æ˜¯`Message`.

æ¶ˆæ¯çš„`body` å¯¹åº”äºå‘é€æˆ–å‘å¸ƒçš„å¯¹è±¡.

æ¶ˆæ¯çš„æ ‡å¤´å¯é€šè¿‡ `headers` è·å¾—.

#### ç¡®è®¤æ¶ˆæ¯/å‘é€å›å¤

å½“ä½¿ç”¨ `send` æ—¶,äº‹ä»¶æ€»çº¿ä¼šå°è¯•å°†æ¶ˆæ¯ä¼ é€’ç»™åœ¨äº‹ä»¶æ€»çº¿ä¸Šæ³¨å†Œçš„ `MessageConsumer`.

åœ¨æŸäº›æƒ…å†µä¸‹,å‘é€æ–¹çŸ¥é“ç”¨æˆ·ä½•æ—¶æ”¶åˆ°æ¶ˆæ¯å¹¶ä½¿ç”¨**è¯·æ±‚-å“åº”**æ¨¡å¼"å¤„ç†"æ¶ˆæ¯æ˜¯æœ‰ç”¨çš„.

è¦ç¡®è®¤æ¶ˆæ¯å·²è¢«å¤„ç†,æ¶ˆè´¹è€…å¯ä»¥é€šè¿‡è°ƒç”¨ `reply` æ¥å›å¤æ¶ˆæ¯.

å½“å‘ç”Ÿè¿™ç§æƒ…å†µæ—¶,å®ƒå°†å¯¼è‡´å°†åº”ç­”å‘é€å›å‘é€æ–¹,å¹¶ä½¿ç”¨åº”ç­”è°ƒç”¨åº”ç­”å¤„ç†å™¨.

ä¸€ä¸ªä¾‹å­å¯ä»¥æ¸…æ¥šåœ°è¯´æ˜è¿™ä¸€ç‚¹:

å‘ä»¶äºº:

```java
eventBus.request("news.uk.sport", "Yay! Someone kicked a ball across a patch of grass", ar -> {
  if (ar.succeeded()) {
    System.out.println("Received reply: " + ar.result().body());
  }
});
```

æ”¶ä»¶äºº:

```java
MessageConsumer<String> consumer = eventBus.consumer("news.uk.sport");
consumer.handler(message -> {
  System.out.println("I have received a message: " + message.body());
  message.reply("how interesting!");
});
```

`io.vertx.core.eventbus.Message.reply()` å¯ä»¥åŒ…å«ä¸€ä¸ªæœ‰ç”¨ä¿¡æ¯çš„æ¶ˆæ¯ä½“.

"processing(å¤„ç†)"çš„å®é™…å«ä¹‰æ˜¯åº”ç”¨ç¨‹åºå®šä¹‰çš„,å¹¶ä¸”å®Œå…¨å–å†³äºæ¶ˆæ¯æ¶ˆè´¹è€…æ‰€åšçš„äº‹æƒ…,è€Œä¸æ˜¯ Vert.x äº‹ä»¶æ€»çº¿æœ¬èº«çŸ¥é“æˆ–å…³å¿ƒçš„äº‹æƒ….

ä¸€äº›ä¾‹å­:

- ä¸€ä¸ªç®€å•çš„æ¶ˆæ¯æ¶ˆè´¹è€…å®ç°äº†ä¸€ä¸ªè¿”å›å½“å¤©æ—¶é—´çš„æœåŠ¡,å®ƒå°†åœ¨åº”ç­”ä¸»ä½“ä¸­ä½¿ç”¨ä¸€ä¸ªåŒ…å«å½“å¤©æ—¶é—´çš„æ¶ˆæ¯è¿›è¡Œç¡®è®¤
- ä¸€ä¸ªå®ç°äº†æŒä¹…é˜Ÿåˆ—çš„æ¶ˆæ¯æ¶ˆè´¹è€…,å¦‚æœæ¶ˆæ¯æˆåŠŸåœ°ä¿å­˜åœ¨å­˜å‚¨ä¸­,å¯ä»¥ç”¨`true`æ¥ç¡®è®¤,å¦‚æœæ²¡æœ‰,å¯ä»¥ç”¨`false`æ¥ç¡®è®¤.
- å¤„ç†è®¢å•çš„æ¶ˆæ¯æ¶ˆè´¹è€…å¯èƒ½ä¼šåœ¨è®¢å•è¢«æˆåŠŸå¤„ç†åä»¥`true`ç¡®è®¤è®¢å•,ä»¥ä¾¿å°†å…¶ä»æ•°æ®åº“ä¸­åˆ é™¤

#### å¸¦è¶…æ—¶çš„å‘é€

å½“å‘é€å¸¦æœ‰å›å¤å¤„ç†å™¨çš„æ¶ˆæ¯æ—¶,æ‚¨å¯ä»¥åœ¨ `DeliveryOptions` ä¸­æŒ‡å®šè¶…æ—¶.

å¦‚æœåœ¨è¯¥æ—¶é—´å†…æœªæ”¶åˆ°å›å¤,åˆ™å°†è°ƒç”¨å›å¤å¤„ç†å™¨å¹¶å¤±è´¥.

é»˜è®¤è¶…æ—¶ä¸º 30 ç§’.

#### å‘é€å¤±è´¥

æ¶ˆæ¯å‘é€å¯èƒ½å› å…¶ä»–åŸå› è€Œå¤±è´¥,åŒ…æ‹¬:

- æ²¡æœ‰å¯ç”¨äºå°†æ¶ˆæ¯å‘é€åˆ°çš„å¤„ç†å™¨
- æ”¶ä»¶äººä½¿ç”¨`fail`æ˜¾å¼åœ°ä½¿æ¶ˆæ¯å¤±è´¥

åœ¨æ‰€æœ‰æƒ…å†µä¸‹,éƒ½ä¼šä»¥ç‰¹å®šçš„å¤±è´¥è°ƒç”¨å›å¤å¤„ç†å™¨.

#### æ¶ˆæ¯ç¼–è§£ç å™¨

å¦‚æœæ‚¨ä¸ºå®ƒå®šä¹‰å’Œæ³¨å†Œä¸€ä¸ª"æ¶ˆæ¯ç¼–è§£ç å™¨",æ‚¨å¯ä»¥é€šè¿‡äº‹ä»¶æ€»çº¿å‘é€æ‚¨å–œæ¬¢çš„ä»»ä½•å¯¹è±¡.

æ¶ˆæ¯ç¼–è§£ç å™¨æœ‰ä¸€ä¸ªåç§°,æ‚¨åœ¨å‘é€æˆ–å‘å¸ƒæ¶ˆæ¯æ—¶åœ¨ `DeliveryOptions` ä¸­æŒ‡å®šè¯¥åç§°:

```java
eventBus.registerCodec(myCodec);

DeliveryOptions options = new DeliveryOptions().setCodecName(myCodec.name());

eventBus.send("orders", new MyPOJO(), options);
```

å¦‚æœæ‚¨æ€»æ˜¯å¸Œæœ›å°†ç›¸åŒçš„ç¼–è§£ç å™¨ç”¨äºç‰¹å®šç±»å‹,é‚£ä¹ˆæ‚¨å¯ä»¥ä¸ºå…¶æ³¨å†Œä¸€ä¸ªé»˜è®¤ç¼–è§£ç å™¨,é‚£ä¹ˆæ‚¨ä¸å¿…åœ¨æ¯æ¬¡å‘é€æ—¶åœ¨äº¤ä»˜é€‰é¡¹ä¸­æŒ‡å®šç¼–è§£ç å™¨:

```java
eventBus.registerDefaultCodec(MyPOJO.class, myCodec);

eventBus.send("orders", new MyPOJO());
```

æ‚¨å¯ä»¥ä½¿ç”¨ `unregisterCodec` å–æ¶ˆæ³¨å†Œæ¶ˆæ¯ç¼–è§£ç å™¨.

æ¶ˆæ¯ç¼–è§£ç å™¨å¹¶ä¸æ€»æ˜¯å¿…é¡»ä»¥ç›¸åŒçš„ç±»å‹è¿›è¡Œç¼–ç å’Œè§£ç . ä¾‹å¦‚,æ‚¨å¯ä»¥ç¼–å†™å…è®¸å‘é€ MyPOJO ç±»çš„ç¼–è§£ç å™¨,ä½†æ˜¯å½“è¯¥æ¶ˆæ¯å‘é€åˆ°å¤„ç†å™¨æ—¶,å®ƒä¼šä½œä¸º MyOtherPOJO ç±»åˆ°è¾¾.

#### é›†ç¾¤çš„äº‹ä»¶æ€»çº¿

äº‹ä»¶æ€»çº¿ä¸ä»…ä»…å­˜åœ¨äºå•ä¸ª Vert.x å®ä¾‹ä¸­. é€šè¿‡åœ¨æ‚¨çš„ç½‘ç»œä¸Šå°†ä¸åŒçš„ Vert.x å®ä¾‹èšé›†åœ¨ä¸€èµ·,å®ƒä»¬å¯ä»¥å½¢æˆä¸€ä¸ªå•ä¸€çš„åˆ†å¸ƒå¼äº‹ä»¶æ€»çº¿.

#### ä»¥ç¼–ç¨‹æ–¹å¼çš„é›†ç¾¤

å¦‚æœæ‚¨ä»¥ç¼–ç¨‹æ–¹å¼åˆ›å»º Vert.x å®ä¾‹,æ‚¨å¯ä»¥é€šè¿‡å°† Vert.x å®ä¾‹é…ç½®ä¸ºé›†ç¾¤æ¥è·å¾—é›†ç¾¤äº‹ä»¶æ€»çº¿;

```java
VertxOptions options = new VertxOptions();
Vertx.clusteredVertx(options, res -> {
  if (res.succeeded()) {
    Vertx vertx = res.result();
    EventBus eventBus = vertx.eventBus();
    System.out.println("We now have a clustered event bus: " + eventBus);
  } else {
    System.out.println("Failed: " + res.cause());
  }
});
```

æ‚¨è¿˜åº”è¯¥ç¡®ä¿åœ¨æ‚¨çš„ç±»è·¯å¾„ä¸Šæœ‰ä¸€ä¸ª`ClusterManager`å®ç°,ä¾‹å¦‚ Hazelcast é›†ç¾¤ç®¡ç†å™¨.

#### åœ¨å‘½ä»¤è¡Œä¸Šè¿›è¡Œé›†ç¾¤

å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­é›†ç¾¤è¿è¡ŒVert.x

```bash
vertx run my-verticle.js -cluster
```

### è‡ªåŠ¨æ¸…ç†verticles

å¦‚æœæ‚¨ä» verticles å†…éƒ¨æ³¨å†Œäº‹ä»¶æ€»çº¿å¤„ç†å™¨,è¿™äº›å¤„ç†å™¨å°†åœ¨ verticle å–æ¶ˆéƒ¨ç½²æ—¶è‡ªåŠ¨å–æ¶ˆæ³¨å†Œ.

## é…ç½®äº‹ä»¶æ€»çº¿

å¯ä»¥é…ç½®äº‹ä»¶æ€»çº¿. å½“äº‹ä»¶æ€»çº¿è¢«é›†ç¾¤æ—¶,å®ƒç‰¹åˆ«æœ‰ç”¨. åœ¨åº•å±‚,äº‹ä»¶æ€»çº¿ä½¿ç”¨ TCP è¿æ¥æ¥å‘é€å’Œæ¥æ”¶æ¶ˆæ¯,å› æ­¤`EventBusOptions` è®©æ‚¨å¯ä»¥é…ç½®è¿™äº› TCP è¿æ¥çš„æ‰€æœ‰æ–¹é¢. ç”±äºäº‹ä»¶æ€»çº¿å……å½“æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯,å› æ­¤é…ç½®æ¥è¿‘äº `NetClientOptions` å’Œ `NetServerOptions`.

```java
VertxOptions options = new VertxOptions()
    .setEventBusOptions(new EventBusOptions()
        .setSsl(true)
        .setKeyStoreOptions(new JksOptions().setPath("keystore.jks").setPassword("wibble"))
        .setTrustStoreOptions(new JksOptions().setPath("keystore.jks").setPassword("wibble"))
        .setClientAuth(ClientAuth.REQUIRED)
    );

Vertx.clusteredVertx(options, res -> {
  if (res.succeeded()) {
    Vertx vertx = res.result();
    EventBus eventBus = vertx.eventBus();
    System.out.println("We now have a clustered event bus: " + eventBus);
  } else {
    System.out.println("Failed: " + res.cause());
  }
});
```

å‰é¢çš„ä»£ç ç‰‡æ®µæè¿°äº†å¦‚ä½•å°† SSL è¿æ¥ç”¨äºäº‹ä»¶æ€»çº¿,è€Œä¸æ˜¯æ™®é€šçš„ TCP è¿æ¥.

> **â˜¢è­¦å‘Š:** è¦åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å¼ºåˆ¶æ‰§è¡Œå®‰å…¨æ€§,æ‚¨**å¿…é¡»**é…ç½®é›†ç¾¤ç®¡ç†å™¨ä»¥ä½¿ç”¨åŠ å¯†æˆ–å¼ºåˆ¶æ‰§è¡Œå®‰å…¨æ€§. æœ‰å…³è¯¦ç»†ä¿¡æ¯,è¯·å‚é˜…é›†ç¾¤ç®¡ç†å™¨çš„æ–‡æ¡£.

äº‹ä»¶æ€»çº¿é…ç½®éœ€è¦åœ¨æ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹ä¸­ä¿æŒä¸€è‡´.

`EventBusOptions`è¿˜å…è®¸ä½ æŒ‡å®šäº‹ä»¶æ€»çº¿æ˜¯å¦é›†ç¾¤,ç«¯å£å’Œä¸»æœº.

åœ¨å®¹å™¨ä¸­ä½¿ç”¨æ—¶,è¿˜å¯ä»¥é…ç½®å…¬å…±ä¸»æœºå’Œç«¯å£:

```java
VertxOptions options = new VertxOptions()
    .setEventBusOptions(new EventBusOptions()
        .setClusterPublicHost("whatever")
        .setClusterPublicPort(1234)
    );

Vertx.clusteredVertx(options, res -> {
  if (res.succeeded()) {
    Vertx vertx = res.result();
    EventBus eventBus = vertx.eventBus();
    System.out.println("We now have a clustered event bus: " + eventBus);
  } else {
    System.out.println("Failed: " + res.cause());
  }
});
```

## JSON

ä¸å…¶ä»–ä¸€äº›è¯­è¨€ä¸åŒ,Java æ²¡æœ‰å¯¹ [JSON](https://json.org/) ä¸€æµçš„æ”¯æŒ,å› æ­¤æˆ‘ä»¬æä¾›äº†ä¸¤ä¸ªç±»æ¥ä½¿æ‚¨åœ¨ Vert.x åº”ç”¨ç¨‹åºä¸­å¤„ç† JSON æ›´å®¹æ˜“ä¸€äº›.

### JSON å¯¹è±¡

`JsonObject` ç±»è¡¨ç¤º JSON å¯¹è±¡.

JSON å¯¹è±¡åŸºæœ¬ä¸Šåªæ˜¯ä¸€ä¸ªMap,å®ƒå…·æœ‰å­—ç¬¦ä¸²é”®,å€¼å¯ä»¥æ˜¯ JSON æ”¯æŒçš„ç±»å‹ä¹‹ä¸€(å­—ç¬¦ä¸²,æ•°å­—,å¸ƒå°”å€¼).

JSON å¯¹è±¡ä¹Ÿæ”¯æŒç©ºå€¼.

#### åˆ›å»ºJSONå¯¹è±¡

å¯ä»¥ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°åˆ›å»ºç©º JSON å¯¹è±¡.

æ‚¨å¯ä»¥ä»å­—ç¬¦ä¸² JSON è¡¨ç¤ºåˆ›å»º JSON å¯¹è±¡,å¦‚ä¸‹æ‰€ç¤º:

```java
String jsonString = "{\"foo\":\"bar\"}";
JsonObject object = new JsonObject(jsonString);
```

æ‚¨å¯ä»¥ä»Mapåˆ›å»º JSON å¯¹è±¡,å¦‚ä¸‹æ‰€ç¤º:

```java
Map<String, Object> map = new HashMap<>();
map.put("foo", "bar");
map.put("xyz", 3);
JsonObject object = new JsonObject(map);
```

#### å°†æ¡ç›®æ”¾å…¥JSONå¯¹è±¡

ä½¿ç”¨ `put` æ–¹æ³•å°†å€¼æ”¾å…¥ JSON å¯¹è±¡.

ç”±äºæµç•…çš„API,æ–¹æ³•è°ƒç”¨å¯ä»¥è¢«é“¾æ¥:

```java
JsonObject object = new JsonObject();
object.put("foo", "bar").put("num", 123).put("mybool", true);
```

#### ä»JSONå¯¹è±¡ä¸­è·å–å€¼

æ‚¨å¯ä»¥ä½¿ç”¨ `getXXX` æ–¹æ³•ä» JSON å¯¹è±¡è·å–å€¼,ä¾‹å¦‚:

```java
String val = jsonObject.getString("some-key");
int intVal = jsonObject.getInteger("some-other-key");
```

#### JSONå¯¹è±¡å’ŒJavaå¯¹è±¡ä¹‹é—´çš„æ˜ å°„

æ‚¨å¯ä»¥ä» Java å¯¹è±¡çš„å­—æ®µåˆ›å»º JSON å¯¹è±¡,å¦‚ä¸‹æ‰€ç¤º:

æ‚¨å¯ä»¥å®ä¾‹åŒ– Java å¯¹è±¡å¹¶ä» JSON å¯¹è±¡ä¸­å¡«å……å…¶å­—æ®µ,å¦‚ä¸‹æ‰€ç¤º:

```java
request.bodyHandler(buff -> {
  JsonObject jsonObject = buff.toJsonObject();
  User javaObject = jsonObject.mapTo(User.class);
});
```

è¯·æ³¨æ„,ä»¥ä¸Šä¸¤ä¸ªæ˜ å°„æ–¹å‘éƒ½ä½¿ç”¨ Jackson çš„ `ObjectMapper#convertValue()` æ¥æ‰§è¡Œæ˜ å°„. æœ‰å…³å­—æ®µå’Œæ„é€ å‡½æ•°å¯è§æ€§çš„å½±å“,è·¨å¯¹è±¡å¼•ç”¨çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è­¦å‘Šç­‰ä¿¡æ¯,è¯·å‚é˜… Jackson æ–‡æ¡£.

ç„¶è€Œ,åœ¨æœ€ç®€å•çš„æƒ…å†µä¸‹,å¦‚æœ Java ç±»çš„æ‰€æœ‰å­—æ®µéƒ½æ˜¯å…¬å…±çš„(æˆ–å…·æœ‰å…¬å…±çš„ getter/setter),å¹¶ä¸”å­˜åœ¨å…¬å…±é»˜è®¤æ„é€ å‡½æ•°(æˆ–æ²¡æœ‰å®šä¹‰çš„æ„é€ å‡½æ•°),åˆ™ `mapFrom` å’Œ `mapTo` éƒ½åº”è¯¥æˆåŠŸ.

åªè¦å¯¹è±¡å›¾æ˜¯æ— å¾ªç¯çš„,å¼•ç”¨çš„å¯¹è±¡å°†è¢«ä¼ é€’åœ°åºåˆ—åŒ–/ååºåˆ—åŒ–åˆ°åµŒå¥—çš„JSONå¯¹è±¡.

#### å°†JSONå¯¹è±¡ç¼–ç ä¸ºå­—ç¬¦ä¸²

æ‚¨ä½¿ç”¨ `encode` å°†å¯¹è±¡ç¼–ç ä¸ºå­—ç¬¦ä¸²å½¢å¼.

### JSON æ•°ç»„

`JsonArray` ç±»è¡¨ç¤º JSON æ•°ç»„.

JSON æ•°ç»„æ˜¯ä¸€ç³»åˆ—å€¼(å­—ç¬¦ä¸²,æ•°å­—,å¸ƒå°”å€¼).

JSON æ•°ç»„ä¹Ÿå¯ä»¥åŒ…å«ç©ºå€¼.

#### åˆ›å»º JSON æ•°ç»„

å¯ä»¥ä½¿ç”¨é»˜è®¤æ„é€ å‡½æ•°åˆ›å»ºç©ºçš„ JSON æ•°ç»„.

æ‚¨å¯ä»¥ä»å­—ç¬¦ä¸² JSON è¡¨ç¤ºåˆ›å»º JSON æ•°ç»„,å¦‚ä¸‹æ‰€ç¤º:

```java
String jsonString = "[\"foo\",\"bar\"]";
JsonArray array = new JsonArray(jsonString);
```

#### å°†æ¡ç›®æ·»åŠ åˆ° JSON æ•°ç»„ä¸­

æ‚¨å¯ä»¥ä½¿ç”¨ `add` æ–¹æ³•å°†æ¡ç›®æ·»åŠ åˆ° JSON æ•°ç»„.

```java
JsonArray array = new JsonArray();
array.add("foo").add(123).add(false);
```

#### ä» JSON æ•°ç»„ä¸­è·å–å€¼

æ‚¨å¯ä»¥ä½¿ç”¨ `getXXX` æ–¹æ³•ä» JSON æ•°ç»„ä¸­è·å–å€¼,ä¾‹å¦‚:

```java
String val = array.getString(0);
Integer intVal = array.getInteger(1);
Boolean boolVal = array.getBoolean(2);
```

#### å°† JSON æ•°ç»„ç¼–ç ä¸ºå­—ç¬¦ä¸²

æ‚¨ä½¿ç”¨ `encode` å°†æ•°ç»„ç¼–ç ä¸ºå­—ç¬¦ä¸²å½¢å¼.

#### åˆ›å»ºä»»æ„ JSON

åˆ›å»º JSON å¯¹è±¡å’Œæ•°ç»„å‡å®šæ‚¨ä½¿ç”¨çš„æ˜¯æœ‰æ•ˆçš„å­—ç¬¦ä¸²è¡¨ç¤º.

å½“æ‚¨ä¸ç¡®å®šå­—ç¬¦ä¸²çš„æœ‰æ•ˆæ€§æ—¶,æ‚¨åº”è¯¥ä½¿ç”¨ `Json.decodeValue`

```java
Object object = Json.decodeValue(arbitraryJson);
if (object instanceof JsonObject) {
  // That's a valid json object
} else if (object instanceof JsonArray) {
  // That's a valid json array
} else if (object instanceof String) {
  // That's valid string
} else {
  // etc...
}
```

## Json æŒ‡é’ˆ

Vert.x æä¾›äº† [æ¥è‡ª RFC6901 çš„ Json æŒ‡é’ˆ](https://tools.ietf.org/html/rfc6901) çš„å®ç°. æ‚¨å¯ä»¥å°†æŒ‡é’ˆç”¨äºæŸ¥è¯¢å’Œå†™å…¥. æ‚¨å¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²,URI æˆ–æ‰‹åŠ¨é™„åŠ è·¯å¾„æ¥æ„å»ºæ‚¨çš„`JsonPointer`:

```java
JsonPointer pointer1 = JsonPointer.from("/hello/world");
// Build a pointer manually
JsonPointer pointer2 = JsonPointer.create()
  .append("hello")
  .append("world");
```

å®ä¾‹åŒ–æŒ‡é’ˆå,ä½¿ç”¨ `queryJson` æŸ¥è¯¢ JSON å€¼. æ‚¨å¯ä»¥ä½¿ç”¨ `writeJson` æ›´æ–° Json å€¼:

```java
Object result1 = objectPointer.queryJson(jsonObject);
// Query a JsonArray
Object result2 = arrayPointer.queryJson(jsonArray);
// Write starting from a JsonObject
objectPointer.writeJson(jsonObject, "new element");
// Write starting from a JsonObject
arrayPointer.writeJson(jsonArray, "new element");
```

é€šè¿‡æä¾› `JsonPointerIterator` çš„è‡ªå®šä¹‰å®ç°,æ‚¨å¯ä»¥å°† Vert.x Json æŒ‡é’ˆ ä¸ä»»ä½•å¯¹è±¡æ¨¡å‹ä¸€èµ·ä½¿ç”¨

## Buffers(ç¼“å†²åŒº)

å¤§å¤šæ•°æ•°æ®åœ¨ Vert.x ä¸­ä½¿ç”¨ç¼“å†²åŒºè¿›è¡Œæ··æ´—.

ç¼“å†²åŒºæ˜¯å¯ä»¥è¯»å–æˆ–å†™å…¥çš„é›¶ä¸ªæˆ–å¤šä¸ªå­—èŠ‚çš„åºåˆ—,å¹¶æ ¹æ®éœ€è¦è‡ªåŠ¨æ‰©å±•ä»¥å®¹çº³å†™å…¥å…¶ä¸­çš„ä»»ä½•å­—èŠ‚. æ‚¨ä¹Ÿè®¸å¯ä»¥å°†ç¼“å†²åŒºè§†ä¸ºæ™ºèƒ½å­—èŠ‚æ•°ç»„.

### åˆ›å»º buffers

ç¼“å†²åŒºå¯ä»¥ä½¿ç”¨é™æ€ `Buffer.buffer` æ–¹æ³•ä¹‹ä¸€åˆ›å»º.

ç¼“å†²åŒºå¯ä»¥ä»å­—ç¬¦ä¸²æˆ–å­—èŠ‚æ•°ç»„åˆå§‹åŒ–,ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ä¸ªç©ºç¼“å†²åŒº.

ä»¥ä¸‹æ˜¯åˆ›å»ºç¼“å†²åŒºçš„ä¸€äº›ç¤ºä¾‹:

åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºç¼“å†²åŒº:

```java
Buffer buff = Buffer.buffer();
```

ä»å­—ç¬¦ä¸²åˆ›å»ºç¼“å†²åŒº. å­—ç¬¦ä¸²å°†ä½¿ç”¨ `UTF-8` åœ¨ç¼“å†²åŒºä¸­ç¼–ç .

```java
Buffer buff = Buffer.buffer("some string");
```

ä»å­—ç¬¦ä¸²åˆ›å»ºç¼“å†²åŒº:å­—ç¬¦ä¸²å°†ä½¿ç”¨æŒ‡å®šçš„ç¼–ç è¿›è¡Œç¼–ç ,ä¾‹å¦‚:

```java
Buffer buff = Buffer.buffer("some string", "UTF-16");
```

ä» `byte[]` åˆ›å»ºä¸€ä¸ªç¼“å†²åŒº

```java
byte[] bytes = new byte[] {1, 3, 5};
Buffer buff = Buffer.buffer(bytes);
```

åˆ›å»ºä¸€ä¸ªå¸¦æœ‰åˆå§‹å¤§å°æç¤ºçš„ç¼“å†²åŒº. å¦‚æœæ‚¨çŸ¥é“ç¼“å†²åŒºå°†å†™å…¥ä¸€å®šæ•°é‡çš„æ•°æ®,åˆ™å¯ä»¥åˆ›å»ºç¼“å†²åŒºå¹¶æŒ‡å®šæ­¤å¤§å°. è¿™ä½¿å¾—ç¼“å†²åŒºæœ€åˆåˆ†é…é‚£ä¹ˆå¤šå†…å­˜,å¹¶ä¸”æ¯”ç¼“å†²åŒºåœ¨æ•°æ®å†™å…¥æ—¶è‡ªåŠ¨è°ƒæ•´å¤§å°å¤šæ¬¡æ›´æœ‰æ•ˆ.

è¯·æ³¨æ„,ä»¥è¿™ç§æ–¹å¼åˆ›å»ºçš„ç¼“å†²åŒº**æ˜¯ç©ºçš„**. å®ƒä¸ä¼šåˆ›å»ºä¸€ä¸ªç”±é›¶å¡«å……åˆ°æŒ‡å®šå¤§å°çš„ç¼“å†²åŒº.

```java
Buffer buff = Buffer.buffer(10000);
```

### å†™å…¥ Buffer

æœ‰ä¸¤ç§å†™å…¥ç¼“å†²åŒºçš„æ–¹æ³•:è¿½åŠ å’Œéšæœºè®¿é—®. åœ¨ä»»ä½•ä¸€ç§æƒ…å†µä¸‹,ç¼“å†²åŒºéƒ½å°†å§‹ç»ˆè‡ªåŠ¨æ‰©å±•ä»¥åŒ…å«å­—èŠ‚. ä½¿ç”¨ç¼“å†²åŒºæ— æ³•è·å¾— `IndexOutOfBoundsException`å¼‚å¸¸.

#### è¿½åŠ åˆ° Buffer

è¦æ·»åŠ åˆ°ç¼“å†²åŒº,ä½ å¯ä»¥ä½¿ç”¨`appendXXX`æ–¹æ³•.å­˜åœ¨ç”¨äºè¿½åŠ å„ç§ä¸åŒç±»å‹çš„Appendæ–¹æ³•.

`appendXXX` æ–¹æ³•çš„è¿”å›å€¼æ˜¯ç¼“å†²åŒºæœ¬èº«,å› æ­¤å¯ä»¥å°†å®ƒä»¬é“¾æ¥èµ·æ¥:

```java
Buffer buff = Buffer.buffer();

buff.appendInt(123).appendString("hello\n");

socket.write(buff);
```

#### éšæœºå­˜å–Bufferå†™å…¥

ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨`setXXX`æ–¹æ³•åœ¨ç‰¹å®šçš„ç´¢å¼•å¤„å†™å…¥ç¼“å†²åŒº.setæ–¹æ³•é€‚ç”¨äºå„ç§ä¸åŒçš„æ•°æ®ç±»å‹.æ‰€æœ‰setæ–¹æ³•éƒ½ä»¥ç´¢å¼•ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°--å®ƒè¡¨ç¤ºç¼“å†²åŒºä¸­å¼€å§‹å†™å…¥æ•°æ®çš„ä½ç½®.

ç¼“å†²åŒºå°†å§‹ç»ˆæ ¹æ®éœ€è¦æ‰©å±•ä»¥å®¹çº³æ•°æ®.

```java
Buffer buff = Buffer.buffer();

buff.setInt(1000, 123);
buff.setString(0, "hello");
```

### ä»Bufferè¯»å–

ä½¿ç”¨`getXXX`æ–¹æ³•ä»ç¼“å†²åŒºè¯»å–æ•°æ®.å­˜åœ¨å„ç§æ•°æ®ç±»å‹çš„Getæ–¹æ³•.è¿™äº›æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨äºè·å–æ•°æ®çš„ç¼“å†²åŒºä¸­çš„ç´¢å¼•.

```java
Buffer buff = Buffer.buffer();
for (int i = 0; i < buff.length(); i += 4) {
  System.out.println("int value at " + i + " is " + buff.getInt(i));
}
```

### å¤„ç†æ— ç¬¦å·æ•°å­—

æ— ç¬¦å·æ•°å¯ä»¥ç”¨`getUnsignedXXX`, `appendUnsignedXXX`å’Œ`setUnsignedXXX`æ–¹æ³•ä»ç¼“å†²åŒºè¯»å–æˆ–è¿½åŠ /è®¾ç½®.åœ¨ä¸ºç½‘ç»œåè®®å®ç°ç¼–è§£ç å™¨ä»¥æœ€å°åŒ–å¸¦å®½æ¶ˆè€—æ—¶,è¿™æ˜¯éå¸¸æœ‰ç”¨çš„.

åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­,å€¼200è¢«è®¾ç½®åœ¨æŒ‡å®šçš„ä½ç½®,åªæœ‰ä¸€ä¸ªå­—èŠ‚:

```java
Buffer buff = Buffer.buffer(128);
int pos = 15;
buff.setUnsignedByte(pos, (short) 200);
System.out.println(buff.getUnsignedByte(pos));
```

æ§åˆ¶å°æ˜¾ç¤º"200".

### Buffer é•¿åº¦

ä½¿ç”¨`length`è·å–ç¼“å†²åŒºçš„é•¿åº¦.ç¼“å†²åŒºçš„é•¿åº¦æ˜¯è¯¥ç¼“å†²åŒºä¸­ç´¢å¼•æœ€å¤§çš„å­—èŠ‚çš„ç´¢å¼•+ 1.

### å¤åˆ¶ buffers

ä½¿ç”¨ `copy` å¤åˆ¶ç¼“å†²åŒº

### Slicing(åˆ‡ç‰‡) buffers

åˆ‡ç‰‡ç¼“å†²åŒºæ˜¯ä¸€ä¸ªæ–°ç¼“å†²åŒº,å®ƒæŒ‡å‘ä¸åŸBufferç›¸åŒçš„å†…å­˜ä½ç½®(å³å®ƒä¸å¤åˆ¶åº•å±‚æ•°æ®),ä¸”ä»…åŒ…å«è£å‰ªçš„å…ƒç´ . ä½¿ç”¨ `slice` åˆ›å»ºåˆ‡ç‰‡ç¼“å†²åŒº.
> **ğŸ·æ³¨æ„:** ä¿®æ”¹è¿”å›çš„åˆ‡ç‰‡ç¼“å†²åŒºæˆ–åŸç¼“å†²åŒºçš„å†…å®¹ä¼šå½±å“å½¼æ­¤çš„å†…å®¹,åŒæ—¶å®ƒä»¬ç»´æŠ¤å•ç‹¬çš„ç´¢å¼•å’Œæ ‡è®°.

### Buffer é‡ç”¨

å°†ç¼“å†²åŒºå†™å…¥å¥—æ¥å­—æˆ–å…¶ä»–ç±»ä¼¼ä½ç½®å,å®ƒä»¬æ— æ³•é‡å¤ä½¿ç”¨.

## ç¼–å†™ TCP æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯

Vert.x å…è®¸æ‚¨è½»æ¾ç¼–å†™éé˜»å¡ TCP å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨.

### åˆ›å»º TCP æœåŠ¡å™¨

ä½¿ç”¨æ‰€æœ‰é»˜è®¤é€‰é¡¹åˆ›å»º TCP æœåŠ¡å™¨çš„æœ€ç®€å•æ–¹æ³•å¦‚ä¸‹:

```java
NetServer server = vertx.createNetServer();
```

### é…ç½® TCP æœåŠ¡å™¨

å¦‚æœæ‚¨ä¸æƒ³è¦é»˜è®¤å€¼,å¯ä»¥é€šè¿‡åœ¨åˆ›å»ºæœåŠ¡å™¨æ—¶ä¼ å…¥ä¸€ä¸ª `NetServerOptions` å®ä¾‹æ¥é…ç½®æœåŠ¡å™¨:

```java
NetServerOptions options = new NetServerOptions().setPort(4321);
NetServer server = vertx.createNetServer(options);
```

### å¯åŠ¨æœåŠ¡å™¨ç›‘å¬

è¦å‘Šè¯‰æœåŠ¡å™¨ç›‘å¬ä¼ å…¥çš„è¯·æ±‚,æ‚¨å¯ä»¥ä½¿ç”¨`listen`é€‰é¡¹ä¹‹ä¸€.

å‘Šè¯‰æœåŠ¡å™¨ç›‘å¬é€‰é¡¹ä¸­æŒ‡å®šçš„ä¸»æœºå’Œç«¯å£:

```java
NetServer server = vertx.createNetServer();
server.listen();
```

æˆ–è€…åœ¨ç›‘å¬çš„è°ƒç”¨ä¸­æŒ‡å®šä¸»æœºå’Œç«¯å£,å¿½ç•¥é€‰é¡¹ä¸­é…ç½®çš„å†…å®¹:

```java
NetServer server = vertx.createNetServer();
server.listen(1234, "localhost");
```

é»˜è®¤ä¸»æœºæ˜¯`0.0.0.0`,è¡¨ç¤º"ç›‘å¬æ‰€æœ‰å¯ç”¨åœ°å€,é»˜è®¤ç«¯å£æ˜¯`0`,è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šå€¼,æŒ‡ç¤ºæœåŠ¡å™¨éšæœºæŸ¥æ‰¾æœªä½¿ç”¨çš„æœ¬åœ°ç«¯å£å¹¶ä½¿ç”¨å®ƒ.

å®é™…çš„ç»‘å®šæ˜¯å¼‚æ­¥çš„,å› æ­¤æœåŠ¡å™¨å¯èƒ½ç›´åˆ°**åœ¨**ç›‘å¬è°ƒç”¨è¿”å›åçš„æŸä¸ªæ—¶é—´æ‰çœŸæ­£ç›‘å¬.

å¦‚æœæ‚¨æƒ³åœ¨æœåŠ¡å™¨å®é™…ç›‘å¬æ—¶æ”¶åˆ°é€šçŸ¥,æ‚¨å¯ä»¥ä¸º`listen`è°ƒç”¨æä¾›ä¸€ä¸ªå¤„ç†å™¨. ä¾‹å¦‚:

```java
NetServer server = vertx.createNetServer();
server.listen(1234, "localhost", res -> {
  if (res.succeeded()) {
    System.out.println("Server is now listening!");
  } else {
    System.out.println("Failed to bind!");
  }
});
```

### ç›‘å¬éšæœºç«¯å£

å¦‚æœä½¿ç”¨`0`ä½œä¸ºç›‘å¬ç«¯å£,æœåŠ¡å™¨å°†æ‰¾åˆ°ä¸€ä¸ªæœªä½¿ç”¨çš„éšæœºç«¯å£è¿›è¡Œç›‘å¬.

è¦æ‰¾å‡ºæœåŠ¡å™¨æ­£åœ¨ä¾¦å¬çš„çœŸå®ç«¯å£,æ‚¨å¯ä»¥è°ƒç”¨`actualPort`.

```java
NetServer server = vertx.createNetServer();
server.listen(0, "localhost", res -> {
  if (res.succeeded()) {
    System.out.println("Server is now listening on actual port: " + server.actualPort());
  } else {
    System.out.println("Failed to bind!");
  }
});
```

### æ”¶åˆ°ä¼ å…¥è¿æ¥çš„é€šçŸ¥

è¦åœ¨å»ºç«‹è¿æ¥æ—¶æ”¶åˆ°é€šçŸ¥,æ‚¨éœ€è¦è®¾ç½®ä¸€ä¸ª `connectHandler`:

```java
NetServer server = vertx.createNetServer();
server.connectHandler(socket -> {
  // Handle the connection in here
});
```

å»ºç«‹è¿æ¥å,å°†ä½¿ç”¨`NetSocket`å®ä¾‹è°ƒç”¨å¤„ç†å™¨.

è¿™æ˜¯ä¸€ä¸ªä¸å®é™…è¿æ¥ç±»ä¼¼çš„å¥—æ¥å­—æ¥å£,å…è®¸æ‚¨è¯»å–å’Œå†™å…¥æ•°æ®ä»¥åŠæ‰§è¡Œå„ç§å…¶ä»–æ“ä½œ,ä¾‹å¦‚å…³é—­å¥—æ¥å­—.

### ä»å¥—æ¥å­—è¯»å–æ•°æ®

è¦ä»å¥—æ¥å­—è¯»å–æ•°æ®,è¯·åœ¨å¥—æ¥å­—ä¸Šè®¾ç½®`handler` .

æ¯æ¬¡åœ¨å¥—æ¥å­—ä¸Šæ¥æ”¶åˆ°æ•°æ®æ—¶,éƒ½ä¼šä¼ é€’ `Buffer` çš„å®ä¾‹è°ƒç”¨æ­¤å¤„ç†å™¨.

```java
NetServer server = vertx.createNetServer();
server.connectHandler(socket -> {
  socket.handler(buffer -> {
    System.out.println("I received some bytes: " + buffer.length());
  });
});
```

### å°†æ•°æ®å†™å…¥å¥—æ¥å­—

æ‚¨ä½¿ç”¨ `write` ä¹‹ä¸€å†™å…¥å¥—æ¥å­—.

```java
Buffer buffer = Buffer.buffer().appendFloat(12.34f).appendInt(123);
socket.write(buffer);

// Write a string in UTF-8 encoding
socket.write("some data");

// Write a string using the specified encoding
socket.write("some data", "UTF-16");
```

å†™æ“ä½œæ˜¯å¼‚æ­¥çš„,å¯èƒ½è¦ç­‰åˆ° `write` è°ƒç”¨è¿”å›åä¸€æ®µæ—¶é—´æ‰ä¼šå‘ç”Ÿ.

### å…³é—­å¤„ç†å™¨

å¦‚æœæ‚¨æƒ³åœ¨å¥—æ¥å­—å…³é—­æ—¶æ”¶åˆ°é€šçŸ¥,å¯ä»¥åœ¨å…¶ä¸Šè®¾ç½®ä¸€ä¸ª `closeHandler`:

```java
socket.closeHandler(v -> {
  System.out.println("The socket has been closed");
});
```

### å¤„ç†å¼‚å¸¸

æ‚¨å¯ä»¥è®¾ç½®ä¸€ä¸ª `exceptionHandler` æ¥æ¥æ”¶å¥—æ¥å­—ä¸Šå‘ç”Ÿçš„ä»»ä½•å¼‚å¸¸.

æ‚¨å¯ä»¥è®¾ç½®ä¸€ä¸ª `exceptionHandler` æ¥æ¥æ”¶åœ¨è¿æ¥ä¼ é€’ç»™ `connectHandler` ä¹‹å‰å‘ç”Ÿçš„ä»»ä½•å¼‚å¸¸,ä¾‹å¦‚åœ¨ TLS æ¡æ‰‹æœŸé—´.

### äº‹ä»¶æ€»çº¿å†™å¤„ç†å™¨(writeHandlerID)

æ¯ä¸ªå¥—æ¥å­—éƒ½ä¼šè‡ªåŠ¨åœ¨äº‹ä»¶æ€»çº¿ä¸Šæ³¨å†Œä¸€ä¸ªå¤„ç†å™¨,å¹¶ä¸”å½“åœ¨æ­¤å¤„ç†å™¨ä¸­æ¥æ”¶åˆ°ä»»ä½•`Buffer`æ—¶,å®ƒä¼šå°†è‡ªåŠ¨å°†`Buffer`é‡Œçš„æ•°æ®å†™å›å®¢æˆ·ç«¯. è¿™äº›æ˜¯æœªåœ¨é›†ç¾¤ä¸Šè·¯ç”±çš„**æœ¬åœ°æ¶ˆæ¯è®¢é˜…**.

è¿™ä½¿æ‚¨å¯ä»¥é€šè¿‡`vertx.eventBus().publish`æ–¹æ³•,å°†`Buffer`å‘é€åˆ°è¯¥å¤„ç†å™¨çš„åœ°å€æ¥å°†æ•°æ®å†™å…¥å¯èƒ½ä½äºå®Œå…¨ä¸åŒçš„Verticleä¸­çš„å¥—æ¥å­—.

å¤„ç†å™¨çš„åœ°å€ç”± `writeHandlerID` ç»™å‡º

ä¾‹å­ä»£ç :
```java
@Test
// This tests using NetSocket.writeHandlerID (on the server side)
// Send some data and make sure it is fanned out to all connections
public void testFanout() throws Exception {
 int numConnections = 10;
 Set<String> connections = new ConcurrentHashSet<>();
 server.connectHandler(socket -> {
  connections.add(socket.writeHandlerID());
  if (connections.size() == numConnections) {
   for (String actorID : connections) {
    vertx.eventBus().publish(actorID, Buffer.buffer("some data"));
   }
  }
  socket.closeHandler(v -> {
   connections.remove(socket.writeHandlerID());
  });
 });
 startServer();
  
 CountDownLatch receivedLatch = new CountDownLatch(numConnections);
 for (int i = 0; i < numConnections; i++) {
  client.connect(testAddress, onSuccess(socket -> {
   socket.handler(data -> {
    receivedLatch.countDown();
   });
  }));
 }
 assertTrue(receivedLatch.await(10, TimeUnit.SECONDS));
 testComplete();
}
```

### æœ¬åœ°å’Œè¿œç¨‹åœ°å€

å¯ä»¥ä½¿ç”¨ `localAddress` æ£€ç´¢`NetSocket` çš„æœ¬åœ°åœ°å€.

å¯ä»¥ä½¿ç”¨`remoteAddress`æ£€ç´¢`NetSocket`çš„è¿œç¨‹åœ°å€(å³è¿æ¥å¦ä¸€ç«¯çš„åœ°å€).

### ä»classpath(ç±»è·¯å¾„)å‘é€æ–‡ä»¶æˆ–èµ„æº

æ–‡ä»¶å’Œç±»è·¯å¾„èµ„æºå¯ä»¥ä½¿ç”¨ `sendFile` ç›´æ¥å†™å…¥å¥—æ¥å­—. è¿™å¯èƒ½æ˜¯ä¸€ç§éå¸¸æœ‰æ•ˆçš„æ–‡ä»¶å‘é€æ–¹å¼,å› ä¸ºå®ƒå¯ä»¥åœ¨æ“ä½œç³»ç»Ÿæ”¯æŒçš„æƒ…å†µä¸‹ç”±æ“ä½œç³»ç»Ÿå†…æ ¸ç›´æ¥å¤„ç†.

æœ‰å…³ç±»è·¯å¾„è§£æçš„é™åˆ¶æˆ–ç¦ç”¨å®ƒ,è¯·å‚é˜…å…³äº [ä»ç±»è·¯å¾„æä¾›æ–‡ä»¶](#classpath) çš„ç« èŠ‚.

```java
socket.sendFile("myfile.dat");
```

### æµå¼å¥—æ¥å­—

`NetSocket` çš„å®ä¾‹ä¹Ÿæ˜¯ `ReadStream` å’Œ `WriteStream` å®ä¾‹,å› æ­¤å®ƒä»¬å¯ç”¨äºå°†æ•°æ®ä¼ é€åˆ°æˆ–è¯»å–æ¥è‡ªå…¶ä»–çš„è¯»å†™æµ.

æœ‰å…³è¯¦ç»†ä¿¡æ¯,è¯·å‚é˜…æœ‰å…³ [streams(æµ)](#streams) çš„ç« èŠ‚.

### å‡çº§åˆ° SSL/TLS çš„è¿æ¥

å¯ä»¥ä½¿ç”¨`upgradeToSsl`å°†é SSL/TLS è¿æ¥å‡çº§åˆ° SSL/TLS.

å¿…é¡»ä¸ºæœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯é…ç½® SSL/TLS æ‰èƒ½æ­£å¸¸å·¥ä½œ. è¯·å‚é˜… [å…³äº SSL/TLS çš„ç« èŠ‚](#ssl) äº†è§£æ›´å¤šä¿¡æ¯.

### å…³é—­ TCP æœåŠ¡å™¨

è°ƒç”¨ `close` å…³é—­æœåŠ¡å™¨. å…³é—­æœåŠ¡å™¨ä¼šå…³é—­æ‰€æœ‰æ‰“å¼€çš„è¿æ¥å¹¶é‡Šæ”¾æ‰€æœ‰æœåŠ¡å™¨èµ„æº.

å…³é—­å®é™…ä¸Šæ˜¯å¼‚æ­¥çš„,å¯èƒ½è¦ç­‰åˆ°è°ƒç”¨è¿”å›åä¸€æ®µæ—¶é—´æ‰èƒ½å®Œæˆ. å¦‚æœæ‚¨æƒ³åœ¨å®é™…å…³é—­å®Œæˆæ—¶æ”¶åˆ°é€šçŸ¥,é‚£ä¹ˆæ‚¨å¯ä»¥ä¼ å…¥ä¸€ä¸ªå¤„ç†å™¨.

å½“å…³é—­å®Œå…¨å®Œæˆæ—¶,å°†è°ƒç”¨æ­¤å¤„ç†å™¨.

```java
server.close(res -> {
  if (res.succeeded()) {
    System.out.println("Server is now closed");
  } else {
    System.out.println("close failed");
  }
});
```

### è‡ªåŠ¨æ¸…ç† verticles

å¦‚æœæ‚¨ä» Verticle å†…éƒ¨åˆ›å»º TCP æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯,åˆ™åœ¨å–æ¶ˆéƒ¨ç½² Verticle æ—¶,è¿™äº›æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å°†è‡ªåŠ¨å…³é—­.

### ä¼¸ç¼©æ€§ - å…±äº« TCP æœåŠ¡å™¨

ä»»ä½• TCP æœåŠ¡å™¨çš„å¤„ç†å™¨æ€»æ˜¯åœ¨åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯çº¿ç¨‹ä¸Šæ‰§è¡Œ.

è¿™æ„å‘³ç€,å¦‚æœæ‚¨åœ¨å…·æœ‰å¤§é‡å†…æ ¸çš„æœåŠ¡å™¨ä¸Šè¿è¡Œ,å¹¶ä¸”æ‚¨åªéƒ¨ç½²äº†è¿™ä¸ªå®ä¾‹,é‚£ä¹ˆæ‚¨çš„æœåŠ¡å™¨ä¸Šæœ€å¤šä¼šä½¿ç”¨ä¸€ä¸ªå†…æ ¸.

ä¸ºäº†åˆ©ç”¨æœåŠ¡å™¨çš„æ›´å¤šæ ¸å¿ƒ,æ‚¨éœ€è¦éƒ¨ç½²æ›´å¤šæœåŠ¡å™¨å®ä¾‹.

æ‚¨å¯ä»¥åœ¨ä»£ç ä¸­ä»¥ç¼–ç¨‹æ–¹å¼å®ä¾‹åŒ–æ›´å¤šå®ä¾‹:

```java
for (int i = 0; i < 10; i++) {
  NetServer server = vertx.createNetServer();
  server.connectHandler(socket -> {
    socket.handler(buffer -> {
      // Just echo back the data
      socket.write(buffer);
    });
  });
  server.listen(1234, "localhost");
}
```

æˆ–è€…,å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ verticles,æ‚¨å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œä¸Šçš„ `-instances` é€‰é¡¹ç®€å•åœ°éƒ¨ç½²æ›´å¤šæœåŠ¡å™¨verticleå®ä¾‹:

`vertx run com.mycompany.MyVerticle -instances 10`

æˆ–è€…åœ¨ä»¥ç¼–ç¨‹æ–¹å¼éƒ¨ç½²æ‚¨çš„verticleæ—¶:

```java
DeploymentOptions options = new DeploymentOptions().setInstances(10);
vertx.deployVerticle("com.mycompany.MyVerticle", options);
```

å®Œæˆæ­¤æ“ä½œå,æ‚¨ä¼šå‘ç° echo æœåŠ¡å™¨åœ¨åŠŸèƒ½ä¸Šä¸ä»¥å‰ç›¸åŒ,ä½†æ‚¨æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰å†…æ ¸éƒ½å¯ä»¥ä½¿ç”¨,å¹¶ä¸”å¯ä»¥å¤„ç†æ›´å¤šå·¥ä½œ.

æ­¤æ—¶æ‚¨å¯èƒ½ä¼šé—®è‡ªå·±: **"å¦‚ä½•è®©å¤šä¸ªæœåŠ¡å™¨åœ¨åŒä¸€ä¸»æœºå’Œç«¯å£ä¸Šä¾¦å¬? å½“æ‚¨å°è¯•éƒ¨ç½²å¤šä¸ªå®ä¾‹æ—¶,æ‚¨è‚¯å®šä¼šé‡åˆ°ç«¯å£å†²çªå—?"**

**Vert.x åœ¨è¿™é‡Œåšäº†ä¸€ç‚¹é­”æ³•.**

å½“æ‚¨åœ¨ä¸ç°æœ‰æœåŠ¡å™¨ç›¸åŒçš„ä¸»æœºå’Œç«¯å£ä¸Šéƒ¨ç½²å¦ä¸€å°æœåŠ¡å™¨æ—¶,å®ƒå®é™…ä¸Šå¹¶æ²¡æœ‰å°è¯•åˆ›å»ºä¸€ä¸ªåœ¨åŒä¸€ä¸»æœº/ç«¯å£ä¸Šä¾¦å¬çš„æ–°æœåŠ¡å™¨.

ç›¸å,å®ƒåœ¨å†…éƒ¨åªç»´æŠ¤ä¸€ä¸ªæœåŠ¡å™¨,å¹¶ä¸”å½“ä¼ å…¥è¿æ¥åˆ°è¾¾æ—¶,å®ƒä»¥å¾ªç¯æ–¹å¼å°†å®ƒä»¬åˆ†å‘ç»™ä»»ä½•è¿æ¥å¤„ç†å™¨.

å› æ­¤,Vert.x TCP æœåŠ¡å™¨å¯ä»¥æ‰©å±•å¯ç”¨å†…æ ¸,åŒæ—¶æ¯ä¸ªå®ä¾‹ä¿æŒå•çº¿ç¨‹.

### åˆ›å»º TCP å®¢æˆ·ç«¯

ä½¿ç”¨æ‰€æœ‰é»˜è®¤é€‰é¡¹åˆ›å»º TCP å®¢æˆ·ç«¯çš„æœ€ç®€å•æ–¹æ³•å¦‚ä¸‹:

```java
NetClient client = vertx.createNetClient();
```

### é…ç½®TCPå®¢æˆ·ç«¯

å¦‚æœæ‚¨ä¸æƒ³è¦é»˜è®¤å€¼,å¯ä»¥åœ¨åˆ›å»ºå®¢æˆ·ç«¯æ—¶é€šè¿‡ä¼ å…¥ `NetClientOptions` å®ä¾‹æ¥é…ç½®å®¢æˆ·ç«¯:

```java
NetClientOptions options = new NetClientOptions().setConnectTimeout(10000);
NetClient client = vertx.createNetClient(options);
```

### å»ºç«‹è¿æ¥

è¦ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥,è¯·ä½¿ç”¨`connect`,æŒ‡å®šæœåŠ¡å™¨çš„ç«¯å£å’Œä¸»æœºä»¥åŠä¸€ä¸ªå¤„ç†å™¨,å½“è¿æ¥æˆåŠŸæˆ–è¿æ¥å¤±è´¥æ—¶,å°†è°ƒç”¨åŒ…å«`NetSocket`çš„ç»“æœçš„å¤„ç†å™¨.

```java
NetClientOptions options = new NetClientOptions().setConnectTimeout(10000);
NetClient client = vertx.createNetClient(options);
client.connect(4321, "localhost", res -> {
  if (res.succeeded()) {
    System.out.println("Connected!");
    NetSocket socket = res.result();
  } else {
    System.out.println("Failed to connect: " + res.cause().getMessage());
  }
});
```

### é…ç½®è¿æ¥å°è¯•

å®¢æˆ·ç«¯å¯ä»¥é…ç½®ä¸ºåœ¨æ— æ³•è¿æ¥æ—¶è‡ªåŠ¨é‡è¯•è¿æ¥åˆ°æœåŠ¡å™¨. è¿™æ˜¯ç”¨ `setReconnectInterval` å’Œ `setReconnectAttempts` é…ç½®çš„.

> **ğŸ·æ³¨æ„:** ç›®å‰,å¦‚æœè¿æ¥å¤±è´¥,Vert.x ä¸ä¼šå°è¯•é‡æ–°è¿æ¥,é‡æ–°è¿æ¥å°è¯•å’Œé—´éš”ä»…é€‚ç”¨äºåˆ›å»ºåˆå§‹è¿æ¥.

```java
NetClientOptions options = new NetClientOptions().
  setReconnectAttempts(10).
  setReconnectInterval(500);

NetClient client = vertx.createNetClient(options);
```

é»˜è®¤æƒ…å†µä¸‹,ç¦ç”¨å¤šæ¬¡è¿æ¥å°è¯•.

<a name="logging_network_activity"></a>
### è®°å½•ç½‘ç»œæ´»åŠ¨

å‡ºäºè°ƒè¯•ç›®çš„,å¯ä»¥è®°å½•ç½‘ç»œæ´»åŠ¨:

```java
NetServerOptions options = new NetServerOptions().setLogActivity(true);

NetServer server = vertx.createNetServer(options);
```

è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ HTTP æœåŠ¡å™¨çš„è¾“å‡º

```
id: 0x359e3df6, L:/127.0.0.1:8080 - R:/127.0.0.1:65351] READ: 78B
        +-------------------------------------------------+
        |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 47 45 54 20 2f 20 48 54 54 50 2f 31 2e 31 0d 0a |GET / HTTP/1.1..|
|00000010| 48 6f 73 74 3a 20 6c 6f 63 61 6c 68 6f 73 74 3a |Host: localhost:|
|00000020| 38 30 38 30 0d 0a 55 73 65 72 2d 41 67 65 6e 74 |8080..User-Agent|
|00000030| 3a 20 63 75 72 6c 2f 37 2e 36 34 2e 31 0d 0a 41 |: curl/7.64.1..A|
|00000040| 63 63 65 70 74 3a 20 2a 2f 2a 0d 0a 0d 0a       |ccept: */*....  |
+--------+-------------------------------------------------+----------------+
[id: 0x359e3df6, L:/127.0.0.1:8080 - R:/127.0.0.1:65351] WRITE: 50B
        +-------------------------------------------------+
        |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
+--------+-------------------------------------------------+----------------+
|00000000| 48 54 54 50 2f 31 2e 31 20 32 30 30 20 4f 4b 0d |HTTP/1.1 200 OK.|
|00000010| 0a 63 6f 6e 74 65 6e 74 2d 6c 65 6e 67 74 68 3a |.content-length:|
|00000020| 20 31 31 0d 0a 0d 0a 48 65 6c 6c 6f 20 57 6f 72 | 11....Hello Wor|
|00000030| 6c 64                                           |ld              |
+--------+-------------------------------------------------+----------------+
[id: 0x359e3df6, L:/127.0.0.1:8080 - R:/127.0.0.1:65351] READ COMPLETE
[id: 0x359e3df6, L:/127.0.0.1:8080 - R:/127.0.0.1:65351] FLUSH
```

é»˜è®¤æƒ…å†µä¸‹ï¼ŒäºŒè¿›åˆ¶æ•°æ®ä»¥åå…­è¿›åˆ¶æ ¼å¼è®°å½•ã€‚

æ‚¨å¯ä»¥é€šè¿‡è®¾ç½®æ—¥å¿—æ•°æ®æ ¼å¼æ¥å‡å°‘æ•°æ®æ ¼å¼çš„è¯¦ç»†ç¨‹åº¦ï¼Œåªæ‰“å°ç¼“å†²åŒºé•¿åº¦è€Œä¸æ˜¯æ•´ä¸ªæ•°æ®ã€‚

```java
NetServerOptions options = new NetServerOptions()
  .setLogActivity(true)
  .setActivityLogDataFormat(ByteBufFormat.SIMPLE);

NetServer server = vertx.createNetServer(options);
```

ä¸‹é¢æ˜¯ç®€å•ç¼“å†²åŒºæ ¼å¼çš„ç›¸åŒè¾“å‡º

```
[id: 0xda8d41dc, L:/127.0.0.1:8080 - R:/127.0.0.1:65399] READ: 78B
[id: 0xda8d41dc, L:/127.0.0.1:8080 - R:/127.0.0.1:65399] WRITE: 50B
[id: 0xda8d41dc, L:/127.0.0.1:8080 - R:/127.0.0.1:65399] READ COMPLETE
[id: 0xda8d41dc, L:/127.0.0.1:8080 - R:/127.0.0.1:65399] FLUSH
[id: 0xda8d41dc, L:/127.0.0.1:8080 - R:/127.0.0.1:65399] READ COMPLETE
[id: 0xda8d41dc, L:/127.0.0.1:8080 ! R:/127.0.0.1:65399] INACTIVE
[id: 0xda8d41dc, L:/127.0.0.1:8080 ! R:/127.0.0.1:65399] UNREGISTERED
```

å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥è®°å½•ç½‘ç»œæ´»åŠ¨

```java
NetClientOptions options = new NetClientOptions().setLogActivity(true);

NetClient client = vertx.createNetClient(options);
```

Netty ä½¿ç”¨ `DEBUG` çº§åˆ«å’Œ `io.netty.handler.logging.LoggingHandler` åç§°è®°å½•ç½‘ç»œæ´»åŠ¨. ä½¿ç”¨ç½‘ç»œæ´»åŠ¨æ—¥å¿—è®°å½•æ—¶,éœ€è¦ç‰¢è®°ä»¥ä¸‹å‡ ç‚¹:

- æ—¥å¿—ä¸æ˜¯ç”± Vert.x æ—¥å¿—æ‰§è¡Œçš„,è€Œæ˜¯ç”± Netty æ‰§è¡Œçš„
- è¿™**ä¸æ˜¯**ä¸€ä¸ªäº§å“ç‰¹æ€§

æ‚¨åº”è¯¥é˜…è¯» [Netty logging](#netty_logging) éƒ¨åˆ†ã€‚

<a name="ssl"></a>
### é…ç½®æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä»¥ä½¿ç”¨ SSL/TLS

TCP å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯ä»¥é…ç½®ä¸ºä½¿ç”¨ [ä¼ è¾“å±‚å®‰å…¨æ€§](https://en.wikipedia.org/wiki/Transport_Layer_Security) - TLS çš„æ—©æœŸç‰ˆæœ¬è¢«ç§°ä¸º SSL.

æ— è®ºæ˜¯å¦ä½¿ç”¨ SSL/TLS,æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„ API éƒ½æ˜¯ç›¸åŒçš„,å¹¶ä¸”é€šè¿‡é…ç½®ç”¨äºåˆ›å»ºæœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯çš„ `NetClientOptions` æˆ– `NetServerOptions` å®ä¾‹æ¥å¯ç”¨å®ƒ.

#### åœ¨æœåŠ¡å™¨ä¸Šå¯ç”¨ SSL/TLS

SSL/TLS é€šè¿‡ `ssl` å¯ç”¨.

é»˜è®¤æƒ…å†µä¸‹å®ƒè¢«ç¦ç”¨.

#### ä¸ºæœåŠ¡å™¨æŒ‡å®šå¯†é’¥/è¯ä¹¦

SSL/TLS æœåŠ¡å™¨é€šå¸¸å‘å®¢æˆ·ç«¯æä¾›è¯ä¹¦,ä»¥ä¾¿å‘å®¢æˆ·ç«¯éªŒè¯å…¶èº«ä»½.

å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼ä¸ºæœåŠ¡å™¨é…ç½®è¯ä¹¦/å¯†é’¥:

ç¬¬ä¸€ç§æ–¹æ³•æ˜¯æŒ‡å®šåŒ…å«è¯ä¹¦å’Œç§é’¥çš„ Java å¯†é’¥åº“çš„ä½ç½®.

Java å¯†é’¥åº“å¯ä»¥ä½¿ç”¨ JDK é™„å¸¦çš„ [keytool](https://docs.oracle.com/javase/6/docs/technotes/tools/solaris/keytool.html) å®ç”¨ç¨‹åºè¿›è¡Œç®¡ç†.

è¿˜åº”æä¾›å¯†é’¥åº“çš„å¯†ç :

```java
NetServerOptions options = new NetServerOptions().setSsl(true).setKeyStoreOptions(
  new JksOptions().
    setPath("/path/to/your/server-keystore.jks").
    setPassword("password-of-your-keystore")
);
NetServer server = vertx.createNetServer(options);
```

æˆ–è€…,ä½ å¯ä»¥è‡ªå·±è¯»å–å¯†é’¥å­˜å‚¨ä½œä¸ºä¸€ä¸ªç¼“å†²åŒº,å¹¶ç›´æ¥æä¾›:

```java
Buffer myKeyStoreAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/server-keystore.jks");
JksOptions jksOptions = new JksOptions().
  setValue(myKeyStoreAsABuffer).
  setPassword("password-of-your-keystore");
NetServerOptions options = new NetServerOptions().
  setSsl(true).
  setKeyStoreOptions(jksOptions);
NetServer server = vertx.createNetServer(options);
```

`PKCS#12` æ ¼å¼çš„å¯†é’¥/è¯ä¹¦([http://en.wikipedia.org/wiki/PKCS_12](https://en.wikipedia.org/wiki/PKCS_12)),é€šå¸¸ä½¿ç”¨ `.pfx` æˆ–è€… `.p12` æ‰©å±•åä¹Ÿå¯ä»¥ä»¥ä¸ JKS å¯†é’¥å­˜å‚¨ç±»ä¼¼çš„æ–¹å¼åŠ è½½:

```java
NetServerOptions options = new NetServerOptions().setSsl(true).setPfxKeyCertOptions(
  new PfxOptions().
    setPath("/path/to/your/server-keystore.pfx").
    setPassword("password-of-your-keystore")
);
NetServer server = vertx.createNetServer(options);
```

è¿˜æ”¯æŒç¼“å†²åŒºé…ç½®:

```java
Buffer myKeyStoreAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/server-keystore.pfx");
PfxOptions pfxOptions = new PfxOptions().
  setValue(myKeyStoreAsABuffer).
  setPassword("password-of-your-keystore");
NetServerOptions options = new NetServerOptions().
  setSsl(true).
  setPfxKeyCertOptions(pfxOptions);
NetServer server = vertx.createNetServer(options);
```

å¦ä¸€ç§æä¾›æœåŠ¡å™¨ç§é’¥å’Œè¯ä¹¦çš„æ–¹å¼,æ˜¯å•ç‹¬ä½¿ç”¨`.pem`æ–‡ä»¶.

```java
NetServerOptions options = new NetServerOptions().setSsl(true).setPemKeyCertOptions(
  new PemKeyCertOptions().
    setKeyPath("/path/to/your/server-key.pem").
    setCertPath("/path/to/your/server-cert.pem")
);
NetServer server = vertx.createNetServer(options);
```

è¿˜æ”¯æŒç¼“å†²åŒºé…ç½®:

```java
Buffer myKeyAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/server-key.pem");
Buffer myCertAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/server-cert.pem");
PemKeyCertOptions pemOptions = new PemKeyCertOptions().
  setKeyValue(myKeyAsABuffer).
  setCertValue(myCertAsABuffer);
NetServerOptions options = new NetServerOptions().
  setSsl(true).
  setPemKeyCertOptions(pemOptions);
NetServer server = vertx.createNetServer(options);
```

Vert.x æ”¯æŒä» PKCS8 PEM æ–‡ä»¶ä¸­è¯»å–æœªåŠ å¯†çš„ RSA å’Œ/æˆ–åŸºäº ECC çš„ç§é’¥. åŸºäº RSA çš„ç§é’¥ä¹Ÿå¯ä»¥ä» PKCS1 PEM æ–‡ä»¶ä¸­è¯»å–. X.509 è¯ä¹¦å¯ä»¥ä» PEM æ–‡ä»¶ä¸­è¯»å–,è¯¥æ–‡ä»¶åŒ…å« [RFC 7468,ç¬¬ 5 èŠ‚](https://tools.ietf.org/html/rfc7468#section-5) å®šä¹‰çš„è¯ä¹¦æ–‡æœ¬ç¼–ç .

> **â˜¢è­¦å‘Š:** è¯·è®°ä½,ä»»ä½•å¯ä»¥è¯»å–æ–‡ä»¶çš„äººéƒ½å¯ä»¥æå–æœªåŠ å¯†çš„ PKCS8 æˆ– PKCS1 PEM æ–‡ä»¶ä¸­åŒ…å«çš„å¯†é’¥. å› æ­¤,è¯·ç¡®ä¿å¯¹æ­¤ç±» PEM æ–‡ä»¶è®¾ç½®é€‚å½“çš„è®¿é—®é™åˆ¶,ä»¥é˜²æ­¢æ»¥ç”¨.

æœ€å,æ‚¨è¿˜å¯ä»¥åŠ è½½é€šç”¨ Java å¯†é’¥åº“,è¿™å¯¹äºä½¿ç”¨å…¶ä»– KeyStore å®ç°(å¦‚ Bouncy Castle)å¾ˆæœ‰ç”¨:

```java
NetServerOptions options = new NetServerOptions().setSsl(true).setKeyCertOptions(
  new KeyStoreOptions().
    setType("BKS").
    setPath("/path/to/your/server-keystore.bks").
    setPassword("password-of-your-keystore")
);
NetServer server = vertx.createNetServer(options);
```

#### ä¸ºæœåŠ¡å™¨æŒ‡å®šä¿¡ä»»

SSL/TLS æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨è¯ä¹¦é¢å‘æœºæ„æ¥éªŒè¯å®¢æˆ·ç«¯çš„èº«ä»½.

å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼ä¸ºæœåŠ¡å™¨é…ç½®è¯ä¹¦é¢å‘æœºæ„:

Java ä¿¡ä»»åº“å¯ä»¥ä½¿ç”¨ JDK é™„å¸¦çš„ [keytool](https://docs.oracle.com/javase/6/docs/technotes/tools/solaris/keytool.html) å®ç”¨ç¨‹åºè¿›è¡Œç®¡ç†.

è¿˜éœ€æä¾›ä¿¡ä»»åº“çš„å¯†ç :

```java
NetServerOptions options = new NetServerOptions().
  setSsl(true).
  setClientAuth(ClientAuth.REQUIRED).
  setTrustStoreOptions(
    new JksOptions().
      setPath("/path/to/your/truststore.jks").
      setPassword("password-of-your-truststore")
  );
NetServer server = vertx.createNetServer(options);
```

æˆ–è€…,æ‚¨å¯ä»¥è‡ªå·±è¯»å–ä¿¡ä»»å­˜å‚¨ä½œä¸ºç¼“å†²åŒºå¹¶ç›´æ¥æä¾›:

```java
Buffer myTrustStoreAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/truststore.jks");
NetServerOptions options = new NetServerOptions().
  setSsl(true).
  setClientAuth(ClientAuth.REQUIRED).
  setTrustStoreOptions(
    new JksOptions().
      setValue(myTrustStoreAsABuffer).
      setPassword("password-of-your-truststore")
  );
NetServer server = vertx.createNetServer(options);
```

`PKCS#12` æ ¼å¼çš„è¯ä¹¦é¢å‘æœºæ„([http://en.wikipedia.org/wiki/PKCS_12](https://en.wikipedia.org/wiki/PKCS_12)),é€šå¸¸ä½¿ç”¨ `.pfx` æˆ– `.p12` æ‰©å±•åä¹Ÿå¯ä»¥ä»¥ä¸ JKS ä¿¡ä»»å­˜å‚¨ç±»ä¼¼çš„æ–¹å¼åŠ è½½:

```java
NetServerOptions options = new NetServerOptions().
  setSsl(true).
  setClientAuth(ClientAuth.REQUIRED).
  setPfxTrustOptions(
    new PfxOptions().
      setPath("/path/to/your/truststore.pfx").
      setPassword("password-of-your-truststore")
  );
NetServer server = vertx.createNetServer(options);
```

è¿˜æ”¯æŒç¼“å†²åŒºé…ç½®:

```java
Buffer myTrustStoreAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/truststore.pfx");
NetServerOptions options = new NetServerOptions().
  setSsl(true).
  setClientAuth(ClientAuth.REQUIRED).
  setPfxTrustOptions(
    new PfxOptions().
      setValue(myTrustStoreAsABuffer).
      setPassword("password-of-your-truststore")
  );
NetServer server = vertx.createNetServer(options);
```

ä½¿ç”¨åˆ—è¡¨`.pem`æ–‡ä»¶æä¾›æœåŠ¡å™¨è¯ä¹¦æˆæƒçš„å¦ä¸€ç§æ–¹æ³•.

```java
NetServerOptions options = new NetServerOptions().
  setSsl(true).
  setClientAuth(ClientAuth.REQUIRED).
  setPemTrustOptions(
    new PemTrustOptions().
      addCertPath("/path/to/your/server-ca.pem")
  );
NetServer server = vertx.createNetServer(options);
```

è¿˜æ”¯æŒç¼“å†²åŒºé…ç½®:

```java
Buffer myCaAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/server-ca.pfx");
NetServerOptions options = new NetServerOptions().
  setSsl(true).
  setClientAuth(ClientAuth.REQUIRED).
  setPemTrustOptions(
    new PemTrustOptions().
      addCertValue(myCaAsABuffer)
  );
NetServer server = vertx.createNetServer(options);
```

#### åœ¨å®¢æˆ·ç«¯ä¸Šå¯ç”¨ SSL/TLS

Net å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥è½»æ¾é…ç½®ä¸ºä½¿ç”¨ SSL. å®ƒä»¬åœ¨ä½¿ç”¨ SSL æ—¶ä¸ä½¿ç”¨æ ‡å‡†å¥—æ¥å­—æ—¶å…·æœ‰å®Œå…¨ç›¸åŒçš„ API.

è¦åœ¨ NetClient ä¸Šå¯ç”¨ SSL,è°ƒç”¨å‡½æ•° `setSSL(true)`.

#### å®¢æˆ·ç«¯ä¿¡ä»»é…ç½®

å¦‚æœå®¢æˆ·ç«¯ä¸Šçš„`trustALL`è®¾ç½®ä¸º `true`,åˆ™å®¢æˆ·ç«¯å°†ä¿¡ä»»æ‰€æœ‰æœåŠ¡å™¨è¯ä¹¦. è¿æ¥ä»å°†è¢«åŠ å¯†,ä½†è¿™ç§æ¨¡å¼å®¹æ˜“å—åˆ°"ä¸­é—´äºº"æ”»å‡». IE. ä½ ä¸èƒ½ç¡®å®šä½ åœ¨è¿æ¥è°. è¯·è°¨æ…ä½¿ç”¨. é»˜è®¤å€¼ä¸º`false`.

```java
NetClientOptions options = new NetClientOptions().
  setSsl(true).
  setTrustAll(true);
NetClient client = vertx.createNetClient(options);
```

å¦‚æœæœªè®¾ç½®`trustAll`,åˆ™å¿…é¡»é…ç½®å®¢æˆ·ç«¯ä¿¡ä»»åº“,å¹¶ä¸”åº”åŒ…å«å®¢æˆ·ç«¯ä¿¡ä»»çš„æœåŠ¡å™¨çš„è¯ä¹¦.

é»˜è®¤æƒ…å†µä¸‹,å®¢æˆ·ç«¯ä¸Šç¦ç”¨ä¸»æœºéªŒè¯. è¦å¯ç”¨ä¸»æœºéªŒè¯,è¯·å°†ç®—æ³•è®¾ç½®ä¸ºåœ¨æ‚¨çš„å®¢æˆ·ç«¯ä¸Šä½¿ç”¨(ç›®å‰ä»…æ”¯æŒ HTTPS å’Œ LDAPS):

```java
NetClientOptions options = new NetClientOptions().
  setSsl(true).
  setHostnameVerificationAlgorithm("HTTPS");
NetClient client = vertx.createNetClient(options);
```

ä¸æœåŠ¡å™¨é…ç½®ç±»ä¼¼,å®¢æˆ·ç«¯ä¿¡ä»»å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼é…ç½®:

ç¬¬ä¸€ç§æ–¹æ³•æ˜¯æŒ‡å®šåŒ…å«è¯ä¹¦é¢å‘æœºæ„çš„ Java ä¿¡ä»»åº“çš„ä½ç½®.

å®ƒåªæ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Java å¯†é’¥åº“,ä¸æœåŠ¡å™¨ç«¯çš„å¯†é’¥åº“ç›¸åŒ. å®¢æˆ·ç«¯ä¿¡ä»»å­˜å‚¨ä½ç½®æ˜¯é€šè¿‡ä½¿ç”¨ `jks options` ä¸Šçš„å‡½æ•° `path` è®¾ç½®çš„. å¦‚æœæœåŠ¡å™¨åœ¨è¿æ¥æœŸé—´æä¾›ä¸åœ¨å®¢æˆ·ç«¯ä¿¡ä»»åº“ä¸­çš„è¯ä¹¦,åˆ™è¿æ¥å°è¯•å°†ä¸ä¼šæˆåŠŸ.

```java
NetClientOptions options = new NetClientOptions().
  setSsl(true).
  setTrustStoreOptions(
    new JksOptions().
      setPath("/path/to/your/truststore.jks").
      setPassword("password-of-your-truststore")
  );
NetClient client = vertx.createNetClient(options);
```

è¿˜æ”¯æŒç¼“å†²åŒºé…ç½®:

```java
Buffer myTrustStoreAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/truststore.jks");
NetClientOptions options = new NetClientOptions().
  setSsl(true).
  setTrustStoreOptions(
    new JksOptions().
      setValue(myTrustStoreAsABuffer).
      setPassword("password-of-your-truststore")
  );
NetClient client = vertx.createNetClient(options);
```

`PKCS#12` æ ¼å¼çš„è¯ä¹¦é¢å‘æœºæ„([http://en.wikipedia.org/wiki/PKCS_12](https://en.wikipedia.org/wiki/PKCS_12)),é€šå¸¸ä½¿ç”¨ `.pfx` æˆ– `.p12` æ‰©å±•åä¹Ÿå¯ä»¥ä»¥ä¸ JKS ä¿¡ä»»å­˜å‚¨ç±»ä¼¼çš„æ–¹å¼åŠ è½½:

```java
NetClientOptions options = new NetClientOptions().
  setSsl(true).
  setPfxTrustOptions(
    new PfxOptions().
      setPath("/path/to/your/truststore.pfx").
      setPassword("password-of-your-truststore")
  );
NetClient client = vertx.createNetClient(options);
```

è¿˜æ”¯æŒç¼“å†²åŒºé…ç½®:

```java
Buffer myTrustStoreAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/truststore.pfx");
NetClientOptions options = new NetClientOptions().
  setSsl(true).
  setPfxTrustOptions(
    new PfxOptions().
      setValue(myTrustStoreAsABuffer).
      setPassword("password-of-your-truststore")
  );
NetClient client = vertx.createNetClient(options);
```

ä½¿ç”¨åˆ—è¡¨`.pem`æ–‡ä»¶æä¾›æœåŠ¡å™¨è¯ä¹¦æˆæƒçš„å¦ä¸€ç§æ–¹æ³•.

```java
NetClientOptions options = new NetClientOptions().
  setSsl(true).
  setPemTrustOptions(
    new PemTrustOptions().
      addCertPath("/path/to/your/ca-cert.pem")
  );
NetClient client = vertx.createNetClient(options);
```

è¿˜æ”¯æŒç¼“å†²åŒºé…ç½®:

```java
Buffer myTrustStoreAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/ca-cert.pem");
NetClientOptions options = new NetClientOptions().
  setSsl(true).
  setPemTrustOptions(
    new PemTrustOptions().
      addCertValue(myTrustStoreAsABuffer)
  );
NetClient client = vertx.createNetClient(options);
```

#### ä¸ºå®¢æˆ·ç«¯æŒ‡å®šå¯†é’¥/è¯ä¹¦

å¦‚æœæœåŠ¡å™¨éœ€è¦å®¢æˆ·ç«¯èº«ä»½éªŒè¯,åˆ™å®¢æˆ·ç«¯åœ¨è¿æ¥æ—¶å¿…é¡»å‘æœåŠ¡å™¨å‡ºç¤ºè‡ªå·±çš„è¯ä¹¦. å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è¿›è¡Œé…ç½®:

ç¬¬ä¸€ç§æ–¹æ³•æ˜¯æŒ‡å®šåŒ…å«å¯†é’¥å’Œè¯ä¹¦çš„ Java å¯†é’¥åº“çš„ä½ç½®. åŒæ ·,å®ƒåªæ˜¯ä¸€ä¸ªæ™®é€šçš„ Java å¯†é’¥åº“. å®¢æˆ·ç«¯å¯†é’¥åº“ä½ç½®æ˜¯é€šè¿‡ä½¿ç”¨ `jks options` ä¸Šçš„å‡½æ•° `path` è®¾ç½®çš„.

```java
NetClientOptions options = new NetClientOptions().setSsl(true).setKeyStoreOptions(
  new JksOptions().
    setPath("/path/to/your/client-keystore.jks").
    setPassword("password-of-your-keystore")
);
NetClient client = vertx.createNetClient(options);
```

è¿˜æ”¯æŒç¼“å†²åŒºé…ç½®:

```java
Buffer myKeyStoreAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/client-keystore.jks");
JksOptions jksOptions = new JksOptions().
  setValue(myKeyStoreAsABuffer).
  setPassword("password-of-your-keystore");
NetClientOptions options = new NetClientOptions().
  setSsl(true).
  setKeyStoreOptions(jksOptions);
NetClient client = vertx.createNetClient(options);
```

`PKCS#12` æ ¼å¼çš„å¯†é’¥/è¯ä¹¦([http://en.wikipedia.org/wiki/PKCS_12](https://en.wikipedia.org/wiki/PKCS_12)),é€šå¸¸ä½¿ç”¨ `.pfx` æˆ–è€… `.p12` æ‰©å±•åä¹Ÿå¯ä»¥ä»¥ä¸ JKS å¯†é’¥å­˜å‚¨ç±»ä¼¼çš„æ–¹å¼åŠ è½½:

```java
NetClientOptions options = new NetClientOptions().setSsl(true).setPfxKeyCertOptions(
  new PfxOptions().
    setPath("/path/to/your/client-keystore.pfx").
    setPassword("password-of-your-keystore")
);
NetClient client = vertx.createNetClient(options);
```

è¿˜æ”¯æŒç¼“å†²åŒºé…ç½®:

```java
Buffer myKeyStoreAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/client-keystore.pfx");
PfxOptions pfxOptions = new PfxOptions().
  setValue(myKeyStoreAsABuffer).
  setPassword("password-of-your-keystore");
NetClientOptions options = new NetClientOptions().
  setSsl(true).
  setPfxKeyCertOptions(pfxOptions);
NetClient client = vertx.createNetClient(options);
```

å¦ä¸€ç§ä½¿ç”¨`.pem`æ–‡ä»¶åˆ†åˆ«æä¾›æœåŠ¡å™¨ç§é’¥å’Œè¯ä¹¦çš„æ–¹æ³•.

```java
NetClientOptions options = new NetClientOptions().setSsl(true).setPemKeyCertOptions(
  new PemKeyCertOptions().
    setKeyPath("/path/to/your/client-key.pem").
    setCertPath("/path/to/your/client-cert.pem")
);
NetClient client = vertx.createNetClient(options);
```

è¿˜æ”¯æŒç¼“å†²åŒºé…ç½®:

```java
Buffer myKeyAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/client-key.pem");
Buffer myCertAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/client-cert.pem");
PemKeyCertOptions pemOptions = new PemKeyCertOptions().
  setKeyValue(myKeyAsABuffer).
  setCertValue(myCertAsABuffer);
NetClientOptions options = new NetClientOptions().
  setSsl(true).
  setPemKeyCertOptions(pemOptions);
NetClient client = vertx.createNetClient(options);
```

è¯·è®°ä½,åœ¨pemé…ç½®ä¸­,ç§é’¥æ˜¯ä¸åŠ å¯†çš„.

#### ç”¨äºæµ‹è¯•å’Œå¼€å‘ç›®çš„çš„è‡ªç­¾åè¯ä¹¦

> **âš å°å¿ƒ:** ä¸è¦åœ¨ç”Ÿäº§è®¾ç½®ä¸­ä½¿ç”¨å®ƒ,å¹¶æ³¨æ„ç”Ÿæˆçš„å¯†é’¥éå¸¸ä¸å®‰å…¨.

é€šå¸¸éœ€è¦è‡ªç­¾åè¯ä¹¦,æ— è®ºæ˜¯ç”¨äºå•å…ƒ/é›†æˆæµ‹è¯•è¿˜æ˜¯è¿è¡Œåº”ç”¨ç¨‹åºçš„å¼€å‘ç‰ˆæœ¬.

`SelfSignedCertificate`å¯ä»¥ç”¨æ¥æä¾›è‡ªç­¾åçš„PEMè¯ä¹¦åŠ©æ‰‹,å¹¶æä¾›`KeyCertOptions` å’Œ `TrustOptions`é…ç½®:

```java
SelfSignedCertificate certificate = SelfSignedCertificate.create();

NetServerOptions serverOptions = new NetServerOptions()
  .setSsl(true)
  .setKeyCertOptions(certificate.keyCertOptions())
  .setTrustOptions(certificate.trustOptions());

vertx.createNetServer(serverOptions)
  .connectHandler(socket -> socket.end(Buffer.buffer("Hello!")))
  .listen(1234, "localhost");

NetClientOptions clientOptions = new NetClientOptions()
  .setSsl(true)
  .setKeyCertOptions(certificate.keyCertOptions())
  .setTrustOptions(certificate.trustOptions());

NetClient client = vertx.createNetClient(clientOptions);
client.connect(1234, "localhost", ar -> {
  if (ar.succeeded()) {
    ar.result().handler(buffer -> System.out.println(buffer));
  } else {
    System.err.println("Woops: " + ar.cause().getMessage());
  }
});
```

å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥é…ç½®ä¸ºä¿¡ä»»æ‰€æœ‰è¯ä¹¦:

```java
NetClientOptions clientOptions = new NetClientOptions()
  .setSsl(true)
  .setTrustAll(true);
```

è¯·æ³¨æ„,è‡ªç­¾åè¯ä¹¦ä¹Ÿé€‚ç”¨äº HTTPS ç­‰å…¶ä»– TCP åè®®:

```java
SelfSignedCertificate certificate = SelfSignedCertificate.create();

vertx.createHttpServer(new HttpServerOptions()
  .setSsl(true)
  .setKeyCertOptions(certificate.keyCertOptions())
  .setTrustOptions(certificate.trustOptions()))
  .requestHandler(req -> req.response().end("Hello!"))
  .listen(8080);
```

#### æ’¤é”€è¯ä¹¦é¢å‘æœºæ„

å¯ä»¥å°†ä¿¡ä»»é…ç½®ä¸ºä½¿ç”¨è¯ä¹¦åŠé”€åˆ—è¡¨ (CRL) æ¥å¤„ç†ä¸åº”å†å—ä¿¡ä»»çš„åŠé”€è¯ä¹¦. `crlPath` é…ç½® crl åˆ—è¡¨ä»¥ä½¿ç”¨:

```java
NetClientOptions options = new NetClientOptions().
  setSsl(true).
  setTrustStoreOptions(trustOptions).
  addCrlPath("/path/to/your/crl.pem");
NetClient client = vertx.createNetClient(options);
```

è¿˜æ”¯æŒç¼“å†²åŒºé…ç½®:

```java
Buffer myCrlAsABuffer = vertx.fileSystem().readFileBlocking("/path/to/your/crl.pem");
NetClientOptions options = new NetClientOptions().
  setSsl(true).
  setTrustStoreOptions(trustOptions).
  addCrlValue(myCrlAsABuffer);
NetClient client = vertx.createNetClient(options);
```

#### é…ç½®åŠ å¯†å¥—ä»¶

é»˜è®¤æƒ…å†µä¸‹,TLSé…ç½®å°†ä½¿ç”¨SSLå¼•æ“çš„Cipherå¥—ä»¶åˆ—è¡¨:

- ä½¿ç”¨ `JdkSSLEngineOptions` æ—¶çš„ JDK SSL å¼•æ“
- ä½¿ç”¨ `OpenSSLEngineOptions` æ—¶çš„ OpenSSL å¼•æ“

æ­¤Cipherå¥—ä»¶å¯ä»¥ä½¿ç”¨ä¸€ç»„å¯ç”¨çš„å¯†ç è¿›è¡Œé…ç½®:

```java
NetServerOptions options = new NetServerOptions().
  setSsl(true).
  setKeyStoreOptions(keyStoreOptions).
  addEnabledCipherSuite("ECDHE-RSA-AES128-GCM-SHA256").
  addEnabledCipherSuite("ECDHE-ECDSA-AES128-GCM-SHA256").
  addEnabledCipherSuite("ECDHE-RSA-AES256-GCM-SHA384").
  addEnabledCipherSuite("CDHE-ECDSA-AES256-GCM-SHA384");
NetServer server = vertx.createNetServer(options);
```

å½“å¯ç”¨çš„å¯†ç å¥—ä»¶è¢«å®šä¹‰(å³éç©º)æ—¶,å®ƒä¼˜å…ˆäº SSL å¼•æ“çš„é»˜è®¤å¯†ç å¥—ä»¶.

å¯†ç å¥—ä»¶å¯ä»¥åœ¨ `NetServerOptions` æˆ– `NetClientOptions` é…ç½®ä¸­æŒ‡å®š.

#### é…ç½® TLS åè®®ç‰ˆæœ¬

é»˜è®¤æƒ…å†µä¸‹,TLSé…ç½®å°†ä½¿ç”¨å¦‚ä¸‹åè®®ç‰ˆæœ¬:`SSLv2Hello`,`TLSv1`,T`LSv1.1`å’Œ`TLSv1.2`.åè®®ç‰ˆæœ¬å¯ä»¥é€šè¿‡æ˜¾å¼æ·»åŠ å¯ç”¨çš„åè®®æ¥é…ç½®:

```java
NetServerOptions options = new NetServerOptions().
  setSsl(true).
  setKeyStoreOptions(keyStoreOptions).
  removeEnabledSecureTransportProtocol("TLSv1").
  addEnabledSecureTransportProtocol("TLSv1.3");
NetServer server = vertx.createNetServer(options);
```

åè®®ç‰ˆæœ¬å¯ä»¥åœ¨ `NetServerOptions` æˆ– `NetClientOptions` é…ç½®ä¸­æŒ‡å®š.

#### SSL å¼•æ“

å¼•æ“å®ç°å¯ä»¥é…ç½®ä¸ºä½¿ç”¨ [OpenSSL](https://www.openssl.org/) è€Œä¸æ˜¯ JDK å®ç°. OpenSSL æä¾›æ¯” JDK å¼•æ“æ›´å¥½çš„æ€§èƒ½å’Œ CPU ä½¿ç”¨ç‡,ä»¥åŠ JDK ç‰ˆæœ¬ç‹¬ç«‹æ€§.

è¦ä½¿ç”¨çš„å¼•æ“é€‰é¡¹æ˜¯

- è®¾ç½®æ—¶çš„ `getSslEngineOptions` é€‰é¡¹
- å¦åˆ™`JdkSSLEngineOptions`

```java
NetServerOptions options = new NetServerOptions().
  setSsl(true).
  setKeyStoreOptions(keyStoreOptions);

// Use JDK SSL engine explicitly
options = new NetServerOptions().
  setSsl(true).
  setKeyStoreOptions(keyStoreOptions).
  setJdkSslEngineOptions(new JdkSSLEngineOptions());

// Use OpenSSL engine
options = new NetServerOptions().
  setSsl(true).
  setKeyStoreOptions(keyStoreOptions).
  setOpenSslEngineOptions(new OpenSSLEngineOptions());
```

#### æœåŠ¡å™¨åç§°æŒ‡ç¤º (SNI)

æœåŠ¡å™¨åç§°æŒ‡ç¤º (SNI) æ˜¯ TLS æ‰©å±•,å®¢æˆ·ç«¯é€šè¿‡å®ƒæŒ‡å®šå°è¯•è¿æ¥çš„ä¸»æœºå:åœ¨ TLS æ¡æ‰‹æœŸé—´,å®¢æˆ·ç«¯æä¾›æœåŠ¡å™¨åç§°,æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨å®ƒæ¥å“åº”æ­¤æœåŠ¡å™¨åç§°çš„ç‰¹å®šè¯ä¹¦,è€Œä¸æ˜¯ é»˜è®¤éƒ¨ç½²çš„è¯ä¹¦. å¦‚æœæœåŠ¡å™¨éœ€è¦å®¢æˆ·ç«¯èº«ä»½éªŒè¯,åˆ™æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨ç‰¹å®šçš„å—ä¿¡ä»» CA è¯ä¹¦,å…·ä½“å–å†³äºæŒ‡å®šçš„æœåŠ¡å™¨åç§°.

å½“ SNI å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶,æœåŠ¡å™¨ä½¿ç”¨

- è¯ä¹¦ CN æˆ– SAN DNS(ä¸»é¢˜å¤‡ç”¨åç§°ä¸ DNS)è¿›è¡Œå®Œå…¨åŒ¹é…,ä¾‹å¦‚`www.example.com`
- è¯ä¹¦ CN æˆ– SAN DNS è¯ä¹¦ä»¥åŒ¹é…é€šé…ç¬¦åç§°,ä¾‹å¦‚ `*.example.com`
- å¦åˆ™å®¢æˆ·ç«¯ä¸æä¾›æœåŠ¡å™¨åç§°æˆ–æä¾›çš„æœåŠ¡å™¨åç§°æ— æ³•åŒ¹é…æ—¶çš„ç¬¬ä¸€ä¸ªè¯ä¹¦

å½“æœåŠ¡å™¨å¦å¤–éœ€è¦å®¢æˆ·ç«¯è®¤è¯æ—¶:

- å¦‚æœ `JksOptions` ç”¨äºè®¾ç½®ä¿¡ä»»é€‰é¡¹(`options`),åˆ™ä¸ä¿¡ä»»åº“åˆ«åå®Œå…¨åŒ¹é…
- å¦åˆ™,å¯ç”¨çš„ CA è¯ä¹¦çš„ä½¿ç”¨æ–¹å¼ä¸æ²¡æœ‰ SNI çš„æ–¹å¼ç›¸åŒ

æ‚¨å¯ä»¥é€šè¿‡å°†`setSni`è®¾ç½®ä¸º`true`å¹¶ä¸ºæœåŠ¡å™¨é…ç½®å¤šä¸ªå¯†é’¥/è¯ä¹¦å¯¹æ¥å¯ç”¨æœåŠ¡å™¨ä¸Šçš„ SNI.

Java KeyStore æ–‡ä»¶æˆ– PKCS12 æ–‡ä»¶å¯ä»¥å­˜å‚¨å¤šä¸ªå¼€ç®±å³ç”¨çš„å¯†é’¥/è¯ä¹¦å¯¹.

```java
JksOptions keyCertOptions = new JksOptions().setPath("keystore.jks").setPassword("wibble");

NetServer netServer = vertx.createNetServer(new NetServerOptions()
    .setKeyStoreOptions(keyCertOptions)
    .setSsl(true)
    .setSni(true)
);
```

`PemKeyCertOptions` å¯ä»¥é…ç½®ä¸ºä¿å­˜å¤šä¸ªæ¡ç›®:

```java
PemKeyCertOptions keyCertOptions = new PemKeyCertOptions()
    .setKeyPaths(Arrays.asList("default-key.pem", "host1-key.pem", "etc..."))
    .setCertPaths(Arrays.asList("default-cert.pem", "host2-key.pem", "etc...")
    );

NetServer netServer = vertx.createNetServer(new NetServerOptions()
    .setPemKeyCertOptions(keyCertOptions)
    .setSsl(true)
    .setSni(true)
);
```

å®¢æˆ·ç«¯å°†è¿æ¥ä¸»æœºä½œä¸ºå®Œå…¨é™å®šåŸŸå (FQDN) çš„ SNI æœåŠ¡å™¨åç§°éšå¼å‘é€.

æ‚¨å¯ä»¥åœ¨è¿æ¥å¥—æ¥å­—æ—¶æä¾›æ˜ç¡®çš„æœåŠ¡å™¨åç§°

```java
NetClient client = vertx.createNetClient(new NetClientOptions()
    .setTrustStoreOptions(trustOptions)
    .setSsl(true)
);

// Connect to 'localhost' and present 'server.name' server name
client.connect(1234, "localhost", "server.name", res -> {
  if (res.succeeded()) {
    System.out.println("Connected!");
    NetSocket socket = res.result();
  } else {
    System.out.println("Failed to connect: " + res.cause().getMessage());
  }
});
```

å®ƒå¯ä»¥ç”¨äºä¸åŒçš„ç›®çš„:

- æä¾›ä¸æœåŠ¡å™¨ä¸»æœºä¸åŒçš„æœåŠ¡å™¨åç§°
- åœ¨è¿æ¥åˆ° IP æ—¶æ˜¾ç¤ºæœåŠ¡å™¨åç§°
- ä½¿ç”¨çŸ­åç§°æ—¶å¼ºåˆ¶æ˜¾ç¤ºæœåŠ¡å™¨åç§°

#### åº”ç”¨å±‚åè®®åå•† (ALPN)

åº”ç”¨å±‚åè®®åå•† (ALPN) æ˜¯åº”ç”¨å±‚åè®®åå•†çš„ TLS æ‰©å±•. å®ƒè¢« HTTP/2 ä½¿ç”¨:åœ¨ TLS æ¡æ‰‹æœŸé—´,å®¢æˆ·ç«¯ç»™å‡ºå®ƒæ¥å—çš„åº”ç”¨ç¨‹åºåè®®åˆ—è¡¨,æœåŠ¡å™¨ç”¨å®ƒæ”¯æŒçš„åè®®è¿›è¡Œå“åº”.

Java TLS æ”¯æŒ ALPN(æœ€æ–°ç‰ˆæœ¬çš„ Java 8).

##### OpenSSL ALPN æ”¯æŒ

OpenSSL è¿˜æ”¯æŒ(æœ¬æœº)ALPN.

OpenSSL éœ€è¦é…ç½® `setOpenSslEngineOptions` å¹¶åœ¨ç±»è·¯å¾„ä¸Šä½¿ç”¨ [netty-tcnative](http://netty.io/wiki/forked-tomcat-native.html) jar. ä½¿ç”¨ tcnative å¯èƒ½éœ€è¦åœ¨æ‚¨çš„æ“ä½œç³»ç»Ÿä¸Šå®‰è£… OpenSSL,å…·ä½“å–å†³äº tcnative å®ç°.

### ä½¿ç”¨ä»£ç†è¿›è¡Œå®¢æˆ·ç«¯è¿æ¥

`NetClient` æ”¯æŒ HTTP/1.x *CONNECT*,*SOCKS4a* æˆ– *SOCKS5* ä»£ç†.

å¯ä»¥é€šè¿‡è®¾ç½®åŒ…å«ä»£ç†ç±»å‹,ä¸»æœºå,ç«¯å£ä»¥åŠå¯é€‰çš„ç”¨æˆ·åå’Œå¯†ç çš„ `ProxyOptions` å¯¹è±¡åœ¨ `NetClientOptions` ä¸­é…ç½®ä»£ç†.

è¿™æ˜¯ä¸€ä¸ªä¾‹å­:

```java
NetClientOptions options = new NetClientOptions()
  .setProxyOptions(new ProxyOptions().setType(ProxyType.SOCKS5)
    .setHost("localhost").setPort(1080)
    .setUsername("username").setPassword("secret"));
NetClient client = vertx.createNetClient(options);
```

DNSè§£ææ€»æ˜¯åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šå®Œæˆ,è¦å®ç°SOCKS4å®¢æˆ·ç«¯çš„åŠŸèƒ½,éœ€è¦åœ¨æœ¬åœ°è§£æDNSåœ°å€.

æ‚¨å¯ä»¥ä½¿ç”¨ `setNonProxyHosts` æ¥é…ç½®ç»•è¿‡ä»£ç†çš„ä¸»æœºåˆ—è¡¨. åˆ—è¡¨æ¥å— `*` é€šé…ç¬¦æ¥åŒ¹é…åŸŸ:

```java
NetClientOptions options = new NetClientOptions()
  .setProxyOptions(new ProxyOptions().setType(ProxyType.SOCKS5)
    .setHost("localhost").setPort(1080)
    .setUsername("username").setPassword("secret"))
  .addNonProxyHost("*.foo.com")
  .addNonProxyHost("localhost");
NetClient client = vertx.createNetClient(options);
```

### ä½¿ç”¨ HA ä»£ç†åè®®

[HA PROXY åè®®](https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt) æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹æ³•æ¥å®‰å…¨åœ°ä¼ è¾“è¿æ¥ä¿¡æ¯,ä¾‹å¦‚è·¨å¤šä¸ª NAT æˆ– TCP ä»£ç†å±‚çš„å®¢æˆ·ç«¯åœ°å€ .

å¯ä»¥é€šè¿‡è®¾ç½®é€‰é¡¹ `setUseProxyProtocol` å¹¶åœ¨ç±»è·¯å¾„ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–é¡¹æ¥å¯ç”¨ HA PROXY åè®®:

```xml
<dependency>
 <groupId>io.netty</groupId>
 <artifactId>netty-codec-haproxy</artifactId>
 <!--<version>Should align with netty version that Vert.x uses</version>-->
</dependency>
NetServerOptions options = new NetServerOptions().setUseProxyProtocol(true);
NetServer server = vertx.createNetServer(options);
server.connectHandler(so -> {
  // Print the actual client address provided by the HA proxy protocol instead of the proxy address
  System.out.println(so.remoteAddress());

  // Print the address of the proxy
  System.out.println(so.localAddress());
});
```

## ç¼–å†™ HTTP æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯

Vert.x å…è®¸æ‚¨è½»æ¾ç¼–å†™éé˜»å¡ HTTP å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨.

Vert.x æ”¯æŒ HTTP/1.0,HTTP/1.1 å’Œ HTTP/2 åè®®.

HTTP çš„åŸºæœ¬ API ä¸ HTTP/1.x å’Œ HTTP/2 ç›¸åŒ,ç‰¹å®šçš„ API åŠŸèƒ½å¯ç”¨äºå¤„ç† HTTP/2 åè®®.

### åˆ›å»º HTTP æœåŠ¡å™¨

ä½¿ç”¨æ‰€æœ‰é»˜è®¤é€‰é¡¹åˆ›å»º HTTP æœåŠ¡å™¨çš„æœ€ç®€å•æ–¹æ³•å¦‚ä¸‹:

```java
HttpServer server = vertx.createHttpServer();
```

### é…ç½® HTTP æœåŠ¡å™¨

å¦‚æœæ‚¨ä¸æƒ³è¦é»˜è®¤å€¼,å¯ä»¥é€šè¿‡åœ¨åˆ›å»ºæœåŠ¡å™¨æ—¶ä¼ å…¥ä¸€ä¸ª `HttpServerOptions` å®ä¾‹æ¥é…ç½®æœåŠ¡å™¨:

```java
HttpServerOptions options = new HttpServerOptions().setMaxWebSocketFrameSize(1000000);

HttpServer server = vertx.createHttpServer(options);
```

### é…ç½® HTTP/2 æœåŠ¡å™¨

Vert.x é€šè¿‡ TLS `h2` å’Œ TCP `h2c` æ”¯æŒ HTTP/2.

- `h2` æ ‡è¯† HTTP/2 åè®®åœ¨é€šè¿‡ [åº”ç”¨å±‚åè®®åå•†](https://en.wikipedia.org/wiki/Application-Layer_Protocol_Negotiation) (ALPN) åå•†çš„ TLS ä¸Šä½¿ç”¨
- `h2c` åœ¨ TCP ä¸Šä»¥æ˜æ–‡å½¢å¼ä½¿ç”¨æ—¶æ ‡è¯† HTTP/2 åè®®,æ­¤ç±»è¿æ¥æ˜¯é€šè¿‡ HTTP/1.1 å‡çº§è¯·æ±‚æˆ–ç›´æ¥å»ºç«‹çš„

è¦å¤„ç† `h2` è¯·æ±‚,TLS å¿…é¡»ä¸ `setUseAlpn` ä¸€èµ·å¯ç”¨:

```java
HttpServerOptions options = new HttpServerOptions()
    .setUseAlpn(true)
    .setSsl(true)
    .setKeyStoreOptions(new JksOptions().setPath("/path/to/my/keystore"));

HttpServer server = vertx.createHttpServer(options);
```

ALPN æ˜¯ä¸€ç§ TLS æ‰©å±•,å®ƒåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¼€å§‹äº¤æ¢æ•°æ®ä¹‹å‰åå•†åè®®.

ä¸æ”¯æŒ ALPN çš„å®¢æˆ·ç«¯ä»ç„¶å¯ä»¥è¿›è¡Œ*ç»å…¸* SSL æ¡æ‰‹.

ALPN é€šå¸¸ä¼šåŒæ„ `h2` åè®®,å°½ç®¡å¦‚æœæœåŠ¡å™¨æˆ–å®¢æˆ·ç«¯å†³å®šä½¿ç”¨ `http/1.1` å¯ä»¥ä½¿ç”¨.

è¦å¤„ç† `h2c` è¯·æ±‚,å¿…é¡»ç¦ç”¨ TLS,æœåŠ¡å™¨å°†å‡çº§åˆ° HTTP/2 ä»»ä½•æƒ³è¦å‡çº§åˆ° HTTP/2 çš„ HTTP/1.1 è¯·æ±‚. å®ƒè¿˜å°†æ¥å—ä»¥ `PRI * HTTP/2.0\r\nSM\r\n` å‰è¨€å¼€å¤´çš„ç›´æ¥ `h2c` è¿æ¥.

> **â˜¢è­¦å‘Š:** å¤§å¤šæ•°æµè§ˆå™¨ä¸æ”¯æŒ `h2c`,å› æ­¤å¯¹äºæœåŠ¡ç½‘ç«™,æ‚¨åº”è¯¥ä½¿ç”¨ `h2` è€Œä¸æ˜¯ `h2c`.

å½“æœåŠ¡å™¨æ¥å— HTTP/2 è¿æ¥æ—¶,å®ƒä¼šå°†å…¶"åˆå§‹è®¾ç½®"å‘é€ç»™å®¢æˆ·ç«¯. è¿™äº›è®¾ç½®å®šä¹‰äº†å®¢æˆ·ç«¯å¦‚ä½•ä½¿ç”¨è¿æ¥,æœåŠ¡å™¨çš„é»˜è®¤åˆå§‹è®¾ç½®æ˜¯:

- `getMaxConcurrentStreams`:HTTP/2 RFC æ¨èçš„ `100`
- å…¶ä»–çš„é»˜è®¤ HTTP/2 è®¾ç½®å€¼

### è®°å½•ç½‘ç»œæœåŠ¡å™¨æ´»åŠ¨

å‡ºäºè°ƒè¯•ç›®çš„,å¯ä»¥è®°å½•ç½‘ç»œæ´»åŠ¨.

```java
HttpServerOptions options = new HttpServerOptions().setLogActivity(true);

HttpServer server = vertx.createHttpServer(options);
```

æœ‰å…³è¯¦ç»†è¯´æ˜,è¯·å‚é˜…æœ‰å…³ [è®°å½•ç½‘ç»œæ´»åŠ¨](#logging_network_activity) çš„ç« èŠ‚.

### å¯åŠ¨æœåŠ¡å™¨ç›‘å¬

è¦å‘Šè¯‰æœåŠ¡å™¨ç›‘å¬ä¼ å…¥çš„è¯·æ±‚,æ‚¨å¯ä»¥ä½¿ç”¨`listen`é€‰é¡¹ä¹‹ä¸€.

å‘Šè¯‰æœåŠ¡å™¨ç›‘å¬é€‰é¡¹ä¸­æŒ‡å®šçš„ä¸»æœºå’Œç«¯å£:

```java
HttpServer server = vertx.createHttpServer();
server.listen();
```

æˆ–è€…åœ¨ç›‘å¬çš„è°ƒç”¨ä¸­æŒ‡å®šä¸»æœºå’Œç«¯å£,å¿½ç•¥é€‰é¡¹ä¸­é…ç½®çš„å†…å®¹:

```java
HttpServer server = vertx.createHttpServer();
server.listen(8080, "myhost.com");
```

é»˜è®¤ä¸»æœºæ˜¯`0.0.0.0`,æ„æ€æ˜¯"ç›‘å¬æ‰€æœ‰å¯ç”¨åœ°å€",é»˜è®¤ç«¯å£æ˜¯`80`.

å®é™…çš„ç»‘å®šæ˜¯å¼‚æ­¥çš„,å› æ­¤æœåŠ¡å™¨å¯èƒ½ç›´åˆ°**åœ¨**è°ƒç”¨ç›‘å¬è¿”å›åçš„æŸä¸ªæ—¶é—´æ‰çœŸæ­£åœ¨ç›‘å¬.

å¦‚æœæ‚¨æƒ³åœ¨æœåŠ¡å™¨å®é™…ç›‘å¬æ—¶æ”¶åˆ°é€šçŸ¥,æ‚¨å¯ä»¥ä¸º`listen`è°ƒç”¨æä¾›ä¸€ä¸ªå¤„ç†å™¨. ä¾‹å¦‚:

```java
HttpServer server = vertx.createHttpServer();
server.listen(8080, "myhost.com", res -> {
  if (res.succeeded()) {
    System.out.println("Server is now listening!");
  } else {
    System.out.println("Failed to bind!");
  }
});
```

### æ”¶åˆ°ä¼ å…¥è¯·æ±‚çš„é€šçŸ¥

è¦åœ¨è¯·æ±‚åˆ°è¾¾æ—¶æ”¶åˆ°é€šçŸ¥,æ‚¨éœ€è¦è®¾ç½®ä¸€ä¸ª`requestHandler`:

```java
HttpServer server = vertx.createHttpServer();
server.requestHandler(request -> {
  // Handle the request in here
});
```

### å¤„ç†è¯·æ±‚

å½“è¯·æ±‚åˆ°è¾¾æ—¶,è°ƒç”¨è¯·æ±‚å¤„ç†å™¨å¹¶ä¼ å…¥ä¸€ä¸ª `HttpServerRequest` çš„å®ä¾‹. æ­¤å¯¹è±¡è¡¨ç¤ºæœåŠ¡å™¨ç«¯ HTTP è¯·æ±‚.

å½“è¯·æ±‚çš„æ ‡å¤´å·²è¢«å®Œå…¨è¯»å–æ—¶,å°†è°ƒç”¨å¤„ç†å™¨.

å¦‚æœè¯·æ±‚åŒ…å«æ­£æ–‡,åˆ™è¯¥æ­£æ–‡å°†åœ¨è°ƒç”¨è¯·æ±‚å¤„ç†å™¨åçš„æŸä¸ªæ—¶é—´åˆ°è¾¾æœåŠ¡å™¨.

æœåŠ¡å™¨ request  å¯¹è±¡å…è®¸æ‚¨æ£€ç´¢ `uri`,`path`,`params` å’Œ `headers` ç­‰.

æ¯ä¸ªæœåŠ¡å™¨è¯·æ±‚å¯¹è±¡éƒ½ä¸ä¸€ä¸ªæœåŠ¡å™¨å“åº”å¯¹è±¡ç›¸å…³è”. æ‚¨ä½¿ç”¨ `response` æ¥è·å–å¯¹ `HttpServerResponse` å¯¹è±¡çš„å¼•ç”¨.

è¿™æ˜¯ä¸€ä¸ªæœåŠ¡å™¨å¤„ç†è¯·æ±‚å¹¶ç”¨"hello world"å›å¤å®ƒçš„ç®€å•ç¤ºä¾‹.

```java
vertx.createHttpServer().requestHandler(request -> {
  request.response().end("Hello world");
}).listen(8080);
```

#### Request version(ç‰ˆæœ¬)

å¯ä»¥ä½¿ç”¨ `version` æ£€ç´¢è¯·æ±‚ä¸­æŒ‡å®šçš„ HTTP ç‰ˆæœ¬

#### Request method(æ–¹æ³•)

ä½¿ç”¨ `method` æ£€ç´¢è¯·æ±‚çš„ HTTP æ–¹æ³•. (å³æ˜¯å¦æ˜¯ GET,POST,PUT,DELETE,HEAD,OPTIONS ç­‰).

#### Request URI

ä½¿ç”¨ `uri` æ£€ç´¢è¯·æ±‚çš„ URI.

è¯·æ³¨æ„,è¿™æ˜¯åœ¨ HTTP è¯·æ±‚ä¸­ä¼ é€’çš„å®é™… URI,å®ƒå‡ ä¹æ€»æ˜¯ä¸€ä¸ªç›¸å¯¹ URI.

URI å®šä¹‰åœ¨ [HTTP è§„èŒƒçš„ç¬¬ 5.1.2 èŠ‚ - Request-URI](https://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html)

#### Request path(è·¯å¾„)

ä½¿ç”¨ `path` è¿”å› URI çš„è·¯å¾„éƒ¨åˆ†

ä¾‹å¦‚,å¦‚æœè¯·æ±‚ URI æ˜¯ `a/b/c/page.html?param1=abc&param2=xyz`

é‚£ä¹ˆè·¯å¾„å°†æ˜¯`/a/b/c/page.html`

#### Request query(æŸ¥è¯¢)

ä½¿ç”¨ `query` è¿”å› URI çš„æŸ¥è¯¢éƒ¨åˆ†

For example, if the request URI was `a/b/c/page.html?param1=abc&param2=xyz`

Then the query would be `param1=abc&param2=xyz`

#### Request headers(æ ‡å¤´)

ä½¿ç”¨ `headers` è¿”å› HTTP è¯·æ±‚çš„æ ‡å¤´.

è¿™å°†è¿”å›ä¸€ä¸ª `MultiMap` çš„å®ä¾‹--å®ƒç±»ä¼¼äºä¸€ä¸ªæ™®é€šçš„ Map æˆ– Hash,ä½†å…è®¸åŒä¸€ä¸ªé”®æœ‰å¤šä¸ªå€¼--è¿™æ˜¯å› ä¸º HTTP å…è®¸å…·æœ‰ç›¸åŒé”®çš„å¤šä¸ªæ ‡å¤´å€¼.

å®ƒè¿˜å…·æœ‰ä¸åŒºåˆ†å¤§å°å†™çš„é”®,è¿™æ„å‘³ç€æ‚¨å¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œ:

```java
MultiMap headers = request.headers();

// Get the User-Agent:
System.out.println("User agent is " + headers.get("user-agent"));

// You can also do this and get the same result:
System.out.println("User agent is " + headers.get("User-Agent"));
```

#### Request host(ä¸»æœº)

ä½¿ç”¨ `host` è¿”å› HTTP è¯·æ±‚çš„ä¸»æœº.

å¯¹äº HTTP/1.x è¯·æ±‚,è¿”å› `host` æ ‡å¤´,å¯¹äº HTTP/1 è¯·æ±‚,è¿”å› `:authority` ä¼ªæ ‡å¤´.

#### Request parameters(å‚æ•°)

ä½¿ç”¨ `params` è¿”å› HTTP è¯·æ±‚çš„å‚æ•°.

å°±åƒ `headers` ä¸€æ ·,è¿™ä¼šè¿”å› `MultiMap` çš„ä¸€ä¸ªå®ä¾‹,å› ä¸ºå¯ä»¥æœ‰å¤šä¸ªå…·æœ‰ç›¸åŒåç§°çš„å‚æ•°.

è¯·æ±‚å‚æ•°åœ¨è·¯å¾„ä¹‹åçš„è¯·æ±‚ URI ä¸Šå‘é€. ä¾‹å¦‚,å¦‚æœ URI æ˜¯ `/page.html?param1=abc&param2=xyz`

ç„¶åå‚æ•°å°†åŒ…å«ä»¥ä¸‹å†…å®¹:

```
param1: 'abc'
param2: 'xyz
```

è¯·æ³¨æ„,è¿™äº›è¯·æ±‚å‚æ•°æ˜¯ä»è¯·æ±‚çš„ URL ä¸­æ£€ç´¢çš„. å¦‚æœæ‚¨çš„è¡¨å•å±æ€§å·²ä½œä¸ºæäº¤ HTML è¡¨å•çš„ä¸€éƒ¨åˆ†å‘é€åˆ°"multi-part/form-data"è¯·æ±‚çš„æ­£æ–‡ä¸­,é‚£ä¹ˆå®ƒä»¬å°†ä¸ä¼šå‡ºç°åœ¨æ­¤å¤„çš„å‚æ•°ä¸­.

#### è¿œç¨‹åœ°å€

å¯ä»¥ä½¿ç”¨ `remoteAddress` æ£€ç´¢è¯·æ±‚å‘é€è€…çš„åœ°å€.

#### ç»å¯¹ URI

åœ¨ HTTP è¯·æ±‚ä¸­ä¼ é€’çš„ URI é€šå¸¸æ˜¯ç›¸å¯¹çš„. å¦‚æœä½ æƒ³è·å–è¯·æ±‚å¯¹åº”çš„ç»å¯¹ URI,ä½ å¯ä»¥é€šè¿‡ `absoluteURI` è·å–

#### End handler(ç»“æŸ å¤„ç†å™¨)

å½“æ•´ä¸ªè¯·æ±‚(åŒ…æ‹¬ä»»ä½•æ­£æ–‡)å·²è¢«å®Œå…¨è¯»å–æ—¶,å°†è°ƒç”¨è¯·æ±‚çš„ `endHandler`.

#### ä» Request Body ä¸­è¯»å–æ•°æ®

é€šå¸¸ä¸€ä¸ª HTTP è¯·æ±‚åŒ…å«æˆ‘ä»¬æƒ³è¦è¯»å–çš„æ­£æ–‡. å¦‚å‰æ‰€è¿°,å½“åªæœ‰è¯·æ±‚çš„æ ‡å¤´åˆ°è¾¾æ—¶è°ƒç”¨è¯·æ±‚å¤„ç†å™¨,å› æ­¤è¯·æ±‚å¯¹è±¡æ­¤æ—¶æ²¡æœ‰æ­£æ–‡.

è¿™æ˜¯å› ä¸ºä¸»ä½“å¯èƒ½éå¸¸å¤§(ä¾‹å¦‚æ–‡ä»¶ä¸Šä¼ ),æˆ‘ä»¬é€šå¸¸ä¸å¸Œæœ›åœ¨å°†å…¶äº¤ç»™æ‚¨ä¹‹å‰å°†æ•´ä¸ªä¸»ä½“ç¼“å†²åœ¨å†…å­˜ä¸­,å› ä¸ºè¿™å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨è€—å°½å¯ç”¨å†…å­˜.

è¦æ¥æ”¶æ­£æ–‡,æ‚¨å¯ä»¥åœ¨è¯·æ±‚ä¸Šä½¿ç”¨`handler`,æ¯æ¬¡è¯·æ±‚æ­£æ–‡çš„ä¸€éƒ¨åˆ†åˆ°è¾¾æ—¶éƒ½ä¼šè°ƒç”¨å®ƒ. è¿™æ˜¯ä¸€ä¸ªä¾‹å­:

```java
request.handler(buffer -> {
  System.out.println("I have received a chunk of the body of length " + buffer.length());
});
```

ä¼ å…¥å¤„ç†å™¨çš„å¯¹è±¡æ˜¯ä¸€ä¸ª `Buffer`,å½“æ•°æ®ä»ç½‘ç»œåˆ°è¾¾æ—¶,å¯ä»¥å¤šæ¬¡è°ƒç”¨å¤„ç†å™¨,å…·ä½“å–å†³äºä¸»ä½“çš„å¤§å°.

åœ¨æŸäº›æƒ…å†µä¸‹(ä¾‹å¦‚,å¦‚æœä¸»ä½“å¾ˆå°),æ‚¨å¯èƒ½å¸Œæœ›åœ¨å†…å­˜ä¸­èšåˆæ•´ä¸ªä¸»ä½“,å› æ­¤æ‚¨å¯ä»¥è‡ªå·±è¿›è¡Œèšåˆ,å¦‚ä¸‹æ‰€ç¤º:

```java
Buffer totalBuffer = Buffer.buffer();

request.handler(buffer -> {
  System.out.println("I have received a chunk of the body of length " + buffer.length());
  totalBuffer.appendBuffer(buffer);
});

request.endHandler(v -> {
  System.out.println("Full body received, length = " + totalBuffer.length());
});
```

è¿™æ˜¯å¾ˆå¸¸è§çš„æƒ…å†µ,Vert.x æä¾›äº†ä¸€ä¸ª `bodyHandler` æ¥ä¸ºæ‚¨æ‰§è¡Œæ­¤æ“ä½œ. æ”¶åˆ°æ‰€æœ‰æ­£æ–‡å,å°†è°ƒç”¨ä¸€æ¬¡æ­£æ–‡å¤„ç†å™¨:

```java
request.bodyHandler(totalBuffer -> {
  System.out.println("Full body received, length = " + totalBuffer.length());
});
```

#### Streaming requests(æµå¼ä¼ è¾“è¯·æ±‚)

è¯·æ±‚å¯¹è±¡æ˜¯ä¸€ä¸ª`ReadStream`,å› æ­¤æ‚¨å¯ä»¥å°†è¯·æ±‚ä¸»ä½“é€šè¿‡ç®¡é“ä¼ è¾“åˆ°ä»»ä½•`WriteStream`å®ä¾‹.

æœ‰å…³è¯¦ç»†è¯´æ˜,è¯·å‚é˜…æœ‰å…³ [streams](#streams) çš„ç« èŠ‚.

#### å¤„ç† HTML è¡¨å•

HTML è¡¨å•å¯ä»¥ä½¿ç”¨ `application/x-www-form-urlencoded` æˆ– `multipart/form-data` çš„å†…å®¹ç±»å‹æäº¤.

å¯¹äº url ç¼–ç çš„è¡¨å•,è¡¨å•å±æ€§åœ¨ url ä¸­ç¼–ç ,å°±åƒæ™®é€šçš„æŸ¥è¯¢å‚æ•°ä¸€æ ·.

å¯¹äºå¤šéƒ¨åˆ†è¡¨å•,å®ƒä»¬åœ¨request bodyä¸­ç¼–ç ,å› æ­¤åœ¨ä»è¿æ¥è¯»å–æ•´ä¸ªrequest bodyä¹‹å‰æ˜¯ä¸å¯ç”¨çš„.

å¤šéƒ¨åˆ†è¡¨å•(Multi-part forms)è¿˜å¯ä»¥åŒ…å«æ–‡ä»¶ä¸Šä¼ .

å¦‚æœæ‚¨æƒ³æ£€ç´¢å¤šéƒ¨åˆ†è¡¨å•çš„å±æ€§,æ‚¨åº”è¯¥å‘Šè¯‰ Vert.x é€šè¿‡è°ƒç”¨ä¼ é€’`true`æ¥è°ƒç”¨`setExpectMultipart`,åœ¨è¯»å–ä»»ä½•bodyä¹‹å‰,ä½ åº”è¯¥æ”¶åˆ°è¿™æ ·ä¸€ä¸ªè¡¨å•,ç„¶ååœ¨è¯»å–æ•´ä¸ªbodyä¹‹å,ä½ åº”è¯¥ä½¿ç”¨`formAttributes`æ£€ç´¢å®é™…çš„å±æ€§:

```java
server.requestHandler(request -> {
  request.setExpectMultipart(true);
  request.endHandler(v -> {
    // The body has now been fully read, so retrieve the form attributes
    MultiMap formAttributes = request.formAttributes();
  });
});
```

è¡¨å•å±æ€§çš„æœ€å¤§å¤§å°ä¸º`8192`å­—èŠ‚. å½“å®¢æˆ·ç«¯æäº¤å±æ€§å¤§å°å¤§äºæ­¤å€¼çš„è¡¨å•æ—¶,æ–‡ä»¶ä¸Šä¼ ä¼šåœ¨ `HttpServerRequest` å¼‚å¸¸å¤„ç†å™¨ä¸Šè§¦å‘å¼‚å¸¸. æ‚¨å¯ä»¥ä½¿ç”¨ `setMaxFormAttributeSize` è®¾ç½®ä¸åŒçš„æœ€å¤§å°ºå¯¸.

#### å¤„ç†è¡¨å•æ–‡ä»¶ä¸Šä¼ 

Vert.x è¿˜å¯ä»¥å¤„ç†åœ¨å¤šéƒ¨åˆ†è¯·æ±‚æ­£æ–‡ä¸­ç¼–ç çš„æ–‡ä»¶ä¸Šä¼ .

è¦æ¥æ”¶æ–‡ä»¶ä¸Šä¼ ,ä½ å‘Šè¯‰ Vert.x æœŸå¾…ä¸€ä¸ªå¤šéƒ¨åˆ†çš„è¡¨å•å¹¶åœ¨è¯·æ±‚ä¸Šè®¾ç½®ä¸€ä¸ª`uploadHandler`.

å¯¹äºåˆ°è¾¾æœåŠ¡å™¨çš„æ¯ä¸ªä¸Šä¼ ,éƒ½ä¼šè°ƒç”¨ä¸€æ¬¡æ­¤å¤„ç†å™¨.

ä¼ é€’ç»™å¤„ç†å™¨çš„å¯¹è±¡æ˜¯ä¸€ä¸ª `HttpServerFileUpload` å®ä¾‹.

```java
server.requestHandler(request -> {
  request.setExpectMultipart(true);
  request.uploadHandler(upload -> {
    System.out.println("Got a file upload " + upload.name());
  });
});
```

æ–‡ä»¶ä¸Šä¼ å¯èƒ½å¾ˆå¤§,æˆ‘ä»¬ä¸ä¼šåœ¨å•ä¸ªç¼“å†²åŒºä¸­æä¾›æ•´ä¸ªä¸Šä¼ ,å› ä¸ºè¿™å¯èƒ½ä¼šå¯¼è‡´å†…å­˜è€—å°½,è€Œæ˜¯ä»¥å—çš„å½¢å¼æ¥æ”¶ä¸Šä¼ æ•°æ®:

```java
request.uploadHandler(upload -> {
  upload.handler(chunk -> {
    System.out.println("Received a chunk of the upload of length " + chunk.length());
  });
});
```

ä¸Šä¼ å¯¹è±¡æ˜¯ä¸€ä¸ª`ReadStream`,å› æ­¤æ‚¨å¯ä»¥å°†è¯·æ±‚æ­£æ–‡é€šè¿‡ç®¡é“ä¼ è¾“åˆ°ä»»ä½•`WriteStream`å®ä¾‹. æœ‰å…³è¯¦ç»†è¯´æ˜,è¯·å‚é˜…æœ‰å…³ [streams](#streams) çš„ç« èŠ‚.

å¦‚æœä½ åªæ˜¯æƒ³å°†æ–‡ä»¶ä¸Šä¼ åˆ°ç£ç›˜çš„æŸä¸ªåœ°æ–¹,ä½ å¯ä»¥ä½¿ç”¨`streamToFileSystem`:

```java
request.uploadHandler(upload -> {
  upload.streamToFileSystem("myuploads_directory/" + upload.filename());
});
```

> **â˜¢è­¦å‘Š:** ç¡®ä¿æ£€æŸ¥ç”Ÿäº§ç³»ç»Ÿä¸­çš„æ–‡ä»¶å,ä»¥é¿å…æ¶æ„å®¢æˆ·ç«¯å°†æ–‡ä»¶ä¸Šä¼ åˆ°æ–‡ä»¶ç³»ç»Ÿä¸Šçš„ä»»æ„ä½ç½®. æœ‰å…³è¯¦ç»†ä¿¡æ¯,è¯·å‚é˜… [å®‰å…¨è¯´æ˜](#_security_notes).

#### å¤„ç† cookie

æ‚¨å¯ä»¥ä½¿ç”¨ `getCookie` æŒ‰åç§°æ£€ç´¢ cookie,æˆ–ä½¿ç”¨ `cookieMap` æ£€ç´¢æ‰€æœ‰ cookie.

è¦åˆ é™¤ cookie,è¯·ä½¿ç”¨`removeCookie`.

è¦æ·»åŠ  cookie,è¯·ä½¿ç”¨ `addCookie`.

å½“å“åº”é£™å¤´è¢«å†™å…¥æ—¶,è¿™ç»„cookieå°†è¢«è‡ªåŠ¨å†™å›å“åº”ä¸­,ä»¥ä¾¿æµè§ˆå™¨å¯ä»¥å­˜å‚¨å®ƒä»¬.

Cookie ç”±`Cookie`å®ä¾‹æè¿°. è¿™å…è®¸æ‚¨æ£€ç´¢åç§°,å€¼,åŸŸ,è·¯å¾„å’Œå…¶ä»–æ­£å¸¸çš„ cookie å±æ€§.

ç›¸åŒç«™ç‚¹ Cookie è®©æœåŠ¡å™¨è¦æ±‚ cookie ä¸åº”ä¸è·¨ç«™ç‚¹(ç«™ç‚¹ç”±å¯æ³¨å†ŒåŸŸå®šä¹‰)è¯·æ±‚ä¸€èµ·å‘é€,è¿™æä¾›äº†ä¸€äº›é’ˆå¯¹è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ æ”»å‡»çš„ä¿æŠ¤. è¿™ç§ cookie æ˜¯ä½¿ç”¨ setter å¯ç”¨çš„:`setSameSite`.

ç›¸åŒçš„ç«™ç‚¹ cookie å¯ä»¥å…·æœ‰ 3 ä¸ªå€¼ä¹‹ä¸€:

- None - æµè§ˆå™¨å°†å‘é€å¸¦æœ‰è·¨ç«™ç‚¹è¯·æ±‚å’ŒåŒç«™ç‚¹è¯·æ±‚çš„ cookie.
- Strict - æµè§ˆå™¨åªä¼šä¸ºç›¸åŒç«™ç‚¹çš„è¯·æ±‚(æ¥è‡ªè®¾ç½® cookie çš„ç«™ç‚¹çš„è¯·æ±‚)å‘é€ cookie. å¦‚æœè¯·æ±‚æ¥è‡ªä¸å½“å‰ä½ç½®çš„ URL ä¸åŒçš„ URL,åˆ™ä¸ä¼šåŒ…å«ä»»ä½•å¸¦æœ‰ Strict å±æ€§æ ‡è®°çš„ cookie.
- Lax - åŒç«™ç‚¹ cookie åœ¨è·¨ç«™ç‚¹å­è¯·æ±‚(ä¾‹å¦‚åŠ è½½å›¾åƒæˆ–æ¡†æ¶çš„è°ƒç”¨)ä¸­è¢«ä¿ç•™,ä½†ä¼šåœ¨ç”¨æˆ·ä»å¤–éƒ¨ç«™ç‚¹å¯¼èˆªåˆ° URL æ—¶å‘é€; ä¾‹å¦‚,é€šè¿‡ç‚¹å‡»é“¾æ¥.

ä»¥ä¸‹æ˜¯æŸ¥è¯¢å’Œæ·»åŠ  cookie çš„ç¤ºä¾‹:

```java
Cookie someCookie = request.getCookie("mycookie");
String cookieValue = someCookie.getValue();

// Do something with cookie...

// Add a cookie - this will get written back in the response automatically
request.response().addCookie(Cookie.cookie("othercookie", "somevalue"));
```

#### Handling compressed body(å¤„ç†å‹ç¼©ä½“)

Vert.x å¯ä»¥å¤„ç†ç”±å®¢æˆ·ç«¯ä½¿ç”¨ *deflate* æˆ– *gzip* ç®—æ³•ç¼–ç çš„å‹ç¼©bodyæœ‰æ•ˆè´Ÿè½½.

è¦å¯ç”¨è§£å‹,åœ¨åˆ›å»ºæœåŠ¡å™¨æ—¶åœ¨é€‰é¡¹ä¸Šè®¾ç½®' setDecompressionSupported '.

é»˜è®¤æƒ…å†µä¸‹,è§£å‹ç¼©æ˜¯ç¦ç”¨çš„.

#### æ¥æ”¶è‡ªå®šä¹‰ HTTP/2 å¸§

HTTP/2 æ˜¯ä¸€ç§æ¡†æ¶åè®®,å…·æœ‰ç”¨äº HTTP è¯·æ±‚/å“åº”æ¨¡å‹çš„å„ç§æ¡†æ¶. è¯¥åè®®å…è®¸å‘é€å’Œæ¥æ”¶å…¶ä»–ç±»å‹çš„å¸§.

è¦æ¥æ”¶è‡ªå®šä¹‰å¸§,æ‚¨å¯ä»¥åœ¨è¯·æ±‚ä¸­ä½¿ç”¨`customFrameHandler`,æ¯æ¬¡è‡ªå®šä¹‰å¸§åˆ°è¾¾æ—¶éƒ½ä¼šè°ƒç”¨å®ƒ. è¿™æ˜¯ä¸€ä¸ªä¾‹å­:

```java
request.customFrameHandler(frame -> {

  System.out.println("Received a frame type=" + frame.type() +
      " payload" + frame.payload().toString());
});
```

HTTP/2 å¸§ä¸å—æµæ§åˆ¶ - å½“æ¥æ”¶åˆ°è‡ªå®šä¹‰å¸§æ—¶,æ— è®ºè¯·æ±‚æ˜¯å¦æš‚åœ,éƒ½ä¼šç«‹å³è°ƒç”¨å¸§å¤„ç†å™¨

### å‘å›å“åº”

æœåŠ¡å™¨å“åº”å¯¹è±¡æ˜¯ `HttpServerResponse` çš„ä¸€ä¸ªå®ä¾‹,æ˜¯ä»å¸¦æœ‰ `response` çš„è¯·æ±‚ä¸­è·å–çš„.

æ‚¨ä½¿ç”¨å“åº”å¯¹è±¡å°†å“åº”å†™å› HTTP å®¢æˆ·ç«¯.

#### è®¾ç½®çŠ¶æ€ç å’Œæ¶ˆæ¯

å“åº”çš„é»˜è®¤ HTTP çŠ¶æ€ä»£ç æ˜¯`200`,è¡¨ç¤º`OK`.

ä½¿ç”¨ `setStatusCode` è®¾ç½®ä¸åŒçš„ä»£ç .

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ `setStatusMessage` æŒ‡å®šè‡ªå®šä¹‰çŠ¶æ€æ¶ˆæ¯.

å¦‚æœæ‚¨ä¸æŒ‡å®šçŠ¶æ€æ¶ˆæ¯,å°†ä½¿ç”¨ä¸çŠ¶æ€ä»£ç å¯¹åº”çš„é»˜è®¤æ¶ˆæ¯.

> **ğŸ·æ³¨æ„:** å¯¹äº HTTP/2,å“åº”ä¸­ä¸ä¼šå‡ºç°çŠ¶æ€,å› ä¸ºåè®®ä¸ä¼šå°†æ¶ˆæ¯ä¼ è¾“åˆ°å®¢æˆ·ç«¯

#### ç¼–å†™ HTTP å“åº”

è¦å°†æ•°æ®å†™å…¥ HTTP å“åº”,è¯·ä½¿ç”¨`write`æ“ä½œä¹‹ä¸€.

è¿™äº›å¯ä»¥åœ¨å“åº”ç»“æŸä¹‹å‰å¤šæ¬¡è°ƒç”¨. å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ç§æ–¹å¼è°ƒç”¨å®ƒä»¬:

ä½¿ç”¨å•ä¸ªç¼“å†²åŒº:

```java
HttpServerResponse response = request.response();
response.write(buffer);
```

ç”¨ä¸€ä¸ªå­—ç¬¦ä¸². åœ¨è¿™ç§æƒ…å†µä¸‹,å­—ç¬¦ä¸²å°†ä½¿ç”¨ UTF-8 ç¼–ç å¹¶å°†ç»“æœå†™å…¥ç½‘ç»œ.

```java
HttpServerResponse response = request.response();
response.write("hello world!");
```

å¸¦æœ‰å­—ç¬¦ä¸²å’Œç¼–ç . åœ¨è¿™ç§æƒ…å†µä¸‹,å­—ç¬¦ä¸²å°†ä½¿ç”¨æŒ‡å®šçš„ç¼–ç è¿›è¡Œç¼–ç ,å¹¶å°†ç»“æœå†™å…¥ç½‘ç»œ.

```java
HttpServerResponse response = request.response();
response.write("hello world!", "UTF-16");
```

å†™å…¥å“åº”æ˜¯å¼‚æ­¥çš„,å¹¶ä¸”æ€»æ˜¯åœ¨å†™å…¥é˜Ÿåˆ—åç«‹å³è¿”å›.

å¦‚æœæ‚¨åªæ˜¯å°†å•ä¸ªå­—ç¬¦ä¸²æˆ–ç¼“å†²åŒºå†™å…¥ HTTP å“åº”,æ‚¨å¯ä»¥ç¼–å†™å®ƒå¹¶åœ¨ä¸€æ¬¡è°ƒç”¨ `end` æ—¶ç»“æŸå“åº”

ç¬¬ä¸€æ¬¡è°ƒç”¨ `write` å¯¼è‡´å°†å“åº”æ ‡å¤´å†™å…¥å“åº”. å› æ­¤,å¦‚æœæ‚¨ä¸ä½¿ç”¨ HTTP åˆ†å—,åˆ™å¿…é¡»åœ¨å†™å…¥å“åº”ä¹‹å‰è®¾ç½®`Content-Length`æ ‡å¤´,å¦åˆ™ä¸ºæ—¶å·²æ™š. å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ HTTP åˆ†å—,åˆ™ä¸å¿…æ‹…å¿ƒ.

#### ç»“æŸ HTTP å“åº”

ä¸€æ—¦ä½ å®Œæˆäº† HTTP å“åº”,ä½ åº”è¯¥`end`å®ƒ.

è¿™å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å®Œæˆ:

æ²¡æœ‰å‚æ•°,å“åº”å°±ç®€å•åœ°ç»“æŸäº†.

```java
HttpServerResponse response = request.response();
response.write("hello world!");
response.end();
```

å®ƒä¹Ÿå¯ä»¥ç”¨å­—ç¬¦ä¸²æˆ–ç¼“å†²åŒºè°ƒç”¨,å°±åƒè°ƒç”¨ `write` ä¸€æ ·. åœ¨è¿™ç§æƒ…å†µä¸‹,å®ƒä¸ä½¿ç”¨å­—ç¬¦ä¸²æˆ–ç¼“å†²åŒºè°ƒç”¨ `write` ä¹‹åè°ƒç”¨ä¸å¸¦å‚æ•°çš„ `end` ç›¸åŒ. ä¾‹å¦‚:

```java
HttpServerResponse response = request.response();
response.end("hello world!");
```

#### å…³é—­åº•å±‚è¿æ¥

æ‚¨å¯ä»¥ä½¿ç”¨ `close` å…³é—­åº•å±‚ TCP è¿æ¥.

å“åº”ç»“æŸæ—¶,Vert.x å°†è‡ªåŠ¨å…³é—­é`keep-alive`è¿æ¥.

é»˜è®¤æƒ…å†µä¸‹,Vert.x ä¸ä¼šè‡ªåŠ¨å…³é—­ Keep-alive è¿æ¥. å¦‚æœæ‚¨å¸Œæœ›åœ¨ç©ºé—²æ—¶é—´åå…³é—­ä¿æŒæ´»åŠ¨è¿æ¥,åˆ™é…ç½®`setIdleTimeout`.

HTTP/2 è¿æ¥åœ¨å…³é—­å“åº”ä¹‹å‰å‘é€ä¸€ä¸ª `{@literal GOAWAY}` å¸§.

#### è®¾ç½®å“åº”å¤´

HTTPå“åº”å¤´å¯ä»¥é€šè¿‡ç›´æ¥æ·»åŠ åˆ°`headers`çš„æ–¹å¼æ·»åŠ åˆ°å“åº”ä¸­:

```java
HttpServerResponse response = request.response();
MultiMap headers = response.headers();
headers.set("content-type", "text/html");
headers.set("other-header", "wibble");
```

ä½ ä¹Ÿå¯ä»¥ç”¨`putHeader`:

```java
HttpServerResponse response = request.response();
response.putHeader("content-type", "text/html").putHeader("other-header", "wibble");
```

> **ğŸ·æ³¨æ„:** å¿…é¡»åœ¨å†™å…¥å“åº”æ­£æ–‡çš„ä»»ä½•éƒ¨åˆ†ä¹‹å‰æ·»åŠ æ‰€æœ‰æ ‡å¤´.

#### åˆ†å—çš„ HTTP å“åº”å’Œå°¾éƒ¨

Vert.x æ”¯æŒ [HTTP åˆ†å—ä¼ è¾“ç¼–ç ](https://en.wikipedia.org/wiki/Chunked_transfer_encoding).

è¿™å…è®¸å°† HTTP å“åº”æ­£æ–‡ä»¥å—çš„å½¢å¼å†™å…¥,å¹¶ä¸”é€šå¸¸åœ¨å°†å¤§å‹å“åº”æ­£æ–‡æµå¼ä¼ è¾“åˆ°å®¢æˆ·ç«¯å¹¶ä¸”äº‹å…ˆä¸çŸ¥é“æ€»å¤§å°æ—¶ä½¿ç”¨.

æ‚¨å°† HTTP å“åº”ç½®äºåˆ†å—æ¨¡å¼,å¦‚ä¸‹æ‰€ç¤º:

```java
HttpServerResponse response = request.response();
response.setChunked(true);
```

é»˜è®¤ä¸ºéåˆ†å—. åœ¨åˆ†å—æ¨¡å¼ä¸‹,æ¯æ¬¡è°ƒç”¨`write`æ–¹æ³•ä¹‹ä¸€éƒ½ä¼šå¯¼è‡´ä¸€ä¸ªæ–°çš„ HTTP å—è¢«å†™å‡º.

åœ¨åˆ†å—æ¨¡å¼ä¸‹,æ‚¨è¿˜å¯ä»¥å°† HTTP å“åº”å°¾éƒ¨å†™å…¥å“åº”. è¿™äº›å®é™…ä¸Šæ˜¯å†™åœ¨å“åº”çš„æœ€åä¸€å—ä¸­.

> **ğŸ·æ³¨æ„:** åˆ†å—å“åº”å¯¹ HTTP/2 æµæ²¡æœ‰å½±å“

è¦å°†å°¾éƒ¨æ·»åŠ åˆ°å“åº”ä¸­,è¯·å°†å®ƒä»¬ç›´æ¥æ·»åŠ åˆ°`trailers`ä¸­.

```java
HttpServerResponse response = request.response();
response.setChunked(true);
MultiMap trailers = response.trailers();
trailers.set("X-wibble", "woobble").set("X-quux", "flooble");
```

æˆ–è€…ä½¿ç”¨ `putTrailer`.

```java
HttpServerResponse response = request.response();
response.setChunked(true);
response.putTrailer("X-wibble", "woobble").putTrailer("X-quux", "flooble");
```

#### ç›´æ¥ä»ç£ç›˜æˆ–ç±»è·¯å¾„æä¾›æ–‡ä»¶

å¦‚æœæ‚¨æ­£åœ¨ç¼–å†™ Web æœåŠ¡å™¨,ä»ç£ç›˜æä¾›æ–‡ä»¶çš„ä¸€ç§æ–¹æ³•æ˜¯å°†å…¶ä½œä¸º`AsyncFile`æ‰“å¼€å¹¶å°†å…¶é€šè¿‡ç®¡é“ä¼ è¾“åˆ° HTTP å“åº”.

æˆ–è€…ä½ å¯ä»¥ä½¿ç”¨`readFile`ä¸€æ¬¡æ€§åŠ è½½å®ƒå¹¶å°†å…¶ç›´æ¥å†™å…¥å“åº”.

æˆ–è€…,Vert.x æä¾›äº†ä¸€ç§æ–¹æ³•,å…è®¸æ‚¨åœ¨ä¸€æ¬¡æ“ä½œä¸­å°†æ–‡ä»¶ä»ç£ç›˜æˆ–æ–‡ä»¶ç³»ç»Ÿæä¾›ç»™ HTTP å“åº”. åœ¨åº•å±‚æ“ä½œç³»ç»Ÿæ”¯æŒçš„æƒ…å†µä¸‹,è¿™å¯èƒ½ä¼šå¯¼è‡´æ“ä½œç³»ç»Ÿç›´æ¥å°†å­—èŠ‚ä»æ–‡ä»¶ä¼ è¾“åˆ°å¥—æ¥å­—,è€Œæ ¹æœ¬ä¸ä¼šé€šè¿‡ç”¨æˆ·ç©ºé—´è¿›è¡Œå¤åˆ¶.

è¿™æ˜¯é€šè¿‡ä½¿ç”¨ `sendFile` å®Œæˆçš„,é€šå¸¸å¯¹äºå¤§æ–‡ä»¶æ›´æœ‰æ•ˆ,ä½†å¯¹äºå°æ–‡ä»¶å¯èƒ½ä¼šæ›´æ…¢.

è¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ Web æœåŠ¡å™¨,å®ƒä½¿ç”¨ sendFile ä»æ–‡ä»¶ç³»ç»Ÿæä¾›æ–‡ä»¶:

```java
vertx.createHttpServer().requestHandler(request -> {
  String file = "";
  if (request.path().equals("/")) {
    file = "index.html";
  } else if (!request.path().contains("..")) {
    file = request.path();
  }
  request.response().sendFile("web/" + file);
}).listen(8080);
```

å‘é€æ–‡ä»¶æ˜¯å¼‚æ­¥çš„,å¯èƒ½è¦ç­‰åˆ°è°ƒç”¨è¿”å›ä¸€æ®µæ—¶é—´åæ‰èƒ½å®Œæˆ. å¦‚æœæ‚¨æƒ³åœ¨æ–‡ä»¶å†™å…¥æ—¶æ”¶åˆ°é€šçŸ¥,å¯ä»¥ä½¿ç”¨`sendFile`

æœ‰å…³ç±»è·¯å¾„è§£ææˆ–ç¦ç”¨å®ƒçš„é™åˆ¶,è¯·å‚é˜…å…³äº [ä»ç±»è·¯å¾„æä¾›æ–‡ä»¶](#classpath) çš„ç« èŠ‚.

> **ğŸ·æ³¨æ„:** å¦‚æœæ‚¨åœ¨ä½¿ç”¨ HTTPS æ—¶ä½¿ç”¨`sendFile`,å®ƒå°†é€šè¿‡ç”¨æˆ·ç©ºé—´è¿›è¡Œå¤åˆ¶,å› ä¸ºå¦‚æœå†…æ ¸ç›´æ¥å°†æ•°æ®ä»ç£ç›˜å¤åˆ¶åˆ°å¥—æ¥å­—,å®ƒä¸ä¼šç»™æˆ‘ä»¬åº”ç”¨ä»»ä½•åŠ å¯†çš„æœºä¼š.

> **â˜¢è­¦å‘Š:** å¦‚æœæ‚¨æ‰“ç®—ç›´æ¥ä½¿ç”¨ Vert.x ç¼–å†™ Web æœåŠ¡å™¨,è¯·æ³¨æ„ç”¨æˆ·ä¸èƒ½åˆ©ç”¨è·¯å¾„è®¿é—®æ‚¨è¦ä¸ºå…¶æä¾›æœåŠ¡çš„ç›®å½•æˆ–ç±»è·¯å¾„ä¹‹å¤–çš„æ–‡ä»¶.ä½¿ç”¨ Vert.x Web æ¨¡å—å¯èƒ½æ›´å®‰å…¨.

å½“éœ€è¦åªæä¾›æ–‡ä»¶çš„ä¸€éƒ¨åˆ†æ—¶,ä¾‹å¦‚ä»ç»™å®šå­—èŠ‚å¼€å§‹,æ‚¨å¯ä»¥é€šè¿‡æ‰§è¡Œä»¥ä¸‹æ“ä½œæ¥å®ç°:

```java
vertx.createHttpServer().requestHandler(request -> {
  long offset = 0;
  try {
    offset = Long.parseLong(request.getParam("start"));
  } catch (NumberFormatException e) {
    // error handling...
  }

  long end = Long.MAX_VALUE;
  try {
    end = Long.parseLong(request.getParam("end"));
  } catch (NumberFormatException e) {
    // error handling...
  }

  request.response().sendFile("web/mybigfile.txt", offset, end);
}).listen(8080);
```

å¦‚æœè¦ä»åç§»é‡å¼€å§‹å‘é€æ–‡ä»¶ç›´åˆ°ç»“æŸ,åˆ™ä¸éœ€è¦æä¾›é•¿åº¦,åœ¨è¿™ç§æƒ…å†µä¸‹,æ‚¨å¯ä»¥è¿™æ ·åš:

```java
vertx.createHttpServer().requestHandler(request -> {
  long offset = 0;
  try {
    offset = Long.parseLong(request.getParam("start"));
  } catch (NumberFormatException e) {
    // error handling...
  }

  request.response().sendFile("web/mybigfile.txt", offset);
}).listen(8080);
```

#### ç®¡é“å“åº”

æœåŠ¡å™¨å“åº”æ˜¯ä¸€ä¸ª`WriteStream`,å› æ­¤æ‚¨å¯ä»¥ä»ä»»ä½•`ReadStream`é€šè¿‡ç®¡é“ä¼ è¾“åˆ°å®ƒ,ä¾‹å¦‚ `AsyncFile`,`NetSocket`,`WebSocket` æˆ– `HttpServerRequest`.

è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹,å®ƒåœ¨ä»»ä½• PUT æ–¹æ³•çš„å“åº”ä¸­å›æ˜¾è¯·æ±‚æ­£æ–‡. å®ƒä½¿ç”¨ç®¡é“ä½œä¸ºæ­£æ–‡,å› æ­¤å³ä½¿ HTTP è¯·æ±‚æ­£æ–‡å¤§äºä»»ä½•æ—¶å€™éƒ½å¯ä»¥æ”¾å…¥å†…å­˜ä¸­,å®ƒä¹Ÿå¯ä»¥å·¥ä½œ:

```java
vertx.createHttpServer().requestHandler(request -> {
  HttpServerResponse response = request.response();
  if (request.method() == HttpMethod.PUT) {
    response.setChunked(true);
    request.pipeTo(response);
  } else {
    response.setStatusCode(400).end();
  }
}).listen(8080);
```

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ `send` æ–¹æ³•å‘é€ `ReadStream`.

å‘é€æµæ˜¯ä¸€ç§ç®¡é“æ“ä½œ,ä½†æ˜¯ç”±äºè¿™æ˜¯ `HttpServerResponse` çš„ä¸€ç§æ–¹æ³•,å®ƒä¹Ÿä¼šåœ¨æœªè®¾ç½® `content-length` æ—¶è´Ÿè´£å¯¹å“åº”è¿›è¡Œåˆ†å—.

```java
vertx.createHttpServer().requestHandler(request -> {
  HttpServerResponse response = request.response();
  if (request.method() == HttpMethod.PUT) {
    response.send(request);
  } else {
    response.setStatusCode(400).end();
  }
}).listen(8080);
```

#### ç¼–å†™ HTTP/2 å¸§

HTTP/2 æ˜¯ä¸€ç§æ¡†æ¶åè®®,å…·æœ‰ç”¨äº HTTP è¯·æ±‚/å“åº”æ¨¡å‹çš„å„ç§æ¡†æ¶. è¯¥åè®®å…è®¸å‘é€å’Œæ¥æ”¶å…¶ä»–ç±»å‹çš„å¸§.

è¦å‘é€æ­¤ç±»å¸§,æ‚¨å¯ä»¥åœ¨å“åº”ä¸­ä½¿ç”¨ `writeCustomFrame`. ä¸‹é¢ä¸€ä¸ªä¾‹å­:

```java
int frameType = 40;
int frameStatus = 10;
Buffer payload = Buffer.buffer("some data");

// Sending a frame to the client
response.writeCustomFrame(frameType, frameStatus, payload);
```

è¿™äº›å¸§è¢«ç«‹å³å‘é€å¹¶ä¸”ä¸å—æµæ§åˆ¶ - å½“è¿™æ ·çš„å¸§è¢«å‘é€åˆ°é‚£é‡Œæ—¶,å®ƒå¯èƒ½åœ¨å…¶ä»– `{@literal DATA}` å¸§ä¹‹å‰å®Œæˆ.

#### æµé‡ç½®

HTTP/1.x ä¸å…è®¸å½»åº•é‡ç½®è¯·æ±‚æˆ–å“åº”æµ,ä¾‹å¦‚,å½“å®¢æˆ·ç«¯ä¸Šä¼ æœåŠ¡å™¨ä¸Šå·²ç»å­˜åœ¨çš„èµ„æºæ—¶,æœåŠ¡å™¨éœ€è¦æ¥å—æ•´ä¸ªå“åº”.

HTTP/2 æ”¯æŒåœ¨è¯·æ±‚/å“åº”æœŸé—´éšæ—¶é‡ç½®æµ:

```java
request.response().reset();
```

é»˜è®¤æƒ…å†µä¸‹,ä¼šå‘é€ `NO_ERROR` (0) é”™è¯¯ä»£ç ,ä¹Ÿå¯ä»¥å‘é€å¦ä¸€ä¸ªä»£ç :

```java
request.response().reset(8);
```

HTTP/2 è§„èŒƒå®šä¹‰äº†å¯ä»¥ä½¿ç”¨çš„ [é”™è¯¯ä»£ç ](http://httpwg.org/specs/rfc7540.html#ErrorCodes) åˆ—è¡¨.

è¯·æ±‚å¤„ç†å™¨é€šè¿‡ `request handler` å’Œ `response handler` æ”¶åˆ°æµé‡ç½®äº‹ä»¶çš„é€šçŸ¥:

```java
request.response().exceptionHandler(err -> {
  if (err instanceof StreamResetException) {
    StreamResetException reset = (StreamResetException) err;
    System.out.println("Stream reset " + reset.getCode());
  }
});
```

#### æœåŠ¡ç«¯æ¨é€

æœåŠ¡å™¨æ¨é€æ˜¯ HTTP/2 çš„ä¸€é¡¹æ–°åŠŸèƒ½,å¯ä»¥ä¸ºå•ä¸ªå®¢æˆ·ç«¯è¯·æ±‚å¹¶è¡Œå‘é€å¤šä¸ªå“åº”.

å½“æœåŠ¡å™¨å¤„ç†è¯·æ±‚æ—¶,å®ƒå¯ä»¥å‘å®¢æˆ·ç«¯æ¨é€è¯·æ±‚/å“åº”:

```java
HttpServerResponse response = request.response();

// Push main.js to the client
response.push(HttpMethod.GET, "/main.js", ar -> {

  if (ar.succeeded()) {

    // The server is ready to push the response
    HttpServerResponse pushedResponse = ar.result();

    // Send main.js response
    pushedResponse.
        putHeader("content-type", "application/json").
        end("alert(\"Push response hello\")");
  } else {
    System.out.println("Could not push client resource " + ar.cause());
  }
});

// Send the requested resource
response.sendFile("<html><head><script src=\"/main.js\"></script></head><body></body></html>");
```

å½“æœåŠ¡å™¨å‡†å¤‡å¥½æ¨é€å“åº”æ—¶,å°†è°ƒç”¨æ¨é€å“åº”å¤„ç†å™¨å¹¶ä¸”å¤„ç†å™¨å¯ä»¥å‘é€å“åº”.

æ¨é€å“åº”å¤„ç†å™¨å¯èƒ½ä¼šæ”¶åˆ°å¤±è´¥,ä¾‹å¦‚å®¢æˆ·ç«¯å¯èƒ½ä¼šå–æ¶ˆæ¨é€,å› ä¸ºå®ƒçš„ç¼“å­˜ä¸­å·²ç»æœ‰ `main.js` å¹¶ä¸”ä¸å†éœ€è¦å®ƒ.

> **ğŸ·æ³¨æ„:** `push` æ–¹æ³•å¿…é¡»åœ¨å‘èµ·å“åº”ç»“æŸä¹‹å‰è°ƒç”¨,ä½†æ˜¯æ¨é€çš„å“åº”å¯ä»¥å†™åœ¨ä¹‹å.

#### å¤„ç†å¼‚å¸¸

æ‚¨å¯ä»¥è®¾ç½® `exceptionHandler` æ¥æ¥æ”¶åœ¨è¿æ¥ä¼ é€’ç»™ `requestHandler` æˆ– `webSocketHandler` ä¹‹å‰å‘ç”Ÿçš„ä»»ä½•å¼‚å¸¸,ä¾‹å¦‚ åœ¨ TLS æ¡æ‰‹æœŸé—´.

#### å¤„ç†æ— æ•ˆè¯·æ±‚

Vert.x å°†å¤„ç†æ— æ•ˆçš„ HTTP è¯·æ±‚å¹¶æä¾›ä¸€ä¸ªé»˜è®¤å¤„ç†å™¨æ¥é€‚å½“åœ°å¤„ç†å¸¸è§æƒ…å†µ,ä¾‹å¦‚ å½“è¯·æ±‚æ ‡å¤´å¤ªé•¿æ—¶,å®ƒä¼šä»¥`REQUEST_HEADER_FIELDS_TOO_LARGE`å“åº”.

æ‚¨å¯ä»¥è®¾ç½®è‡ªå·±çš„ `invalidRequestHandler` æ¥å¤„ç†æ— æ•ˆè¯·æ±‚. æ‚¨çš„å®ç°å¯ä»¥å¤„ç†ç‰¹å®šæƒ…å†µå¹¶å°†å…¶ä»–æƒ…å†µå§”æ‰˜ç»™`HttpServerRequest.DEFAULT_INVALID_REQUEST_HANDLER`.

### HTTP å‹ç¼©

Vert.x æ”¯æŒå¼€ç®±å³ç”¨çš„ HTTP å‹ç¼©.

è¿™æ„å‘³ç€æ‚¨å¯ä»¥åœ¨å°†å“åº”å‘é€å›å®¢æˆ·ç«¯ä¹‹å‰è‡ªåŠ¨å‹ç¼©å“åº”çš„æ­£æ–‡.

å¦‚æœå®¢æˆ·ç«¯ä¸æ”¯æŒ HTTP å‹ç¼©,åˆ™åœ¨ä¸å‹ç¼©æ­£æ–‡çš„æƒ…å†µä¸‹å‘å›å“åº”.

è¿™å…è®¸åŒæ—¶å¤„ç†æ”¯æŒ HTTP å‹ç¼©å’Œä¸æ”¯æŒå®ƒçš„å®¢æˆ·ç«¯.

è¦å¯ç”¨å‹ç¼©,å¯ä»¥ä½¿ç”¨ `setCompressionSupported` å¯¹å…¶è¿›è¡Œé…ç½®.

é»˜è®¤æƒ…å†µä¸‹,æœªå¯ç”¨å‹ç¼©.

å¯ç”¨ HTTP å‹ç¼©å,æœåŠ¡å™¨å°†æ£€æŸ¥å®¢æˆ·ç«¯æ˜¯å¦åŒ…å«åŒ…å«æ”¯æŒçš„å‹ç¼©çš„`Accept-Encoding`æ ‡å¤´. å¸¸ç”¨çš„æœ‰deflateå’Œgzip. Vert.x æ”¯æŒä¸¤è€….

å¦‚æœæ‰¾åˆ°è¿™æ ·çš„æ ‡å¤´,æœåŠ¡å™¨å°†ä½¿ç”¨æ”¯æŒçš„å‹ç¼©ä¹‹ä¸€è‡ªåŠ¨å‹ç¼©å“åº”çš„ä¸»ä½“å¹¶å°†å…¶å‘é€å›å®¢æˆ·ç«¯.

æ¯å½“éœ€è¦åœ¨ä¸å‹ç¼©çš„æƒ…å†µä¸‹å‘é€å“åº”æ—¶,æ‚¨å¯ä»¥å°†æ ‡å¤´ `content-encoding` è®¾ç½®ä¸º `identity`:

```java
request.response()
  .putHeader(HttpHeaders.CONTENT_ENCODING, HttpHeaders.IDENTITY)
  .sendFile("/path/to/image.jpg");
```

è¯·æ³¨æ„,å‹ç¼©å¯èƒ½èƒ½å¤Ÿå‡å°‘ç½‘ç»œæµé‡,ä½†ä¼šå ç”¨æ›´å¤š CPU.

ä¸ºäº†è§£å†³åä¸€ä¸ªé—®é¢˜,Vert.x å…è®¸æ‚¨è°ƒæ•´ gzip/deflate å‹ç¼©ç®—æ³•çš„åŸç”Ÿ"å‹ç¼©çº§åˆ«"å‚æ•°.

å‹ç¼©çº§åˆ«å…è®¸æ ¹æ®ç»“æœæ•°æ®çš„å‹ç¼©ç‡å’Œå‹ç¼©/è§£å‹ç¼©æ“ä½œçš„è®¡ç®—æˆæœ¬æ¥é…ç½® gzip/deflate ç®—æ³•.

å‹ç¼©çº§åˆ«æ˜¯ä¸€ä¸ªæ•´æ•°å€¼,èŒƒå›´ä»"1"åˆ°"9",å…¶ä¸­"1"è¡¨ç¤ºå‹ç¼©ç‡è¾ƒä½ä½†ç®—æ³•æœ€å¿«,"9"è¡¨ç¤ºå¯ç”¨å‹ç¼©ç‡æœ€å¤§ä½†ç®—æ³•è¾ƒæ…¢.

ä½¿ç”¨é«˜äº 1-2 çš„å‹ç¼©çº§åˆ«é€šå¸¸åªå…è®¸åœ¨å¤§å°ä¸ŠèŠ‚çœä¸€äº›å­—èŠ‚ - å¢ç›Šä¸æ˜¯çº¿æ€§çš„,å¹¶ä¸”å–å†³äºè¦å‹ç¼©çš„ç‰¹å®šæ•°æ® - ä½†å°± æœåŠ¡å™¨åŒæ—¶ç”Ÿæˆå‹ç¼©å“åº”æ•°æ®(è¯·æ³¨æ„,ç›®å‰ Vert.x ä¸æ”¯æŒä»»ä½•å½¢å¼çš„å‹ç¼©å“åº”æ•°æ®ç¼“å­˜,å³ä½¿å¯¹äºé™æ€æ–‡ä»¶ä¹Ÿæ˜¯å¦‚æ­¤,å› æ­¤å‹ç¼©æ˜¯åœ¨æ¯æ¬¡è¯·æ±‚æ­£æ–‡ç”Ÿæˆæ—¶å³æ—¶å®Œæˆçš„)å’Œ ä¸è§£ç (è†¨èƒ€)æ¥æ”¶åˆ°çš„å“åº”æ—¶å½±å“å®¢æˆ·ç«¯çš„æ–¹å¼ç›¸åŒ,çº§åˆ«è¶Šé«˜,æ“ä½œå°±è¶Šå ç”¨ CPU.

é»˜è®¤æƒ…å†µä¸‹ - å¦‚æœé€šè¿‡ `setCompressionSupported` å¯ç”¨å‹ç¼© - Vert.x å°†ä½¿ç”¨ '6' ä½œä¸ºå‹ç¼©çº§åˆ«,ä½†å¯ä»¥ä½¿ç”¨ `setCompressionLevel` é…ç½®å‚æ•°ä»¥è§£å†³ä»»ä½•æƒ…å†µ.

### åˆ›å»º HTTP å®¢æˆ·ç«¯

æ‚¨ä½¿ç”¨ä»¥ä¸‹é»˜è®¤é€‰é¡¹åˆ›å»ºä¸€ä¸ª `HttpClient` å®ä¾‹:

```java
HttpClient client = vertx.createHttpClient();
```

å¦‚æœè¦ä¸ºå®¢æˆ·ç«¯é…ç½®é€‰é¡¹,è¯·æŒ‰å¦‚ä¸‹æ–¹å¼åˆ›å»ºå®ƒ:

```java
HttpClientOptions options = new HttpClientOptions().setKeepAlive(false);
HttpClient client = vertx.createHttpClient(options);
```

Vert.x é€šè¿‡ TLS `h2` å’Œ TCP `h2c` æ”¯æŒ HTTP/2.

é»˜è®¤æƒ…å†µä¸‹,http å®¢æˆ·ç«¯æ‰§è¡Œ HTTP/1.1 è¯·æ±‚,è¦æ‰§è¡Œ HTTP/2 è¯·æ±‚,`setProtocolVersion` å¿…é¡»è®¾ç½®ä¸º `HTTP_2`.

å¯¹äº `h2` è¯·æ±‚,å¿…é¡»ä½¿ç”¨ *Application-Layer Protocol Negotiation* å¯ç”¨ TLS:

```java
HttpClientOptions options = new HttpClientOptions().
    setProtocolVersion(HttpVersion.HTTP_2).
    setSsl(true).
    setUseAlpn(true).
    setTrustAll(true);

HttpClient client = vertx.createHttpClient(options);
```

å¯¹äº' h2c 'è¯·æ±‚,TLSå¿…é¡»ç¦ç”¨,å®¢æˆ·ç«¯å°†æ‰§è¡ŒHTTP/1.1è¯·æ±‚,å¹¶å°è¯•å‡çº§åˆ°HTTP/2:

```java
HttpClientOptions options = new HttpClientOptions().setProtocolVersion(HttpVersion.HTTP_2);

HttpClient client = vertx.createHttpClient(options);
```

`h2c`è¿æ¥ä¹Ÿå¯ä»¥ç›´æ¥å»ºç«‹,ä¹Ÿå°±æ˜¯è¯´,è¿æ¥æ˜¯åœ¨é¢„å…ˆçŸ¥é“çš„æƒ…å†µä¸‹å¼€å§‹çš„,å½“`setHttp2ClearTextUpgrade`é€‰é¡¹è®¾ç½®ä¸º`false`æ—¶:åœ¨è¿æ¥å»ºç«‹å,å®¢æˆ·ç«¯å°†å‘é€HTTP/2è¿æ¥åºè¨€,å¹¶æœŸæœ›ä»æœåŠ¡å™¨æ¥æ”¶åˆ°ç›¸åŒçš„åºè¨€.

http æœåŠ¡å™¨å¯èƒ½ä¸æ”¯æŒ HTTP/2,å®é™…ç‰ˆæœ¬å¯ä»¥åœ¨å“åº”åˆ°è¾¾æ—¶ä½¿ç”¨ `version` æ¥æ£€æŸ¥.

å½“å®¢æˆ·ç«¯è¿æ¥åˆ° HTTP/2 æœåŠ¡å™¨æ—¶,å®ƒä¼šå°†å…¶"åˆå§‹è®¾ç½®"å‘é€åˆ°æœåŠ¡å™¨. è¿™äº›è®¾ç½®å®šä¹‰äº†æœåŠ¡å™¨å¦‚ä½•ä½¿ç”¨è¿æ¥,å®¢æˆ·ç«¯çš„é»˜è®¤åˆå§‹è®¾ç½®æ˜¯ HTTP/2 RFC å®šä¹‰çš„é»˜è®¤å€¼.

### è®°å½•ç½‘ç»œå®¢æˆ·ç«¯æ´»åŠ¨

å‡ºäºè°ƒè¯•ç›®çš„,å¯ä»¥è®°å½•ç½‘ç»œæ´»åŠ¨.

```java
HttpClientOptions options = new HttpClientOptions().setLogActivity(true);
HttpClient client = vertx.createHttpClient(options);
```

æœ‰å…³è¯¦ç»†è¯´æ˜,è¯·å‚é˜…æœ‰å…³ [è®°å½•ç½‘ç»œæ´»åŠ¨](#logging_network_activity) çš„ç« èŠ‚.

### å‘å‡ºè¯·æ±‚

http å®¢æˆ·ç«¯éå¸¸çµæ´»,æ‚¨å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼ä½¿ç”¨å®ƒå‘å‡ºè¯·æ±‚.

å‘å‡ºè¯·æ±‚çš„ç¬¬ä¸€æ­¥æ˜¯è·å–åˆ°è¿œç¨‹æœåŠ¡å™¨çš„ HTTP è¿æ¥:

```java
client.request(HttpMethod.GET,8080, "myserver.mycompany.com", "/some-uri", ar1 -> {
  if (ar1.succeeded()) {
    // Connected to the server
  }
});
```

å®¢æˆ·ç«¯å°†è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨æˆ–é‡ç”¨å®¢æˆ·ç«¯è¿æ¥æ± ä¸­çš„å¯ç”¨è¿æ¥.

#### é»˜è®¤ä¸»æœºå’Œç«¯å£

é€šå¸¸,æ‚¨å¸Œæœ›ä½¿ç”¨ http å®¢æˆ·ç«¯å‘åŒä¸€ä¸ªä¸»æœº/ç«¯å£å‘å‡ºè®¸å¤šè¯·æ±‚. ä¸ºäº†é¿å…æ¯æ¬¡å‘å‡ºè¯·æ±‚æ—¶éƒ½é‡å¤ä¸»æœº/ç«¯å£,æ‚¨å¯ä»¥ä½¿ç”¨é»˜è®¤ä¸»æœº/ç«¯å£é…ç½®å®¢æˆ·ç«¯:

```java
HttpClientOptions options = new HttpClientOptions().setDefaultHost("wibble.com");

// Can also set default port if you want...
HttpClient client = vertx.createHttpClient(options);
client.request(HttpMethod.GET, "/some-uri", ar1 -> {
  if (ar1.succeeded()) {
    HttpClientRequest request = ar1.result();
    request.send(ar2 -> {
      if (ar2.succeeded()) {
        HttpClientResponse response = ar2.result();
        System.out.println("Received response with status code " + response.statusCode());
      }
    });
  }
});
```

#### å†™è¯·æ±‚æ ‡å¤´

æ‚¨å¯ä»¥ä½¿ç”¨ `HttpHeaders` å°†æ ‡å¤´å†™å…¥è¯·æ±‚,å¦‚ä¸‹æ‰€ç¤º:

```java
HttpClient client = vertx.createHttpClient();

// Write some headers using the headers multi-map
MultiMap headers = HttpHeaders.set("content-type", "application/json").set("other-header", "foo");

client.request(HttpMethod.GET, "some-uri", ar1 -> {
  if (ar1.succeeded()) {
    HttpClientRequest request = ar1.result();
    request.headers().addAll(headers);
    request.send(ar2 -> {
      HttpClientResponse response = ar2.result();
      System.out.println("Received response with status code " + response.statusCode());
    });
  }
});
```

æ ‡å¤´æ˜¯`MultiMap`çš„ä¸€ä¸ªå®ä¾‹,å®ƒæä¾›äº†æ·»åŠ ,è®¾ç½®å’Œåˆ é™¤æ¡ç›®çš„æ“ä½œ. Http æ ‡å¤´å…è®¸ç‰¹å®šé”®æœ‰å¤šä¸ªå€¼.

You can also write headers using `putHeader`

```java
request.putHeader("content-type", "application/json")
       .putHeader("other-header", "foo");
```

> **ğŸ·æ³¨æ„:** å¦‚æœæ‚¨å¸Œæœ›å°†æ ‡å¤´å†™å…¥è¯·æ±‚,åˆ™å¿…é¡»åœ¨å†™å…¥è¯·æ±‚æ­£æ–‡çš„ä»»ä½•éƒ¨åˆ†ä¹‹å‰æ‰§è¡Œæ­¤æ“ä½œ.

#### å†™è¯·æ±‚å’Œå¤„ç†å“åº”

`HttpClientRequest` çš„ `request` æ–¹æ³•è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨æˆ–é‡ç”¨ç°æœ‰è¿æ¥. è·å–åˆ°çš„è¯·æ±‚å®ä¾‹é¢„å…ˆå¡«å……äº†ä¸€äº›æ•°æ®,ä¾‹å¦‚ä¸»æœºæˆ–è¯·æ±‚ URI,ä½†æ‚¨éœ€è¦å°†æ­¤è¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨.

æ‚¨å¯ä»¥è°ƒç”¨ `send` æ¥å‘é€ HTTP `GET` ç­‰è¯·æ±‚å¹¶å¤„ç†å¼‚æ­¥ `HttpClientResponse`.

```java
client.request(HttpMethod.GET,8080, "myserver.mycompany.com", "/some-uri", ar1 -> {
  if (ar1.succeeded()) {
    HttpClientRequest request = ar1.result();

    // Send the request and process the response
    request.send(ar -> {
      if (ar.succeeded()) {
        HttpClientResponse response = ar.result();
        System.out.println("Received response with status code " + response.statusCode());
      } else {
        System.out.println("Something went wrong " + ar.cause().getMessage());
      }
    });
  }
});
```

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨bodyå‘é€è¯·æ±‚.

å¸¦æœ‰å­—ç¬¦ä¸²çš„ `send`,å¦‚æœä¹‹å‰æ²¡æœ‰è®¾ç½®,åˆ™ä¼šä¸ºæ‚¨è®¾ç½® `Content-Length` æ ‡å¤´.

```java
client.request(HttpMethod.GET,8080, "myserver.mycompany.com", "/some-uri", ar1 -> {
  if (ar1.succeeded()) {
    HttpClientRequest request = ar1.result();

    // Send the request and process the response
    request.send("Hello World", ar -> {
      if (ar.succeeded()) {
        HttpClientResponse response = ar.result();
        System.out.println("Received response with status code " + response.statusCode());
      } else {
        System.out.println("Something went wrong " + ar.cause().getMessage());
      }
    });
  }
});
```

å¸¦æœ‰ç¼“å†²åŒºçš„ `send`,å¦‚æœä¹‹å‰æ²¡æœ‰è®¾ç½® `Content-Length` æ ‡å¤´,å°†ä¸ºæ‚¨è®¾ç½®.

```java
request.send(Buffer.buffer("Hello World"), ar -> {
  if (ar.succeeded()) {
    HttpClientResponse response = ar.result();
    System.out.println("Received response with status code " + response.statusCode());
  } else {
    System.out.println("Something went wrong " + ar.cause().getMessage());
  }
});
```

å¸¦æœ‰æµçš„ `send`,å¦‚æœå…ˆå‰æœªè®¾ç½® `Content-Length` æ ‡å¤´,åˆ™ä½¿ç”¨åˆ†å—çš„ `Content-Encoding` å‘é€è¯·æ±‚.

```java
request
  .putHeader(HttpHeaders.CONTENT_LENGTH, "1000")
  .send(stream, ar -> {
  if (ar.succeeded()) {
    HttpClientResponse response = ar.result();
    System.out.println("Received response with status code " + response.statusCode());
  } else {
    System.out.println("Something went wrong " + ar.cause().getMessage());
  }
});
```

#### Streaming Request body(æµå¼è¯·æ±‚æ­£æ–‡)

`send` æ–¹æ³•ä¸€æ¬¡å‘é€è¯·æ±‚.

æœ‰æ—¶æ‚¨ä¼šå¸Œæœ›å¯¹å¦‚ä½•ç¼–å†™è¯·æ±‚bodysè¿›è¡Œä½çº§åˆ«æ§åˆ¶.

`HttpClientRequest` å¯ç”¨äºç¼–å†™è¯·æ±‚body.

ä»¥ä¸‹æ˜¯ä¸€äº›ä½¿ç”¨bodyç¼–å†™ `POST` è¯·æ±‚çš„ç¤ºä¾‹:

```java
HttpClient client = vertx.createHttpClient();

client.request(HttpMethod.POST, "some-uri")
  .onSuccess(request -> {
    request.response().onSuccess(response -> {
      System.out.println("Received response with status code " + response.statusCode());
    });

    // Now do stuff with the request
    request.putHeader("content-length", "1000");
    request.putHeader("content-type", "text/plain");
    request.write(body);

    // Make sure the request is ended when you're done with it
    request.end();
});

// Or fluently:

client.request(HttpMethod.POST, "some-uri")
  .onSuccess(request -> {
    request
      .response(ar -> {
        if (ar.succeeded()) {
          HttpClientResponse response = ar.result();
          System.out.println("Received response with status code " + response.statusCode());
        }
      })
      .putHeader("content-length", "1000")
      .putHeader("content-type", "text/plain")
      .end(body);
});
```

å­˜åœ¨çš„æ–¹æ³•å¯ä»¥ç”¨UTF-8ç¼–ç å’Œä»»ä½•ç‰¹å®šç¼–ç ç¼–å†™å­—ç¬¦ä¸²,å¹¶å†™å…¥ç¼“å†²åŒº:

```java
request.write("some data");

// Write string encoded in specific encoding
request.write("some other data", "UTF-16");

// Write a buffer
Buffer buffer = Buffer.buffer();
buffer.appendInt(123).appendLong(245l);
request.write(buffer);
```

å¦‚æœæ‚¨åªæ˜¯å°†å•ä¸ªå­—ç¬¦ä¸²æˆ–ç¼“å†²åŒºå†™å…¥ HTTP è¯·æ±‚,æ‚¨å¯ä»¥ç¼–å†™å®ƒå¹¶åœ¨å¯¹ `end` å‡½æ•°çš„ä¸€æ¬¡è°ƒç”¨ä¸­ç»“æŸè¯·æ±‚.

```java
request.end("some simple data");

// Write buffer and end the request (send it) in a single call
Buffer buffer = Buffer.buffer().appendDouble(12.34d).appendLong(432l);
request.end(buffer);
```

å½“æ‚¨å†™å…¥è¯·æ±‚æ—¶,ç¬¬ä¸€æ¬¡è°ƒç”¨ write å°†å¯¼è‡´è¯·æ±‚æ ‡å¤´è¢«å†™å…¥ç½‘ç»œ.

å®é™…çš„å†™å…¥æ˜¯å¼‚æ­¥çš„,å¯èƒ½è¦ç­‰åˆ°è°ƒç”¨è¿”å›åä¸€æ®µæ—¶é—´æ‰ä¼šå‘ç”Ÿ.

å¸¦æœ‰è¯·æ±‚æ­£æ–‡çš„éåˆ†å— HTTP è¯·æ±‚éœ€è¦æä¾›`Content-Length`æ ‡å¤´.

å› æ­¤,å¦‚æœæ‚¨ä¸ä½¿ç”¨åˆ†å— HTTP,é‚£ä¹ˆæ‚¨å¿…é¡»åœ¨å†™å…¥è¯·æ±‚ä¹‹å‰è®¾ç½®`Content-Length`æ ‡å¤´,å¦åˆ™ä¸ºæ—¶å·²æ™š.

å¦‚æœæ‚¨æ­£åœ¨è°ƒç”¨é‡‡ç”¨å­—ç¬¦ä¸²æˆ–ç¼“å†²åŒºçš„ `end` æ–¹æ³•ä¹‹ä¸€,é‚£ä¹ˆ Vert.x å°†åœ¨å†™å…¥è¯·æ±‚æ­£æ–‡ä¹‹å‰è‡ªåŠ¨è®¡ç®—å¹¶è®¾ç½® `Content-Length` æ ‡å¤´.

å¦‚æœæ‚¨ä½¿ç”¨ HTTP åˆ†å—,åˆ™ä¸éœ€è¦`Content-Length`æ ‡å¤´,å› æ­¤æ‚¨ä¸å¿…é¢„å…ˆè®¡ç®—å¤§å°.

#### ç»“æŸæµå¼ HTTP è¯·æ±‚

å®Œæˆ HTTP è¯·æ±‚å,æ‚¨å¿…é¡»ä½¿ç”¨ `end` æ“ä½œä¹‹ä¸€ç»“æŸå®ƒ.

ç»“æŸè¯·æ±‚ä¼šå¯¼è‡´å†™å…¥ä»»ä½•æ ‡å¤´,å¦‚æœå®ƒä»¬å°šæœªè¢«å†™å…¥å¹¶ä¸”è¯·æ±‚è¢«æ ‡è®°ä¸ºå®Œæˆ.

å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼ç»“æŸè¯·æ±‚. æ²¡æœ‰å‚æ•°,è¯·æ±‚å°±ç®€å•åœ°ç»“æŸäº†:

```java
request.end();
```

æˆ–è€…å¯ä»¥åœ¨å¯¹ `end` çš„è°ƒç”¨ä¸­æä¾›å­—ç¬¦ä¸²æˆ–ç¼“å†²åŒº. è¿™å°±åƒåœ¨ä¸å¸¦å‚æ•°è°ƒç”¨ `end` ä¹‹å‰ç”¨å­—ç¬¦ä¸²æˆ–ç¼“å†²åŒºè°ƒç”¨ `write`

```java
request.end("some-data");

// End it with a buffer
Buffer buffer = Buffer.buffer().appendFloat(12.3f).appendInt(321);
request.end(buffer);
```

#### å°†è¯·æ±‚ç”¨ä½œæµ

`HttpClientRequest` å®ä¾‹ä¹Ÿæ˜¯ `WriteStream` å®ä¾‹.

æ‚¨å¯ä»¥ä»ä»»ä½• `ReadStream` å®ä¾‹é€šè¿‡ç®¡é“ä¼ è¾“åˆ°å®ƒ.

ä¾‹å¦‚,æ‚¨å¯ä»¥å°†ç£ç›˜ä¸Šçš„æ–‡ä»¶é€šè¿‡ç®¡é“ä¼ è¾“åˆ° http è¯·æ±‚æ­£æ–‡,å¦‚ä¸‹æ‰€ç¤º:

```java
request.setChunked(true);
file.pipeTo(request);
```

#### åˆ†å—çš„ HTTP è¯·æ±‚

Vert.x æ”¯æŒ [HTTP Chunked Transfer Encoding](https://en.wikipedia.org/wiki/Chunked_transfer_encoding) è¯·æ±‚.

è¿™å…è®¸å°† HTTP è¯·æ±‚æ­£æ–‡ä»¥å—çš„å½¢å¼å†™å…¥,å¹¶ä¸”é€šå¸¸åœ¨å°†å¤§å‹è¯·æ±‚æ­£æ–‡æµå¼ä¼ è¾“åˆ°æœåŠ¡å™¨æ—¶ä½¿ç”¨,å…¶å¤§å°äº‹å…ˆä¸çŸ¥é“.

æ‚¨ä½¿ç”¨ `setChunked` å°† HTTP è¯·æ±‚ç½®äºåˆ†å—æ¨¡å¼.

åœ¨åˆ†å—æ¨¡å¼ä¸‹,æ¯æ¬¡è°ƒç”¨ write éƒ½ä¼šå¯¼è‡´ä¸€ä¸ªæ–°çš„å—è¢«å†™å…¥ç½‘ç»œ. åœ¨åˆ†å—æ¨¡å¼ä¸‹,æ— éœ€é¢„å…ˆè®¾ç½®è¯·æ±‚çš„`Content-Length`.

```java
request.setChunked(true);

// Write some chunks
for (int i = 0; i < 10; i++) {
  request.write("this-is-chunk-" + i);
}

request.end();
```

#### è¯·æ±‚è¶…æ—¶

æ‚¨å¯ä»¥ä½¿ç”¨ `setTimeout` ä¸ºç‰¹å®šçš„ http è¯·æ±‚è®¾ç½®è¶…æ—¶.

å¦‚æœè¯·æ±‚åœ¨è¶…æ—¶æœŸé™å†…æœªè¿”å›ä»»ä½•æ•°æ®,åˆ™ä¼šå°†å¼‚å¸¸ä¼ é€’ç»™å¼‚å¸¸å¤„ç†å™¨(å¦‚æœæä¾›)å¹¶å…³é—­è¯·æ±‚.

#### å†™ HTTP/2 å¸§

HTTP/2 æ˜¯ä¸€ç§æ¡†æ¶åè®®,å…·æœ‰ç”¨äº HTTP è¯·æ±‚/å“åº”æ¨¡å‹çš„å„ç§æ¡†æ¶. è¯¥åè®®å…è®¸å‘é€å’Œæ¥æ”¶å…¶ä»–ç±»å‹çš„å¸§.

è¦å‘é€æ­¤ç±»å¸§,æ‚¨å¯ä»¥åœ¨è¯·æ±‚ä¸­ä½¿ç”¨`write`. è¿™æ˜¯ä¸€ä¸ªä¾‹å­:

```java
int frameType = 40;
int frameStatus = 10;
Buffer payload = Buffer.buffer("some data");

// Sending a frame to the server
request.writeCustomFrame(frameType, frameStatus, payload);
```

#### æµé‡ç½®

HTTP/1.x ä¸å…è®¸å½»åº•é‡ç½®è¯·æ±‚æˆ–å“åº”æµ,ä¾‹å¦‚,å½“å®¢æˆ·ç«¯ä¸Šä¼ æœåŠ¡å™¨ä¸Šå·²ç»å­˜åœ¨çš„èµ„æºæ—¶,æœåŠ¡å™¨éœ€è¦æ¥å—æ•´ä¸ªå“åº”.

HTTP/2 æ”¯æŒåœ¨è¯·æ±‚/å“åº”æœŸé—´éšæ—¶é‡ç½®æµ:

```java
request.reset();
```

é»˜è®¤æƒ…å†µä¸‹å‘é€ NO_ERROR (0) é”™è¯¯ä»£ç ,å¯ä»¥å‘é€å¦ä¸€ä¸ªä»£ç :

```java
request.reset(8);
```

HTTP/2 è§„èŒƒå®šä¹‰äº†å¯ä»¥ä½¿ç”¨çš„ [é”™è¯¯ä»£ç ](http://httpwg.org/specs/rfc7540.html#ErrorCodes) åˆ—è¡¨.

è¯·æ±‚å¤„ç†å™¨é€šè¿‡ `request handler` å’Œ `response handler` æ”¶åˆ°æµé‡ç½®äº‹ä»¶çš„é€šçŸ¥:

```java
request.exceptionHandler(err -> {
  if (err instanceof StreamResetException) {
    StreamResetException reset = (StreamResetException) err;
    System.out.println("Stream reset " + reset.getCode());
  }
});
```

### å¤„ç† HTTP å“åº”

æ‚¨å¯ä»¥åœ¨è¯·æ±‚æ–¹æ³•ä¸­æŒ‡å®šçš„å¤„ç†å™¨ä¸­æ¥æ”¶ `HttpClientResponse` çš„å®ä¾‹,æˆ–è€…ç›´æ¥åœ¨ `HttpClientRequest` å¯¹è±¡ä¸Šè®¾ç½®å¤„ç†å™¨.

æ‚¨å¯ä»¥ä½¿ç”¨ `statusCode` å’Œ `statusMessage` æŸ¥è¯¢å“åº”çš„çŠ¶æ€ç å’ŒçŠ¶æ€æ¶ˆæ¯.

```java
request.send(ar2 -> {
  if (ar2.succeeded()) {

    HttpClientResponse response = ar2.result();

    // the status code - e.g. 200 or 404
    System.out.println("Status code is " + response.statusCode());

    // the status message e.g. "OK" or "Not Found".
    System.out.println("Status message is " + response.statusMessage());
  }
});

// Similar to above, set a completion handler and end the request
request
  .response(ar2 -> {
    if (ar2.succeeded()) {

      HttpClientResponse response = ar2.result();

      // the status code - e.g. 200 or 404
      System.out.println("Status code is " + response.statusCode());

      // the status message e.g. "OK" or "Not Found".
      System.out.println("Status message is " + response.statusMessage());
    }
  })
  .end();
```

#### å°†å“åº”ç”¨ä½œæµ

`HttpClientResponse` å®ä¾‹ä¹Ÿæ˜¯ä¸€ä¸ª `ReadStream`,è¿™æ„å‘³ç€æ‚¨å¯ä»¥å°†å…¶é€šè¿‡ç®¡é“ä¼ è¾“åˆ°ä»»ä½• `WriteStream` å®ä¾‹.

#### å“åº”æ ‡å¤´å’Œå°¾

Http å“åº”å¯ä»¥åŒ…å«æ ‡å¤´. ä½¿ç”¨ `headers` è·å–.

è¿”å›çš„å¯¹è±¡æ˜¯`MultiMap`,å› ä¸º HTTP æ ‡å¤´å¯ä»¥åŒ…å«å•ä¸ªé”®çš„å¤šä¸ªå€¼.

```java
String contentType = response.headers().get("content-type");
String contentLength = response.headers().get("content-lengh");
```

åˆ†å—çš„ HTTP å“åº”ä¹Ÿå¯ä»¥åŒ…å«å°¾éƒ¨ - è¿™äº›åœ¨å“åº”æ­£æ–‡çš„æœ€åä¸€ä¸ªå—ä¸­å‘é€.

æ‚¨ä½¿ç”¨ `trailers` æ¥è·å–å°¾éƒ¨. å°¾éƒ¨ä¹Ÿæ˜¯ä¸€ä¸ª"MultiMap".

#### è¯»å–è¯·æ±‚body

å½“å“åº”çš„æ ‡å¤´å·²ä»ç½‘ç»œä¸­è¯»å–æ—¶,å°†è°ƒç”¨å“åº”å¤„ç†å™¨.

å¦‚æœå“åº”æœ‰æ­£æ–‡,åˆ™å¯èƒ½ä¼šåœ¨è¯»å–æ ‡å¤´åçš„ä¸€æ®µæ—¶é—´å†…åˆ†å‡ éƒ¨åˆ†åˆ°è¾¾. åœ¨è°ƒç”¨å“åº”å¤„ç†å™¨ä¹‹å‰,æˆ‘ä»¬ä¸ä¼šç­‰å¾…æ‰€æœ‰bodyåˆ°è¾¾,å› ä¸ºå“åº”å¯èƒ½éå¸¸å¤§,æˆ‘ä»¬å¯èƒ½ä¼šç­‰å¾…å¾ˆé•¿æ—¶é—´,æˆ–è€…å†…å­˜ä¸è¶³ä»¥è·å–å¤§é‡å“åº”.

å½“å“åº”bodyçš„ä¸€éƒ¨åˆ†åˆ°è¾¾æ—¶,ä½¿ç”¨ä»£è¡¨body éƒ¨åˆ†çš„`Buffer`è°ƒç”¨`handler` :

```java
client.request(HttpMethod.GET, "some-uri", ar1 -> {

  if (ar1.succeeded()) {
    HttpClientRequest request = ar1.result();
    request.send(ar2 -> {
      HttpClientResponse response = ar2.result();
      response.handler(buffer -> {
        System.out.println("Received a part of the response body: " + buffer);
      });
    });
  }
});
```

å¦‚æœæ‚¨çŸ¥é“å“åº”bodyä¸æ˜¯å¾ˆå¤§å¹¶ä¸”æƒ³åœ¨å¤„ç†å®ƒä¹‹å‰å°†å…¶å…¨éƒ¨èšåˆåˆ°å†…å­˜ä¸­,æ‚¨å¯ä»¥è‡ªå·±èšåˆå®ƒ:

```java
request.send(ar2 -> {

  if (ar2.succeeded()) {

    HttpClientResponse response = ar2.result();

    // Create an empty buffer
    Buffer totalBuffer = Buffer.buffer();

    response.handler(buffer -> {
      System.out.println("Received a part of the response body: " + buffer.length());

      totalBuffer.appendBuffer(buffer);
    });

    response.endHandler(v -> {
      // Now all the body has been read
      System.out.println("Total response body length is " + totalBuffer.length());
    });
  }
});
```

æˆ–è€…,æ‚¨å¯ä»¥ä½¿ç”¨æ–¹ä¾¿çš„ `body`,å½“å“åº”è¢«å®Œå…¨è¯»å–æ—¶,å®ƒä¼šä¸æ•´ä¸ªbodyä¸€èµ·è°ƒç”¨:

```java
request.send(ar1 -> {

  if (ar1.succeeded()) {
    HttpClientResponse response = ar1.result();
    response.body(ar2 -> {

      if (ar2.succeeded()) {
        Buffer body = ar2.result();
        // Now all the body has been read
        System.out.println("Total response body length is " + body.length());
      }
    });
  }
});
```

#### å“åº”ç»“æŸå¤„ç†å™¨

å“åº”`endHandler`æ˜¯åœ¨æ•´ä¸ªå“åº”bodyå·²ç»è¢«è¯»å–æ—¶è°ƒç”¨çš„,æˆ–è€…åœ¨æ¶ˆæ¯å¤´å·²ç»è¢«è¯»å–åç«‹å³è°ƒç”¨,å¹¶ä¸”å¦‚æœæ²¡æœ‰å“åº”body,åˆ™è°ƒç”¨å“åº”å¤„ç†å™¨.

#### è¯·æ±‚å’Œå“åº”ç»„åˆ

å®¢æˆ·ç«¯æ¥å£éå¸¸ç®€å•,éµå¾ªä»¥ä¸‹æ¨¡å¼:

1. `request` ä¸€ä¸ªè¿æ¥
2. `send` æˆ–è€… `write`/`end` è¯·æ±‚åˆ°æœåŠ¡å™¨
3. å¤„ç†`HttpClientResponse`çš„å¼€å§‹éƒ¨åˆ†
4. å¤„ç†å“åº”äº‹ä»¶

ä½ å¯ä»¥ä½¿ç”¨Vert.xçš„`future`çš„ç»„åˆæ–¹æ³•æ¥ç®€åŒ–ä½ çš„ä»£ç ,ä½†æ˜¯APIæ˜¯äº‹ä»¶é©±åŠ¨çš„,ä½ éœ€è¦ç†è§£å®ƒ,å¦åˆ™ä½ å¯èƒ½ä¼šé‡åˆ°æ•°æ®ç«äº‰(å³ä¸¢å¤±äº‹ä»¶å¯¼è‡´æ•°æ®æŸå).

> **ğŸ·æ³¨æ„:** [Vert.x Web Client](https://vertx.io/docs/vertx-web-client/java/) æ˜¯ä¸€ç§æ›´é«˜çº§åˆ«çš„ API æ›¿ä»£æ–¹æ¡ˆ(å®é™…ä¸Šå®ƒæ˜¯å»ºç«‹åœ¨æ­¤å®¢æˆ·ç«¯ä¹‹ä¸Šçš„),å¦‚æœè¿™ä¸ªå®¢æˆ·ç«¯å¯¹äºä½ çš„ç”¨ä¾‹æ¥è¯´çº§åˆ«å¤ªä½äº†,ä½ å¯ä»¥è€ƒè™‘ä¸€ä¸‹"Vert.x Web Client".

å®¢æˆ·ç«¯ API æ•…æ„ä¸è¿”å› `Future<HttpClientResponse>`,å› ä¸ºå½“åœ¨äº‹ä»¶å¾ªç¯ä¹‹å¤–è®¾ç½®å®Œæˆå¤„ç†å™¨æ—¶,åœ¨ future ä¸Šè®¾ç½®å®Œæˆå¤„ç†å™¨å¯èƒ½ä¼šå¾ˆä¸ç¨³å®šçš„.

```java
Future<HttpClientResponse> get = client.get("some-uri");

// å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯,å®ƒè¿”å›ä¸€ä¸ªfuture
// å“åº”å‡è®¾å®ƒä¸åœ¨äº‹ä»¶å¾ªç¯ä¸­
// ä¸ºäº†è¿™ä¸ªä¾‹å­,å¼•å…¥äº†ä¸€ä¸ªæ½œåœ¨çš„æ•°æ®ç«äº‰
Thread.sleep(100);

get.onSuccess(response -> {

  // å“åº”äº‹ä»¶å¯èƒ½å·²ç»å‘ç”Ÿ
  response.body(ar -> {

  });
});
```

å°† `HttpClientRequest` ä½¿ç”¨é™åˆ¶åœ¨ Verticle ä¸­æ˜¯æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆ,å› ä¸º Verticle å°†ç¡®ä¿æŒ‰é¡ºåºå¤„ç†äº‹ä»¶ä»¥é¿å…ç«äº‰.

```java
vertx.deployVerticle(() -> new AbstractVerticle() {
 @Override
 public void start() {

   HttpClient client = vertx.createHttpClient();

   Future<HttpClientRequest> future = client.request(HttpMethod.GET, "some-uri");
 }
}, new DeploymentOptions());
```

å½“æ‚¨å¯èƒ½åœ¨ Verticle ä¹‹å¤–ä¸å®¢æˆ·ç«¯äº¤äº’æ—¶,åªè¦ä¸å»¶è¿Ÿå“åº”äº‹ä»¶,æ‚¨å°±å¯ä»¥å®‰å…¨åœ°æ‰§è¡Œç»„åˆ,ä¾‹å¦‚ç›´æ¥åœ¨äº‹ä»¶å¾ªç¯ä¸Šå¤„ç†å“åº”.

```java
Future<JsonObject> future = client
  .request(HttpMethod.GET, "some-uri")
  .compose(request -> request
    .send()
    .compose(response -> {
      // Process the response on the event-loop which guarantees no races
      if (response.statusCode() == 200 &&
          response.getHeader(HttpHeaders.CONTENT_TYPE).equals("application/json")) {
        return response
          .body()
          .map(buffer -> buffer.toJsonObject());
      } else {
        return Future.failedFuture("Incorrect HTTP response");
      }
    }));

// Listen to the composed final json result
future.onSuccess(json -> {
  System.out.println("Received json result " + json);
}).onFailure(err -> {
  System.out.println("Something went wrong " + err.getMessage());
});
```

å¦‚æœæ‚¨éœ€è¦å»¶è¿Ÿå“åº”å¤„ç†,åˆ™éœ€è¦`pause`å“åº”æˆ–ä½¿ç”¨`pipe`,è¿™åœ¨æ¶‰åŠå¦ä¸€ä¸ªå¼‚æ­¥æ“ä½œæ—¶å¯èƒ½æ˜¯å¿…è¦çš„.

```java
Future<Void> future = client
  .request(HttpMethod.GET, "some-uri")
  .compose(request -> request
    .send()
    .compose(response -> {
      // Process the response on the event-loop which guarantees no races
      if (response.statusCode() == 200) {

        // Create a pipe, this pauses the response
        Pipe<Buffer> pipe = response.pipe();

        // Write the file on the disk
        return fileSystem
          .open("/some/large/file", new OpenOptions().setWrite(true))
          .onFailure(err -> pipe.close())
          .compose(file -> pipe.to(file));
      } else {
        return Future.failedFuture("Incorrect HTTP response");
      }
    }));
```

#### ä»å“åº”ä¸­è¯»å– cookie

æ‚¨å¯ä»¥ä½¿ç”¨ `cookies` ä»å“åº”ä¸­æ£€ç´¢ cookie åˆ—è¡¨.

æˆ–è€…,æ‚¨å¯ä»¥è‡ªå·±åœ¨å“åº”ä¸­è§£æ `Set-Cookie` æ ‡å¤´.

#### 30x é‡å®šå‘å¤„ç†

å®¢æˆ·ç«¯å¯ä»¥é…ç½®ä¸ºå½“å®¢æˆ·ç«¯æ¥æ”¶åˆ°`Location`å“åº”å¤´æä¾›çš„HTTPé‡å®šå‘:

- `301`,`302`,`307` æˆ– `308` çŠ¶æ€ç ä»¥åŠ HTTP GET æˆ– HEAD æ–¹æ³•
- ä¸€ä¸ª`303`çŠ¶æ€ç ,æ­¤å¤–å®šå‘è¯·æ±‚æ‰§è¡Œä¸€ä¸ª HTTP GET æ–¹æ³•

è¿™æ˜¯ä¸€ä¸ªä¾‹å­:

```java
client.request(HttpMethod.GET, "some-uri", ar1 -> {
  if (ar1.succeeded()) {

    HttpClientRequest request = ar1.result();
    request.setFollowRedirects(true);
    request.send(ar2 -> {
      if (ar2.succeeded()) {

        HttpClientResponse response = ar2.result();
        System.out.println("Received response with status code " + response.statusCode());
      }
    });
  }
});
```

é»˜è®¤æƒ…å†µä¸‹,æœ€å¤§é‡å®šå‘ä¸º `16` æ¬¡,å¯ä»¥ä½¿ç”¨ `setMaxRedirects` è¿›è¡Œæ›´æ”¹.

```java
HttpClient client = vertx.createHttpClient(
    new HttpClientOptions()
        .setMaxRedirects(32));

client.request(HttpMethod.GET, "some-uri", ar1 -> {
  if (ar1.succeeded()) {

    HttpClientRequest request = ar1.result();
    request.setFollowRedirects(true);
    request.send(ar2 -> {
      if (ar2.succeeded()) {

        HttpClientResponse response = ar2.result();
        System.out.println("Received response with status code " + response.statusCode());
      }
    });
  }
});
```

ä¸€ç§å°ºå¯¸æ— æ³•æ»¡è¶³æ‰€æœ‰éœ€æ±‚,é»˜è®¤é‡å®šå‘ç­–ç•¥å¯èƒ½æ— æ³•æ»¡è¶³æ‚¨çš„éœ€æ±‚.

é»˜è®¤é‡å®šå‘ç­–ç•¥å¯ä»¥é€šè¿‡è‡ªå®šä¹‰å®ç°è¿›è¡Œæ›´æ”¹:

```java
client.redirectHandler(response -> {

  // Only follow 301 code
  if (response.statusCode() == 301 && response.getHeader("Location") != null) {

    // Compute the redirect URI
    String absoluteURI = resolveURI(response.request().absoluteURI(), response.getHeader("Location"));

    // Create a new ready to use request that the client will use
    return Future.succeededFuture(new RequestOptions().setAbsoluteURI(absoluteURI));
  }

  // We don't redirect
  return null;
});
```

è¯¥ç­–ç•¥å¤„ç†æ”¶åˆ°çš„åŸå§‹ `HttpClientResponse` å¹¶è¿”å› `null` æˆ– `Future<HttpClientRequest>`.

- è¿”å› `null` æ—¶,å¤„ç†åŸå§‹å“åº”
- å½“futureè¿”å›æ—¶,è¯·æ±‚å°†åœ¨æˆåŠŸå®Œæˆæ—¶å‘é€
- å½“è¿”å›ä¸€ä¸ªfuture æ—¶,åœ¨è¯·æ±‚ä¸Šè®¾ç½®çš„å¼‚å¸¸å¤„ç†å™¨åœ¨å…¶å¤±è´¥æ—¶è¢«è°ƒç”¨

è¿”å›çš„è¯·æ±‚å¿…é¡»æœªå‘é€,ä»¥ä¾¿å¯ä»¥å‘é€åŸå§‹è¯·æ±‚å¤„ç†å™¨,ç„¶åå®¢æˆ·ç«¯å¯ä»¥å‘é€å®ƒ.

å¤§å¤šæ•°åŸå§‹è¯·æ±‚è®¾ç½®å°†ä¼ æ’­åˆ°æ–°è¯·æ±‚:

- è¯·æ±‚æ ‡å¤´,é™¤éæ‚¨è®¾ç½®äº†ä¸€äº›æ ‡å¤´
- è¯·æ±‚body `GET` æ–¹æ³•
- å“åº”å¤„ç†å™¨
- è¯·æ±‚å¼‚å¸¸å¤„ç†å™¨
- è¯·æ±‚è¶…æ—¶

#### 100-ç»§ç»­å¤„ç†

æ ¹æ®[HTTP 1.1è§„èŒƒ](https://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html),å®¢æˆ·ç«¯å¯ä»¥è®¾ç½®ä¸€ä¸ªæŠ¥å¤´`Expect: 100-Continue`,å¹¶åœ¨å‘é€å…¶ä½™çš„è¯·æ±‚bodyä¹‹å‰å‘é€è¯·æ±‚æŠ¥å¤´.

ç„¶å,æœåŠ¡å™¨å¯ä»¥ä»¥ä¸´æ—¶å“åº”çŠ¶æ€`Status: 100 (Continue)`è¿›è¡Œå“åº”,ä»¥å‘å®¢æˆ·ç«¯è¡¨ç¤ºå¯ä»¥å‘é€bodyçš„å…¶ä½™éƒ¨åˆ†.

è¿™é‡Œçš„æƒ³æ³•æ˜¯å®ƒå…è®¸æœåŠ¡å™¨åœ¨å‘é€å¤§é‡æ•°æ®ä¹‹å‰æˆæƒå’Œæ¥å—/æ‹’ç»è¯·æ±‚. å¦‚æœè¯·æ±‚å¯èƒ½ä¸è¢«æ¥å—,åˆ™å‘é€å¤§é‡æ•°æ®ä¼šæµªè´¹å¸¦å®½,å¹¶ä¸”ä¼šå ç”¨æœåŠ¡å™¨è¯»å–å®ƒå°†ä¸¢å¼ƒçš„æ•°æ®.

Vert.xå…è®¸ä½ åœ¨å®¢æˆ·ç«¯è¯·æ±‚å¯¹è±¡ä¸Šè®¾ç½®ä¸€ä¸ª`continueHandler`

å¦‚æœæœåŠ¡å™¨å‘å›`Status: 100 (Continue)`å“åº”ä»¥è¡¨ç¤ºå¯ä»¥å‘é€è¯·æ±‚çš„å…¶ä½™éƒ¨åˆ†,åˆ™ä¼šè°ƒç”¨æ­¤æ–¹æ³•.

è¿™ä¸ `[sendHead](https://vertx.io/docs/apidocs/io/vertx/core/http/HttpClientRequest.html#sendHead--)` ç»“åˆä½¿ç”¨ä»¥å‘é€è¯·æ±‚çš„å¤´éƒ¨.

è¿™æ˜¯ä¸€ä¸ªä¾‹å­:

```java
client.request(HttpMethod.PUT, "some-uri")
  .onSuccess(request -> {
    request.response().onSuccess(response -> {
      System.out.println("Received response with status code " + response.statusCode());
    });

    request.putHeader("Expect", "100-Continue");

    request.continueHandler(v -> {
      // OK to send rest of body
      request.write("Some data");
      request.write("Some more data");
      request.end();
    });

    request.sendHead();
});
```

åœ¨æœåŠ¡å™¨ç«¯,å¯ä»¥å°† Vert.x http æœåŠ¡å™¨é…ç½®ä¸ºåœ¨æ”¶åˆ° `Expect: 100-Continue` æ ‡å¤´æ—¶è‡ªåŠ¨å‘å› 100 Continue ä¸´æ—¶å“åº”.

è¿™æ˜¯é€šè¿‡è®¾ç½®é€‰é¡¹`setHandle100ContinueAutomatically`æ¥å®Œæˆçš„.

å¦‚æœæ‚¨æ›´æ„¿æ„æ‰‹åŠ¨å†³å®šæ˜¯å¦å‘å›ç»§ç»­å“åº”,åˆ™åº”å°†æ­¤å±æ€§è®¾ç½®ä¸º `false`(é»˜è®¤å€¼),ç„¶åæ‚¨å¯ä»¥æ£€æŸ¥æ ‡å¤´å¹¶è°ƒç”¨ `writeContinue` è®©å®¢æˆ·ç«¯ç»§ç»­å‘é€æ­£æ–‡:

```java
httpServer.requestHandler(request -> {
  if (request.getHeader("Expect").equalsIgnoreCase("100-Continue")) {

    // Send a 100 continue response
    request.response().writeContinue();

    // The client should send the body when it receives the 100 response
    request.bodyHandler(body -> {
      // Do something with body
    });

    request.endHandler(v -> {
      request.response().end();
    });
  }
});
```

æ‚¨è¿˜å¯ä»¥é€šè¿‡ç›´æ¥å‘å›å¤±è´¥çŠ¶æ€ä»£ç æ¥æ‹’ç»è¯·æ±‚:åœ¨è¿™ç§æƒ…å†µä¸‹,åº”è¯¥å¿½ç•¥ä¸»ä½“æˆ–å…³é—­è¿æ¥(100-Continue æ˜¯æ€§èƒ½æç¤º,ä¸èƒ½æˆä¸ºé€»è¾‘åè®®çº¦æŸ):

```java
httpServer.requestHandler(request -> {
  if (request.getHeader("Expect").equalsIgnoreCase("100-Continue")) {

    //
    boolean rejectAndClose = true;
    if (rejectAndClose) {

      // Reject with a failure code and close the connection
      // this is probably best with persistent connection
      request.response()
          .setStatusCode(405)
          .putHeader("Connection", "close")
          .end();
    } else {

      // Reject with a failure code and ignore the body
      // this may be appropriate if the body is small
      request.response()
          .setStatusCode(405)
          .end();
    }
  }
});
```

#### åˆ›å»º HTTP éš§é“

HTTP éš§é“å¯ä»¥ä½¿ç”¨ `connect` åˆ›å»º:

```java
client.request(HttpMethod.CONNECT, "some-uri")
  .onSuccess(request -> {

    // Connect to the server
    request.connect(ar -> {
      if (ar.succeeded()) {
        HttpClientResponse response = ar.result();

        if (response.statusCode() != 200) {
          // Connect failed for some reason
        } else {
          // Tunnel created, raw buffers are transmitted on the wire
          NetSocket socket = response.netSocket();
        }
      }
    });
});
```

å¤„ç†å™¨å°†åœ¨æ”¶åˆ° HTTP å“åº”æ ‡å¤´åè°ƒç”¨,å¥—æ¥å­—å°†å‡†å¤‡å¥½è¿›è¡Œéš§é“ä¼ è¾“,å¹¶å°†å‘é€å’Œæ¥æ”¶ç¼“å†²åŒº.

`connect` çš„å·¥ä½œæ–¹å¼ç±»ä¼¼äº `send`,ä½†å®ƒé‡æ–°é…ç½®ä¼ è¾“ä»¥äº¤æ¢åŸå§‹ç¼“å†²åŒº.

#### Client push(å®¢æˆ·ç«¯æ¨é€)

æœåŠ¡å™¨æ¨é€æ˜¯ HTTP/2 çš„ä¸€é¡¹æ–°åŠŸèƒ½,å¯ä»¥ä¸ºå•ä¸ªå®¢æˆ·ç«¯è¯·æ±‚å¹¶è¡Œå‘é€å¤šä¸ªå“åº”.

å¯ä»¥åœ¨è¯·æ±‚ä¸Šè®¾ç½®æ¨é€å¤„ç†å™¨ä»¥æ¥æ”¶æœåŠ¡å™¨æ¨é€çš„è¯·æ±‚/å“åº”:

```java
client.request(HttpMethod.GET, "/index.html")
  .onSuccess(request -> {

    request
      .response().onComplete(response -> {
        // Process index.html response
      });

    // Set a push handler to be aware of any resource pushed by the server
    request.pushHandler(pushedRequest -> {

      // A resource is pushed for this request
      System.out.println("Server pushed " + pushedRequest.path());

      // Set an handler for the response
      pushedRequest.response().onComplete(pushedResponse -> {
        System.out.println("The response for the pushed request");
      });
    });

    // End the request
    request.end();
});
```

å¦‚æœå®¢æˆ·ç«¯ä¸æƒ³æ¥æ”¶æ¨é€çš„è¯·æ±‚,å®ƒå¯ä»¥é‡ç½®æµ:

```java
request.pushHandler(pushedRequest -> {
  if (pushedRequest.path().equals("/main.js")) {
    pushedRequest.reset();
  } else {
    // Handle it
  }
});
```

å½“æœªè®¾ç½®å¤„ç†å™¨æ—¶,å®¢æˆ·ç«¯å°†è‡ªåŠ¨å–æ¶ˆæ¨é€çš„ä»»ä½•æµå¹¶é‡ç½®æµ(`8` é”™è¯¯ä»£ç ).

#### æ¥æ”¶è‡ªå®šä¹‰ HTTP/2 å¸§

HTTP/2 æ˜¯ä¸€ç§æ¡†æ¶åè®®,å…·æœ‰ç”¨äº HTTP è¯·æ±‚/å“åº”æ¨¡å‹çš„å„ç§æ¡†æ¶. è¯¥åè®®å…è®¸å‘é€å’Œæ¥æ”¶å…¶ä»–ç±»å‹çš„å¸§.

è¦æ¥æ”¶è‡ªå®šä¹‰å¸§,æ‚¨å¯ä»¥åœ¨è¯·æ±‚ä¸Šä½¿ç”¨ `customFrameHandler`,æ¯æ¬¡è‡ªå®šä¹‰å¸§åˆ°è¾¾æ—¶éƒ½ä¼šè°ƒç”¨å®ƒ. è¿™æ˜¯ä¸€ä¸ªä¾‹å­:

```java
response.customFrameHandler(frame -> {

  System.out.println("Received a frame type=" + frame.type() +
      " payload" + frame.payload().toString());
});
```

### åœ¨å®¢æˆ·ç«¯å¯ç”¨å‹ç¼©

http å®¢æˆ·ç«¯æ”¯æŒå¼€ç®±å³ç”¨çš„ HTTP å‹ç¼©.

è¿™æ„å‘³ç€å®¢æˆ·ç«¯å¯ä»¥è®©è¿œç¨‹ http æœåŠ¡å™¨çŸ¥é“å®ƒæ”¯æŒå‹ç¼©,å¹¶ä¸”èƒ½å¤Ÿå¤„ç†å‹ç¼©çš„å“åº”Body.

http æœåŠ¡å™¨å¯ä»¥è‡ªç”±åœ°ä½¿ç”¨ä¸€ç§å—æ”¯æŒçš„å‹ç¼©ç®—æ³•è¿›è¡Œå‹ç¼©,ä¹Ÿå¯ä»¥åœ¨æ ¹æœ¬ä¸å‹ç¼©çš„æƒ…å†µä¸‹å°†æ­£æ–‡å‘å›. æ‰€ä»¥è¿™åªæ˜¯å¯¹ Http æœåŠ¡å™¨çš„ä¸€ä¸ªæç¤º,å®ƒå¯ä»¥éšæ„å¿½ç•¥.

ä¸ºäº†å‘Šè¯‰ http æœåŠ¡å™¨å®¢æˆ·ç«¯æ”¯æŒå“ªç§å‹ç¼©,å®ƒå°†åŒ…å«ä¸€ä¸ª `Accept-Encoding` æ ‡å¤´,å…¶ä¸­åŒ…å«æ”¯æŒçš„å‹ç¼©ç®—æ³•ä½œä¸ºå€¼. æ”¯æŒå¤šç§å‹ç¼©ç®—æ³•. åœ¨ Vert.x çš„æƒ…å†µä¸‹,è¿™å°†å¯¼è‡´æ·»åŠ ä»¥ä¸‹æ ‡å¤´:

```
Accept-Encoding: gzip, deflate
```

ç„¶åæœåŠ¡å™¨å°†ä»å…¶ä¸­ä¹‹ä¸€ä¸­è¿›è¡Œé€‰æ‹©. æ‚¨å¯ä»¥é€šè¿‡æ£€æŸ¥ä»æœåŠ¡å™¨å‘å›çš„å“åº”ä¸­çš„`Content-Encoding`æ ‡å¤´æ¥æ£€æµ‹æœåŠ¡å™¨æ˜¯å¦å‹ç¼©äº†æ­£æ–‡.

å¦‚æœå“åº”çš„ä¸»ä½“æ˜¯é€šè¿‡ gzip å‹ç¼©çš„,å®ƒå°†åŒ…æ‹¬ä¾‹å¦‚ä»¥ä¸‹æ ‡å¤´:

```
Content-Encoding: gzip

```

åœ¨åˆ›å»ºå®¢æˆ·ç«¯æ—¶ä½¿ç”¨çš„é€‰é¡¹ä¸Šå¯ç”¨å‹ç¼©é›†`setTryUseCompression`.

é»˜è®¤æƒ…å†µä¸‹ç¦ç”¨å‹ç¼©.

### HTTP/1.x æ± åŒ–å¹¶ä¿æŒæ´»åŠ¨çŠ¶æ€

Http keep alive å…è®¸å°† http è¿æ¥ç”¨äºå¤šä¸ªè¯·æ±‚. å½“æ‚¨å‘åŒä¸€æœåŠ¡å™¨å‘å‡ºå¤šä¸ªè¯·æ±‚æ—¶,è¿™å¯ä»¥æ›´æœ‰æ•ˆåœ°ä½¿ç”¨è¿æ¥.

å¯¹äº HTTP/1.x ç‰ˆæœ¬,http å®¢æˆ·ç«¯æ”¯æŒè¿æ¥æ± ,å…è®¸æ‚¨åœ¨è¯·æ±‚ä¹‹é—´é‡ç”¨è¿æ¥.

ä¸ºäº†ä½¿æ± å·¥ä½œ,ä¿æŒæ´»åŠ¨å¿…é¡»åœ¨é…ç½®å®¢æˆ·ç«¯æ—¶ä½¿ç”¨çš„é€‰é¡¹ä¸Šä½¿ç”¨`setKeepAlive`ä¸ºçœŸ. é»˜è®¤å€¼æ˜¯true.

å½“å¯ç”¨ä¿æ´»æ—¶. Vert.x å°†ä¸ºæ¯ä¸ªå‘é€çš„ HTTP/1.0 è¯·æ±‚æ·»åŠ ä¸€ä¸ª `Connection: Keep-Alive` æ ‡å¤´. å½“ä¿æŒæ´»åŠ¨è¢«ç¦ç”¨æ—¶. Vert.x å°†åœ¨å‘é€çš„æ¯ä¸ª HTTP/1.1 è¯·æ±‚ä¸­æ·»åŠ ä¸€ä¸ª `Connection: Close` æ ‡å¤´,ä»¥è¡¨æ˜åœ¨å“åº”å®Œæˆåè¿æ¥å°†å…³é—­.

ä½¿ç”¨ `setMaxPoolSize` é…ç½® ** æ¯ä¸ªæœåŠ¡å™¨** çš„æœ€å¤§è¿æ¥æ± æ•°

åœ¨å¯ç”¨æ± çš„æƒ…å†µä¸‹å‘å‡ºè¯·æ±‚æ—¶,å¦‚æœå·²ä¸ºè¯¥æœåŠ¡å™¨åˆ›å»ºçš„è¿æ¥æ•°å°‘äºæœ€å¤§è¿æ¥æ•°,Vert.x å°†åˆ›å»ºä¸€ä¸ªæ–°è¿æ¥,å¦åˆ™ä¼šå°†è¯·æ±‚æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­.

è¶…æ—¶å,å®¢æˆ·ç«¯å°†è‡ªåŠ¨å…³é—­ä¿æŒæ´»åŠ¨è¿æ¥. æœåŠ¡å™¨å¯ä»¥ä½¿ç”¨ `keep-alive` æ ‡å¤´æŒ‡å®šè¶…æ—¶:

```
keep-alive: timeout=30
```

æ‚¨å¯ä»¥ä½¿ç”¨ `setKeepAliveTimeout` è®¾ç½®é»˜è®¤è¶…æ—¶ - åœ¨æ­¤è¶…æ—¶å†…æœªä½¿ç”¨çš„ä»»ä½•è¿æ¥éƒ½å°†è¢«å…³é—­. è¯·æ³¨æ„è¶…æ—¶å€¼æ˜¯ç§’è€Œä¸æ˜¯æ¯«ç§’.

### HTTP/1.1ç®¡é“

å®¢æˆ·ç«¯è¿˜æ”¯æŒè¿æ¥ä¸Šè¯·æ±‚çš„ç®¡é“è¿æ¥.

ç®¡é“è¿æ¥æ„å‘³ç€åœ¨å‰ä¸€ä¸ªè¯·æ±‚çš„å“åº”è¿”å›ä¹‹å‰,åœ¨åŒä¸€ä¸ªè¿æ¥ä¸Šå‘é€å¦ä¸€ä¸ªè¯·æ±‚.ç®¡é“å¹¶ä¸é€‚ç”¨äºæ‰€æœ‰è¯·æ±‚.

è¦å¯ç”¨ç®¡é“,å¿…é¡»ä½¿ç”¨`setPipelining`æ¥å¯ç”¨.ç¼ºçœæƒ…å†µä¸‹,ç®¡é“æ˜¯ç¦ç”¨çš„.

å½“å¯ç”¨äº†ç®¡é“è¿æ¥æ—¶,è¯·æ±‚å°†è¢«å†™å…¥åˆ°è¿æ¥ä¸­,è€Œæ— éœ€ç­‰å¾…ä¹‹å‰çš„å“åº”è¿”å›.

åœ¨å•ä¸ªè¿æ¥ä¸Šçš„ç®¡é“è¯·æ±‚çš„æ•°é‡è¢«`setPipeliningLimit`é™åˆ¶.è¿™ä¸ªé€‰é¡¹å®šä¹‰äº†å‘é€åˆ°æœåŠ¡å™¨ç­‰å¾…å“åº”çš„æœ€å¤§httpè¯·æ±‚æ•°.è¿™ä¸ªé™åˆ¶ç¡®ä¿äº†å®¢æˆ·ç«¯è¯·æ±‚åœ¨åˆ°åŒä¸€æœåŠ¡å™¨çš„è¿æ¥ä¸Šçš„åˆ†é…çš„å…¬å¹³æ€§.

### HTTP/2 å¤šè·¯å¤ç”¨

HTTP/2 æå€¡ä½¿ç”¨å•ä¸ªè¿æ¥åˆ°æœåŠ¡å™¨,é»˜è®¤æƒ…å†µä¸‹,http å®¢æˆ·ç«¯ä¸ºæ¯ä¸ªæœåŠ¡å™¨ä½¿ç”¨å•ä¸ªè¿æ¥,åˆ°åŒä¸€æœåŠ¡å™¨çš„æ‰€æœ‰æµéƒ½åœ¨åŒä¸€è¿æ¥ä¸Šå¤šè·¯å¤ç”¨.

å½“å®¢æˆ·ç«¯éœ€è¦ä½¿ç”¨å¤šä¸ªè¿æ¥å¹¶ä½¿ç”¨æ± æ—¶,åº”ä½¿ç”¨`setHttp2MaxPoolSize`.

å½“å¸Œæœ›é™åˆ¶æ¯ä¸ªè¿æ¥çš„å¤šè·¯å¤ç”¨æµæ•°é‡å¹¶ä½¿ç”¨è¿æ¥æ± è€Œä¸æ˜¯å•ä¸ªè¿æ¥æ—¶,å¯ä»¥ä½¿ç”¨`setHttp2MultiplexingLimit`.

```java
HttpClientOptions clientOptions = new HttpClientOptions().
    setHttp2MultiplexingLimit(10).
    setHttp2MaxPoolSize(3);

// Uses up to 3 connections and up to 10 streams per connection
HttpClient client = vertx.createHttpClient(clientOptions);
```

è¿æ¥çš„å¤šè·¯å¤ç”¨é™åˆ¶æ˜¯åœ¨å®¢æˆ·ç«¯ä¸Šè®¾ç½®çš„è®¾ç½®,ç”¨äºé™åˆ¶å•ä¸ªè¿æ¥çš„æµæ•°. å¦‚æœæœåŠ¡å™¨ä½¿ç”¨ `SETTINGS_MAX_CONCURRENT_STREAMS` è®¾ç½®è®¾ç½®ä¸‹é™,åˆ™æœ‰æ•ˆå€¼å¯èƒ½ä¼šæ›´ä½.

HTTP/2 è¿æ¥ä¸ä¼šè¢«å®¢æˆ·ç«¯è‡ªåŠ¨å…³é—­. è¦å…³é—­å®ƒä»¬,æ‚¨å¯ä»¥è°ƒç”¨ `close` æˆ–å…³é—­å®¢æˆ·ç«¯å®ä¾‹.

æˆ–è€…,æ‚¨å¯ä»¥ä½¿ç”¨ `setIdleTimeout` è®¾ç½®ç©ºé—²è¶…æ—¶ - åœ¨æ­¤è¶…æ—¶å†…æœªä½¿ç”¨çš„ä»»ä½•è¿æ¥éƒ½å°†è¢«å…³é—­. è¯·æ³¨æ„,ç©ºé—²è¶…æ—¶å€¼ä»¥ç§’ä¸ºå•ä½è€Œä¸æ˜¯æ¯«ç§’.

### HTTP è¿æ¥

`HttpConnection` æä¾›äº†å¤„ç† HTTP è¿æ¥äº‹ä»¶,ç”Ÿå‘½å‘¨æœŸå’Œè®¾ç½®çš„ API.

HTTP/2 å®Œå…¨å®ç°äº† `HttpConnection` API.

HTTP/1.x éƒ¨åˆ†å®ç°äº† `HttpConnection` API:ä»…å®ç°äº†å…³é—­æ“ä½œ,å…³é—­å¤„ç†å™¨å’Œå¼‚å¸¸å¤„ç†å™¨. è¯¥åè®®ä¸ä¸ºå…¶ä»–æ“ä½œæä¾›è¯­ä¹‰.

#### æœåŠ¡å™¨ è¿æ¥

`connection` æ–¹æ³•è¿”å›æœåŠ¡å™¨ä¸Šçš„è¯·æ±‚è¿æ¥:

```java
HttpConnection connection = request.connection();
```

å¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šè®¾ç½®è¿æ¥å¤„ç†å™¨,ä»¥é€šçŸ¥ä»»ä½•ä¼ å…¥è¿æ¥:

```java
HttpServer server = vertx.createHttpServer(http2Options);

server.connectionHandler(connection -> {
  System.out.println("A client connected");
});
```

#### å®¢æˆ·ç«¯ è¿æ¥

`connection` æ–¹æ³•è¿”å›å®¢æˆ·ç«¯ä¸Šçš„è¯·æ±‚è¿æ¥:

```java
HttpConnection connection = request.connection();
```

å¯ä»¥åœ¨å®¢æˆ·ç«¯ä¸Šè®¾ç½®è¿æ¥å¤„ç†å™¨,ä»¥ä¾¿åœ¨å»ºç«‹è¿æ¥æ—¶æ”¶åˆ°é€šçŸ¥:

```java
client.connectionHandler(connection -> {
  System.out.println("Connected to the server");
});
```

#### è¿æ¥ è®¾ç½®

HTTP/2 çš„é…ç½®ç”± `Http2Settings` æ•°æ®å¯¹è±¡é…ç½®.

æ¯ä¸ªç«¯ç‚¹éƒ½å¿…é¡»éµå®ˆè¿æ¥å¦ä¸€ç«¯å‘é€çš„è®¾ç½®.

å»ºç«‹è¿æ¥å,å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¼šäº¤æ¢åˆå§‹è®¾ç½®. åˆå§‹è®¾ç½®ç”±å®¢æˆ·ç«¯ä¸Šçš„`setInitialSettings`å’ŒæœåŠ¡å™¨ä¸Šçš„`setInitialSettings`é…ç½®.

å»ºç«‹è¿æ¥åå¯ä»¥éšæ—¶æ›´æ”¹è®¾ç½®:

```java
connection.updateSettings(new Http2Settings().setMaxConcurrentStreams(100));
```

ç”±äºè¿œç¨‹ç«¯åº”åœ¨æ”¶åˆ°è®¾ç½®æ›´æ–°æ—¶è¿›è¡Œç¡®è®¤,å› æ­¤å¯ä»¥æä¾›å›è°ƒä»¥é€šçŸ¥ç¡®è®¤:

```java
connection.updateSettings(new Http2Settings().setMaxConcurrentStreams(100), ar -> {
  if (ar.succeeded()) {
    System.out.println("The settings update has been acknowledged ");
  }
});
```

ç›¸å,å½“æ¥æ”¶åˆ°æ–°çš„è¿œç¨‹è®¾ç½®æ—¶,ä¼šé€šçŸ¥ `remoteSettingsHandler`:

```java
connection.remoteSettingsHandler(settings -> {
  System.out.println("Received new settings");
});
```

> **ğŸ·æ³¨æ„:** this only applies to the HTTP/2 protocol

#### è¿æ¥ ping

HTTP/2 è¿æ¥ ping å¯ç”¨äºç¡®å®šè¿æ¥å¾€è¿”æ—¶é—´æˆ–æ£€æŸ¥è¿æ¥æœ‰æ•ˆæ€§:`ping` å‘è¿œç¨‹ç«¯ç‚¹å‘é€ `{@literal PING}` å¸§:

```java
Buffer data = Buffer.buffer();
for (byte i = 0;i < 8;i++) {
  data.appendByte(i);
}
connection.ping(data, pong -> {
  System.out.println("Remote side replied");
});
```

Vert.x å°†åœ¨æ”¶åˆ° `{@literal PING}` å¸§æ—¶è‡ªåŠ¨å‘é€ç¡®è®¤,å¯ä»¥å°†å¤„ç†å™¨è®¾ç½®ä¸ºæ”¶åˆ°æ¯ä¸ª ping é€šçŸ¥:

```java
connection.pingHandler(ping -> {
  System.out.println("Got pinged by remote side");
});
```

å¤„ç†å™¨åªæ˜¯æ”¶åˆ°é€šçŸ¥,æ— è®ºå¦‚ä½•éƒ½ä¼šå‘é€ç¡®è®¤. æ­¤ç±»åŠŸèƒ½æ—¨åœ¨åœ¨ HTTP/2 ä¹‹ä¸Šå®ç°åè®®.

> **ğŸ·æ³¨æ„:** è¿™ä»…é€‚ç”¨äº HTTP/2 åè®®

#### è¿æ¥å…³é—­å¹¶ç¦»å¼€

è°ƒç”¨ `shutdown` å°†å‘è¿æ¥çš„è¿œç¨‹ç«¯å‘é€ä¸€ä¸ª` {@literal GOAWAY}` å¸§,è¦æ±‚å®ƒåœæ­¢åˆ›å»ºæµ:å®¢æˆ·ç«¯å°†åœæ­¢æ‰§è¡Œæ–°è¯·æ±‚,æœåŠ¡å™¨å°†åœæ­¢æ¨é€å“åº”. å‘é€ `{@literal GOAWAY}` å¸§å,è¿æ¥ä¼šç­‰å¾…ä¸€æ®µæ—¶é—´(é»˜è®¤ä¸º 30 ç§’),ç›´åˆ°æ‰€æœ‰å½“å‰æµå…³é—­å¹¶å…³é—­è¿æ¥:

```java
connection.shutdown();
```

`shutdownHandler` é€šçŸ¥æ‰€æœ‰æµå·²å…³é—­æ—¶,è¿æ¥å°šæœªå…³é—­.

å¯ä»¥åªå‘é€ä¸€ä¸ª `{@literal GOAWAY}` å¸§,ä¸å…³é—­çš„ä¸»è¦åŒºåˆ«åœ¨äºå®ƒåªä¼šå‘Šè¯‰è¿æ¥çš„è¿œç¨‹ç«¯åœæ­¢åˆ›å»ºæ–°æµè€Œä¸å®‰æ’å…³é—­è¿æ¥:

```java
connection.goAway(0);
```

ç›¸å,ä¹Ÿå¯ä»¥åœ¨æ”¶åˆ° `{@literal GOAWAY}` æ—¶å¾—åˆ°é€šçŸ¥:

```java
connection.goAwayHandler(goAway -> {
  System.out.println("Received a go away frame");
});
```

å½“æ‰€æœ‰å½“å‰æµéƒ½å·²å…³é—­å¹¶ä¸”å¯ä»¥å…³é—­è¿æ¥æ—¶,å°†è°ƒç”¨`shutdownHandler`:

```java
connection.goAway(0);
connection.shutdownHandler(v -> {

  // All streams are closed, close the connection
  connection.close();
});
```

è¿™ä¹Ÿé€‚ç”¨äºæ”¶åˆ° `{@literal GOAWAY}` æ—¶.

> **ğŸ·æ³¨æ„:** è¿™ä»…é€‚ç”¨äº HTTP/2 åè®®

#### è¿æ¥ å…³é—­

è¿æ¥è°ƒç”¨ `close`å…³é—­è¿æ¥:

- å®ƒå…³é—­ HTTP/1.x çš„å¥—æ¥å­—
- å¯¹äº HTTP/2 æ²¡æœ‰å»¶è¿Ÿçš„å…³é—­,{@literal GOAWAY} å¸§ä»å°†åœ¨è¿æ¥å…³é—­ä¹‹å‰å‘é€. 

å½“è¿æ¥å…³é—­æ—¶,`closeHandler` ä¼šå‘å‡ºé€šçŸ¥.

### å®¢æˆ·ç«¯ å…±äº«

æ‚¨å¯ä»¥åœ¨å¤šä¸ª Verticle æˆ–åŒä¸€ Verticle çš„å®ä¾‹ä¹‹é—´å…±äº«ä¸€ä¸ª HTTP å®¢æˆ·ç«¯. æ­¤ç±»å®¢æˆ·ç«¯åº”åœ¨ Verticle ä¹‹å¤–åˆ›å»º,å¦åˆ™åœ¨å–æ¶ˆéƒ¨ç½²åˆ›å»ºå®ƒçš„ Verticle æ—¶å®ƒå°†å…³é—­

```java
HttpClient client = vertx.createHttpClient(new HttpClientOptions().setShared(true));
vertx.deployVerticle(() -> new AbstractVerticle() {
  @Override
  public void start() throws Exception {
    // Use the client
  }
}, new DeploymentOptions().setInstances(4));
```

æ‚¨è¿˜å¯ä»¥åœ¨æ¯ä¸ª Verticle ä¸­åˆ›å»ºä¸€ä¸ªå…±äº«çš„ HTTP å®¢æˆ·ç«¯:

```java
vertx.deployVerticle(() -> new AbstractVerticle() {
  HttpClient client;
  @Override
  public void start() {
    // Get or create a shared client
    // this actually creates a lease to the client
    // when the verticle is undeployed, the lease will be released automaticaly
    client = vertx.createHttpClient(new HttpClientOptions().setShared(true).setName("my-client"));
  }
}, new DeploymentOptions().setInstances(4));
```

ç¬¬ä¸€æ¬¡åˆ›å»ºå…±äº«å®¢æˆ·ç«¯æ—¶,å®ƒå°†åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªå®¢æˆ·ç«¯. åç»­è°ƒç”¨å°†é‡ç”¨è¯¥å®¢æˆ·ç«¯å¹¶ä¸ºè¯¥å®¢æˆ·ç«¯åˆ›å»ºç§Ÿçº¦. åœ¨å¤„ç†å®Œæ‰€æœ‰ç§Ÿçº¦å,å®¢æˆ·ç«¯å°†å…³é—­.

é»˜è®¤æƒ…å†µä¸‹,å®¢æˆ·ç«¯åœ¨éœ€è¦åˆ›å»º TCP è¿æ¥æ—¶ä¼šé‡ç”¨å½“å‰çš„äº‹ä»¶å¾ªç¯. å› æ­¤,HTTP å®¢æˆ·ç«¯å°†éšæœºä½¿ç”¨ Verticle çš„äº‹ä»¶å¾ªç¯,ä»¥å®‰å…¨çš„æ–¹å¼ä½¿ç”¨å®ƒ.

æ‚¨å¯ä»¥åˆ†é…å¤šä¸ªäº‹ä»¶å¾ªç¯,å®¢æˆ·ç«¯å°†ç‹¬ç«‹äºä½¿ç”¨å®ƒçš„å®¢æˆ·ç«¯ä½¿ç”¨

```java
vertx.deployVerticle(() -> new AbstractVerticle() {
  HttpClient client;
  @Override
  public void start() {
    // The client creates and use two event-loops for 4 instances
    client = vertx.createHttpClient(new HttpClientOptions().setPoolEventLoopSize(2).setShared(true).setName("my-client"));
  }
}, new DeploymentOptions().setInstances(4));
```

### æœåŠ¡ç«¯ å…±äº«

å½“å¤šä¸ª HTTP æœåŠ¡å™¨åœ¨åŒä¸€ä¸ªç«¯å£ä¸Šä¾¦å¬æ—¶,vert.x ä½¿ç”¨å¾ªç¯ç­–ç•¥ç¼–æ’è¯·æ±‚å¤„ç†.

è®©æˆ‘ä»¬ä»¥ Verticle åˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡å™¨ä¸ºä¾‹:

io.vertx.examples.http.sharing.HttpServerVerticle

```java
vertx.createHttpServer().requestHandler(request -> {
  request.response().end("Hello from server " + this);
}).listen(8080);
```

è¯¥æœåŠ¡æ­£åœ¨ç›‘å¬ 8080 ç«¯å£.é‚£ä¹ˆ,å½“è¿™ä¸ª Verticle è¢«å¤šæ¬¡å®ä¾‹åŒ–æ—¶:`vertx run io.vertx.examples.http.sharing.HttpServerVerticle -instances 2`,å‘ç”Ÿäº†ä»€ä¹ˆ? å¦‚æœä¸¤ä¸ª Verticle éƒ½ç»‘å®šåˆ°åŒä¸€ä¸ªç«¯å£,ä½ ä¼šæ”¶åˆ°ä¸€ä¸ªå¥—æ¥å­—å¼‚å¸¸. å¹¸è¿çš„æ˜¯,vert.x æ­£åœ¨ä¸ºæ‚¨å¤„ç†è¿™ç§æƒ…å†µ. å½“æ‚¨åœ¨ä¸ç°æœ‰æœåŠ¡å™¨ç›¸åŒçš„ä¸»æœºå’Œç«¯å£ä¸Šéƒ¨ç½²å¦ä¸€å°æœåŠ¡å™¨æ—¶,å®ƒå®é™…ä¸Šå¹¶æ²¡æœ‰å°è¯•åˆ›å»ºä¸€ä¸ªåœ¨åŒä¸€ä¸»æœº/ç«¯å£ä¸Šä¾¦å¬çš„æ–°æœåŠ¡å™¨. å®ƒåªç»‘å®šä¸€æ¬¡åˆ°å¥—æ¥å­—. å½“æ”¶åˆ°è¯·æ±‚æ—¶,å®ƒä¼šæŒ‰ç…§å¾ªç¯ç­–ç•¥è°ƒç”¨æœåŠ¡å™¨å¤„ç†å™¨.

ç°åœ¨è®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸ªå®¢æˆ·ç«¯,ä¾‹å¦‚:

```java
vertx.setPeriodic(100, (l) -> {
  vertx.createHttpClient().request(HttpMethod.GET, 8080, "localhost", "/", ar1 -> {
    if (ar1.succeeded()) {
      HttpClientRequest request = ar1.result();
      request.send(ar2 -> {
        if (ar2.succeeded()) {
          HttpClientResponse resp = ar2.result();
          resp.bodyHandler(body -> {
            System.out.println(body.toString("ISO-8859-1"));
          });
        }
      });
    }
  });
});
```

Vert.x æŒ‰é¡ºåºå°†è¯·æ±‚å§”æ‰˜ç»™å…¶ä¸­ä¸€å°æœåŠ¡å™¨:

```
Hello from i.v.e.h.s.HttpServerVerticle@1
Hello from i.v.e.h.s.HttpServerVerticle@2
Hello from i.v.e.h.s.HttpServerVerticle@1
Hello from i.v.e.h.s.HttpServerVerticle@2
...
```

å› æ­¤,æœåŠ¡å™¨å¯ä»¥åœ¨å¯ç”¨å†…æ ¸ä¸Šæ‰©å±•,è€Œæ¯ä¸ª Vert.x verticle å®ä¾‹éƒ½ä¿æŒä¸¥æ ¼çš„å•çº¿ç¨‹,å¹¶ä¸”æ‚¨æ— éœ€æ‰§è¡Œä»»ä½•ç‰¹æ®ŠæŠ€å·§,ä¾‹å¦‚ç¼–å†™è´Ÿè½½å¹³è¡¡å™¨å³å¯åœ¨å¤šæ ¸æœºå™¨ä¸Šæ‰©å±•æœåŠ¡å™¨.

ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ªè´Ÿçš„ç«¯å£å€¼ç»‘å®šä¸€ä¸ªå…±äº«çš„éšæœºç«¯å£,ç¬¬ä¸€ä¸ªç»‘å®šå°†éšæœºé€‰æ‹©ä¸€ä¸ªç«¯å£,ç›¸åŒç«¯å£å€¼çš„åç»­ç»‘å®šå°†å…±äº«è¿™ä¸ªéšæœºç«¯å£.

`io.vertx.examples.http.sharing.HttpServerVerticle`ä¾‹å­:

```java
vertx.createHttpServer().requestHandler(request -> {
  request.response().end("Hello from server " + this);
}).listen(-1);
```

### åœ¨ Vert.x ä¸­ä½¿ç”¨ HTTPS

Vert.x http æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å¯ä»¥é…ç½®ä¸ºä½¿ç”¨ HTTPS,å…¶æ–¹å¼ä¸ç½‘ç»œæœåŠ¡å™¨å®Œå…¨ç›¸åŒ.

è¯·å‚é˜… [é…ç½®ç½‘ç»œæœåŠ¡å™¨ä»¥ä½¿ç”¨ SSL](#ssl) äº†è§£æ›´å¤šä¿¡æ¯.

SSL ä¹Ÿå¯ä»¥ä½¿ç”¨ `RequestOptions` æˆ–åœ¨ä½¿ç”¨ `setAbsoluteURI` æ–¹æ³•æŒ‡å®šæ–¹æ¡ˆæ—¶å¯ç”¨/ç¦ç”¨æ¯ä¸ªè¯·æ±‚.

```java
client.request(new RequestOptions()
    .setHost("localhost")
    .setPort(8080)
    .setURI("/")
    .setSsl(true), ar1 -> {
  if (ar1.succeeded()) {
    HttpClientRequest request = ar1.result();
    request.send(ar2 -> {
      if (ar2.succeeded()) {
        HttpClientResponse response = ar2.result();
        System.out.println("Received response with status code " + response.statusCode());
      }
    });
  }
});
```

`setSsl` è®¾ç½®å……å½“é»˜è®¤å®¢æˆ·ç«¯è®¾ç½®.

`setSsl` è¦†ç›–é»˜è®¤å®¢æˆ·ç«¯è®¾ç½®

- å³ä½¿å°†å®¢æˆ·ç«¯é…ç½®ä¸ºä½¿ç”¨ SSL/TLS,å°†å€¼è®¾ç½®ä¸º `false` ä¹Ÿä¼šç¦ç”¨ SSL/TLS
- å°†å€¼è®¾ç½®ä¸º `true` å°†å¯ç”¨ SSL/TLS,å³ä½¿å®¢æˆ·ç«¯é…ç½®ä¸ºä¸ä½¿ç”¨ SSL/TLS,å®é™…å®¢æˆ·ç«¯ SSL/TLS(ä¾‹å¦‚ä¿¡ä»»,å¯†é’¥/è¯ä¹¦,å¯†ç ,ALPN ç­‰)å°†è¢«é‡ç”¨

åŒæ ·,`setAbsoluteURI` æ–¹æ¡ˆä¹Ÿè¦†ç›–äº†é»˜è®¤çš„å®¢æˆ·ç«¯è®¾ç½®.

#### æœåŠ¡å™¨åç§°æŒ‡ç¤º (SNI)

Vert.x http æœåŠ¡å™¨å¯ä»¥é…ç½®ä¸ºä½¿ç”¨ä¸ {@linkplain io.vertx.core.net net servers} å®Œå…¨ç›¸åŒçš„æ–¹å¼ä½¿ç”¨ SNI.

Vert.x http å®¢æˆ·ç«¯å°†åœ¨ TLS æ¡æ‰‹æœŸé—´å°†å®é™…ä¸»æœºåæ˜¾ç¤ºä¸º *server name*.

### WebSockets

[WebSockets](https://en.wikipedia.org/wiki/WebSocket) æ˜¯ä¸€ç§ Web æŠ€æœ¯,å®ƒå…è®¸åœ¨ HTTP æœåŠ¡å™¨å’Œ HTTP å®¢æˆ·ç«¯(é€šå¸¸æ˜¯æµè§ˆå™¨)ä¹‹é—´å»ºç«‹ç±»ä¼¼å…¨åŒå·¥å¥—æ¥å­—çš„è¿æ¥.

Vert.x supports WebSockets on both the client and server-side.

#### æœåŠ¡å™¨ä¸Šçš„ WebSockets

åœ¨æœåŠ¡å™¨ç«¯æœ‰ä¸¤ç§å¤„ç† WebSocket çš„æ–¹æ³•.

##### WebSocket å¤„ç†å™¨

ç¬¬ä¸€ç§æ–¹æ³•æ¶‰åŠåœ¨æœåŠ¡å™¨å®ä¾‹ä¸Šæä¾›ä¸€ä¸ª`webSocketHandler`.

å½“ä¸æœåŠ¡å™¨å»ºç«‹ WebSocket è¿æ¥æ—¶,å°†è°ƒç”¨å¤„ç†å™¨,å¹¶ä¼ å…¥ `ServerWebSocket` çš„å®ä¾‹.

```java
server.webSocketHandler(webSocket -> {
  System.out.println("Connected!");
});
```

æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨ `reject` æ¥é€‰æ‹©æ‹’ç» WebSocket.

```java
server.webSocketHandler(webSocket -> {
  if (webSocket.path().equals("/myapi")) {
    webSocket.reject();
  } else {
    // Do something
  }
});
```

æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨å¸¦æœ‰ `Future` çš„ `setHandshake` æ¥æ‰§è¡Œå¼‚æ­¥æ¡æ‰‹:

```java
server.webSocketHandler(webSocket -> {
  Promise<Integer> promise = Promise.promise();
  webSocket.setHandshake(promise.future());
  authenticate(webSocket.headers(), ar -> {
    if (ar.succeeded()) {
      // Terminate the handshake with the status code 101 (Switching Protocol)
      // Reject the handshake with 401 (Unauthorized)
      promise.complete(ar.succeeded() ? 101 : 401);
    } else {
      // Will send a 500 error
      promise.fail(ar.cause());
    }
  });
});
```

> **ğŸ·æ³¨æ„:** é™¤éWebSocketçš„æ¡æ‰‹è¢«è®¾ç½®å¥½äº†,å¦åˆ™WebSocketä¼šåœ¨å¤„ç†å™¨è¢«è°ƒç”¨åè¢«è‡ªåŠ¨æ¥å—

##### å‡çº§åˆ° WebSocket

å¤„ç† WebSocket çš„ç¬¬äºŒç§æ–¹æ³•æ˜¯å¤„ç†ä»å®¢æˆ·ç«¯å‘é€çš„ HTTP å‡çº§è¯·æ±‚,å¹¶åœ¨æœåŠ¡å™¨è¯·æ±‚ä¸Šè°ƒç”¨ `toWebSocket`.

```java
server.requestHandler(request -> {
  if (request.path().equals("/myapi")) {

    Future<ServerWebSocket> fut = request.toWebSocket();
    fut.onSuccess(ws -> {
      // Do something
    });

  } else {
    // Reject
    request.response().setStatusCode(400).end();
  }
});
```

##### æœåŠ¡å™¨ç«¯çš„ WebSocket

`ServerWebSocket` å®ä¾‹ä½¿æ‚¨èƒ½å¤Ÿæ£€ç´¢ WebSocket æ¡æ‰‹çš„ HTTP è¯·æ±‚çš„ `headers`,`path`,`query` å’Œ `URI`.

#### å®¢æˆ·ç«¯çš„ WebSocket

Vert.xçš„ `HttpClient` æ”¯æŒ WebSockets.

æ‚¨å¯ä»¥ä½¿ç”¨ `webSocket` æ“ä½œä¹‹ä¸€å¹¶æä¾›å¤„ç†å™¨å°† WebSocket è¿æ¥åˆ°æœåŠ¡å™¨.

å»ºç«‹è¿æ¥å,å°†ä½¿ç”¨ `WebSocket` çš„å®ä¾‹è°ƒç”¨å¤„ç†å™¨:

```java
client.webSocket("/some-uri", res -> {
  if (res.succeeded()) {
    WebSocket ws = res.result();
    System.out.println("Connected!");
  }
});
```

é»˜è®¤æƒ…å†µä¸‹,å®¢æˆ·ç«¯å°† `origin` æ ‡å¤´è®¾ç½®ä¸ºæœåŠ¡å™¨ä¸»æœº,ä¾‹å¦‚ [http://www.example.com](http://www.example.com/). æœ‰äº›æœåŠ¡å™¨ä¼šæ‹’ç»è¿™æ ·çš„è¯·æ±‚,ä½ å¯ä»¥é…ç½®å®¢æˆ·ç«¯ä¸è®¾ç½®è¿™ä¸ªå¤´.

```java
WebSocketConnectOptions options = new WebSocketConnectOptions()
  .setHost(host)
  .setPort(port)
  .setURI(requestUri)
  .setAllowOriginHeader(false);
client.webSocket(options, res -> {
  if (res.succeeded()) {
    WebSocket ws = res.result();
    System.out.println("Connected!");
  }
});
```

æ‚¨è¿˜å¯ä»¥è®¾ç½®ä¸åŒçš„æ ‡é¢˜:

```java
WebSocketConnectOptions options = new WebSocketConnectOptions()
  .setHost(host)
  .setPort(port)
  .setURI(requestUri)
  .addHeader(HttpHeaders.ORIGIN, origin);
client.webSocket(options, res -> {
  if (res.succeeded()) {
    WebSocket ws = res.result();
    System.out.println("Connected!");
  }
});
```

> **ğŸ·æ³¨æ„:** æ—§ç‰ˆæœ¬çš„ WebSocket åè®®ä½¿ç”¨ `sec-websocket-origin`

#### å°†æ¶ˆæ¯å†™å…¥ WebSocket

å¦‚æœæ‚¨å¸Œæœ›å°†å•ä¸ª WebSocket æ¶ˆæ¯å†™å…¥ WebSocket,æ‚¨å¯ä»¥ä½¿ç”¨ `writeBinaryMessage` æˆ– `writeTextMessage` æ‰§è¡Œæ­¤æ“ä½œ:

```java
Buffer buffer = Buffer.buffer().appendInt(123).appendFloat(1.23f);
webSocket.writeBinaryMessage(buffer);

// Write a simple text message
String message = "hello";
webSocket.writeTextMessage(message);
```

å¦‚æœ WebSocket æ¶ˆæ¯å¤§äºä½¿ç”¨ `setMaxWebSocketFrameSize` é…ç½®çš„æœ€å¤§ WebSocket å¸§å¤§å°,åˆ™ Vert.x å°†åœ¨å°†å…¶åœ¨çº¿å‘é€ä¹‹å‰å°†å…¶æ‹†åˆ†ä¸ºå¤šä¸ª WebSocket å¸§.

#### å°†å¸§å†™å…¥ WebSocket

ä¸€ä¸ª WebSocket æ¶ˆæ¯å¯ä»¥ç”±å¤šä¸ªå¸§ç»„æˆ. åœ¨è¿™ç§æƒ…å†µä¸‹,ç¬¬ä¸€å¸§æ˜¯ *binary* æˆ– *text* å¸§,åè·Ÿé›¶ä¸ªæˆ–å¤šä¸ª *continuation* å¸§.

æ¶ˆæ¯ä¸­çš„æœ€åä¸€å¸§è¢«æ ‡è®°ä¸º *final*.

è¦å‘é€ç”±å¤šä¸ªå¸§ç»„æˆçš„æ¶ˆæ¯,æ‚¨å¯ä»¥ä½¿ç”¨ `WebSocketFrame.binaryFrame` , `WebSocketFrame.textFrame` æˆ– `WebSocketFrame.continuationFrame` åˆ›å»ºå¸§,ç„¶åä½¿ç”¨ `writeFrame` å°†å®ƒä»¬å†™å…¥ WebSocket.

Here's an example for binary frames:

```java
WebSocketFrame frame1 = WebSocketFrame.binaryFrame(buffer1, false);
webSocket.writeFrame(frame1);

WebSocketFrame frame2 = WebSocketFrame.continuationFrame(buffer2, false);
webSocket.writeFrame(frame2);

// Write the final frame
WebSocketFrame frame3 = WebSocketFrame.continuationFrame(buffer2, true);
webSocket.writeFrame(frame3);
```

åœ¨è®¸å¤šæƒ…å†µä¸‹,æ‚¨åªæƒ³å‘é€ä¸€ä¸ªåŒ…å«å•ä¸ªæœ€ç»ˆå¸§çš„ WebSocket æ¶ˆæ¯,å› æ­¤æˆ‘ä»¬æä¾›äº†ä¸€äº›å¿«æ·æ–¹æ³•æ¥æ‰§è¡Œæ­¤æ“ä½œ,ä½¿ç”¨ `writeFinalBinaryFrame` å’Œ `writeFinalTextFrame`.

è¿™æ˜¯ä¸€ä¸ªä¾‹å­:

```java
webSocket.writeFinalTextFrame("Geronimo!");

// Send a WebSocket message consisting of a single final binary frame:

Buffer buff = Buffer.buffer().appendInt(12).appendString("foo");

webSocket.writeFinalBinaryFrame(buff);
```

#### ä» WebSocket è¯»å–å¸§

è¦ä» WebSocket è¯»å–å¸§,è¯·ä½¿ç”¨`frameHandler`.

å½“å¸§åˆ°è¾¾æ—¶,å°†ä½¿ç”¨ `WebSocketFrame` å®ä¾‹è°ƒç”¨å¸§å¤„ç†å™¨,ä¾‹å¦‚:

```java
webSocket.frameHandler(frame -> {
  System.out.println("Received a frame of size!");
});
```

#### å…³é—­ WebSockets

å®Œæˆåä½¿ç”¨ `close` å…³é—­ WebSocket è¿æ¥.

#### ç®¡é“ WebSockets

`WebSocket` å®ä¾‹ä¹Ÿæ˜¯ `ReadStream` å’Œ `WriteStream`,å› æ­¤å®ƒå¯ä»¥ä¸ç®¡é“ä¸€èµ·ä½¿ç”¨.

å°† WebSocket ç”¨ä½œå†™å…¥æµæˆ–è¯»å–æµæ—¶,å®ƒåªèƒ½ä¸ WebSockets è¿æ¥ä¸€èµ·ä½¿ç”¨,è¿™äº›è¿æ¥ä¸ä¸æ‹†åˆ†ä¸ºå¤šä¸ªå¸§çš„äºŒè¿›åˆ¶å¸§ä¸€èµ·ä½¿ç”¨.

#### äº‹ä»¶æ€»çº¿å¤„ç†å™¨

æ¯ä¸ªWebSocketä¼šè‡ªåŠ¨åœ¨äº‹ä»¶æ€»çº¿ä¸Šæ³¨å†Œä¸¤ä¸ªå¤„ç†å™¨,å½“è¿™ä¸ªå¤„ç†å™¨æ¥æ”¶åˆ°ä»»ä½•æ•°æ®æ—¶,å®ƒä¼šå°†å®ƒä»¬å†™å…¥è‡ªèº«.è¿™äº›æ˜¯ä¸åœ¨é›†ç¾¤ä¸Šè·¯ç”±çš„æœ¬åœ°è®¢é˜….

è¿™ä½¿æ‚¨èƒ½å¤Ÿå°†æ•°æ®å†™å…¥ WebSocket,è¯¥ WebSocket å¯èƒ½åœ¨ä¸€ä¸ªå®Œå…¨ä¸åŒçš„ Verticle ä¸­,å°†æ•°æ®å‘é€åˆ°è¯¥å¤„ç†å™¨çš„åœ°å€.

å¤„ç†å™¨çš„åœ°å€ç”± `binaryHandlerID` å’Œ `textHandlerID` ç»™å‡º.

### ä¸º HTTP/HTTPS è¿æ¥ä½¿ç”¨ä»£ç†

http å®¢æˆ·ç«¯æ”¯æŒé€šè¿‡ HTTP ä»£ç†(ä¾‹å¦‚ Squid)æˆ– *SOCKS4a* æˆ– *SOCKS5* ä»£ç†è®¿é—® http/https URL. CONNECT åè®®ä½¿ç”¨ HTTP/1.x,ä½†å¯ä»¥è¿æ¥åˆ° HTTP/1.x å’Œ HTTP/2 æœåŠ¡å™¨.

http ä»£ç†å¯èƒ½ä¸æ”¯æŒè¿æ¥åˆ° h2c(æœªåŠ å¯†çš„ HTTP/2 æœåŠ¡å™¨),å› ä¸ºå®ƒä»¬ä»…æ”¯æŒ HTTP/1.1.

å¯ä»¥é€šè¿‡è®¾ç½®åŒ…å«ä»£ç†ç±»å‹,ä¸»æœºå,ç«¯å£ä»¥åŠå¯é€‰çš„ç”¨æˆ·åå’Œå¯†ç çš„ `ProxyOptions` å¯¹è±¡åœ¨ `HttpClientOptions` ä¸­é…ç½®ä»£ç†.

è¿™æ˜¯ä½¿ç”¨ HTTP ä»£ç†çš„ç¤ºä¾‹:

```java
HttpClientOptions options = new HttpClientOptions()
    .setProxyOptions(new ProxyOptions().setType(ProxyType.HTTP)
        .setHost("localhost").setPort(3128)
        .setUsername("username").setPassword("secret"));
HttpClient client = vertx.createHttpClient(options);
```

å½“å®¢æˆ·ç«¯è¿æ¥åˆ°ä¸€ä¸ª http URL æ—¶,å®ƒä¼šè¿æ¥åˆ°ä»£ç†æœåŠ¡å™¨å¹¶åœ¨ HTTP è¯·æ±‚ä¸­æä¾›å®Œæ•´çš„ URL("GET http://www.somehost.com/path/file.html HTTP/1.1").

å½“å®¢æˆ·ç«¯è¿æ¥åˆ° https URL æ—¶,å®ƒè¦æ±‚ä»£ç†ä½¿ç”¨ CONNECT æ–¹æ³•åˆ›å»ºåˆ°è¿œç¨‹ä¸»æœºçš„éš§é“.

å¯¹äº SOCKS5 ä»£ç†:

```java
HttpClientOptions options = new HttpClientOptions()
    .setProxyOptions(new ProxyOptions().setType(ProxyType.SOCKS5)
        .setHost("localhost").setPort(1080)
        .setUsername("username").setPassword("secret"));
HttpClient client = vertx.createHttpClient(options);
```

DNSè§£ææ€»æ˜¯åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šå®Œæˆ,è¦å®ç°SOCKS4å®¢æˆ·ç«¯çš„åŠŸèƒ½,éœ€è¦åœ¨æœ¬åœ°è§£æDNSåœ°å€.

ä»£ç†é€‰é¡¹ä¹Ÿå¯ä»¥æ ¹æ®è¯·æ±‚è®¾ç½®:

```java
client.request(new RequestOptions()
  .setHost("example.com")
  .setProxyOptions(proxyOptions))
  .compose(request -> request
    .send()
    .compose(HttpClientResponse::body))
  .onSuccess(body -> {
    System.out.println("Received response");
  });
```

> **ğŸ·æ³¨æ„:** ç»™å®šçš„ä¸»æœºåº”å§‹ç»ˆä½¿ç”¨ç›¸åŒçš„ä»£ç†é€‰é¡¹:ç”±äº HTTP è¯·æ±‚æ˜¯æ± åŒ–çš„,å› æ­¤åœ¨å»ºç«‹è¿æ¥æ—¶ä½¿ç”¨æ¯ä¸ªè¯·æ±‚çš„ä»£ç†é€‰é¡¹

æ‚¨å¯ä»¥ä½¿ç”¨ `setNonProxyHosts` æ¥é…ç½®ç»•è¿‡ä»£ç†çš„ä¸»æœºåˆ—è¡¨. åˆ—è¡¨æ¥å— `*` é€šé…ç¬¦æ¥åŒ¹é…åŸŸ:

```java
HttpClientOptions options = new HttpClientOptions()
  .setProxyOptions(new ProxyOptions().setType(ProxyType.SOCKS5)
    .setHost("localhost").setPort(1080)
    .setUsername("username").setPassword("secret"))
  .addNonProxyHost("*.foo.com")
  .addNonProxyHost("localhost");
HttpClient client = vertx.createHttpClient(options);
```

#### å¤„ç†å…¶ä»–åè®®

å¦‚æœä»£ç†æ”¯æŒ,HTTP ä»£ç†å®ç°æ”¯æŒè·å– ftp:// url.

å½“ HTTP è¯·æ±‚ URI åŒ…å«å®Œæ•´çš„ URL æ—¶,å®¢æˆ·ç«¯å°†ä¸ä¼šè®¡ç®—å®Œæ•´çš„ HTTP url,è€Œæ˜¯ä½¿ç”¨è¯·æ±‚ URI ä¸­æŒ‡å®šçš„å®Œæ•´ URL:

```java
HttpClientOptions options = new HttpClientOptions()
    .setProxyOptions(new ProxyOptions().setType(ProxyType.HTTP));
HttpClient client = vertx.createHttpClient(options);
client.request(HttpMethod.GET, "ftp://ftp.gnu.org/gnu/", ar -> {
  if (ar.succeeded()) {
    HttpClientRequest request = ar.result();
    request.send(ar2 -> {
      if (ar2.succeeded()) {
        HttpClientResponse response = ar2.result();
        System.out.println("Received response with status code " + response.statusCode());
      }
    });
  }
});
```

### ä½¿ç”¨ HA PROXY  åè®®

[HA PROXY åè®®](https://www.haproxy.org/download/1.8/doc/proxy-protocol.txt) æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥å®‰å…¨åœ°è·¨å¤šä¸ª NAT æˆ– TCP ä»£ç†ä¼ è¾“å®¢æˆ·ç«¯åœ°å€ç­‰è¿æ¥ä¿¡æ¯ .

å¯ä»¥é€šè¿‡è®¾ç½®é€‰é¡¹ `setUseProxyProtocol` å¹¶åœ¨ç±»è·¯å¾„ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–é¡¹æ¥å¯ç”¨ HA PROXY åè®®:

```xml
<dependency>
 <groupId>io.netty</groupId>
 <artifactId>netty-codec-haproxy</artifactId>
 <!--<version>Should align with netty version that Vert.x uses</version>-->
</dependency>
```

```java
HttpServerOptions options = new HttpServerOptions()
  .setUseProxyProtocol(true);

HttpServer server = vertx.createHttpServer(options);
server.requestHandler(request -> {
  // Print the actual client address provided by the HA proxy protocol instead of the proxy address
  System.out.println(request.remoteAddress());

  // Print the address of the proxy
  System.out.println(request.localAddress());
});
```

### Verticleä¸­çš„è‡ªåŠ¨æ¸…ç†

å¦‚æœæ‚¨ä» Verticle å†…éƒ¨åˆ›å»º http æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯,è¿™äº›æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å°†åœ¨ verticle å–æ¶ˆéƒ¨ç½²æ—¶è‡ªåŠ¨å…³é—­.

## ä½¿ç”¨ SharedData API

é¡¾åæ€ä¹‰,`SharedData` API å…è®¸æ‚¨åœ¨ä»¥ä¸‹ä¹‹é—´å®‰å…¨åœ°å…±äº«æ•°æ®:

- åº”ç”¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†,æˆ–
- åŒä¸€ä¸ª Vert.x å®ä¾‹ä¸­çš„ä¸åŒåº”ç”¨ç¨‹åº,æˆ–
- è·¨ Vert.x å®ä¾‹é›†ç¾¤çš„ä¸åŒåº”ç”¨ç¨‹åº.

å®é™…ä¸Š,å®ƒæä¾›äº†:

- åŒæ­¥ maps(ä»…é™æœ¬åœ°)
- å¼‚æ­¥ maps
- å¼‚æ­¥ locks
- å¼‚æ­¥ counters

> **âš é‡è¦:** åˆ†å¸ƒå¼æ•°æ®ç»“æ„çš„è¡Œä¸ºå–å†³äºæ‚¨ä½¿ç”¨çš„é›†ç¾¤ç®¡ç†å™¨. é¢å¯¹ç½‘ç»œåˆ†åŒºæ—¶çš„å¤‡ä»½(å¤åˆ¶)å’Œè¡Œä¸ºç”±é›†ç¾¤ç®¡ç†å™¨åŠå…¶é…ç½®å®šä¹‰. è¯·å‚é˜…é›†ç¾¤ç®¡ç†å™¨æ–‡æ¡£ä»¥åŠåº•å±‚æ¡†æ¶æ‰‹å†Œ.

### æœ¬åœ° maps

`Local maps` å…è®¸æ‚¨åœ¨åŒä¸€ä¸ª Vert.x å®ä¾‹ä¸­çš„ä¸åŒäº‹ä»¶å¾ªç¯(ä¾‹å¦‚ä¸åŒçš„ Verticle)ä¹‹é—´å®‰å…¨åœ°å…±äº«æ•°æ®.

å®ƒä»¬åªå…è®¸å°†æŸäº›æ•°æ®ç±»å‹ç”¨ä½œé”®å’Œå€¼:

- ä¸å¯å˜ç±»å‹(ä¾‹å¦‚å­—ç¬¦ä¸²,å¸ƒå°”å€¼ç­‰),æˆ–
- å®ç°äº†`Shareable`æ¥å£çš„ç±»å‹(buffers,JSON æ•°ç»„,JSON å¯¹è±¡æˆ–æ‚¨è‡ªå·±çš„å¯å…±äº«å¯¹è±¡).

åœ¨åä¸€ç§æƒ…å†µä¸‹,é”®/å€¼å°†åœ¨æ”¾å…¥mapä¹‹å‰è¢«å¤åˆ¶.

é€šè¿‡è¿™ç§æ–¹å¼,æˆ‘ä»¬å¯ä»¥ç¡®ä¿åœ¨æ‚¨çš„ Vert.x åº”ç”¨ç¨‹åºçš„ä¸åŒçº¿ç¨‹ä¹‹é—´æ²¡æœ‰*å¯¹å¯å˜çŠ¶æ€çš„å…±äº«è®¿é—®*. è€Œä¸”æ‚¨ä¸å¿…æ‹…å¿ƒé€šè¿‡åŒæ­¥è®¿é—®æ¥ä¿æŠ¤è¯¥çŠ¶æ€.

è¿™æ˜¯ä½¿ç”¨å…±äº«æœ¬åœ°mapçš„ç¤ºä¾‹:

```java
SharedData sharedData = vertx.sharedData();

LocalMap<String, String> map1 = sharedData.getLocalMap("mymap1");

map1.put("foo", "bar"); // Strings are immutable so no need to copy

LocalMap<String, Buffer> map2 = sharedData.getLocalMap("mymap2");

map2.put("eek", Buffer.buffer().appendInt(123)); // This buffer will be copied before adding to map

// Then... in another part of your application:

map1 = sharedData.getLocalMap("mymap1");

String val = map1.get("foo");

map2 = sharedData.getLocalMap("mymap2");

Buffer buff = map2.get("eek");
```

### å¼‚æ­¥å…±äº« maps

`å¼‚æ­¥å…±äº«Map`å…è®¸å°†æ•°æ®æ”¾å…¥mapåœ¨æœ¬åœ°æˆ–ä»ä»»ä½•å…¶ä»–èŠ‚ç‚¹æ£€ç´¢.

è¿™ä½¿å¾—å®ƒä»¬å¯¹äºè¯¸å¦‚å°†ä¼šè¯çŠ¶æ€å­˜å‚¨åœ¨æ‰˜ç®¡ Vert.x Web åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨åœºä¸­éå¸¸æœ‰ç”¨.

è·å–mapæ˜¯å¼‚æ­¥çš„,ç»“æœä¼šåœ¨æ‚¨æŒ‡å®šçš„å¤„ç†å™¨ä¸­è¿”å›ç»™æ‚¨. è¿™æ˜¯ä¸€ä¸ªä¾‹å­:

```java
SharedData sharedData = vertx.sharedData();

sharedData.<String, String>getAsyncMap("mymap", res -> {
  if (res.succeeded()) {
    AsyncMap<String, String> map = res.result();
  } else {
    // Something went wrong!
  }
});
```

å½“ Vert.x è¢«é›†ç¾¤æ—¶,æ‚¨æ”¾å…¥mapçš„æ•°æ®å¯ä»¥åœ¨æœ¬åœ°è®¿é—®,ä¹Ÿå¯ä»¥åœ¨ä»»ä½•å…¶ä»–é›†ç¾¤æˆå‘˜ä¸Šè®¿é—®.

> **âš é‡è¦:** åœ¨é›†ç¾¤æ¨¡å¼ä¸‹,å¼‚æ­¥å…±äº«mapä¾èµ–äºé›†ç¾¤ç®¡ç†å™¨æä¾›çš„åˆ†å¸ƒå¼æ•°æ®ç»“æ„. è¯·æ³¨æ„,é›†ç¾¤æ¨¡å¼ä¸‹ä¸å¼‚æ­¥å…±äº«mapæ“ä½œç›¸å…³çš„å»¶è¿Ÿå¯èƒ½æ¯”æœ¬åœ°æ¨¡å¼ä¸‹é«˜å¾—å¤š.

å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºä¸éœ€è¦ä¸å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹å…±äº«æ•°æ®,æ‚¨å¯ä»¥æ£€ç´¢ä¸€ä¸ªä»…é™æœ¬åœ°çš„map:

```java
SharedData sharedData = vertx.sharedData();

sharedData.<String, String>getLocalAsyncMap("mymap", res -> {
  if (res.succeeded()) {
    // Local-only async map
    AsyncMap<String, String> map = res.result();
  } else {
    // Something went wrong!
  }
});
```

#### å°†æ•°æ®æ”¾å…¥map

ä½ ç”¨ `put` æŠŠæ•°æ®æ”¾åˆ°ä¸€ä¸ªmapä¸­.

å®é™…çš„ put æ˜¯å¼‚æ­¥çš„,ä¸€æ—¦å®Œæˆå°±ä¼šé€šçŸ¥å¤„ç†å™¨:

```java
map.put("foo", "bar", resPut -> {
  if (resPut.succeeded()) {
    // Successfully put the value
  } else {
    // Something went wrong!
  }
});
```

#### ä»mapä¸­è·å–æ•°æ®

æ‚¨å¯ä»¥ä½¿ç”¨ `get` ä»mapä¸­è·å–æ•°æ®.

å®é™…çš„ get æ˜¯å¼‚æ­¥çš„,å¤„ç†å™¨ä¼šåœ¨ä¸€æ®µæ—¶é—´åæ”¶åˆ°ç»“æœé€šçŸ¥:

```java
map.get("foo", resGet -> {
  if (resGet.succeeded()) {
    // Successfully got the value
    Object val = resGet.result();
  } else {
    // Something went wrong!
  }
});
```

##### å…¶ä»–mapæ“ä½œ

æ‚¨è¿˜å¯ä»¥ä»å¼‚æ­¥mapä¸­åˆ é™¤æ¡ç›®,æ¸…é™¤å®ƒä»¬å¹¶è·å–å¤§å°.

æœ‰å…³mapæ“ä½œçš„è¯¦ç»†åˆ—è¡¨,è¯·å‚é˜…`API æ–‡æ¡£`.

### å¼‚æ­¥ locks

`å¼‚æ­¥é”`å…è®¸æ‚¨åœ¨æœ¬åœ°æˆ–è·¨é›†ç¾¤è·å¾—æ’ä»–é”. å½“æ‚¨æƒ³è¦åœ¨ä»»ä½•æ—¶å€™åªåœ¨é›†ç¾¤çš„ä¸€ä¸ªèŠ‚ç‚¹ä¸ŠåšæŸäº‹æˆ–è®¿é—®èµ„æºæ—¶,è¿™å¾ˆæœ‰ç”¨.

ä¸å¤§å¤šæ•°é” API ä¸åŒ,å¼‚æ­¥é”æœ‰ä¸€ä¸ªå¼‚æ­¥ API,åè€…ä¼šé˜»å¡è°ƒç”¨çº¿ç¨‹,ç›´åˆ°è·å¾—é”ä¸ºæ­¢.

è¦è·å¾—é”,è¯·ä½¿ç”¨`getLock`. è¿™ä¸ä¼šé˜»å¡,ä½†æ˜¯å½“é”å¯ç”¨æ—¶,å°†ä½¿ç”¨ `Lock` çš„å®ä¾‹è°ƒç”¨å¤„ç†å™¨,è¡¨æ˜æ‚¨ç°åœ¨æ‹¥æœ‰é”.

å½“æ‚¨æ‹¥æœ‰é”æ—¶,æœ¬åœ°æˆ–é›†ç¾¤ä¸Šçš„å…¶ä»–è°ƒç”¨è€…å°†æ— æ³•è·å¾—é”.

å½“ä½ å®Œæˆé”å,ä½ è°ƒç”¨`release`æ¥é‡Šæ”¾å®ƒ,æ‰€ä»¥å¦ä¸€ä¸ªè°ƒç”¨è€…å¯ä»¥è·å¾—å®ƒ:

```java
SharedData sharedData = vertx.sharedData();

sharedData.getLock("mylock", res -> {
  if (res.succeeded()) {
    // Got the lock!
    Lock lock = res.result();

    // 5 seconds later we release the lock so someone else can get it

    vertx.setTimer(5000, tid -> lock.release());

  } else {
    // Something went wrong
  }
});
```

æ‚¨è¿˜å¯ä»¥é€šè¿‡è¶…æ—¶è·å¾—é”. å¦‚æœåœ¨è¶…æ—¶æ—¶é—´å†…æœªèƒ½è·å¾—é”,åˆ™å¤„ç†å™¨å°†è¢«è°ƒç”¨å¤±è´¥:

```java
SharedData sharedData = vertx.sharedData();

sharedData.getLockWithTimeout("mylock", 10000, res -> {
  if (res.succeeded()) {
    // Got the lock!
    Lock lock = res.result();

  } else {
    // Failed to get lock
  }
});
```

æœ‰å…³lockæ“ä½œçš„è¯¦ç»†åˆ—è¡¨,è¯·å‚é˜…`API æ–‡æ¡£`.

> **âš é‡è¦:** åœ¨é›†ç¾¤æ¨¡å¼ä¸‹,å¼‚æ­¥é”ä¾èµ–äºé›†ç¾¤ç®¡ç†å™¨æä¾›çš„åˆ†å¸ƒå¼æ•°æ®ç»“æ„. è¯·æ³¨æ„,é›†ç¾¤æ¨¡å¼ä¸‹ä¸å¼‚æ­¥å…±äº«é”æ“ä½œç›¸å…³çš„å»¶è¿Ÿå¯èƒ½æ¯”æœ¬åœ°æ¨¡å¼ä¸‹é«˜å¾—å¤š.

å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºä¸éœ€è¦ä¸å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹å…±äº«é”,æ‚¨å¯ä»¥æ£€ç´¢æœ¬åœ°é”:

```java
SharedData sharedData = vertx.sharedData();

sharedData.getLocalLock("mylock", res -> {
  if (res.succeeded()) {
    // Local-only lock
    Lock lock = res.result();

    // 5 seconds later we release the lock so someone else can get it

    vertx.setTimer(5000, tid -> lock.release());

  } else {
    // Something went wrong
  }
});
```

### å¼‚æ­¥ counters

åœ¨æœ¬åœ°æˆ–è·¨åº”ç”¨ç¨‹åºçš„ä¸åŒèŠ‚ç‚¹ç»´æŠ¤åŸå­è®¡æ•°å™¨é€šå¸¸å¾ˆæœ‰ç”¨.

æ‚¨å¯ä»¥ä½¿ç”¨ `Counter` æ‰§è¡Œæ­¤æ“ä½œ.

æ‚¨ä½¿ç”¨ `getCounter` è·å¾—ä¸€ä¸ªå®ä¾‹:

```java
SharedData sharedData = vertx.sharedData();

sharedData.getCounter("mycounter", res -> {
  if (res.succeeded()) {
    Counter counter = res.result();
  } else {
    // Something went wrong!
  }
});
```

ä¸€æ—¦ä½ æœ‰ä¸€ä¸ªå®ä¾‹,ä½ å¯ä»¥æ£€ç´¢å½“å‰è®¡æ•°,åŸå­åœ°å¢åŠ å®ƒ,å‡å°‘å®ƒå¹¶ä½¿ç”¨å„ç§æ–¹æ³•å‘å®ƒæ·»åŠ ä¸€ä¸ªå€¼.

æœ‰å…³è®¡æ•°å™¨æ“ä½œçš„è¯¦ç»†åˆ—è¡¨,è¯·å‚é˜…`API æ–‡æ¡£`.

> **âš é‡è¦:** åœ¨é›†ç¾¤æ¨¡å¼ä¸‹,å¼‚æ­¥è®¡æ•°å™¨ä¾èµ–äºé›†ç¾¤ç®¡ç†å™¨æä¾›çš„åˆ†å¸ƒå¼æ•°æ®ç»“æ„. è¯·æ³¨æ„,é›†ç¾¤æ¨¡å¼ä¸‹ä¸å¼‚æ­¥å…±äº«è®¡æ•°å™¨æ“ä½œç›¸å…³çš„å»¶è¿Ÿå¯èƒ½æ¯”æœ¬åœ°æ¨¡å¼ä¸‹é«˜å¾—å¤š.

If your application doesn't need the counter to be shared with every other node, you can retrieve a local-only counter:

```java
SharedData sharedData = vertx.sharedData();

sharedData.getLocalCounter("mycounter", res -> {
  if (res.succeeded()) {
    // Local-only counter
    Counter counter = res.result();
  } else {
    // Something went wrong!
  }
});
```

## åœ¨ Vert.x ä¸­ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿ

Vert.x `FileSystem` å¯¹è±¡æä¾›äº†è®¸å¤šæ“ä½œæ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œ.

æ¯ä¸ª Vert.x å®ä¾‹æœ‰ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¯¹è±¡,æ‚¨å¯ä»¥é€šè¿‡ `fileSystem` æ–¹æ³•æ¥è·å¾—å®ƒ.

æä¾›äº†æ¯ä¸ªæ“ä½œçš„é˜»å¡å’Œéé˜»å¡ç‰ˆæœ¬. éé˜»å¡ç‰ˆæœ¬é‡‡ç”¨ä¸€ä¸ªå¤„ç†å™¨,å½“æ“ä½œå®Œæˆæˆ–å‘ç”Ÿé”™è¯¯æ—¶è°ƒç”¨è¯¥å¤„ç†å™¨.

ä¸‹é¢æ˜¯ä¸€ä¸ªæ–‡ä»¶çš„å¼‚æ­¥å‰¯æœ¬ç¤ºä¾‹:

```java
FileSystem fs = vertx.fileSystem();

// Copy file from foo.txt to bar.txt
fs.copy("foo.txt", "bar.txt", res -> {
  if (res.succeeded()) {
    // Copied ok!
  } else {
    // Something went wrong
  }
});
```

é˜»å¡ç‰ˆæœ¬è¢«å‘½åä¸º `xxxBlocking` å¹¶ç›´æ¥è¿”å›ç»“æœæˆ–æŠ›å‡ºå¼‚å¸¸. åœ¨è®¸å¤šæƒ…å†µä¸‹,æ ¹æ®æ“ä½œç³»ç»Ÿå’Œæ–‡ä»¶ç³»ç»Ÿ,ä¸€äº›æ½œåœ¨çš„é˜»å¡æ“ä½œå¯èƒ½ä¼šå¾ˆå¿«è¿”å›,è¿™å°±æ˜¯æˆ‘ä»¬æä¾›å®ƒä»¬çš„åŸå› ,ä½†å¼ºçƒˆå»ºè®®æ‚¨åœ¨ä»äº‹ä»¶å¾ªç¯ä¸­ä½¿ç”¨å®ƒä»¬ä¹‹å‰æµ‹è¯•å®ƒä»¬åœ¨ç‰¹å®šåº”ç”¨ç¨‹åºä¸­è¿”å›æ‰€éœ€çš„æ—¶é—´,ä»¥å…è¿å<mark>**é»„é‡‘æ³•åˆ™**</mark>.

è¿™æ˜¯ä½¿ç”¨é˜»å¡ API çš„`copy`:

```java
FileSystem fs = vertx.fileSystem();

// Copy file from foo.txt to bar.txt synchronously
fs.copyBlocking("foo.txt", "bar.txt");
```

å­˜åœ¨è®¸å¤šæ“ä½œæ¥ å¤åˆ¶,ç§»åŠ¨,æˆªæ–­,chmod å’Œè®¸å¤šå…¶ä»–æ–‡ä»¶æ“ä½œ. æˆ‘ä»¬ä¸ä¼šåœ¨è¿™é‡Œå…¨éƒ¨åˆ—å‡º,è¯·æŸ¥é˜… `API docs` è·å–å®Œæ•´åˆ—è¡¨.

è®©æˆ‘ä»¬çœ‹å‡ ä¸ªä½¿ç”¨å¼‚æ­¥æ–¹æ³•çš„ä¾‹å­:

```java
vertx.fileSystem().readFile("target/classes/readme.txt", result -> {
  if (result.succeeded()) {
    System.out.println(result.result());
  } else {
    System.err.println("Oh oh ..." + result.cause());
  }
});

// Copy a file
vertx.fileSystem().copy("target/classes/readme.txt", "target/classes/readme2.txt", result -> {
  if (result.succeeded()) {
    System.out.println("File copied");
  } else {
    System.err.println("Oh oh ..." + result.cause());
  }
});

// Write a file
vertx.fileSystem().writeFile("target/classes/hello.txt", Buffer.buffer("Hello"), result -> {
  if (result.succeeded()) {
    System.out.println("File written");
  } else {
    System.err.println("Oh oh ..." + result.cause());
  }
});

// Check existence and delete
vertx.fileSystem().exists("target/classes/junk.txt", result -> {
  if (result.succeeded() && result.result()) {
    vertx.fileSystem().delete("target/classes/junk.txt", r -> {
      System.out.println("File deleted");
    });
  } else {
    System.err.println("Oh oh ... - cannot delete the file: " + result.cause());
  }
});
```

### å¼‚æ­¥æ–‡ä»¶

Vert.x æä¾›äº†ä¸€ç§å¼‚æ­¥æ–‡ä»¶æŠ½è±¡,å…è®¸æ‚¨æ“ä½œæ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶.

å¦‚ä¸‹æ‰€ç¤ºæ‰“å¼€ä¸€ä¸ª`AsyncFile`:

```java
OpenOptions options = new OpenOptions();
fileSystem.open("myfile.txt", options, res -> {
  if (res.succeeded()) {
    AsyncFile file = res.result();
  } else {
    // Something went wrong!
  }
});
```

`AsyncFile` å®ç°äº† `ReadStream` å’Œ `WriteStream`,å› æ­¤æ‚¨å¯ä»¥ *pipe* æ–‡ä»¶ä¸å…¶ä»–æµå¯¹è±¡(ä¾‹å¦‚ç½‘ç»œå¥—æ¥å­—,http è¯·æ±‚å’Œå“åº”ä»¥åŠ WebSockets)ä¹‹é—´è¿›è¡Œä¼ è¾“.

å®ƒä»¬è¿˜å…è®¸æ‚¨ç›´æ¥è¯»å–å’Œå†™å…¥å®ƒä»¬.

#### éšæœºå­˜å–å†™

è¦ä½¿ç”¨ `AsyncFile` è¿›è¡Œéšæœºå­˜å–å†™å…¥,è¯·ä½¿ç”¨ `write` æ–¹æ³•.

è¯¥æ–¹æ³•çš„å‚æ•°æ˜¯:

- `buffer`: è¦å†™å…¥çš„ç¼“å†²åŒº.
- `position`: æ–‡ä»¶ä¸­å†™å…¥ç¼“å†²åŒºçš„æ•´æ•°ä½ç½®. å¦‚æœä½ç½®å¤§äºæˆ–ç­‰äºæ–‡ä»¶çš„å¤§å°,æ–‡ä»¶å°†è¢«æ”¾å¤§ä»¥é€‚åº”åç§»é‡.
- `handler`: ç»“æœå¤„ç†å™¨

è¿™æ˜¯éšæœºå­˜å–å†™å…¥çš„ç¤ºä¾‹:

```java
vertx.fileSystem().open("target/classes/hello.txt", new OpenOptions(), result -> {
  if (result.succeeded()) {
    AsyncFile file = result.result();
    Buffer buff = Buffer.buffer("foo");
    for (int i = 0; i < 5; i++) {
      file.write(buff, buff.length() * i, ar -> {
        if (ar.succeeded()) {
          System.out.println("Written ok!");
          // etc
        } else {
          System.err.println("Failed to write: " + ar.cause());
        }
      });
    }
  } else {
    System.err.println("Cannot open file " + result.cause());
  }
});
```

#### éšæœºå­˜å–è¯»

è¦ä½¿ç”¨ `AsyncFile` è¿›è¡Œéšæœºå­˜å–è¯»,è¯·ä½¿ç”¨ `read` æ–¹æ³•.

è¯¥æ–¹æ³•çš„å‚æ•°æ˜¯:

- `buffer`: æ•°æ®å°†è¢«è¯»å–åˆ°çš„ç¼“å†²åŒº.
- `offset`: å°†æ”¾ç½®è¯»å–æ•°æ®çš„ç¼“å†²åŒºçš„æ•´æ•°åç§»é‡.
- `position`: æ–‡ä»¶ä¸­ä»ä¸­è¯»å–æ•°æ®çš„ä½ç½®.
- `length`: è¦è¯»å–çš„æ•°æ®å­—èŠ‚æ•°
- `handler`: ç»“æœå¤„ç†å™¨

è¿™æ˜¯éšæœºè®¿é—®è¯»å–çš„ç¤ºä¾‹:

```java
vertx.fileSystem().open("target/classes/les_miserables.txt", new OpenOptions(), result -> {
  if (result.succeeded()) {
    AsyncFile file = result.result();
    Buffer buff = Buffer.buffer(1000);
    for (int i = 0; i < 10; i++) {
      file.read(buff, i * 100, i * 100, 100, ar -> {
        if (ar.succeeded()) {
          System.out.println("Read ok!");
        } else {
          System.err.println("Failed to write: " + ar.cause());
        }
      });
    }
  } else {
    System.err.println("Cannot open file " + result.cause());
  }
});
```

#### æ‰“å¼€é€‰é¡¹

å½“æ‰“å¼€ä¸€ä¸ª `AsyncFile` æ—¶,ä½ ä¼ é€’äº†ä¸€ä¸ª `OpenOptions` å®ä¾‹. è¿™äº›é€‰é¡¹æè¿°æ–‡ä»¶è®¿é—®çš„è¡Œä¸º. ä¾‹å¦‚,æ‚¨å¯ä»¥ä½¿ç”¨ `setRead`,`setWrite` å’Œ `setPerms` æ–¹æ³•é…ç½®æ–‡ä»¶æƒé™.

å¦‚æœæ‰“å¼€çš„æ–‡ä»¶å·²ç»å­˜åœ¨,æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ `setCreateNew` å’Œ `setTruncateExisting` é…ç½®è¡Œä¸º.

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ `setDeleteOnClose` æ ‡è®°è¦åœ¨å…³é—­æˆ–å…³é—­ JVM æ—¶åˆ é™¤çš„æ–‡ä»¶.

#### å°†æ•°æ®åˆ·æ–°åˆ°åº•å±‚å­˜å‚¨.

åœ¨ `OpenOptions` ä¸­,æ‚¨å¯ä»¥ä½¿ç”¨ `setDsync` åœ¨æ¯æ¬¡å†™å…¥æ—¶å¯ç”¨/ç¦ç”¨å†…å®¹çš„è‡ªåŠ¨åŒæ­¥. åœ¨è¿™ç§æƒ…å†µä¸‹,æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨ `flush` æ–¹æ³•æ‰‹åŠ¨åˆ·æ–°æ“ä½œç³»ç»Ÿç¼“å­˜ä¸­çš„ä»»ä½•å†™å…¥.

æ­¤æ–¹æ³•ä¹Ÿå¯ä»¥é€šè¿‡ä¸€ä¸ªå¤„ç†å™¨æ¥è°ƒç”¨,è¯¥å¤„ç†å™¨å°†åœ¨åˆ·æ–°å®Œæˆæ—¶è°ƒç”¨.

#### ä½¿ç”¨ AsyncFile ä½œä¸º ReadStream å’Œ WriteStream

`AsyncFile` å®ç°äº† `ReadStream` å’Œ `WriteStream`. ç„¶å,æ‚¨å¯ä»¥å°†å®ƒä»¬ä¸ *pipe* ä¸€èµ·ä½¿ç”¨,å°†æ•°æ®é€šè¿‡ç®¡é“ä¼ è¾“åˆ°å…¶ä»–è¯»å†™æµ. ä¾‹å¦‚,è¿™ä¼šå°†å†…å®¹å¤åˆ¶åˆ°å¦ä¸€ä¸ª `AsyncFile`:

```java
final AsyncFile output = vertx.fileSystem().openBlocking("target/classes/plagiary.txt", new OpenOptions());

vertx.fileSystem().open("target/classes/les_miserables.txt", new OpenOptions(), result -> {
  if (result.succeeded()) {
    AsyncFile file = result.result();
    file.pipeTo(output)
      .onComplete(v -> {
        System.out.println("Copy done");
      });
  } else {
    System.err.println("Cannot open file " + result.cause());
  }
});
```

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ *pipe* å°†æ–‡ä»¶å†…å®¹å†™å…¥ HTTP å“åº”,æˆ–è€…æ›´æ™®éåœ°å†™å…¥ä»»ä½• `WriteStream`.

<a name="classpath"></a>
#### [ä»classpath(ç±»è·¯å¾„)è®¿é—®æ–‡ä»¶](#classpath)

å½“vert.xæ— æ³•åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ‰¾åˆ°è¯¥æ–‡ä»¶æ—¶,å®ƒå°†å°è¯•ä»ç±»è·¯å¾„è§£æè¯¥æ–‡ä»¶.<mark>**è¯·æ³¨æ„,ç±»è·¯å¾„èµ„æºè·¯å¾„ä¸èƒ½ä»¥`/`å¼€å¤´.**</mark>

ç”±äºJavaæ²¡æœ‰æä¾›å¯¹ç±»è·¯å¾„èµ„æºçš„å¼‚æ­¥è®¿é—®,å½“ç¬¬ä¸€æ¬¡è®¿é—®ç±»è·¯å¾„èµ„æºæ—¶,æ–‡ä»¶ä¼šè¢«å¤åˆ¶åˆ°å·¥ä½œçº¿ç¨‹ä¸­çš„æ–‡ä»¶ç³»ç»Ÿä¸­,å¹¶ä»é‚£é‡Œå¼‚æ­¥åœ°æä¾›æœåŠ¡.å½“ç¬¬äºŒæ¬¡è®¿é—®ç›¸åŒçš„èµ„æºæ—¶,æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶å°†ç›´æ¥ä»æ–‡ä»¶ç³»ç»Ÿä¸­æä¾›.å³ä½¿ç±»è·¯å¾„èµ„æºå‘ç”Ÿäº†å˜åŒ–(ä¾‹å¦‚åœ¨å¼€å‘ç³»ç»Ÿä¸­),ä¹Ÿåªä¼šæœ€åˆå†…å®¹è¢«æä¾›.

æ­¤ç¼“å­˜è¡Œä¸ºå¯ä»¥åœ¨ `FileSystemOptions.setFileCachingEnabled()` é€‰é¡¹ä¸Šè®¾ç½®. æ­¤é€‰é¡¹çš„é»˜è®¤å€¼ä¸º `true`,é™¤éå®šä¹‰äº†ç³»ç»Ÿå±æ€§ `vertx.disableFileCaching`.

æ–‡ä»¶ç¼“å­˜çš„è·¯å¾„é»˜è®¤æ˜¯`/tmp/vertx-cache-UUID`,å¯ä»¥é€šè¿‡è®¾ç½®ç³»ç»Ÿå±æ€§`vertx.cacheDirBase`æ¥è‡ªå®šä¹‰. ä½¿ç”¨æ­¤å±æ€§æ—¶,å®ƒåº”è¯¥æŒ‡å‘è¿›ç¨‹å¯è¯»/å¯å†™ä½ç½®ä¸­çš„ç›®å½•å‰ç¼€,ä¾‹å¦‚:`-Dvertx.cacheDirBase=/tmp/my-vertx-cache`(è¯·æ³¨æ„,æ²¡æœ‰ UUID).

æ¯ä¸ª vert.x è¿›ç¨‹éƒ½ä¼šé™„åŠ å®ƒè‡ªå·±çš„ UUID,ä»¥ä¾¿ä¿æŒç¼“å­˜ç‹¬ç«‹äºåœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œçš„ä¸åŒåº”ç”¨ç¨‹åº.

é€šè¿‡å°†ç³»ç»Ÿå±æ€§ `vertx.disableFileCPResolving` è®¾ç½®ä¸º `true`,å¯ä»¥åœ¨ç³»ç»ŸèŒƒå›´å†…ç¦ç”¨æ•´ä¸ªç±»è·¯å¾„è§£æåŠŸèƒ½.

> **ğŸ·æ³¨æ„:** è¿™äº›ç³»ç»Ÿå±æ€§ä¼šåœ¨åŠ è½½ `io.vertx.core.file.FileSystemOptions` ç±»æ—¶è¯„ä¼°ä¸€æ¬¡,å› æ­¤åº”åœ¨åŠ è½½æ­¤ç±»ä¹‹å‰è®¾ç½®è¿™äº›å±æ€§,æˆ–è€…åœ¨å¯åŠ¨å®ƒæ—¶å°†å…¶è®¾ç½®ä¸º JVM ç³»ç»Ÿå±æ€§.

å¦‚æœä½ æƒ³åœ¨ç‰¹å®šçš„åº”ç”¨ç¨‹åºä¸­ç¦ç”¨ç±»è·¯å¾„è§£æ,ä½†æ˜¯åœ¨ç³»ç»ŸèŒƒå›´å†…é»˜è®¤å¯ç”¨å®ƒ,ä½ å¯ä»¥é€šè¿‡`VertxOptions.getFileSystemOptions().setClassPathResolvingEnabled()`é€‰é¡¹æ¥å®ç°.

#### å…³é—­ AsyncFile

è¦å…³é—­ `AsyncFile`,è¯·è°ƒç”¨ `close` æ–¹æ³•. å…³é—­æ˜¯å¼‚æ­¥çš„,å¦‚æœæ‚¨æƒ³åœ¨å…³é—­å®Œæˆæ—¶æ”¶åˆ°é€šçŸ¥,æ‚¨å¯ä»¥æŒ‡å®šä¸€ä¸ªå¤„ç†å‡½æ•°ä½œä¸ºå‚æ•°.

## æ•°æ®æŠ¥å¥—æ¥å­— (UDP)

åœ¨ Vert.x ä¸­ä½¿ç”¨ç”¨æˆ·æ•°æ®æŠ¥åè®® (UDP) æ˜¯å°èœä¸€ç¢Ÿ.

UDP æ˜¯ä¸€ç§æ— è¿æ¥ä¼ è¾“,è¿™åŸºæœ¬ä¸Šæ„å‘³ç€æ‚¨æ²¡æœ‰ä¸è¿œç¨‹å¯¹ç­‰æ–¹çš„æŒä¹…è¿æ¥.

ç›¸å,æ‚¨å¯ä»¥å‘é€å’Œæ¥æ”¶åŒ…,å¹¶ä¸”æ¯ä¸ªåŒ…ä¸­éƒ½åŒ…å«è¿œç¨‹åœ°å€.

é™¤æ­¤ä¹‹å¤–,UDP ä½¿ç”¨èµ·æ¥ä¸å¦‚ TCP å®‰å…¨,è¿™æ„å‘³ç€æ ¹æœ¬æ— æ³•ä¿è¯å‘é€æ•°æ®æŠ¥æ•°æ®åŒ…ä¼šæ”¶åˆ°å®ƒçš„ç«¯ç‚¹.

å”¯ä¸€çš„ä¿è¯æ˜¯å®ƒè¦ä¹ˆä¼šæ”¶åˆ°å®Œæ•´çš„,è¦ä¹ˆæ ¹æœ¬ä¸ä¼šæ”¶åˆ°.

æ­¤å¤–,æ‚¨é€šå¸¸ä¸èƒ½å‘é€å¤§äºç½‘ç»œæ¥å£ MTU å¤§å°çš„æ•°æ®,è¿™æ˜¯å› ä¸ºæ¯ä¸ªæ•°æ®åŒ…å°†ä½œä¸ºä¸€ä¸ªæ•°æ®åŒ…å‘é€.

ä½†æ˜¯,è¯·æ³¨æ„,å³ä½¿æ•°æ®åŒ…å¤§å°å°äº MTU,å®ƒä»å¯èƒ½å¤±è´¥.

å¤±è´¥çš„å¤§å°å–å†³äºæ“ä½œç³»ç»Ÿç­‰.æ‰€ä»¥ç»éªŒæ³•åˆ™æ˜¯å°è¯•å‘é€å°æ•°æ®åŒ….

ç”±äº UDP çš„æ€§è´¨,å®ƒæœ€é€‚åˆå…è®¸æ‚¨ä¸¢å¼ƒæ•°æ®åŒ…çš„åº”ç”¨ç¨‹åº(ä¾‹å¦‚ç›‘æ§åº”ç”¨ç¨‹åº).

å¥½å¤„æ˜¯ä¸ TCP ç›¸æ¯”,å®ƒçš„å¼€é”€è¦å°‘å¾—å¤š,å¯ä»¥ç”± NetServer å’Œ NetClient å¤„ç†(è§ä¸Šæ–‡).

### åˆ›å»ºæ•°æ®æŠ¥å¥—æ¥å­—

è¦ä½¿ç”¨ UDP,æ‚¨é¦–å…ˆéœ€è¦åˆ›å»ºä¸€ä¸ª `DatagramSocket`. å¦‚æœæ‚¨åªæƒ³å‘é€æ•°æ®æˆ–å‘é€å’Œæ¥æ”¶,è¿™å¹¶ä¸é‡è¦.

```java
DatagramSocket socket = vertx.createDatagramSocket(new DatagramSocketOptions());
```

è¿”å›çš„ `DatagramSocket` ä¸ä¼šç»‘å®šåˆ°ç‰¹å®šç«¯å£. å¦‚æœæ‚¨åªæƒ³å‘é€æ•°æ®(å¦‚å®¢æˆ·ç«¯),è¿™ä¸æ˜¯é—®é¢˜,ä½†ä¸‹ä¸€èŠ‚å°†è¯¦ç»†ä»‹ç».

### å‘é€æ•°æ®æŠ¥åŒ…

å¦‚å‰æ‰€è¿°,ç”¨æˆ·æ•°æ®æŠ¥åè®® (UDP) ä»¥æ•°æ®åŒ…çš„å½¢å¼å°†æ•°æ®å‘é€åˆ°è¿œç¨‹å¯¹ç­‰ç‚¹,ä½†ä¸ä¼šä»¥æŒä¹…çš„æ–¹å¼è¿æ¥åˆ°å®ƒä»¬.

è¿™æ„å‘³ç€æ¯ä¸ªæ•°æ®åŒ…éƒ½å¯ä»¥å‘é€åˆ°ä¸åŒçš„è¿œç¨‹å¯¹ç­‰æ–¹.

å‘é€æ•°æ®åŒ…å¾ˆç®€å•,å¦‚ä¸‹æ‰€ç¤º:

```java
DatagramSocket socket = vertx.createDatagramSocket(new DatagramSocketOptions());
Buffer buffer = Buffer.buffer("content");
// Send a Buffer
socket.send(buffer, 1234, "10.0.0.1", asyncResult -> {
  System.out.println("Send succeeded? " + asyncResult.succeeded());
});
// Send a String
socket.send("A string used as content", 1234, "10.0.0.1", asyncResult -> {
  System.out.println("Send succeeded? " + asyncResult.succeeded());
});
```

### æ¥æ”¶æ•°æ®æŠ¥åŒ…

å¦‚æœä½ æƒ³æ¥æ”¶æ•°æ®åŒ…,ä½ éœ€è¦é€šè¿‡è°ƒç”¨`listen(â€¦)}`æ¥ç»‘å®š`DatagramSocket`.

è¿™æ ·,æ‚¨å°†èƒ½å¤Ÿæ¥æ”¶å‘é€åˆ°`DatagramSocket`ä¾¦å¬çš„åœ°å€å’Œç«¯å£çš„`DatagramPacket`.

é™¤æ­¤ä¹‹å¤–,æ‚¨è¿˜æƒ³è®¾ç½®ä¸€ä¸ª `Handler`,å®ƒå°†ä¸ºæ¯ä¸ªæ”¶åˆ°çš„ `DatagramPacket` è°ƒç”¨.

`DatagramPacket` æœ‰ä»¥ä¸‹æ–¹æ³•:

- `sender`:ä»£è¡¨æ•°æ®åŒ…å‘é€è€…çš„ InetSocketAddress
- `data`:ä¿å­˜æ¥æ”¶åˆ°çš„æ•°æ®çš„ç¼“å†²åŒº.

å› æ­¤,è¦ç›‘å¬ç‰¹å®šåœ°å€å’Œç«¯å£,æ‚¨å¯ä»¥æ‰§è¡Œå¦‚ä¸‹æ‰€ç¤ºçš„æ“ä½œ:

```java
DatagramSocket socket = vertx.createDatagramSocket(new DatagramSocketOptions());
socket.listen(1234, "0.0.0.0", asyncResult -> {
  if (asyncResult.succeeded()) {
    socket.handler(packet -> {
      // Do something with the packet
    });
  } else {
    System.out.println("Listen failed" + asyncResult.cause());
  }
});
```

> **ğŸ·æ³¨æ„:** è¯·æ³¨æ„,å³ä½¿ {code AsyncResult} æˆåŠŸ,å®ƒä¹Ÿä»…æ„å‘³ç€å®ƒå¯èƒ½è¢«å†™å…¥ç½‘ç»œå †æ ˆ,ä½†ä¸èƒ½ä¿è¯å®ƒæ›¾ç»åˆ°è¾¾æˆ–å°†åˆ°è¾¾è¿œç¨‹å¯¹ç­‰ç‚¹.

å¦‚æœæ‚¨éœ€è¦è¿™æ ·çš„ä¿è¯,é‚£ä¹ˆæ‚¨å¸Œæœ›ä½¿ç”¨ TCP å¹¶åœ¨é¡¶éƒ¨æ„å»ºä¸€äº›æ¡æ‰‹é€»è¾‘.

### Multicast(ç»„æ’­)

#### å‘é€ç»„æ’­æ•°æ®åŒ…

ç»„æ’­å…è®¸å¤šä¸ªå¥—æ¥å­—æ¥æ”¶ç›¸åŒçš„æ•°æ®åŒ…. è¿™æ˜¯é€šè¿‡è®©å¥—æ¥å­—åŠ å…¥åŒä¸€ä¸ªå¤šæ’­ç»„æ¥å®ç°çš„,ç„¶åæ‚¨å¯ä»¥å°†æ•°æ®åŒ…å‘é€åˆ°è¯¥ç»„.

æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€èŠ‚ä¸­ä»‹ç»å¦‚ä½•åŠ å…¥å¤šæ’­ç»„å¹¶æ¥æ”¶æ•°æ®åŒ….

å‘é€å¤šæ’­æ•°æ®åŒ…ä¸å‘é€æ™®é€šæ•°æ®æŠ¥æ•°æ®åŒ…æ²¡æœ‰åŒºåˆ«. ä¸åŒä¹‹å¤„åœ¨äºæ‚¨å°†å¤šæ’­ç»„åœ°å€ä¼ é€’ç»™ send æ–¹æ³•.

å¦‚ä¸‹æ‰€ç¤º:

```java
DatagramSocket socket = vertx.createDatagramSocket(new DatagramSocketOptions());
Buffer buffer = Buffer.buffer("content");
// Send a Buffer to a multicast address
socket.send(buffer, 1234, "230.0.0.1", asyncResult -> {
  System.out.println("Send succeeded? " + asyncResult.succeeded());
});
```

æ‰€æœ‰å·²åŠ å…¥å¤šæ’­ç»„ `230.0.0.1` çš„å¥—æ¥å­—éƒ½å°†æ”¶åˆ°è¯¥æ•°æ®åŒ….

##### æ¥æ”¶ç»„æ’­æ•°æ®åŒ…

å¦‚æœä½ æƒ³æ¥æ”¶ç‰¹å®šç»„æ’­ç»„çš„æ•°æ®åŒ…,ä½ éœ€è¦é€šè¿‡è°ƒç”¨`listen(â€¦)`æ¥ç»‘å®š`DatagramSocket`æ¥åŠ å…¥ç»„æ’­ç»„.

è¿™æ ·,æ‚¨å°†æ”¶åˆ°å‘é€åˆ°`DatagramSocket`ä¾¦å¬çš„åœ°å€å’Œç«¯å£çš„æ•°æ®æŠ¥åŒ…,ä»¥åŠå‘é€åˆ°å¤šæ’­ç»„çš„æ•°æ®åŒ….

é™¤æ­¤ä¹‹å¤–,æ‚¨è¿˜æƒ³è®¾ç½®ä¸€ä¸ªå¤„ç†å™¨,å®ƒå°†ä¸ºæ¯ä¸ªæ¥æ”¶åˆ°çš„ DatagramPacket è°ƒç”¨.

`DatagramPacket` æœ‰ä»¥ä¸‹æ–¹æ³•:

- `sender()`:ä»£è¡¨æ•°æ®åŒ…å‘é€è€…çš„ InetSocketAddress
- `data()`:ä¿å­˜æ¥æ”¶åˆ°çš„æ•°æ®çš„ç¼“å†²åŒº.

å› æ­¤,è¦ç›‘å¬ç‰¹å®šåœ°å€å’Œç«¯å£å¹¶æ¥æ”¶å¤šæ’­ç»„ `230.0.0.1` çš„æ•°æ®åŒ…,æ‚¨å¯ä»¥æ‰§è¡Œå¦‚ä¸‹æ‰€ç¤ºçš„æ“ä½œ:

```java
DatagramSocket socket = vertx.createDatagramSocket(new DatagramSocketOptions());
socket.listen(1234, "0.0.0.0", asyncResult -> {
  if (asyncResult.succeeded()) {
    socket.handler(packet -> {
      // Do something with the packet
    });

    // join the multicast group
    socket.listenMulticastGroup("230.0.0.1", asyncResult2 -> {
        System.out.println("Listen succeeded? " + asyncResult2.succeeded());
    });
  } else {
    System.out.println("Listen failed" + asyncResult.cause());
  }
});
```

##### å–æ¶ˆç›‘å¬/ç¦»å¼€å¤šæ’­ç»„

æœ‰æ—¶æ‚¨å¸Œæœ›åœ¨æœ‰é™çš„æ—¶é—´å†…æ¥æ”¶å¤šæ’­ç»„çš„æ•°æ®åŒ….

åœ¨è¿™ç§æƒ…å†µä¸‹,æ‚¨å¯ä»¥å…ˆå¼€å§‹è†å¬å®ƒä»¬,ç„¶åå†ä¸å¬.

å¦‚ä¸‹æ‰€ç¤º:

```java
DatagramSocket socket = vertx.createDatagramSocket(new DatagramSocketOptions());
socket.listen(1234, "0.0.0.0", asyncResult -> {
    if (asyncResult.succeeded()) {
      socket.handler(packet -> {
        // Do something with the packet
      });

      // join the multicast group
      socket.listenMulticastGroup("230.0.0.1", asyncResult2 -> {
          if (asyncResult2.succeeded()) {
            // will now receive packets for group

            // do some work

            socket.unlistenMulticastGroup("230.0.0.1", asyncResult3 -> {
              System.out.println("Unlisten succeeded? " + asyncResult3.succeeded());
            });
          } else {
            System.out.println("Listen failed" + asyncResult2.cause());
          }
      });
    } else {
      System.out.println("Listen failed" + asyncResult.cause());
    }
});
```

##### é˜»æ­¢å¤šæ’­

é™¤äº†å–æ¶ˆä¾¦å¬å¤šæ’­åœ°å€ä¹‹å¤–,è¿˜å¯ä»¥ä»…é˜»æ­¢ç‰¹å®šå‘ä»¶äººåœ°å€çš„å¤šæ’­.

è¯·æ³¨æ„,è¿™åªé€‚ç”¨äºæŸäº›æ“ä½œç³»ç»Ÿå’Œå†…æ ¸ç‰ˆæœ¬. å› æ­¤,å¦‚æœæ”¯æŒ,è¯·æŸ¥çœ‹æ“ä½œç³»ç»Ÿæ–‡æ¡£.

è¿™æ˜¯ä¸€ä¸ªä¸“å®¶ç‰¹æ€§.

è¦é˜»æ­¢æ¥è‡ªç‰¹å®šåœ°å€çš„å¤šæ’­,æ‚¨å¯ä»¥åœ¨ DatagramSocket ä¸Šè°ƒç”¨ `blockMulticastGroup(...)`,å¦‚ä¸‹æ‰€ç¤º:

```java
DatagramSocket socket = vertx.createDatagramSocket(new DatagramSocketOptions());

// Some code

// This would block packets which are send from 10.0.0.2
socket.blockMulticastGroup("230.0.0.1", "10.0.0.2", asyncResult -> {
  System.out.println("block succeeded? " + asyncResult.succeeded());
});
```

#### DatagramSocket å±æ€§

åˆ›å»º `DatagramSocket` æ—¶,æ‚¨å¯ä»¥è®¾ç½®å¤šä¸ªå±æ€§ä»¥ä½¿ç”¨ `DatagramSocketOptions` å¯¹è±¡æ›´æ”¹å…¶è¡Œä¸º. è¿™äº›éƒ½åœ¨è¿™é‡Œåˆ—å‡º:

- `setSendBufferSize` ä»¥å­—èŠ‚ä¸ºå•ä½è®¾ç½®å‘é€ç¼“å†²åŒºå¤§å°.
- `setReceiveBufferSize` ä»¥å­—èŠ‚ä¸ºå•ä½è®¾ç½® TCP æ¥æ”¶ç¼“å†²åŒºå¤§å°.
- `setReuseAddress` å¦‚æœä¸ºçœŸ,é‚£ä¹ˆå¤„äº TIME_WAIT çŠ¶æ€çš„åœ°å€å¯ä»¥åœ¨å…³é—­åé‡æ–°ä½¿ç”¨.
- `setTrafficClass`
- `setBroadcast` è®¾ç½®æˆ–æ¸…é™¤ SO_BROADCAST å¥—æ¥å­—é€‰é¡¹. è®¾ç½®æ­¤é€‰é¡¹å,æ•°æ®æŠ¥ (UDP) æ•°æ®åŒ…å¯èƒ½ä¼šå‘é€åˆ°æœ¬åœ°æ¥å£çš„å¹¿æ’­åœ°å€.
- `setMulticastNetworkInterface` è®¾ç½®æˆ–æ¸…é™¤ IP_MULTICAST_LOOP å¥—æ¥å­—é€‰é¡¹. å½“è®¾ç½®æ­¤é€‰é¡¹æ—¶,å¤šæ’­æ•°æ®åŒ…ä¹Ÿå°†åœ¨æœ¬åœ°æ¥å£ä¸Šæ¥æ”¶.
- `setMulticastTimeToLive` è®¾ç½® IP_MULTICAST_TTL å¥—æ¥å­—é€‰é¡¹. TTL ä»£è¡¨"ç”Ÿå­˜æ—¶é—´",ä½†åœ¨æ­¤ä¸Šä¸‹æ–‡ä¸­,å®ƒæŒ‡å®šå…è®¸æ•°æ®åŒ…é€šè¿‡çš„ IP è·ƒç‚¹æ•°,ç‰¹åˆ«æ˜¯å¯¹äºå¤šæ’­æµé‡. æ¯ä¸ªè½¬å‘æ•°æ®åŒ…çš„è·¯ç”±å™¨æˆ–ç½‘å…³éƒ½ä¼šé€’å‡ TTL. å¦‚æœè·¯ç”±å™¨å°† TTL å‡ä¸º 0,åˆ™ä¸ä¼šè½¬å‘.

#### DatagramSocket æœ¬åœ°åœ°å€

æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨ `localAddress` æ‰¾åˆ°å¥—æ¥å­—çš„æœ¬åœ°åœ°å€(å³ UDP å¥—æ¥å­—è¿™ä¸€ç«¯çš„åœ°å€). å¦‚æœæ‚¨ä¹‹å‰ä½¿ç”¨ `listen(...)` ç»‘å®šäº† `DatagramSocket`,è¿™åªä¼šè¿”å› `InetSocketAddress`,å¦åˆ™å®ƒå°†è¿”å› null.

#### å…³é—­ DatagramSocket

æ‚¨å¯ä»¥é€šè¿‡è°ƒç”¨ `close` æ–¹æ³•æ¥å…³é—­å¥—æ¥å­—. è¿™å°†å…³é—­å¥—æ¥å­—å¹¶é‡Šæ”¾æ‰€æœ‰èµ„æº

## DNS å®¢æˆ·ç«¯

é€šå¸¸,æ‚¨ä¼šå‘ç°è‡ªå·±éœ€è¦ä»¥å¼‚æ­¥æ–¹å¼è·å– DNS ä¿¡æ¯. ä¸å¹¸çš„æ˜¯,Java è™šæ‹Ÿæœºæœ¬èº«é™„å¸¦çš„ API æ— æ³•åšåˆ°è¿™ä¸€ç‚¹. å› æ­¤,Vert.x æä¾›äº†è‡ªå·±çš„å®Œå…¨å¼‚æ­¥çš„ DNS è§£æ API.

è¦è·å¾—ä¸€ä¸ª Dns å®¢æˆ·ç«¯å®ä¾‹,æ‚¨å°†é€šè¿‡ Vertex å®ä¾‹åˆ›å»ºä¸€ä¸ªæ–°å®ä¾‹.

```java
DnsClient client = vertx.createDnsClient(53, "10.0.0.1");
```

You can also create the client with options and configure the query timeout.

```java
DnsClient client = vertx.createDnsClient(new DnsClientOptions()
  .setPort(53)
  .setHost("10.0.0.1")
  .setQueryTimeout(10000)
);
```

åˆ›å»ºä¸å¸¦å‚æ•°çš„å®¢æˆ·ç«¯æˆ–çœç•¥æœåŠ¡å™¨åœ°å€å°†ä½¿ç”¨å†…éƒ¨ç”¨äºéé˜»å¡åœ°å€è§£æçš„æœåŠ¡å™¨åœ°å€.

```java
DnsClient client1 = vertx.createDnsClient();

// Just the same but with a different query timeout
DnsClient client2 = vertx.createDnsClient(new DnsClientOptions().setQueryTimeout(10000));
```

### æŸ¥æ‰¾

å°è¯•æŸ¥æ‰¾ç»™å®šåç§°çš„ A (ipv4) æˆ– AAAA (ipv6) è®°å½•. è¿”å›çš„ç¬¬ä¸€ä¸ªå°†è¢«ä½¿ç”¨,å› æ­¤å®ƒçš„è¡Œä¸ºæ–¹å¼ä¸æ‚¨åœ¨æ“ä½œç³»ç»Ÿä¸Šä½¿ç”¨"nslookup"æ—¶å¯èƒ½ä½¿ç”¨çš„æ–¹å¼ç›¸åŒ.

è¦æŸ¥æ‰¾"vertx.io"çš„ A / AAAA è®°å½•,æ‚¨é€šå¸¸ä¼šåƒè¿™æ ·ä½¿ç”¨å®ƒ:

```java
DnsClient client = vertx.createDnsClient(53, "9.9.9.9");
client.lookup("vertx.io", ar -> {
  if (ar.succeeded()) {
    System.out.println(ar.result());
  } else {
    System.out.println("Failed to resolve entry" + ar.cause());
  }
});
```

### lookup4

å°è¯•æŸ¥æ‰¾ç»™å®šåç§°çš„ A (ipv4) è®°å½•. è¿”å›çš„ç¬¬ä¸€ä¸ªå°†è¢«ä½¿ç”¨,å› æ­¤å®ƒçš„è¡Œä¸ºæ–¹å¼ä¸æ‚¨åœ¨æ“ä½œç³»ç»Ÿä¸Šä½¿ç”¨"nslookup"æ—¶å¯èƒ½ä½¿ç”¨çš„æ–¹å¼ç›¸åŒ.

è¦æŸ¥æ‰¾"vertx.io"çš„ A è®°å½•,æ‚¨é€šå¸¸ä¼šåƒè¿™æ ·ä½¿ç”¨å®ƒ:

```java
DnsClient client = vertx.createDnsClient(53, "9.9.9.9");
client.lookup4("vertx.io", ar -> {
  if (ar.succeeded()) {
    System.out.println(ar.result());
  } else {
    System.out.println("Failed to resolve entry" + ar.cause());
  }
});
```

### lookup6

å°è¯•æŸ¥æ‰¾ç»™å®šåç§°çš„ AAAA (ipv6) è®°å½•. è¿”å›çš„ç¬¬ä¸€ä¸ªå°†è¢«ä½¿ç”¨,å› æ­¤å®ƒçš„è¡Œä¸ºæ–¹å¼ä¸æ‚¨åœ¨æ“ä½œç³»ç»Ÿä¸Šä½¿ç”¨"nslookup"æ—¶å¯èƒ½ä½¿ç”¨çš„æ–¹å¼ç›¸åŒ.

To lookup the A record for "vertx.io" you would typically use it like:

```java
DnsClient client = vertx.createDnsClient(53, "9.9.9.9");
client.lookup6("vertx.io", ar -> {
  if (ar.succeeded()) {
    System.out.println(ar.result());
  } else {
    System.out.println("Failed to resolve entry" + ar.cause());
  }
});
```

### resolveA

å°è¯•è§£æç»™å®šåç§°çš„æ‰€æœ‰ A (ipv4) è®°å½•. è¿™ä¸åœ¨ç±»ä¼¼ unix çš„æ“ä½œç³»ç»Ÿä¸Šä½¿ç”¨"dig"éå¸¸ç›¸ä¼¼.

è¦æŸ¥æ‰¾"vertx.io"çš„æ‰€æœ‰ A è®°å½•,æ‚¨é€šå¸¸ä¼šè¿™æ ·åš:

```java
DnsClient client = vertx.createDnsClient(53, "9.9.9.9");
client.resolveA("vertx.io", ar -> {
  if (ar.succeeded()) {
    List<String> records = ar.result();
    for (String record : records) {
      System.out.println(record);
    }
  } else {
    System.out.println("Failed to resolve entry" + ar.cause());
  }
});
```

### resolveAAAA

å°è¯•è§£æç»™å®šåç§°çš„æ‰€æœ‰ AAAA (ipv6) è®°å½•. è¿™ä¸åœ¨ç±»ä¼¼ unix çš„æ“ä½œç³»ç»Ÿä¸Šä½¿ç”¨"dig"éå¸¸ç›¸ä¼¼.

è¦æŸ¥æ‰¾"vertx.io"çš„æ‰€æœ‰ AAAAA è®°å½•,æ‚¨é€šå¸¸ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œ:

```java
DnsClient client = vertx.createDnsClient(53, "9.9.9.9");
client.resolveAAAA("vertx.io", ar -> {
  if (ar.succeeded()) {
    List<String> records = ar.result();
    for (String record : records) {
      System.out.println(record);
    }
  } else {
    System.out.println("Failed to resolve entry" + ar.cause());
  }
});
```

### resolveCNAME

å°è¯•è§£æç»™å®šåç§°çš„æ‰€æœ‰ CNAME è®°å½•. è¿™ä¸åœ¨ç±»ä¼¼ unix çš„æ“ä½œç³»ç»Ÿä¸Šä½¿ç”¨"dig"éå¸¸ç›¸ä¼¼.

è¦æŸ¥æ‰¾"vertx.io"çš„æ‰€æœ‰ CNAME è®°å½•,æ‚¨é€šå¸¸ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œ:

```java
DnsClient client = vertx.createDnsClient(53, "9.9.9.9");
client.resolveCNAME("vertx.io", ar -> {
  if (ar.succeeded()) {
    List<String> records = ar.result();
    for (String record : records) {
      System.out.println(record);
    }
  } else {
    System.out.println("Failed to resolve entry" + ar.cause());
  }
});
```

### resolveMX

å°è¯•è§£æç»™å®šåç§°çš„æ‰€æœ‰ MX è®°å½•. MX è®°å½•ç”¨äºå®šä¹‰å“ªä¸ªé‚®ä»¶æœåŠ¡å™¨æ¥å—ç»™å®šåŸŸçš„ç”µå­é‚®ä»¶.

è¦æŸ¥æ‰¾"vertx.io"çš„æ‰€æœ‰ MX è®°å½•,æ‚¨é€šå¸¸ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œ:

```java
DnsClient client = vertx.createDnsClient(53, "9.9.9.9");
client.resolveMX("vertx.io", ar -> {
  if (ar.succeeded()) {
    List<MxRecord> records = ar.result();
    for (MxRecord record: records) {
      System.out.println(record);
    }
  } else {
    System.out.println("Failed to resolve entry" + ar.cause());
  }
});
```

è¯·æ³¨æ„,åˆ—è¡¨å°†åŒ…å«æŒ‰ä¼˜å…ˆçº§æ’åºçš„ `MxRecord`,è¿™æ„å‘³ç€ä¼˜å…ˆçº§è¾ƒå°çš„ MX è®°å½•åœ¨åˆ—è¡¨ä¸­æ’åœ¨ç¬¬ä¸€ä½.

`MxRecord` å…è®¸æ‚¨é€šè¿‡æä¾›æ–¹æ³•è®¿é—® MX è®°å½•çš„ä¼˜å…ˆçº§å’Œåç§°,ä¾‹å¦‚:

```java
record.priority();
record.name();
```

### resolveTXT

å°è¯•è§£æç»™å®šåç§°çš„æ‰€æœ‰ TXT è®°å½•. TXT è®°å½•é€šå¸¸ç”¨äºå®šä¹‰åŸŸçš„é¢å¤–ä¿¡æ¯.

è¦è§£æ"vertx.io"çš„æ‰€æœ‰ TXT è®°å½•,æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å†…å®¹:

```java
DnsClient client = vertx.createDnsClient(53, "9.9.9.9");
client.resolveTXT("vertx.io", ar -> {
  if (ar.succeeded()) {
    List<String> records = ar.result();
    for (String record: records) {
      System.out.println(record);
    }
  } else {
    System.out.println("Failed to resolve entry" + ar.cause());
  }
});
```

### resolveNS

å°è¯•è§£æç»™å®šåç§°çš„æ‰€æœ‰ NS è®°å½•. NS è®°å½•æŒ‡å®šå“ªä¸ª DNS æœåŠ¡å™¨æ‰˜ç®¡ç»™å®šåŸŸçš„ DNS ä¿¡æ¯.

è¦è§£æ"vertx.io"çš„æ‰€æœ‰ NS è®°å½•,æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å†…å®¹:

```java
DnsClient client = vertx.createDnsClient(53, "9.9.9.9");
client.resolveNS("vertx.io", ar -> {
  if (ar.succeeded()) {
    List<String> records = ar.result();
    for (String record: records) {
      System.out.println(record);
    }
  } else {
    System.out.println("Failed to resolve entry" + ar.cause());
  }
});
```

### resolveSRV

å°è¯•è§£æç»™å®šåç§°çš„æ‰€æœ‰ SRV è®°å½•. SRV è®°å½•ç”¨äºå®šä¹‰æœåŠ¡çš„ç«¯å£å’Œä¸»æœºåç­‰é¢å¤–ä¿¡æ¯. ä¸€äº›åè®®éœ€è¦è¿™äº›é¢å¤–ä¿¡æ¯.

è¦æŸ¥æ‰¾"vertx.io"çš„æ‰€æœ‰ SRV è®°å½•,æ‚¨é€šå¸¸ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œ:

```java
DnsClient client = vertx.createDnsClient(53, "9.9.9.9");
client.resolveSRV("vertx.io", ar -> {
  if (ar.succeeded()) {
    List<SrvRecord> records = ar.result();
    for (SrvRecord record: records) {
      System.out.println(record);
    }
  } else {
    System.out.println("Failed to resolve entry" + ar.cause());
  }
});
```

è¯·æ³¨æ„,åˆ—è¡¨å°†åŒ…å«æŒ‰ä¼˜å…ˆçº§æ’åºçš„ Srv è®°å½•,è¿™æ„å‘³ç€ä¼˜å…ˆçº§è¾ƒå°çš„ Srv è®°å½•åœ¨åˆ—è¡¨ä¸­æ’åœ¨é¦–ä½.

`SrvRecord` å…è®¸æ‚¨è®¿é—® SRV è®°å½•æœ¬èº«ä¸­åŒ…å«çš„æ‰€æœ‰ä¿¡æ¯:

```java
record.priority();
record.name();
record.weight();
record.port();
record.protocol();
record.service();
record.target();
```

Please refer to the API docs for the exact details.

### resolvePTR

å°è¯•è§£æç»™å®šåç§°çš„ PTR è®°å½•. PTR è®°å½•å°† ipaddress æ˜ å°„åˆ°åç§°.

è¦è§£æ ipaddress 10.0.0.1 çš„ PTR è®°å½•,æ‚¨å°†ä½¿ç”¨"1.0.0.10.in-addr.arpa"çš„ PTR æ¦‚å¿µ

```java
DnsClient client = vertx.createDnsClient(53, "9.9.9.9");
client.resolvePTR("1.0.0.10.in-addr.arpa", ar -> {
  if (ar.succeeded()) {
    String record = ar.result();
    System.out.println(record);
  } else {
    System.out.println("Failed to resolve entry" + ar.cause());
  }
});
```

### reverseLookup

å°è¯•å¯¹ IP åœ°å€è¿›è¡Œåå‘æŸ¥æ‰¾. è¿™ä¸è§£æ PTR è®°å½•åŸºæœ¬ç›¸åŒ,ä½†åªå…è®¸æ‚¨ä¼ å…¥ ip åœ°å€è€Œä¸æ˜¯æœ‰æ•ˆçš„ PTR æŸ¥è¯¢å­—ç¬¦ä¸².

è¦å¯¹ ipaddress 10.0.0.1 è¿›è¡Œåå‘æŸ¥æ‰¾,è¯·æ‰§è¡Œä»¥ä¸‹ç±»ä¼¼æ“ä½œ:

```java
DnsClient client = vertx.createDnsClient(53, "9.9.9.9");
client.reverseLookup("10.0.0.1", ar -> {
  if (ar.succeeded()) {
    String record = ar.result();
    System.out.println(record);
  } else {
    System.out.println("Failed to resolve entry" + ar.cause());
  }
});
```

### é”™è¯¯å¤„ç†

æ­£å¦‚æ‚¨åœ¨å‰é¢çš„éƒ¨åˆ†ä¸­çœ‹åˆ°çš„,DnsClient å…è®¸æ‚¨ä¼ å…¥ä¸€ä¸ªå¤„ç†å™¨,ä¸€æ—¦æŸ¥è¯¢å®Œæˆ,è¯¥å¤„ç†å™¨å°†é€šè¿‡ AsyncResult å¾—åˆ°é€šçŸ¥. å¦‚æœå‡ºç°é”™è¯¯,å°†é€šè¿‡ DnsException é€šçŸ¥å®ƒ,è¯¥å¼‚å¸¸å°†å¯¼è‡´ä¸€ä¸ª"DnsResponseCode",æŒ‡ç¤ºè§£æå¤±è´¥çš„åŸå› . æ­¤ DnsResponseCode å¯ç”¨äºæ›´è¯¦ç»†åœ°æ£€æŸ¥åŸå› .

å¯èƒ½çš„ DnsResponseCodes æ˜¯:

- `NOERROR` æ²¡æœ‰æ‰¾åˆ°ç»™å®šæŸ¥è¯¢çš„è®°å½•
- `FORMERROR` æ ¼å¼é”™è¯¯
- `SERVFAIL` æœåŠ¡å™¨æ•…éšœ
- `NXDOMAIN` åç§°é”™è¯¯
- `NOTIMPL` æœªç”± DNS æœåŠ¡å™¨å®ç°
- `REFUSED` DNS æœåŠ¡å™¨æ‹’ç»æŸ¥è¯¢
- `YXDOMAIN` åŸŸåä¸åº”è¯¥å­˜åœ¨
- `YXRRSET` èµ„æºè®°å½•ä¸åº”è¯¥å­˜åœ¨
- `NXRRSET` RRSET ä¸å­˜åœ¨
- `NOTZONE` åç§°ä¸åœ¨åŒºåŸŸä¸­
- `BADVERS` ç‰ˆæœ¬çš„é”™è¯¯æ‰©å±•æœºåˆ¶
- `BADSIG` é”™è¯¯ç­¾å
- `BADKEY` åé”®
- `BADTIME` é”™è¯¯çš„æ—¶é—´æˆ³

æ‰€æœ‰è¿™äº›é”™è¯¯éƒ½æ˜¯ç”± DNS æœåŠ¡å™¨æœ¬èº«"ç”Ÿæˆ"çš„.

æ‚¨å¯ä»¥ä» DnsException ä¸­è·å– DnsResponseCode,ä¾‹å¦‚:

```java
DnsClient client = vertx.createDnsClient(53, "10.0.0.1");
client.lookup("nonexisting.vert.xio", ar -> {
  if (ar.succeeded()) {
    String record = ar.result();
    System.out.println(record);
  } else {
    Throwable cause = ar.cause();
    if (cause instanceof DnsException) {
      DnsException exception = (DnsException) cause;
      DnsResponseCode code = exception.code();
      // ...
    } else {
      System.out.println("Failed to resolve entry" + ar.cause());
    }
  }
});
```

<a name="streams"></a>
## æµ

åœ¨Vertxä¸­æœ‰å‡ ä¸ªå¯¹è±¡å…è®¸å¯¹é¡¹ç›®è¿›è¡Œè¯»å†™.

åœ¨ Vert.x ä¸­,å†™å…¥è°ƒç”¨ç«‹å³è¿”å›,å†™å…¥åœ¨å†…éƒ¨æ’é˜Ÿ.

ä¸éš¾çœ‹å‡º,å¦‚æœæ‚¨å†™å…¥å¯¹è±¡çš„é€Ÿåº¦æ¯”å®ƒå®é™…å°†æ•°æ®å†™å…¥å…¶åº•å±‚èµ„æºçš„é€Ÿåº¦å¿«,é‚£ä¹ˆå†™å…¥é˜Ÿåˆ—å¯èƒ½ä¼šæ— é™å¢é•¿ - æœ€ç»ˆå¯¼è‡´å†…å­˜è€—å°½.

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ Vert.x API ä¸­çš„ä¸€äº›å¯¹è±¡æä¾›äº†ç®€å•çš„æµé‡æ§åˆ¶(*èƒŒå‹*)åŠŸèƒ½.

ä»»ä½•å¯ä»¥*å†™å…¥*çš„æµæ§åˆ¶æ„ŸçŸ¥å¯¹è±¡éƒ½å®ç°äº†`WriteStream`,è€Œä»»ä½•å¯ä»¥*è¯»å–*çš„æµæ§åˆ¶å¯¹è±¡éƒ½è¢«ç§°ä¸ºå®ç°äº†`ReadStream`.

è®©æˆ‘ä»¬ä¸¾ä¸€ä¸ªä¾‹å­,æˆ‘ä»¬æƒ³ä» `ReadStream` ä¸­è¯»å–æ•°æ®,ç„¶åå°†æ•°æ®å†™å…¥ `WriteStream`.

ä¸€ä¸ªéå¸¸ç®€å•çš„ä¾‹å­æ˜¯ä» `NetSocket` è¯»å–ç„¶åå†™å›åŒä¸€ä¸ª `NetSocket` - å› ä¸º `NetSocket` å®ç°äº† `ReadStream` å’Œ `WriteStream`. è¯·æ³¨æ„,è¿™é€‚ç”¨äºä»»ä½•ç¬¦åˆ `ReadStream` å’Œ `WriteStream` çš„å¯¹è±¡,åŒ…æ‹¬ HTTP è¯·æ±‚,HTTP å“åº”,å¼‚æ­¥æ–‡ä»¶ I/O,WebSocket ç­‰.

ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ç›´æ¥è·å–å·²è¯»å–çš„æ•°æ®,å¹¶ç«‹å³å°†å…¶å†™å…¥`NetSocket`:

```java
NetServer server = vertx.createNetServer(
    new NetServerOptions().setPort(1234).setHost("localhost")
);
server.connectHandler(sock -> {
  sock.handler(buffer -> {
    // Write the data straight back
    sock.write(buffer);
  });
}).listen();
```

ä¸Šé¢çš„ä¾‹å­æœ‰ä¸€ä¸ªé—®é¢˜:å¦‚æœä»å¥—æ¥å­—è¯»å–æ•°æ®çš„é€Ÿåº¦å¿«äºå°†æ•°æ®å†™å›å¥—æ¥å­—çš„é€Ÿåº¦,å®ƒå°†åœ¨ `NetSocket` çš„å†™å…¥é˜Ÿåˆ—ä¸­å †ç§¯,æœ€ç»ˆè€—å°½ RAM. è¿™å¯èƒ½ä¼šå‘ç”Ÿ,ä¾‹å¦‚,å¦‚æœå¥—æ¥å­—å¦ä¸€ç«¯çš„å®¢æˆ·ç«¯è¯»å–é€Ÿåº¦ä¸å¤Ÿå¿«,ä»è€Œæœ‰æ•ˆåœ°å¯¹è¿æ¥æ–½åŠ èƒŒå‹.

ç”±äº `NetSocket` å®ç°äº† `WriteStream`,æˆ‘ä»¬å¯ä»¥åœ¨å†™å…¥ä¹‹å‰æ£€æŸ¥ `WriteStream` æ˜¯å¦å·²æ»¡:

```java
NetServer server = vertx.createNetServer(
    new NetServerOptions().setPort(1234).setHost("localhost")
);
server.connectHandler(sock -> {
  sock.handler(buffer -> {
    if (!sock.writeQueueFull()) {
      sock.write(buffer);
    }
  });

}).listen();
```

æ­¤ç¤ºä¾‹ä¸ä¼šè€—å°½ RAM,ä½†å¦‚æœå†™å…¥é˜Ÿåˆ—å·²æ»¡,æˆ‘ä»¬æœ€ç»ˆä¼šä¸¢å¤±æ•°æ®. æˆ‘ä»¬çœŸæ­£æƒ³åšçš„æ˜¯åœ¨å†™é˜Ÿåˆ—æ»¡æ—¶æš‚åœ`NetSocket`:

```java
NetServer server = vertx.createNetServer(
    new NetServerOptions().setPort(1234).setHost("localhost")
);
server.connectHandler(sock -> {
  sock.handler(buffer -> {
    sock.write(buffer);
    if (sock.writeQueueFull()) {
      sock.pause();
    }
  });
}).listen();
```

æˆ‘ä»¬å¿«åˆ°äº†,ä½†è¿˜ä¸å®Œå…¨. `NetSocket` ç°åœ¨åœ¨æ–‡ä»¶å·²æ»¡æ—¶æš‚åœ,ä½†æˆ‘ä»¬è¿˜éœ€è¦åœ¨å†™å…¥é˜Ÿåˆ—å¤„ç†å®Œå…¶ç§¯å‹åå–æ¶ˆæš‚åœ:

```java
NetServer server = vertx.createNetServer(
    new NetServerOptions().setPort(1234).setHost("localhost")
);
server.connectHandler(sock -> {
  sock.handler(buffer -> {
    sock.write(buffer);
    if (sock.writeQueueFull()) {
      sock.pause();
      sock.drainHandler(done -> {
        sock.resume();
      });
    }
  });
}).listen();
```

æˆ‘ä»¬ç»ˆäºå¾—åˆ°å®ƒäº†. å½“å†™å…¥é˜Ÿåˆ—å‡†å¤‡å¥½æ¥å—æ›´å¤šæ•°æ®æ—¶,ä¼šè°ƒç”¨ `drainHandler` äº‹ä»¶å¤„ç†å™¨,è¿™ä¼šæ¢å¤å…è®¸è¯»å–æ›´å¤šæ•°æ®çš„ `NetSocket`.

åœ¨ç¼–å†™ Vert.x åº”ç”¨ç¨‹åºæ—¶æƒ³è¦è¿™æ ·åšæ˜¯å¾ˆå¸¸è§çš„,æ‰€ä»¥æˆ‘ä»¬æ·»åŠ äº† `pipeTo` æ–¹æ³•æ¥ä¸ºæ‚¨å®Œæˆæ‰€æœ‰è¿™äº›è‰°è‹¦çš„å·¥ä½œ. ä½ åªéœ€ç»™å®ƒ `WriteStream` å¹¶ä½¿ç”¨å®ƒ:

```java
NetServer server = vertx.createNetServer(
  new NetServerOptions().setPort(1234).setHost("localhost")
);
server.connectHandler(sock -> {
  sock.pipeTo(sock);
}).listen();
```

è¿™ä¸æ›´è¯¦ç»†çš„ç¤ºä¾‹å®Œå…¨ç›¸åŒ,å¹¶ä¸”å®ƒå¤„ç†æµå¤±è´¥å’Œç»ˆæ­¢:å½“ç®¡é“ä»¥æˆåŠŸæˆ–å¤±è´¥å®Œæˆæ—¶ç»“æŸç›®æ ‡`WriteStream`.

æ“ä½œå®Œæˆæ—¶å¯ä»¥é€šçŸ¥æ‚¨:

```java
server.connectHandler(sock -> {

  // Pipe the socket providing an handler to be notified of the result
  sock.pipeTo(sock, ar -> {
    if (ar.succeeded()) {
      System.out.println("Pipe succeeded");
    } else {
      System.out.println("Pipe failed");
    }
  });
}).listen();
```

å½“æ‚¨å¤„ç†å¼‚æ­¥ç›®æ ‡æ—¶,æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ª `Pipe` å®ä¾‹,è¯¥å®ä¾‹æš‚åœæºå¹¶åœ¨æºé€šè¿‡ç®¡é“ä¼ è¾“åˆ°ç›®æ ‡æ—¶æ¢å¤å®ƒ:

```java
server.connectHandler(sock -> {

  // Create a pipe to use asynchronously
  Pipe<Buffer> pipe = sock.pipe();

  // Open a destination file
  fs.open("/path/to/file", new OpenOptions(), ar -> {
    if (ar.succeeded()) {
      AsyncFile file = ar.result();

      // Pipe the socket to the file and close the file at the end
      pipe.to(file);
    } else {
      sock.close();
    }
  });
}).listen();
```

å½“æ‚¨éœ€è¦ä¸­æ­¢ä¼ è¾“æ—¶,æ‚¨éœ€è¦å°†å…¶å…³é—­:

```java
vertx.createHttpServer()
  .requestHandler(request -> {

    // Create a pipe that to use asynchronously
    Pipe<Buffer> pipe = request.pipe();

    // Open a destination file
    fs.open("/path/to/file", new OpenOptions(), ar -> {
      if (ar.succeeded()) {
        AsyncFile file = ar.result();

        // Pipe the socket to the file and close the file at the end
        pipe.to(file);
      } else {
        // Close the pipe and resume the request, the body buffers will be discarded
        pipe.close();

        // Send an error response
        request.response().setStatusCode(500).end();
      }
    });
  }).listen(8080);
```

å½“ç®¡é“å…³é—­æ—¶,æµå¤„ç†å™¨å°†è¢«å–æ¶ˆè®¾ç½®å¹¶æ¢å¤`ReadStream`.

å¦‚ä¸Šæ‰€ç¤º,é»˜è®¤æƒ…å†µä¸‹,ç›®æ ‡æ€»æ˜¯åœ¨æµå®Œæˆæ—¶ç»“æŸ,æ‚¨å¯ä»¥åœ¨ç®¡é“å¯¹è±¡ä¸Šæ§åˆ¶æ­¤è¡Œä¸º:

- `endOnFailure` æ§åˆ¶å¤±è´¥å‘ç”Ÿæ—¶çš„è¡Œä¸º
- `endOnSuccess` æ§åˆ¶è¯»å–æµç»“æŸæ—¶çš„è¡Œä¸º
- `endOnComplete` æ§åˆ¶æ‰€æœ‰æƒ…å†µä¸‹çš„è¡Œä¸º

è¿™æ˜¯ä¸€ä¸ªç®€çŸ­çš„ä¾‹å­:

```java
src.pipe()
  .endOnSuccess(false)
  .to(dst, rs -> {
    // Append some text and close the file
    dst.end(Buffer.buffer("done"));
});
```

ç°åœ¨è®©æˆ‘ä»¬æ›´è¯¦ç»†åœ°çœ‹ä¸€ä¸‹ `ReadStream` å’Œ `WriteStream` ä¸Šçš„æ–¹æ³•:

### ReadStream

`ReadStream` ç”±`HttpClientResponse`,`DatagramSocket`,`HttpClientRequest`,`HttpServerFileUpload`,`HttpServerRequest`,`MessageConsumer`,`NetSocket`,`WebSocket`,`TimeoutStream`,`AsyncFile`å®ç°.

- `handler`:è®¾ç½®ä¸€ä¸ªä» ReadStream æ¥æ”¶é¡¹ç›®çš„å¤„ç†å™¨.
- `pause`:æš‚åœæµ. æš‚åœæ—¶,å¤„ç†å™¨ä¸­ä¸ä¼šæ”¶åˆ°ä»»ä½•é¡¹ç›®.
- `fetch`:ä»æµä¸­è·å–æŒ‡å®šæ•°é‡çš„é¡¹ç›®. å¦‚æœæœ‰ä»»ä½•é¡¹ç›®åˆ°è¾¾,å°†è°ƒç”¨å¤„ç†å™¨. è·å–æ˜¯ç´¯ç§¯çš„.
- `resume`:æ¢å¤æµ. å¦‚æœæœ‰ä»»ä½•é¡¹ç›®åˆ°è¾¾,å°†è°ƒç”¨å¤„ç†å™¨. æ¢å¤ç›¸å½“äºè·å– `Long.MAX_VALUE` é¡¹.
- `exceptionHandler`:å½“ ReadStream å‘ç”Ÿå¼‚å¸¸æ—¶è°ƒç”¨.
- `endHandler`: å½“åˆ°è¾¾æµçš„æœ«å°¾æ—¶è°ƒç”¨. å¦‚æœ ReadStream è¡¨ç¤ºæ–‡ä»¶,åˆ™å¯èƒ½æ˜¯åˆ°è¾¾ EOF æ—¶,æˆ–è€…å¦‚æœæ˜¯ HTTP è¯·æ±‚,åˆ™å¯èƒ½æ˜¯åˆ°è¾¾è¯·æ±‚ç»“æŸæ—¶,æˆ–è€…å¦‚æœæ˜¯ TCP å¥—æ¥å­—,åˆ™å¯èƒ½æ˜¯è¿æ¥å…³é—­æ—¶.

è¯»å–æµå¤„äº *flowing* æˆ– *fetch* æ¨¡å¼

- æœ€åˆ,æµå¤„äº *flowing* æ¨¡å¼
- å½“æµå¤„äº *flowing* æ¨¡å¼æ—¶,å…ƒç´ è¢«ä¼ é€’ç»™å¤„ç†å™¨
- å½“æµå¤„äº *fetch* æ¨¡å¼æ—¶,åªä¼šå°†è¯·æ±‚çš„å…ƒç´ æ•°é‡ä¼ é€’ç»™å¤„ç†å™¨

`pause`,`resume` å’Œ `fetch` æ”¹å˜æ¨¡å¼

- `resume()` è®¾ç½® *flowing* æ¨¡å¼
- `pause()` è®¾ç½® *fetch* æ¨¡å¼å¹¶å°†éœ€æ±‚é‡ç½®ä¸º `0`
- `fetch(long)` è¯·æ±‚ç‰¹å®šæ•°é‡çš„å…ƒç´ å¹¶å°†å…¶æ·»åŠ åˆ°å®é™…éœ€æ±‚ä¸­

### WriteStream

`WriteStream` ç”± `HttpClientRequest`,`HttpServerResponse` `WebSocket`,`NetSocket` å’Œ `AsyncFile` å®ç°.

æ–¹æ³•:

- `write`:å°†å¯¹è±¡å†™å…¥ WriteStream. è¿™ç§æ–¹æ³•æ°¸è¿œä¸ä¼šé˜»å¡. å†™å…¥åœ¨å†…éƒ¨æ’é˜Ÿå¹¶å¼‚æ­¥å†™å…¥åº•å±‚èµ„æº.
- `setWriteQueueMaxSize`:è®¾ç½®å†™å…¥é˜Ÿåˆ—è¢«è®¤ä¸º*æ»¡*çš„å¯¹è±¡æ•°é‡,æ–¹æ³•`writeQueueFull`è¿”å›`true`. è¯·æ³¨æ„,å½“è®¤ä¸ºå†™å…¥é˜Ÿåˆ—å·²æ»¡æ—¶,å¦‚æœè°ƒç”¨ write,æ•°æ®ä»å°†è¢«æ¥å—å¹¶æ’é˜Ÿ. å®é™…æ•°é‡å–å†³äºæµçš„å®ç°,å¯¹äº `Buffer`,å¤§å°è¡¨ç¤ºå®é™…å†™å…¥çš„å­—èŠ‚æ•°,è€Œä¸æ˜¯ç¼“å†²åŒºçš„æ•°é‡.
- `writeQueueFull`:å¦‚æœè®¤ä¸ºå†™å…¥é˜Ÿåˆ—å·²æ»¡,åˆ™è¿”å› `true`.
- `exceptionHandler`:å¦‚æœ`WriteStream`å‘ç”Ÿå¼‚å¸¸,å°†è¢«è°ƒç”¨.
- `drainHandler`:å¦‚æœ`WriteStream`è¢«è®¤ä¸ºä¸å†æ»¡,å¤„ç†å™¨å°†è¢«è°ƒç”¨.

## è®°å½•è§£æå™¨(Record Parser)

è®°å½•è§£æå™¨å…è®¸æ‚¨è½»æ¾è§£æç”±å­—èŠ‚åºåˆ—æˆ–å›ºå®šå¤§å°è®°å½•åˆ†éš”çš„åè®®. å®ƒå°†è¾“å…¥ç¼“å†²åŒºåºåˆ—è½¬æ¢ä¸ºæŒ‰é…ç½®ç»“æ„åŒ–çš„ç¼“å†²åŒºåºåˆ—(å›ºå®šå¤§å°æˆ–åˆ†éš”è®°å½•).

ä¾‹å¦‚,å¦‚æœæ‚¨æœ‰ä¸€ä¸ªç”± `\n` åˆ†éš”çš„ç®€å• ASCII æ–‡æœ¬åè®®,å¹¶ä¸”è¾“å…¥å¦‚ä¸‹:

```
buffer1:HELLO\nHOW ARE Y
buffer2:OU?\nI AM
buffer3: DOING OK
buffer4:\n
```

è®°å½•è§£æå™¨ä¼šäº§ç”Ÿ

```
buffer1:HELLO
buffer2:HOW ARE YOU?
buffer3:I AM DOING OK
```

è®©æˆ‘ä»¬çœ‹çœ‹ç›¸å…³çš„ä»£ç :

```java
final RecordParser parser = RecordParser.newDelimited("\n", h -> {
  System.out.println(h.toString());
});

parser.handle(Buffer.buffer("HELLO\nHOW ARE Y"));
parser.handle(Buffer.buffer("OU?\nI AM"));
parser.handle(Buffer.buffer("DOING OK"));
parser.handle(Buffer.buffer("\n"));
```

æ‚¨è¿˜å¯ä»¥ç”Ÿæˆå›ºå®šå¤§å°çš„å—,å¦‚ä¸‹æ‰€ç¤º:

```java
RecordParser.newFixed(4, h -> {
  System.out.println(h.toString());
});
```

æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯,è¯·æŸ¥çœ‹ `RecordParser` ç±».

## Jsonè§£æå™¨(Json Parser)

æ‚¨å¯ä»¥è½»æ¾åœ°è§£æ JSON ç»“æ„,ä½†è¿™éœ€è¦ä¸€æ¬¡æä¾› JSON å†…å®¹,ä½†æ˜¯å½“æ‚¨éœ€è¦è§£æéå¸¸å¤§çš„ç»“æ„æ—¶å¯èƒ½ä¸æ–¹ä¾¿.

éé˜»å¡ JSON è§£æå™¨æ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨çš„è§£æå™¨,èƒ½å¤Ÿå¤„ç†éå¸¸å¤§çš„ç»“æ„. å®ƒå°†è¾“å…¥ç¼“å†²åŒºåºåˆ—è½¬æ¢ä¸º JSON è§£æäº‹ä»¶åºåˆ—.

```java
JsonParser parser = JsonParser.newParser();

// Set handlers for various events
parser.handler(event -> {
  switch (event.type()) {
    case START_OBJECT:
      // Start an objet
      break;
    case END_OBJECT:
      // End an objet
      break;
    case START_ARRAY:
      // Start an array
      break;
    case END_ARRAY:
      // End an array
      break;
    case VALUE:
      // Handle a value
      String field = event.fieldName();
      if (field != null) {
        // In an object
      } else {
        // In an array or top level
        if (event.isString()) {

        } else {
          // ...
        }
      }
      break;
  }
});
```

è§£æå™¨æ˜¯éé˜»å¡çš„,å‘å‡ºçš„äº‹ä»¶ç”±è¾“å…¥ç¼“å†²åŒºé©±åŠ¨.

```java
JsonParser parser = JsonParser.newParser();

// start array event
// start object event
// "firstName":"Bob" event
parser.handle(Buffer.buffer("[{\"firstName\":\"Bob\","));

// "lastName":"Morane" event
// end object event
parser.handle(Buffer.buffer("\"lastName\":\"Morane\"},"));

// start object event
// "firstName":"Luke" event
// "lastName":"Lucky" event
// end object event
parser.handle(Buffer.buffer("{\"firstName\":\"Luke\",\"lastName\":\"Lucky\"}"));

// end array event
parser.handle(Buffer.buffer("]"));

// Always call end
parser.end();
```

äº‹ä»¶é©±åŠ¨çš„è§£ææä¾›äº†æ›´å¤šçš„æ§åˆ¶,ä½†ä»£ä»·æ˜¯å¤„ç†ç»†ç²’åº¦çš„äº‹ä»¶,è¿™æœ‰æ—¶ä¼šå¾ˆä¸æ–¹ä¾¿. JSON è§£æå™¨å…è®¸æ‚¨åœ¨éœ€è¦æ—¶å°† JSON ç»“æ„ä½œä¸ºå€¼å¤„ç†:

```java
JsonParser parser = JsonParser.newParser();

parser.objectValueMode();

parser.handler(event -> {
  switch (event.type()) {
    case START_ARRAY:
      // Start the array
      break;
    case END_ARRAY:
      // End the array
      break;
    case VALUE:
      // Handle each object
      break;
  }
});

parser.handle(Buffer.buffer("[{\"firstName\":\"Bob\"},\"lastName\":\"Morane\"),...]"));
parser.end();
```

åœ¨è§£ææœŸé—´å¯ä»¥è®¾ç½®å’Œå–æ¶ˆè®¾ç½®å€¼æ¨¡å¼,å…è®¸æ‚¨åœ¨ç»†ç²’åº¦äº‹ä»¶æˆ– JSON å¯¹è±¡å€¼äº‹ä»¶ä¹‹é—´åˆ‡æ¢.

```java
JsonParser parser = JsonParser.newParser();

parser.handler(event -> {
  // Start the object

  switch (event.type()) {
    case START_OBJECT:
      // Set object value mode to handle each entry, from now on the parser won't emit start object events
      parser.objectValueMode();
      break;
    case VALUE:
      // Handle each object
      // Get the field in which this object was parsed
      String id = event.fieldName();
      System.out.println("User with id " + id + " : " + event.value());
      break;
    case END_OBJECT:
      // Set the object event mode so the parser emits start/end object events again
      parser.objectEventMode();
      break;
  }
});

parser.handle(Buffer.buffer("{\"39877483847\":{\"firstName\":\"Bob\"},\"lastName\":\"Morane\"),...}"));
parser.end();
```

ä½ ä¹Ÿå¯ä»¥å¯¹æ•°ç»„åšåŒæ ·çš„äº‹æƒ…

```java
JsonParser parser = JsonParser.newParser();

parser.handler(event -> {
  // Start the object

  switch (event.type()) {
    case START_OBJECT:
      // Set array value mode to handle each entry, from now on the parser won't emit start array events
      parser.arrayValueMode();
      break;
    case VALUE:
      // Handle each array
      // Get the field in which this object was parsed
      System.out.println("Value : " + event.value());
      break;
    case END_OBJECT:
      // Set the array event mode so the parser emits start/end object events again
      parser.arrayEventMode();
      break;
  }
});

parser.handle(Buffer.buffer("[0,1,2,3,4,...]"));
parser.end();
```

æ‚¨è¿˜å¯ä»¥è§£ç  POJO

```java
parser.handler(event -> {
  // Handle each object
  // Get the field in which this object was parsed
  String id = event.fieldName();
  User user = event.mapTo(User.class);
  System.out.println("User with id " + id + " : " + user.firstName + " " + user.lastName);
});
```

æ¯å½“è§£æå™¨æ— æ³•å¤„ç†ç¼“å†²åŒºæ—¶,é™¤éæ‚¨è®¾ç½®å¼‚å¸¸å¤„ç†å™¨,å¦åˆ™å°†å¼•å‘å¼‚å¸¸:

```java
JsonParser parser = JsonParser.newParser();

parser.exceptionHandler(err -> {
  // Catch any parsing or decoding error
});
```

è§£æå™¨è¿˜è§£æ json æµ:

- è¿æ¥çš„ json æµ: `{"temperature":30}{"temperature":50}`
- è¡Œåˆ†éš”çš„ json æµ: `{"an":"object"}\r\n3\r\n"a string"\r\nnull`

æœ‰å…³æ›´å¤šè¯¦ç»†ä¿¡æ¯,è¯·æŸ¥çœ‹ `JsonParser` ç±».

## çº¿ç¨‹å®‰å…¨

å¤§å¤šæ•° Vert.x å¯¹è±¡å¯ä»¥å®‰å…¨åœ°ä»ä¸åŒçš„çº¿ç¨‹è®¿é—®. *ç„¶è€Œ*å½“å®ƒä»¬ä»åˆ›å»ºå®ƒä»¬çš„ç›¸åŒä¸Šä¸‹æ–‡ä¸­è®¿é—®æ—¶,æ€§èƒ½å¾—åˆ°äº†ä¼˜åŒ–.

ä¾‹å¦‚,å¦‚æœæ‚¨éƒ¨ç½²äº†ä¸€ä¸ª verticle,å®ƒåˆ›å»ºäº†ä¸€ä¸ªåœ¨å…¶å¤„ç†å™¨ä¸­æä¾› `NetSocket` å®ä¾‹çš„ `NetServer`,é‚£ä¹ˆæœ€å¥½å§‹ç»ˆä» verticle çš„äº‹ä»¶å¾ªç¯ä¸­è®¿é—®è¯¥å¥—æ¥å­—å®ä¾‹.

å¦‚æœä½ åšæŒæ ‡å‡†çš„ Vert.x Verticle éƒ¨ç½²æ¨¡å‹å¹¶é¿å…åœ¨ Verticle ä¹‹é—´å…±äº«å¯¹è±¡,é‚£ä¹ˆè¿™åº”è¯¥æ˜¯ä½ ä¸å¿…è€ƒè™‘çš„æƒ…å†µ.

<a name="Running_blocking_code"></a>
## è¿è¡Œé˜»å¡ä»£ç 

åœ¨ä¸€ä¸ªå®Œç¾çš„ä¸–ç•Œä¸­,ä¸ä¼šæœ‰æˆ˜äº‰æˆ–é¥¥é¥¿,æ‰€æœ‰apiéƒ½æ˜¯å¼‚æ­¥ç¼–å†™çš„,å…”å­ä¼šå’Œå°ç¾Šç¾”æ‰‹ç‰µæ‰‹è·³è¿‡é˜³å…‰æ˜åªšçš„ç»¿è‰²è‰åœ°.

**ä½†ç°å®ä¸–ç•Œä¸æ˜¯è¿™æ ·çš„.(ä½ æœ€è¿‘çœ‹æ–°é—»äº†å—?)**

äº‹å®æ˜¯,å³ä½¿ä¸æ˜¯å¤§å¤šæ•°åº“,ä¹Ÿæœ‰å¾ˆå¤šåº“,ç‰¹åˆ«æ˜¯åœ¨ JVM ç”Ÿæ€ç³»ç»Ÿä¸­,éƒ½æœ‰åŒæ­¥ API,å¹¶ä¸”è®¸å¤šæ–¹æ³•å¯èƒ½ä¼šé˜»å¡. ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­æ˜¯ JDBC API - å®ƒæœ¬è´¨ä¸Šæ˜¯åŒæ­¥çš„,æ— è®ºå®ƒå¤šä¹ˆåŠªåŠ›,Vert.x éƒ½æ— æ³•åœ¨å…¶ä¸Šæ’’ä¸Šé­”æ³•ç²‰ä»¥ä½¿å…¶å¼‚æ­¥.

æˆ‘ä»¬ä¸ä¼šåœ¨ä¸€å¤œä¹‹é—´å°†æ‰€æœ‰å†…å®¹é‡å†™ä¸ºå¼‚æ­¥,å› æ­¤æˆ‘ä»¬éœ€è¦ä¸ºæ‚¨æä¾›ä¸€ç§åœ¨ Vert.x åº”ç”¨ç¨‹åºä¸­å®‰å…¨åœ°ä½¿ç”¨"ä¼ ç»Ÿ"é˜»å¡ API çš„æ–¹æ³•.

å¦‚å‰æ‰€è¿°,æ‚¨ä¸èƒ½ç›´æ¥ä»äº‹ä»¶å¾ªç¯è°ƒç”¨é˜»å¡æ“ä½œ,å› ä¸ºè¿™ä¼šé˜»æ­¢å®ƒæ‰§è¡Œä»»ä½•å…¶ä»–æœ‰ç”¨çš„å·¥ä½œ. é‚£ä¹ˆä½ æ€ä¹ˆèƒ½åšåˆ°è¿™ä¸€ç‚¹å‘¢?

è¿™æ˜¯é€šè¿‡è°ƒç”¨ `executeBlocking` æ¥å®Œæˆçš„,æŒ‡å®šè¦æ‰§è¡Œçš„é˜»å¡ä»£ç å’Œåœ¨æ‰§è¡Œé˜»å¡ä»£ç æ—¶å¼‚æ­¥å›è°ƒçš„ç»“æœå¤„ç†å™¨.

```java
vertx.executeBlocking(promise -> {
  // Call some blocking API that takes a significant amount of time to return
  String result = someAPI.blockingMethod("hello");
  promise.complete(result);
}, res -> {
  System.out.println("The result is: " + res.result());
});
```

> **â˜¢è­¦å‘Š:** é˜»å¡ä»£ç åº”è¯¥é˜»å¡ä¸€æ®µåˆç†çš„æ—¶é—´(å³ä¸è¶…è¿‡å‡ ç§’é’Ÿ).é•¿æ—¶é—´çš„é˜»å¡æ“ä½œæˆ–è½®è¯¢æ“ä½œ(å³ä»¥é˜»å¡æ–¹å¼å¾ªç¯è½®è¯¢äº‹ä»¶çš„çº¿ç¨‹)è¦è¢«åšå†³æœç».å½“é˜»å¡æ“ä½œæŒç»­è¶…è¿‡ 10 ç§’æ—¶,é˜»å¡çº¿ç¨‹æ£€æŸ¥å™¨å°†åœ¨æ§åˆ¶å°ä¸Šæ‰“å°ä¸€æ¡æ¶ˆæ¯. é•¿é˜»å¡æ“ä½œåº”è¯¥ä½¿ç”¨ç”±åº”ç”¨ç¨‹åºç®¡ç†çš„ä¸“ç”¨çº¿ç¨‹,è¯¥çº¿ç¨‹å¯ä»¥ä½¿ç”¨ `event-bus(äº‹ä»¶æ€»çº¿)` æˆ– `runOnContext`ä¸verticlesäº¤äº’

é»˜è®¤æƒ…å†µä¸‹,å¦‚æœä»åŒä¸€ä¸ªä¸Šä¸‹æ–‡(ä¾‹å¦‚,åŒä¸€ä¸ªverticleå®ä¾‹)å¤šæ¬¡è°ƒç”¨executeBlocking,é‚£ä¹ˆä¸åŒçš„executeBlockingå°†*è¿ç»­*æ‰§è¡Œ(å³ä¸€ä¸ªæ¥ä¸€ä¸ª).

å¦‚æœä½ ä¸å…³å¿ƒæ¬¡åº,ä½ å¯ä»¥è°ƒç”¨ `executeBlocking` æŒ‡å®š `false` ä½œä¸º `ordered` çš„å‚æ•°. åœ¨è¿™ç§æƒ…å†µä¸‹,ä»»ä½• executeBlocking éƒ½å¯ä»¥åœ¨å·¥ä½œæ± ä¸Šå¹¶è¡Œæ‰§è¡Œ.

è¿è¡Œé˜»å¡ä»£ç çš„å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨ [å·¥ä½œ verticle](#worker_verticles)

`worker verticle`æ€»æ˜¯ä½¿ç”¨å·¥ä½œæ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œ.

é»˜è®¤æƒ…å†µä¸‹,é˜»å¡ä»£ç åœ¨ Vert.x å·¥ä½œæ± ä¸Šæ‰§è¡Œ,å¯ä»¥ä½¿ç”¨ `setWorkerPoolSize` æ–¹æ³•æ¥é…ç½®å·¥ä½œæ± çš„å¤§å°.

å¯ä»¥ä¸ºä¸åŒç›®çš„åˆ›å»ºé¢å¤–çš„æ± :

```java
WorkerExecutor executor = vertx.createSharedWorkerExecutor("my-worker-pool");
executor.executeBlocking(promise -> {
  // Call some blocking API that takes a significant amount of time to return
  String result = someAPI.blockingMethod("hello");
  promise.complete(result);
}, res -> {
  System.out.println("The result is: " + res.result());
});
```

ä¸å†éœ€è¦æ—¶,å¿…é¡»å…³é—­ worker executor:

```java
executor.close();
```

å½“å¤šä¸ªworkerä»¥ç›¸åŒçš„åç§°åˆ›å»ºæ—¶,å®ƒä»¬å°†å…±äº«ç›¸åŒçš„æ± .å½“ä½¿ç”¨è¯¥å·¥ä½œæ± çš„æ‰€æœ‰å·¥ä½œæ‰§è¡Œç¨‹åºéƒ½å…³é—­æ—¶,è¯¥å·¥ä½œæ± å°†è¢«é”€æ¯.

åœ¨ Verticle ä¸­åˆ›å»º executor æ—¶,Vert.x ä¼šåœ¨ Verticle å–æ¶ˆéƒ¨ç½²æ—¶è‡ªåŠ¨ä¸ºæ‚¨å…³é—­å®ƒ.

Worker executorså¯ä»¥åœ¨åˆ›å»ºæ—¶é…ç½®:

```java
int poolSize = 10;

// 2 minutes
long maxExecuteTime = 2;
TimeUnit maxExecuteTimeUnit = TimeUnit.MINUTES;

WorkerExecutor executor = vertx.createSharedWorkerExecutor("my-worker-pool", poolSize, maxExecuteTime, maxExecuteTimeUnit);
```

> **ğŸ·æ³¨æ„:** é…ç½®æ˜¯åœ¨åˆ›å»ºå·¥ä½œæ± æ—¶è®¾ç½®çš„

### executeBlockingæ–¹æ³•è¯¦è§£
<mark>**è¯‘è€…æ³¨:** ä¸ºäº†æ›´å¥½çš„ç†è§£executeBlockingæ–¹æ³•è¯¦è§£,è¯‘è€…è‡ªå·±æ·»åŠ çš„!</mark>

Vertxç±»å’ŒContextç±»ä¸Šçš„ `<T> void executeBlocking(Handler<Promise<T>> blockingCodeHandler,
                         boolean ordered,
                         Handler<AsyncResult<T>> resultHandler)` æ–¹æ³•è¯¦è§£å¦‚ä¸‹:

å®‰å…¨åœ°æ‰§è¡Œä¸€äº›é˜»å¡ä»£ç ã€‚

ä½¿ç”¨å·¥ä½œæ± ä¸­çš„çº¿ç¨‹æ‰§è¡Œå¤„ç†ç¨‹åº `blockingCodeHandler` ä¸­çš„é˜»å¡ä»£ç ã€‚

ä»£ç å®Œæˆåï¼Œå¤„ç†ç¨‹åº `resultHandler` å°†åœ¨åŸå§‹ä¸Šä¸‹æ–‡ä¸­ï¼ˆä¾‹å¦‚ï¼Œåœ¨è°ƒç”¨æ–¹çš„åŸå§‹äº‹ä»¶å¾ªç¯ä¸­ï¼‰ä½¿ç”¨ç»“æœè°ƒç”¨ã€‚

ä¸€ä¸ª `Future` å®ä¾‹è¢«ä¼ é€’åˆ° `blockingCodeHandler`ã€‚å½“é˜»å¡ä»£ç æˆåŠŸå®Œæˆæ—¶ï¼Œå¤„ç†ç¨‹åºåº”è°ƒç”¨ `Promise.complete(T)` æˆ– `Promise.complete(Object)` æ–¹æ³•ï¼Œå¦‚æœå¤±è´¥åˆ™è°ƒç”¨ `Promise.fail(java.lang.Throwable)` æ–¹æ³•ã€‚

å½“ä½¿ç”¨ `Vertx.executeBlocking(Handler, Handler)` ä»æ ‡å‡†ï¼ˆé workerï¼‰verticle è¿è¡Œé˜»å¡ä»£ç æ—¶, åœ¨ `blockingCodeHandler` ä¸­ï¼Œå½“å‰ä¸Šä¸‹æ–‡ä»ç„¶æ˜¯åŸå§‹ä¸Šä¸‹æ–‡ï¼Œå› æ­¤åœ¨ `blockingCodeHandler` ä¸­è°ƒåº¦çš„ä»»ä½•ä»»åŠ¡éƒ½å°†åœ¨è¯¥ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œè€Œä¸æ˜¯åœ¨å·¥ä½œçº¿ç¨‹ä¸­æ‰§è¡Œã€‚

é˜»å¡ä»£ç åº”è¯¥é˜»å¡ä¸€æ®µåˆç†çš„æ—¶é—´(å³ä¸è¶…è¿‡å‡ ç§’é’Ÿ)ã€‚ç¦æ­¢é•¿æ—¶é—´çš„é˜»å¡æ“ä½œæˆ–è½®è¯¢æ“ä½œ(å³ä»¥é˜»å¡æ–¹å¼åœ¨å¾ªç¯ä¸­è½®è¯¢äº‹ä»¶çš„çº¿ç¨‹)ã€‚
å½“é˜»å¡æ“ä½œæŒç»­è¶…è¿‡ 10 ç§’æ—¶ï¼Œé˜»å¡çš„çº¿ç¨‹æ£€æŸ¥å™¨å°†åœ¨æ§åˆ¶å°ä¸Šæ‰“å°ä¸€æ¡æ¶ˆæ¯ã€‚
é•¿é˜»å¡æ“ä½œåº”è¯¥ä½¿ç”¨ç”±åº”ç”¨ç¨‹åºç®¡ç†çš„ä¸“ç”¨çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹å¯ä»¥ä½¿ç”¨ event-bus æˆ– `runOnContext(Handler)` ä¸ Verticles äº¤äº’

## åº¦é‡æŒ‡æ ‡ SPI

é»˜è®¤æƒ…å†µä¸‹,Vert.x ä¸è®°å½•ä»»ä½•æŒ‡æ ‡. ç›¸å,å®ƒæä¾›äº†ä¸€ä¸ª SPI ä¾›å…¶ä»–äººå®ç°,å¯ä»¥å°†å…¶æ·»åŠ åˆ°ç±»è·¯å¾„ä¸­. æŒ‡æ ‡ SPI æ˜¯ä¸€é¡¹é«˜çº§åŠŸèƒ½,å®ƒå…è®¸å®æ–½è€…ä» Vert.x æ•è·äº‹ä»¶ä»¥æ”¶é›†æŒ‡æ ‡. æœ‰å…³è¿™æ–¹é¢çš„æ›´å¤šä¿¡æ¯,è¯·å‚é˜…"API æ–‡æ¡£".

å¦‚æœä½¿ç”¨ `setFactory` åµŒå…¥Vert.x,ä½ ä¹Ÿå¯ä»¥é€šè¿‡ç¼–ç¨‹æ–¹å¼æŒ‡å®šä¸€ä¸ªåº¦é‡å·¥å‚.

## `vertx` å‘½ä»¤è¡Œ

`vertx` å‘½ä»¤ç”¨äºä»å‘½ä»¤è¡Œä¸ Vert.x äº¤äº’. å®ƒçš„ä¸»è¦ç”¨é€”æ˜¯è¿è¡Œ Vert.x verticles. ä¸ºæ­¤,æ‚¨éœ€è¦ä¸‹è½½å¹¶å®‰è£… Vert.x å‘è¡Œç‰ˆ,å¹¶å°†å®‰è£…çš„ `bin` ç›®å½•æ·»åŠ åˆ° `PATH` ç¯å¢ƒå˜é‡ä¸­. è¿˜è¦ç¡®ä¿ä½ çš„ `PATH` ä¸Šæœ‰ä¸€ä¸ª Java JDK.

Vert.x æ”¯æŒ Java 8 åˆ° 17.

> **ğŸ·æ³¨æ„:** éœ€è¦JDKæ¥æ”¯æŒ Java ä»£ç çš„åŠ¨æ€ç¼–è¯‘.

### è¿è¡Œ verticles

æ‚¨å¯ä»¥ä½¿ç”¨ `vertx run` ç›´æ¥ä»å‘½ä»¤è¡Œè¿è¡ŒåŸå§‹ Vert.x verticles. ä»¥ä¸‹æ˜¯ `run` *command* çš„å‡ ä¸ªç¤ºä¾‹:

```bash
vertx run my-verticle.js                                 (1)
vertx run my-verticle.groovy                             (2)
vertx run my-verticle.rb                                 (3)

vertx run io.vertx.example.MyVerticle                    (4)
vertx run io.vertx.example.MVerticle -cp my-verticle.jar (5)

vertx run MyVerticle.java                                (6)
```

1. éƒ¨ç½²ä¸€ä¸ª JavaScript verticle
2. éƒ¨ç½²ä¸€ä¸ª Groovy verticle
3. éƒ¨ç½²ä¸€ä¸ªRuby Verticle
4. éƒ¨ç½²ä¸€ä¸ªå·²ç»ç¼–è¯‘å¥½çš„Java Verticle. ç±»è·¯å¾„æ ¹æ˜¯å½“å‰ç›®å½•
5. éƒ¨ç½²ä¸€ä¸ªæ‰“åŒ…åœ¨jarä¸­çš„verticle,jaréœ€è¦åœ¨classpathä¸­
6. ç¼–è¯‘Javaæºç å¹¶éƒ¨ç½²
æ­£å¦‚æ‚¨åœ¨ Java çš„æƒ…å†µä¸‹çœ‹åˆ°çš„,åç§°å¯ä»¥æ˜¯ Verticle çš„å®Œå…¨é™å®šç±»åç§°,ä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®š Java æºæ–‡ä»¶,Vert.x ä¼šä¸ºæ‚¨ç¼–è¯‘å®ƒ.

æ‚¨è¿˜å¯ä»¥åœ¨ Verticle å‰é¢åŠ ä¸Šè¦ä½¿ç”¨çš„è¯­è¨€å®ç°çš„åç§°. ä¾‹å¦‚,å¦‚æœ Verticle æ˜¯ä¸€ä¸ªå·²ç¼–è¯‘çš„ Groovy ç±»,åˆ™åœ¨å®ƒå‰é¢åŠ ä¸Š `groovy:` ä»¥ä¾¿ Vert.x çŸ¥é“å®ƒæ˜¯ä¸€ä¸ª Groovy ç±»è€Œä¸æ˜¯ Java ç±».

```bash
vertx run groovy:io.vertx.example.MyGroovyVerticle
```

`vertx run` å‘½ä»¤å¯ä»¥å¸¦å‡ ä¸ªå¯é€‰å‚æ•°,å®ƒä»¬æ˜¯:

- `-options <options>` - æä¾› Vert.x é€‰é¡¹. `options` æ˜¯è¡¨ç¤º Vert.x é€‰é¡¹çš„ JSON æ–‡ä»¶çš„åç§°,æˆ– JSON å­—ç¬¦ä¸². è¿™æ˜¯å¯é€‰çš„.
- `-conf <config>` - ä¸ºverticleæä¾›ä¸€äº›é…ç½®. `config` æ˜¯ä¸€ä¸ª JSON æ–‡ä»¶çš„åç§°,å®ƒä»£è¡¨äº† Verticle çš„é…ç½®,æˆ–è€…ä¸€ä¸ª JSON å­—ç¬¦ä¸². è¿™æ˜¯å¯é€‰çš„.
- `-cp <path>` - æœç´¢ Verticle å’Œ Verticle ä½¿ç”¨çš„ä»»ä½•å…¶ä»–èµ„æºçš„è·¯å¾„. è¿™é»˜è®¤ä¸º `.` (å½“å‰ç›®å½•). å¦‚æœæ‚¨çš„ Verticle å¼•ç”¨äº†å…¶ä»–è„šæœ¬,ç±»æˆ–å…¶ä»–èµ„æº(ä¾‹å¦‚ jar æ–‡ä»¶),è¯·ç¡®ä¿å®ƒä»¬åœ¨æ­¤è·¯å¾„ä¸Š. è·¯å¾„å¯ä»¥åŒ…å«å¤šä¸ªè·¯å¾„æ¡ç›®,ç”± `:`(å†’å·)æˆ– `;`(åˆ†å·)åˆ†éš”,å…·ä½“å–å†³äºæ“ä½œç³»ç»Ÿ. æ¯ä¸ªè·¯å¾„æ¡ç›®å¯ä»¥æ˜¯åŒ…å«è„šæœ¬çš„ç›®å½•çš„ç»å¯¹æˆ–ç›¸å¯¹è·¯å¾„,æˆ–è€…æ˜¯ jar æˆ– zip æ–‡ä»¶çš„ç»å¯¹æˆ–ç›¸å¯¹æ–‡ä»¶å.ä¸€ä¸ªç¤ºä¾‹è·¯å¾„å¯èƒ½æ˜¯ `-cp classes:lib/otherscripts:jars/myjar.jar:jars/otherjar.jar`. å§‹ç»ˆä½¿ç”¨è·¯å¾„æ¥å¼•ç”¨æ‚¨çš„ Verticle æ‰€éœ€çš„ä»»ä½•èµ„æº. ä¸è¦**ä¸è¦**å°†å®ƒä»¬æ”¾åœ¨ç³»ç»Ÿç±»è·¯å¾„ä¸­,å› ä¸ºè¿™å¯èƒ½ä¼šå¯¼è‡´éƒ¨ç½²çš„ Verticle ä¹‹é—´å‡ºç°éš”ç¦»é—®é¢˜.
- `-instances <instances>` - è¦å®ä¾‹åŒ–çš„verticleçš„å®ä¾‹æ•°. æ¯ä¸ª Verticle å®ä¾‹éƒ½æ˜¯ä¸¥æ ¼çš„å•çº¿ç¨‹çš„,å› æ­¤è¦è·¨å¯ç”¨å†…æ ¸æ‰©å±•æ‚¨çš„åº”ç”¨ç¨‹åº,æ‚¨å¯èƒ½éœ€è¦éƒ¨ç½²å¤šä¸ªå®ä¾‹. å¦‚æœçœç•¥,å°†éƒ¨ç½²å•ä¸ªå®ä¾‹.
- `-worker` - è¿™ä¸ªé€‰é¡¹å†³å®šäº†è¿™ä¸ªverticleæ˜¯å¦æ˜¯ä¸€ä¸ªworker Verticle.
- `-cluster` - æ­¤é€‰é¡¹ç¡®å®š Vert.x å®ä¾‹æ˜¯å¦ä¼šå°è¯•ä¸ç½‘ç»œä¸Šçš„å…¶ä»– Vert.x å®ä¾‹å½¢æˆé›†ç¾¤. é›†ç¾¤ Vert.x å®ä¾‹å…è®¸ Vert.x ä¸å…¶ä»–èŠ‚ç‚¹å½¢æˆåˆ†å¸ƒå¼äº‹ä»¶æ€»çº¿. é»˜è®¤ä¸º `false` (æœªé›†ç¾¤).
- `-cluster-port` - å¦‚æœè¿˜æŒ‡å®šäº† `cluster` é€‰é¡¹,é‚£ä¹ˆè¿™å°†ç¡®å®šå“ªä¸ªç«¯å£å°†ç»‘å®šåˆ°ä¸å…¶ä»– Vert.x å®ä¾‹çš„é›†ç¾¤é€šä¿¡. é»˜è®¤ä¸º"0"--è¿™æ„å‘³ç€"*é€‰æ‹©ä¸€ä¸ªå…è´¹çš„éšæœºç«¯å£*". é€šå¸¸ä¸éœ€è¦æŒ‡å®šæ­¤å‚æ•°,é™¤éæ‚¨ç¡®å®éœ€è¦ç»‘å®šåˆ°ç‰¹å®šç«¯å£.
- `-cluster-host` - å¦‚æœè¿˜æŒ‡å®šäº† `cluster` é€‰é¡¹,é‚£ä¹ˆè¿™å°†ç¡®å®šå“ªä¸ªä¸»æœºåœ°å€å°†ç»‘å®šåˆ°ä¸å…¶ä»– Vert.x å®ä¾‹çš„é›†ç¾¤é€šä¿¡. å¦‚æœæœªè®¾ç½®,åˆ™é›†ç¾¤äº‹ä»¶æ€»çº¿ä¼šå°è¯•ç»‘å®šåˆ°ä¸åº•å±‚é›†ç¾¤ç®¡ç†å™¨ç›¸åŒçš„ä¸»æœº. ä½œä¸ºæœ€åçš„æ‰‹æ®µ,å°†åœ¨å¯ç”¨çš„ç½‘ç»œæ¥å£ä¸­é€‰æ‹©ä¸€ä¸ªåœ°å€.
- `-cluster-public-port` - å¦‚æœè¿˜æŒ‡å®šäº† `cluster` é€‰é¡¹,é‚£ä¹ˆè¿™å°†ç¡®å®šå“ªä¸ªç«¯å£å°†è¢«é€šå‘Šç”¨äºä¸å…¶ä»– Vert.x å®ä¾‹çš„é›†ç¾¤é€šä¿¡. é»˜è®¤ä¸º `-1`,ä¸ `cluster-port` çš„å«ä¹‰ç›¸åŒ.
- `-cluster-public-host` - å¦‚æœè¿˜æŒ‡å®šäº† `cluster` é€‰é¡¹,é‚£ä¹ˆè¿™å°†ç¡®å®šå“ªä¸ªä¸»æœºåœ°å€å°†è¢«é€šå‘Šç”¨äºä¸å…¶ä»– Vert.x å®ä¾‹çš„é›†ç¾¤é€šä¿¡. å¦‚æœæœªæŒ‡å®š,Vert.x ä½¿ç”¨ `cluster-host` çš„å€¼.
- `-ha` - å¦‚æœæŒ‡å®š,verticle å°†è¢«éƒ¨ç½²ä¸ºé«˜å¯ç”¨æ€§ (HA) éƒ¨ç½². æœ‰å…³è¯¦ç»†ä¿¡æ¯,è¯·å‚é˜…ç›¸å…³éƒ¨åˆ†
- `-quorum` - ä¸ `-ha` ä¸€èµ·ä½¿ç”¨. å®ƒæŒ‡å®šé›†ç¾¤ä¸­ä»»ä½• *HA éƒ¨ç½² ID* å¤„äºæ´»åŠ¨çŠ¶æ€çš„æœ€å°èŠ‚ç‚¹æ•°. é»˜è®¤ä¸º 0.
- `-hagroup` - ä¸ `-ha` ä¸€èµ·ä½¿ç”¨. å®ƒæŒ‡å®šæ­¤èŠ‚ç‚¹å°†åŠ å…¥çš„ HA ç»„. ä¸€ä¸ªé›†ç¾¤ä¸­å¯ä»¥æœ‰å¤šä¸ª HA ç»„. èŠ‚ç‚¹åªä¼šæ•…éšœè½¬ç§»åˆ°åŒä¸€ç»„ä¸­çš„å…¶ä»–èŠ‚ç‚¹. é»˜è®¤å€¼ä¸º`__DEFAULT__`

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨:`-Dkey=value` è®¾ç½®ç³»ç»Ÿå±æ€§.

ä»¥ä¸‹æ˜¯æ›´å¤šç¤ºä¾‹:

ä½¿ç”¨é»˜è®¤è®¾ç½®è¿è¡Œ JavaScript verticle server.js

```bash
vertx run server.js
```

è¿è¡Œ 10 ä¸ªæŒ‡å®šç±»è·¯å¾„çš„é¢„ç¼–è¯‘ Java verticle å®ä¾‹

```bash
vertx run com.acme.MyVerticle -cp "classes:lib/myjar.jar" -instances 10
```

é€šè¿‡æº *file* è¿è¡Œ 10 ä¸ª Java verticle å®ä¾‹

```bash
vertx run MyVerticle.java -instances 10
```

è¿è¡Œ 20 ä¸ª ruby worker verticle å®ä¾‹

```bash
vertx run order_worker.rb -instances 20 -worker
```

åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œä¸¤ä¸ª JavaScript verticles å¹¶è®©å®ƒä»¬å½¼æ­¤é›†ç¾¤åœ¨ä¸€èµ·ä»¥åŠç½‘ç»œä¸Šçš„ä»»ä½•å…¶ä»–æœåŠ¡å™¨

```bash
vertx run handler.js -cluster
vertx run sender.js -cluster
```

è¿è¡Œä¸€ä¸ª Ruby verticle ä¼ é€’ä¸€äº›é…ç½®

```bash
vertx run my_verticle.rb -conf my_verticle.conf
```

å…¶ä¸­ `my_verticle.conf` å¯èƒ½åŒ…å«ä»¥ä¸‹å†…å®¹:

```json
{
"name": "foo",
"num_widgets": 46
}
```

é…ç½®å°†é€šè¿‡æ ¸å¿ƒ API åœ¨ Verticle å†…å¯ç”¨.

ä½¿ç”¨ vert.x çš„é«˜å¯ç”¨æ€§åŠŸèƒ½æ—¶,æ‚¨å¯èƒ½éœ€è¦åˆ›å»ºä¸€ä¸ª *bare* vert.x å®ä¾‹. æ­¤å®ä¾‹åœ¨å¯åŠ¨æ—¶ä¸ä¼šéƒ¨ç½²ä»»ä½• Verticle,ä½†å¦‚æœé›†ç¾¤çš„å¦ä¸€ä¸ªèŠ‚ç‚¹æ­»äº¡,å®ƒå°†æ¥æ”¶ä¸€ä¸ª Verticle. è¦åˆ›å»º *bare* å®ä¾‹,è¯·å¯åŠ¨:

```bash
vertx bare
```

æ ¹æ®æ‚¨çš„é›†ç¾¤é…ç½®,æ‚¨å¯èƒ½éœ€è¦é™„åŠ  `cluster-host` å’Œ `cluster-port` å‚æ•°.

### æ‰§è¡Œæ‰“åŒ…ä¸º fat jar çš„ Vert.x åº”ç”¨ç¨‹åº

*fat jar* æ˜¯åµŒå…¥å…¶ä¾èµ–é¡¹çš„å¯æ‰§è¡Œ jar. è¿™æ„å‘³ç€æ‚¨ä¸å¿…åœ¨æ‰§è¡Œ jar çš„æœºå™¨ä¸Šé¢„å…ˆå®‰è£… Vert.x. åƒä»»ä½•å¯æ‰§è¡Œçš„ Java jar ä¸€æ ·,å®ƒå¯ä»¥è¢«æ‰§è¡Œ.

```bash
java -jar my-application-fat.jar
```

Vert.x å¯¹æ­¤å¹¶æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„,æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½• Java åº”ç”¨ç¨‹åºæ¥æ‰§è¡Œæ­¤æ“ä½œ

æ‚¨å¯ä»¥åˆ›å»ºè‡ªå·±çš„ä¸»ç±»å¹¶åœ¨æ¸…å•ä¸­æŒ‡å®š,ä½†å»ºè®®æ‚¨å°†ä»£ç ç¼–å†™ä¸º verticles å¹¶ä½¿ç”¨ Vert.x `Launcher` ç±» (`io.vertx.core.Launcher`) ä½œä¸ºä¸»ç±» . è¿™ä¸åœ¨å‘½ä»¤è¡Œè¿è¡Œ Vert.x æ—¶ä½¿ç”¨çš„ä¸»ç±»ç›¸åŒ,å› æ­¤å…è®¸æ‚¨æŒ‡å®šå‘½ä»¤è¡Œå‚æ•°,ä¾‹å¦‚ `-instances` ä»¥ä¾¿æ›´è½»æ¾åœ°æ‰©å±•åº”ç”¨ç¨‹åº.

è¦åƒè¿™æ ·åœ¨ *fatjar* ä¸­éƒ¨ç½²æ‚¨çš„ Verticle,æ‚¨å¿…é¡»æœ‰ä¸€ä¸ª *manifest*,å…¶ä¸­åŒ…å«:

- `Main-Class` è®¾ç½®æˆ `io.vertx.core.Launcher`
- `Main-Verticle` æŒ‡å®šä¸»verticle(å®Œå…¨é™å®šçš„ç±»åæˆ–è„šæœ¬æ–‡ä»¶å)

æ‚¨è¿˜å¯ä»¥æä¾›å°†ä¼ é€’ç»™ `vertx run` çš„å¸¸ç”¨å‘½ä»¤è¡Œå‚æ•°:

```bash
java -jar my-verticle-fat.jar -cluster -conf myconf.json
java -jar my-verticle-fat.jar -cluster -conf myconf.json -cp path/to/dir/conf/cluster_xml
```

> **ğŸ·æ³¨æ„:** è¯·å‚è€ƒç¤ºä¾‹å­˜å‚¨åº“ä¸­çš„ Maven/Gradle æœ€ç®€å•å’Œ Maven/Gradle verticle ç¤ºä¾‹,ä»¥è·å–å°†åº”ç”¨ç¨‹åºæ„å»ºä¸º fatjar çš„ç¤ºä¾‹.

é»˜è®¤æƒ…å†µä¸‹,fat jar ä¼šæ‰§è¡Œ `run` å‘½ä»¤.

### æ˜¾ç¤ºVert.xçš„ç‰ˆæœ¬

è¦æ˜¾ç¤º vert.x ç‰ˆæœ¬,åªéœ€å¯åŠ¨:

```bash
vertx version
```

### å…¶ä»–å‘½ä»¤

é™¤äº† `run` å’Œ `version` ä¹‹å¤–,`vertx` å‘½ä»¤è¡Œå’Œ `Launcher` è¿˜æä¾›äº†å…¶ä»– *å‘½ä»¤*:

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åˆ›å»ºä¸€ä¸ª`bare(è£¸)`å®ä¾‹:

```bash
vertx bare
# or
java -jar my-verticle-fat.jar bare
```

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•åœ¨åå°å¯åŠ¨åº”ç”¨ç¨‹åº:

```bash
java -jar my-verticle-fat.jar start --vertx-id=my-app-name
```

å¦‚æœ `my-app-name` æœªè®¾ç½®,å°†ç”Ÿæˆä¸€ä¸ªéšæœº id,å¹¶æ‰“å°åœ¨å‘½ä»¤æç¤ºç¬¦ä¸Š. æ‚¨å¯ä»¥å°† `run` é€‰é¡¹ä¼ é€’ç»™ `start` å‘½ä»¤:

```bash
java -jar my-verticle-fat.jar start --vertx-id=my-app-name -cluster
```

åœ¨åå°å¯åŠ¨å,æ‚¨å¯ä»¥ä½¿ç”¨ `stop` å‘½ä»¤åœæ­¢å®ƒ:

```bash
java -jar my-verticle-fat.jar stop my-app-name
```

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ—å‡ºåœ¨åå°å¯åŠ¨çš„ vert.x åº”ç”¨ç¨‹åº:

```bash
java -jar my-verticle-fat.jar list
```

`start`,`stop` å’Œ `list` å‘½ä»¤ä¹Ÿå¯ä»¥ä» `vertx` å·¥å…·è·å¾—. `start` å‘½ä»¤æ”¯æŒå‡ ä¸ªé€‰é¡¹:

- `vertx-id` : åº”ç”¨ç¨‹åº ID,å¦‚æœæœªè®¾ç½®,åˆ™ä½¿ç”¨éšæœº UUID
- `java-opts` : Java è™šæ‹Ÿæœºé€‰é¡¹,å¦‚æœæœªè®¾ç½®,åˆ™ä½¿ç”¨ `JAVA_OPTS` ç¯å¢ƒå˜é‡.
- `redirect-output` : å°†ç”Ÿæˆçš„è¿›ç¨‹è¾“å‡ºå’Œé”™è¯¯æµé‡å®šå‘åˆ°çˆ¶è¿›ç¨‹æµ.

å¦‚æœé€‰é¡¹å€¼åŒ…å«ç©ºæ ¼,è¯·ä¸è¦å¿˜è®°å°†å€¼åŒ…å«åœ¨ `""`(åŒå¼•å·)ä¹‹é—´.

ç”±äº `start` å‘½ä»¤ç”Ÿæˆä¸€ä¸ªæ–°è¿›ç¨‹,ä¼ é€’ç»™ JVM çš„ java é€‰é¡¹ä¸ä¼šä¼ æ’­,å› æ­¤æ‚¨å¿…é¡»**ä½¿ç”¨ `java-opts` æ¥é…ç½® JVM(`-X`,`-D`... ). å¦‚æœæ‚¨ä½¿ç”¨ `CLASSPATH` ç¯å¢ƒå˜é‡,è¯·ç¡®ä¿å®ƒåŒ…å«æ‰€æœ‰å¿…éœ€çš„ jars(vertx-core,æ‚¨çš„ jars å’Œæ‰€æœ‰ä¾èµ–é¡¹).

è¯¥å‘½ä»¤é›†æ˜¯å¯æ‰©å±•çš„,è¯·å‚é˜… [Extending the vert.x Launcher](#_extending_the_vert_x_launcher) éƒ¨åˆ†.

### å®æ—¶é‡æ–°éƒ¨ç½²(çƒ­éƒ¨ç½²)

åœ¨å¼€å‘æ—¶,åœ¨æ–‡ä»¶æ›´æ”¹æ—¶è‡ªåŠ¨é‡æ–°éƒ¨ç½²åº”ç”¨ç¨‹åºå¯èƒ½ä¼šå¾ˆæ–¹ä¾¿. `vertx` å‘½ä»¤è¡Œå·¥å…·å’Œæ›´æ™®éçš„ `Launcher` ç±»æä¾›äº†æ­¤åŠŸèƒ½. è¿™é‡Œæœ‰äº›ä¾‹å­:

```bash
vertx run MyVerticle.groovy --redeploy="**/*.groovy" --launcher-class=io.vertx.core.Launcher
vertx run MyVerticle.groovy --redeploy="**/*.groovy,**/*.rb"  --launcher-class=io.vertx.core.Launcher
java io.vertx.core.Launcher run org.acme.MyVerticle --redeploy="**/*.class"  --launcher-class=io.vertx.core
.Launcher -cp ...
```

é‡æ–°éƒ¨ç½²è¿‡ç¨‹æ‰§è¡Œå¦‚ä¸‹. é¦–å…ˆ,æ‚¨çš„åº”ç”¨ç¨‹åºä½œä¸ºåå°åº”ç”¨ç¨‹åºå¯åŠ¨(ä½¿ç”¨ `start` å‘½ä»¤). åœ¨åŒ¹é…æ–‡ä»¶æ›´æ”¹æ—¶,è¯¥è¿›ç¨‹å°†åœæ­¢å¹¶é‡æ–°å¯åŠ¨åº”ç”¨ç¨‹åº. è¿™æ ·å¯ä»¥é¿å…æ³„æ¼,å› ä¸ºè¯¥è¿›ç¨‹ä¼šé‡æ–°å¯åŠ¨.

è¦å¯ç”¨å®æ—¶é‡æ–°éƒ¨ç½²,è¯·å°† `--redeploy` é€‰é¡¹ä¼ é€’ç»™ `run` å‘½ä»¤. `--redeploy` æŒ‡ç¤ºè¦ *watch* çš„æ–‡ä»¶é›†. è¯¥é›†åˆå¯ä»¥ä½¿ç”¨ Ant æ ·å¼çš„æ¨¡å¼(ä½¿ç”¨ `**`,`*` å’Œ `?`). æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨é€—å· (`,`) åˆ†éš”å®ƒä»¬æ¥æŒ‡å®šå¤šä¸ªé›†åˆ. æ¨¡å¼æ˜¯ç›¸å¯¹äºå½“å‰å·¥ä½œç›®å½•çš„.

ä¼ é€’ç»™`run` å‘½ä»¤çš„å‚æ•°è¢«ä¼ é€’ç»™åº”ç”¨ç¨‹åº. Java è™šæ‹Ÿæœºé€‰é¡¹å¯ä»¥ä½¿ç”¨ `--java-opts` è¿›è¡Œé…ç½®. ä¾‹å¦‚,è¦ä¼ é€’ `conf` å‚æ•°æˆ–ç³»ç»Ÿå±æ€§,æ‚¨éœ€è¦ä½¿ç”¨: `--java-opts="-conf=my-conf.json -Dkey=value"`

`--launcher-class` é€‰é¡¹ä¸ *main* ç±»ä¸€èµ·ç¡®å®šåº”ç”¨ç¨‹åºæ˜¯å¯åŠ¨å™¨. å®ƒé€šå¸¸æ˜¯`Launcher`,ä½†ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä½ è‡ªå·±çš„*main*.

å¯ä»¥åœ¨æ‚¨çš„ IDE ä¸­ä½¿ç”¨é‡æ–°éƒ¨ç½²åŠŸèƒ½:

- Eclipse - åˆ›å»ºä¸€ä¸ª *Run* é…ç½®,ä½¿ç”¨ `io.vertx.core.Launcher` ç±»ä½œä¸º *main class*. åœ¨ *Program arguments* åŒºåŸŸ(åœ¨ *Arguments* é€‰é¡¹å¡ä¸­),ç¼–å†™ `run your-verticle-fully-qualified-name --redeploy=**/*.java --launcher-class=io.vertx.core.Launcher`. æ‚¨è¿˜å¯ä»¥æ·»åŠ å…¶ä»–å‚æ•°. éšç€ Eclipse åœ¨ä¿å­˜æ—¶å¢é‡ç¼–è¯‘æ‚¨çš„æ–‡ä»¶,é‡æ–°éƒ¨ç½²å·¥ä½œé¡ºåˆ©è¿›è¡Œ.
- IntelliJ - åˆ›å»ºä¸€ä¸ª *Run* é…ç½® (*Application*),å°† *Main class* è®¾ç½®ä¸º `io.vertx.core.Launcher`. åœ¨ç¨‹åºå‚æ•°ä¸­å†™å…¥:`run your-verticle-fully-qualified-name --redeploy=**/*.class --launcher-class=io.vertx.core.Launcher`. è¦è§¦å‘é‡æ–°éƒ¨ç½²,æ‚¨éœ€è¦æ˜¾å¼åœ° *make* é¡¹ç›®æˆ–æ¨¡å—(*Build* èœå• â†’ *Make project*).

è¦è°ƒè¯•æ‚¨çš„åº”ç”¨ç¨‹åº,è¯·å°†æ‚¨çš„è¿è¡Œé…ç½®åˆ›å»ºä¸ºè¿œç¨‹åº”ç”¨ç¨‹åºå¹¶ä½¿ç”¨ --java-opts é…ç½®è°ƒè¯•å™¨. ä½†æ˜¯,ä¸è¦å¿˜è®°åœ¨æ¯æ¬¡é‡æ–°éƒ¨ç½²åé‡æ–°æ’å…¥è°ƒè¯•å™¨,å› ä¸ºæ¯æ¬¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹.

æ‚¨è¿˜å¯ä»¥åœ¨é‡æ–°éƒ¨ç½²å‘¨æœŸä¸­æŒ‚é’©æ‚¨çš„æ„å»ºè¿‡ç¨‹:

```
java -jar target/my-fat-jar.jar --redeploy="**/*.java" --on-redeploy="mvn package"
java -jar build/libs/my-fat-jar.jar --redeploy="src/**/*.java" --on-redeploy='./gradlew shadowJar'
```

"on-redeploy"é€‰é¡¹æŒ‡å®šåœ¨åº”ç”¨ç¨‹åºå…³é—­ä¹‹åå’Œé‡æ–°å¯åŠ¨ä¹‹å‰è°ƒç”¨çš„å‘½ä»¤. å› æ­¤,å¦‚æœå®ƒæ›´æ–°äº†ä¸€äº›è¿è¡Œæ—¶å·¥ä»¶,æ‚¨å¯ä»¥æŒ‚é’©æ‚¨çš„æ„å»ºå·¥å…·. ä¾‹å¦‚,æ‚¨å¯ä»¥å¯åŠ¨ `gulp` æˆ– `grunt` æ¥æ›´æ–°æ‚¨çš„èµ„æº. ä¸è¦å¿˜è®°å‘åº”ç”¨ç¨‹åºä¼ é€’å‚æ•°éœ€è¦ `--java-opts` å‚æ•°:

```
java -jar target/my-fat-jar.jar --redeploy="**/*.java" --on-redeploy="mvn package" --java-opts="-Dkey=val"
java -jar build/libs/my-fat-jar.jar --redeploy="src/**/*.java" --on-redeploy='./gradlew shadowJar' --java-opts="-Dkey=val"
```

é‡æ–°éƒ¨ç½²åŠŸèƒ½è¿˜æ”¯æŒä»¥ä¸‹è®¾ç½®:

- `redeploy-scan-period` : æ–‡ä»¶ç³»ç»Ÿæ£€æŸ¥å‘¨æœŸ(æ¯«ç§’),é»˜è®¤250ms
- `redeploy-grace-period` : åœ¨ 2 æ¬¡é‡æ–°éƒ¨ç½²ä¹‹é—´ç­‰å¾…çš„æ—¶é—´(ä»¥æ¯«ç§’ä¸ºå•ä½),é»˜è®¤ä¸º 1000 æ¯«ç§’
- `redeploy-termination-period` : åœæ­¢åº”ç”¨ç¨‹åºå(å¯åŠ¨ç”¨æˆ·å‘½ä»¤ä¹‹å‰)ç­‰å¾…çš„æ—¶é—´. è¿™åœ¨ Windows ä¸Šå¾ˆæœ‰ç”¨,åœ¨ Windows ä¸­è¿›ç¨‹ä¸ä¼šç«‹å³è¢«ç»ˆæ­¢. æ—¶é—´ä»¥æ¯«ç§’ä¸ºå•ä½. é»˜è®¤ä¸º 0 æ¯«ç§’.

## é›†ç¾¤ç®¡ç†å™¨

åœ¨ Vert.x ä¸­,é›†ç¾¤ç®¡ç†å™¨ç”¨äºå„ç§åŠŸèƒ½,åŒ…æ‹¬:

- é›†ç¾¤ä¸­ Vert.x èŠ‚ç‚¹çš„å‘ç°å’Œç»„æˆå‘˜èº«ä»½
- ç»´æŠ¤é›†ç¾¤èŒƒå›´çš„ä¸»é¢˜è®¢é˜…è€…åˆ—è¡¨(å› æ­¤æˆ‘ä»¬çŸ¥é“å“ªäº›èŠ‚ç‚¹å¯¹å“ªäº›äº‹ä»¶æ€»çº¿åœ°å€æ„Ÿå…´è¶£)
- åˆ†å¸ƒå¼Mapæ”¯æŒ
- åˆ†å¸ƒå¼é”
- åˆ†å¸ƒå¼è®¡æ•°å™¨

é›†ç¾¤ç®¡ç†å™¨*ä¸*å¤„ç†èŠ‚ç‚¹é—´çš„äº‹ä»¶æ€»çº¿ä¼ è¾“,è¿™æ˜¯ç”± Vert.x é€šè¿‡ TCP è¿æ¥ç›´æ¥å®Œæˆçš„.

Vert.x å‘è¡Œç‰ˆä¸­ä½¿ç”¨çš„é»˜è®¤é›†ç¾¤ç®¡ç†å™¨æ˜¯ä½¿ç”¨ [Hazelcast](http://hazelcast.com/) çš„é›†ç¾¤ç®¡ç†å™¨,ä½†ç”±äº Vert.x é›†ç¾¤ç®¡ç†å™¨æ˜¯å¯æ’æ‹”çš„,å› æ­¤å¯ä»¥å¾ˆå®¹æ˜“åœ°ç”¨ä¸åŒçš„å®ç°æ›¿æ¢å®ƒ.

é›†ç¾¤ç®¡ç†å™¨å¿…é¡»å®ç°æ¥å£`ClusterManager`. Vert.x åœ¨è¿è¡Œæ—¶é€šè¿‡ä½¿ç”¨ Java [Service Loader](https://docs.oracle.com/javase/8/docs/api/java/util/ServiceLoader.html) åŠŸèƒ½å®šä½é›†ç¾¤ç®¡ç†å™¨æ¥å®šä½ ç±»è·¯å¾„ä¸Šçš„`ClusterManager`.

å¦‚æœæ‚¨åœ¨å‘½ä»¤è¡Œä¸­ä½¿ç”¨ Vert.x å¹¶ä¸”æƒ³è¦ä½¿ç”¨é›†ç¾¤,åˆ™åº”ç¡®ä¿ Vert.x å®‰è£…çš„ `lib` ç›®å½•åŒ…å«é›†ç¾¤ç®¡ç†å™¨ jar.

å¦‚æœæ‚¨åœ¨ Maven æˆ– Gradle é¡¹ç›®ä¸­ä½¿ç”¨ Vert.x,åªéœ€å°†é›†ç¾¤ç®¡ç†å™¨ jar æ·»åŠ ä¸ºé¡¹ç›®çš„ä¾èµ–é¡¹.

å¦‚æœä½¿ç”¨ `setClusterManager` åµŒå…¥ Vert.x,æ‚¨è¿˜å¯ä»¥é€šè¿‡ç¼–ç¨‹æ–¹å¼æŒ‡å®šé›†ç¾¤ç®¡ç†å™¨.

## æ—¥å¿—è®°å½•

Vert.x ä½¿ç”¨å…¶å†…éƒ¨æ—¥å¿— API è¿›è¡Œæ—¥å¿—è®°å½•,å¹¶æ”¯æŒå„ç§æ—¥å¿—åç«¯.

æ—¥å¿—åç«¯é€‰æ‹©å¦‚ä¸‹:

1. ç”± `vertx.logger-delegate-factory-class-name` ç³»ç»Ÿå±æ€§è¡¨ç¤ºçš„åç«¯(å¦‚æœå­˜åœ¨),æˆ–è€…,
2. å½“ `vertx-default-jul-logging.properties` æ–‡ä»¶ä½äºç±»è·¯å¾„ä¸­æ—¶çš„ JDK æ—¥å¿—è®°å½•,æˆ–è€…,
3. ç±»è·¯å¾„ä¸­å­˜åœ¨çš„åç«¯,æŒ‰ä»¥ä¸‹ä¼˜å…ˆé¡ºåº:
   1. SLF4J
   2. Log4J
   3. Log4J2

å¦åˆ™ Vert.x é»˜è®¤ä½¿ç”¨ JDK æ—¥å¿—è®°å½•.

### ä½¿ç”¨ç³»ç»Ÿå±æ€§è¿›è¡Œé…ç½®

å°† `vertx.logger-delegate-factory-class-name` ç³»ç»Ÿå±æ€§è®¾ç½®ä¸º:

- `io.vertx.core.logging.SLF4JLogDelegateFactory` ç»™ SLF4J æˆ–è€…,
- `io.vertx.core.logging.Log4j2LogDelegateFactory` ç»™ Log4J2 æˆ–è€…,
- `io.vertx.core.logging.JULLogDelegateFactory` ç»™ JDK logging

### è‡ªåŠ¨é…ç½®

å½“æ²¡æœ‰è®¾ç½® `vertx.logger-delegate-factory-class-name` ç³»ç»Ÿå±æ€§æ—¶,Vert.x å°†å°è¯•æ‰¾åˆ°æœ€åˆé€‚çš„æ—¥å¿—è®°å½•å™¨:

- åœ¨å…·æœ‰å®é™…å®ç°çš„ç±»è·¯å¾„ä¸Šå¯ç”¨æ—¶ä½¿ç”¨ SLF4J(å³ `LoggerFactory.getILoggerFactory()` ä¸æ˜¯ `NOPLoggerFactory` çš„å®ä¾‹)
- å¦åˆ™åœ¨ç±»è·¯å¾„ä¸Šå¯ç”¨æ—¶ä½¿ç”¨ Log4j2
- å¦åˆ™ä½¿ç”¨ JUL

### é…ç½® JUL æ—¥å¿—è®°å½•

é€šè¿‡æä¾›åä¸º`java.util.logging.config.file`çš„ç³»ç»Ÿå±æ€§,å…¶å€¼æ˜¯æ‚¨çš„é…ç½®æ–‡ä»¶,å¯ä»¥ä»¥æ­£å¸¸çš„ JUL æ–¹å¼æŒ‡å®š JUL æ—¥å¿—è®°å½•é…ç½®æ–‡ä»¶. æœ‰å…³æ­¤å†…å®¹å’Œ JUL é…ç½®æ–‡ä»¶ç»“æ„çš„æ›´å¤šä¿¡æ¯,è¯·å‚é˜… JDK æ—¥å¿—è®°å½•æ–‡æ¡£.

Vert.x è¿˜æä¾›äº†ä¸€ç§æ›´æ–¹ä¾¿çš„æ–¹å¼æ¥æŒ‡å®šé…ç½®æ–‡ä»¶,è€Œæ— éœ€è®¾ç½®ç³»ç»Ÿå±æ€§. åªéœ€åœ¨ä½ çš„ç±»è·¯å¾„(ä¾‹å¦‚åœ¨ä½ çš„ fatjar ä¸­)æä¾›ä¸€ä¸ªåä¸º `vertx-default-jul-logging.properties` çš„ JUL é…ç½®æ–‡ä»¶,Vert.x å°†ä½¿ç”¨å®ƒæ¥é…ç½® JUL.

<a name="netty_logging"></a>
### Netty æ—¥å¿—è®°å½•

Netty ä¸ä¾èµ–äºå¤–éƒ¨æ—¥å¿—é…ç½®(ä¾‹å¦‚ç³»ç»Ÿå±æ€§). ç›¸å,å®ƒåŸºäº Netty ç±»ä¸­å¯è§çš„æ—¥å¿—åº“å®ç°äº†æ—¥å¿—é…ç½®:

- ä½¿ç”¨ `SLF4J` åº“,å¦‚æœå®ƒæ˜¯å¯è§çš„
- å¦åˆ™ä½¿ç”¨ `Log4j` å¦‚æœå®ƒæ˜¯å¯è§çš„
- å¦åˆ™ä½¿ç”¨ `Log4j2` å¦‚æœå®ƒæ˜¯å¯è§çš„
- å¦åˆ™å›é€€åˆ° `java.util.logging`

> **ğŸ·æ³¨æ„:** ä½ ä»¬ä¸­çš„é¹°çœ¼å¯èƒ½å·²ç»æ³¨æ„åˆ° Vert.x éµå¾ªç›¸åŒçš„ä¼˜å…ˆé¡ºåº.

é€šè¿‡ç›´æ¥åœ¨ `io.netty.util.internal.logging.InternalLoggerFactory` ä¸Šè®¾ç½® Netty çš„å†…éƒ¨æ—¥å¿—è®°å½•å™¨å®ç°,å¯ä»¥å°†æ—¥å¿—è®°å½•å™¨å®ç°å¼ºåˆ¶ä¸ºç‰¹å®šå®ç°:

```java
// Force logging to Log4j 2
InternalLoggerFactory.setDefaultFactory(Log4J2LoggerFactory.INSTANCE);
```

### æ•…éšœæ’é™¤

#### å¯åŠ¨æ—¶çš„ SLF4J è­¦å‘Š

å¦‚æœåœ¨å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶çœ‹åˆ°ä»¥ä¸‹æ¶ˆæ¯:

```
SLF4J: Failed to load class "org.slf4j.impl.StaticLoggerBinder".
SLF4J: Defaulting to no-operation (NOP) logger implementation
SLF4J: See http://www.slf4j.org/codes.html#StaticLoggerBinder for further details.
```

è¿™æ„å‘³ç€æ‚¨çš„ç±»è·¯å¾„ä¸­æœ‰ SLF4J-API ä½†æ²¡æœ‰å®é™…ç»‘å®š. ä½¿ç”¨ SLF4J è®°å½•çš„æ¶ˆæ¯å°†è¢«ä¸¢å¼ƒ. æ‚¨åº”è¯¥å°†ç»‘å®šæ·»åŠ åˆ°æ‚¨çš„ç±»è·¯å¾„. æ£€æŸ¥ `https://www.slf4j.org/manual.html#swapping` ä»¥é€‰æ‹©ç»‘å®šå¹¶è¿›è¡Œé…ç½®.

è¯·æ³¨æ„,Netty ä¼šæŸ¥æ‰¾ SLF4-API jar å¹¶é»˜è®¤ä½¿ç”¨å®ƒ.

#### å¯¹ç­‰ç‚¹é‡ç½®è¿æ¥

å¦‚æœæ‚¨çš„æ—¥å¿—æ˜¾ç¤ºä¸€å †:

```
io.vertx.core.net.impl.ConnectionBase
SEVERE: java.io.IOException: Connection reset by peer
```

è¿™æ„å‘³ç€å®¢æˆ·ç«¯æ­£åœ¨é‡ç½® HTTP è¿æ¥è€Œä¸æ˜¯å…³é—­å®ƒ. æ­¤æ¶ˆæ¯è¿˜è¡¨æ˜æ‚¨å¯èƒ½å°šæœªä½¿ç”¨å®Œæ•´çš„æœ‰æ•ˆè´Ÿè½½(åœ¨æ‚¨èƒ½å¤Ÿä½¿ç”¨ä¹‹å‰è¿æ¥å·²æ–­å¼€).

## ä¸»æœºåè§£æ

Vert.x ä½¿ç”¨åœ°å€è§£æå™¨å°†ä¸»æœºåè§£æä¸º IP åœ°å€,è€Œä¸æ˜¯ JVM å†…ç½®çš„é˜»å¡è§£æå™¨.

ä¸»æœºåä½¿ç”¨ä»¥ä¸‹æ–¹å¼è§£æä¸º IP åœ°å€:

- æ“ä½œç³»ç»Ÿçš„ *hosts* æ–‡ä»¶
- å¦åˆ™å¯¹æœåŠ¡å™¨åˆ—è¡¨è¿›è¡Œ DNS æŸ¥è¯¢

é»˜è®¤æƒ…å†µä¸‹,å®ƒå°†ä½¿ç”¨ç¯å¢ƒä¸­çš„ç³»ç»Ÿ DNS æœåŠ¡å™¨åœ°å€åˆ—è¡¨,å¦‚æœæ— æ³•æ£€ç´¢è¯¥åˆ—è¡¨,å®ƒå°†ä½¿ç”¨ Google çš„å…¬å…± DNS æœåŠ¡å™¨`8.8.8.8`å’Œ`8.8.4.4`.

åˆ›å»º `Vertx` å®ä¾‹æ—¶ä¹Ÿå¯ä»¥é…ç½® DNS æœåŠ¡å™¨:

```java
Vertx vertx = Vertx.vertx(new VertxOptions().
    setAddressResolverOptions(
        new AddressResolverOptions().
            addServer("192.168.0.1").
            addServer("192.168.0.2:40000"))
);
```

DNS æœåŠ¡å™¨çš„é»˜è®¤ç«¯å£æ˜¯`53`,å½“æœåŠ¡å™¨ä½¿ç”¨ä¸åŒçš„ç«¯å£æ—¶,å¯ä»¥ä½¿ç”¨å†’å·åˆ†éš”ç¬¦è®¾ç½®è¯¥ç«¯å£:`192.168.0.2:40000`.

> **ğŸ·æ³¨æ„:** æœ‰æ—¶å¯èƒ½éœ€è¦ä½¿ç”¨ JVM å†…ç½®è§£æå™¨,JVM ç³»ç»Ÿå±æ€§ `-Dvertx.disableDnsResolver=true` ä¼šæ¿€æ´»æ­¤è¡Œä¸º

### æ•…éšœè½¬ç§»

å½“æœåŠ¡å™¨æ²¡æœ‰åŠæ—¶å›å¤æ—¶,è§£æå™¨å°†å°è¯•åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ª,æœç´¢å—é™äº`setMaxQueries`(é»˜è®¤å€¼ä¸º`4`ä¸ªæŸ¥è¯¢).

å½“è§£æå™¨åœ¨ `getQueryTimeout` æ¯«ç§’(é»˜è®¤å€¼ä¸º `5` ç§’)å†…æœªæ”¶åˆ°æ­£ç¡®ç­”æ¡ˆæ—¶,DNS æŸ¥è¯¢è¢«è§†ä¸ºå¤±è´¥.

### æœåŠ¡å™¨åˆ—è¡¨è½®æ¢

é»˜è®¤æƒ…å†µä¸‹,dns æœåŠ¡å™¨é€‰æ‹©ä½¿ç”¨ç¬¬ä¸€ä¸ª,å…¶ä½™æœåŠ¡å™¨ç”¨äºæ•…éšœè½¬ç§».

æ‚¨å¯ä»¥å°† `setRotateServers` é…ç½®ä¸º `true` ä»¥è®©è§£æå™¨æ‰§è¡Œå¾ªç¯é€‰æ‹©. å®ƒåœ¨æœåŠ¡å™¨ä¹‹é—´åˆ†æ•£æŸ¥è¯¢è´Ÿè½½,å¹¶é¿å…æ‰€æœ‰æŸ¥æ‰¾å‘½ä¸­åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªæœåŠ¡å™¨.

æ•…éšœè½¬ç§»ä»ç„¶é€‚ç”¨,å¹¶å°†ä½¿ç”¨åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªæœåŠ¡å™¨.

### ä¸»æœºæ˜ å°„

æ“ä½œç³»ç»Ÿçš„ *hosts* æ–‡ä»¶ç”¨äºå¯¹ ipaddress æ‰§è¡Œä¸»æœºåæŸ¥æ‰¾.

å¯ä»¥ä½¿ç”¨æ›¿ä»£çš„ *hosts* æ–‡ä»¶:

```java
Vertx vertx = Vertx.vertx(new VertxOptions().
    setAddressResolverOptions(
        new AddressResolverOptions().
            setHostsPath("/path/to/hosts"))
);
```

### æœç´¢åŸŸ

é»˜è®¤æƒ…å†µä¸‹,è§£æå™¨å°†ä½¿ç”¨ç¯å¢ƒä¸­çš„ç³»ç»Ÿ DNS æœç´¢åŸŸ. æˆ–è€…,å¯ä»¥æä¾›æ˜¾å¼æœç´¢åŸŸåˆ—è¡¨:

```java
Vertx vertx = Vertx.vertx(new VertxOptions().
    setAddressResolverOptions(
        new AddressResolverOptions().addSearchDomain("foo.com").addSearchDomain("bar.com"))
);
```

When a search domain list is used, the threshold for the number of dots is `1` or loaded from `/etc/resolv.conf` on Linux, it can be configured to a specific value with `setNdots`.

### MacOS é…ç½®

MacOS æœ‰ä¸€ä¸ªç‰¹å®šçš„åŸç”Ÿæ‰©å±•,å¯ä»¥åŸºäº <a href="https://opensource.apple.com/tarballs/mDNSResponder/">Apple çš„å¼€æº mDNSResponder</a> è·å–ç³»ç»Ÿçš„åç§°æœåŠ¡å™¨é…ç½®. å½“æ­¤æ‰©å±•ä¸å­˜åœ¨æ—¶,Netty ä¼šè®°å½•ä»¥ä¸‹è­¦å‘Š.

```
[main] WARN io.netty.resolver.dns.DnsServerAddressStreamProviders - Can not find io.netty.resolver.dns.macos.MacOSDnsServerAddressStreamProvider in the classpath, fallback to system defaults. This may result in incorrect DNS resolutions on MacOS.
```

è¿™ä¸ªæ‰©å±•ä¸æ˜¯å¿…éœ€çš„,å› ä¸ºå®ƒçš„ç¼ºå¤±ä¸ä¼šé˜»æ­¢ Vert.x çš„æ‰§è¡Œ,ä½†æ˜¯æ˜¯**æ¨èçš„**.

æ‚¨å¯ä»¥ä½¿ç”¨å°†å…¶æ·»åŠ åˆ°æ‚¨çš„ç±»è·¯å¾„æ¥æ”¹è¿›é›†æˆå¹¶åˆ é™¤è­¦å‘Š.

```xml
<profile>
 <id>mac</id>
 <activation>
   <os>
     <family>mac</family>
   </os>
 </activation>
 <dependencies>
   <dependency>
     <groupId>io.netty</groupId>
     <artifactId>netty-resolver-dns-native-macos</artifactId>
     <classifier>osx-x86_64</classifier>
     <!--<version>Should align with netty version that Vert.x uses</version>-->
   </dependency>
 </dependencies>
</profile>
```

<a name="high_availability_and_fail_over"></a>
## é«˜å¯ç”¨æ€§å’Œæ•…éšœè½¬ç§»

Vert.x å…è®¸æ‚¨è¿è¡Œå…·æœ‰é«˜å¯ç”¨æ€§ (HA) æ”¯æŒçš„ Verticle. åœ¨è¿™ç§æƒ…å†µä¸‹,å½“è¿è¡Œ verticle çš„ vert.x å®ä¾‹çªç„¶æ­»äº¡æ—¶,verticle ä¼šè¿ç§»åˆ°å¦ä¸€ä¸ª vertx å®ä¾‹. vert.x å®ä¾‹å¿…é¡»åœ¨åŒä¸€ä¸ªé›†ç¾¤ä¸­.

### è‡ªåŠ¨æ•…éšœè½¬ç§»

å½“ vert.x åœ¨å¯ç”¨ *HA* çš„æƒ…å†µä¸‹è¿è¡Œæ—¶,å¦‚æœä¸€ä¸ª verticle è¿è¡Œçš„ vert.x å®ä¾‹å¤±è´¥æˆ–æ­»äº¡,åˆ™è¯¥ verticle ä¼šè‡ªåŠ¨é‡æ–°éƒ¨ç½²åˆ°é›†ç¾¤çš„å¦ä¸€ä¸ª vert.x å®ä¾‹ä¸Š. æˆ‘ä»¬ç§°ä¹‹ä¸º*verticle æ•…éšœè½¬ç§»*.

è¦åœ¨å¯ç”¨ *HA* çš„æƒ…å†µä¸‹è¿è¡Œ vert.x,åªéœ€å°† `-ha` æ ‡å¿—æ·»åŠ åˆ°å‘½ä»¤è¡Œ:

```bash
vertx run my-verticle.js -ha
```

ç°åœ¨è¦ä½¿ HA å·¥ä½œ,æ‚¨éœ€è¦é›†ç¾¤ä¸­çš„å¤šä¸ª Vert.x å®ä¾‹,æ‰€ä»¥å‡è®¾æ‚¨å·²ç»å¯åŠ¨äº†å¦ä¸€ä¸ª Vert.x å®ä¾‹,ä¾‹å¦‚:

```bash
vertx run my-other-verticle.js -ha
```

å¦‚æœæ­£åœ¨è¿è¡Œ `my-verticle.js` çš„ Vert.x å®ä¾‹ç°åœ¨æ­»æ‰äº†(æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ `kill -9` ç»ˆæ­¢è¿›ç¨‹æ¥æµ‹è¯•å®ƒ),è¿è¡Œ `my-other-verticle.js` çš„ Vert.x å®ä¾‹ å°†è‡ªåŠ¨éƒ¨ç½² `my-verticle .js` æ‰€ä»¥ç°åœ¨ Vert.x å®ä¾‹æ­£åœ¨è¿è¡Œä¸¤ä¸ª verticles.

> **ğŸ·æ³¨æ„:** ä»…å½“ç¬¬äºŒä¸ª vert.x å®ä¾‹å¯ä»¥è®¿é—® verticle æ–‡ä»¶(æ­¤å¤„ä¸º `my-verticle.js`)æ—¶,æ‰èƒ½è¿›è¡Œè¿ç§».

> **âš é‡è¦:** è¯·æ³¨æ„,å¹²å‡€åœ°å…³é—­ Vert.x å®ä¾‹ä¸ä¼šå¯¼è‡´å‘ç”Ÿæ•…éšœè½¬ç§»,ä¾‹å¦‚ `CTRL-C` æˆ– `kill -SIGINT`

æ‚¨è¿˜å¯ä»¥å¯åŠ¨ *bare*  Vert.x å®ä¾‹ - å³æœ€åˆä¸è¿è¡Œä»»ä½• Verticle çš„å®ä¾‹,å®ƒä»¬è¿˜å°†ä¸ºé›†ç¾¤ä¸­çš„èŠ‚ç‚¹è¿›è¡Œæ•…éšœè½¬ç§». è¦å¯åŠ¨ä¸€ä¸ªè£¸å®ä¾‹,æ‚¨åªéœ€æ‰§è¡Œä»¥ä¸‹æ“ä½œ:

```bash
vertx run -ha
```

ä½¿ç”¨ `-ha` å¼€å…³æ—¶,æ‚¨ä¸éœ€è¦æä¾› `-cluster` å¼€å…³,å› ä¸ºå¦‚æœæ‚¨éœ€è¦ HA,åˆ™å‡å®šä¸ºé›†ç¾¤.

> **ğŸ·æ³¨æ„:** æ ¹æ®æ‚¨çš„é›†ç¾¤é…ç½®,æ‚¨å¯èƒ½éœ€è¦è‡ªå®šä¹‰é›†ç¾¤ç®¡ç†å™¨é…ç½®(é»˜è®¤ä¸º Hazelcast),å’Œ/æˆ–æ·»åŠ  `cluster-host` å’Œ `cluster-port` å‚æ•°.

### HA ç»„

ä½¿ç”¨ HA è¿è¡Œ Vert.x å®ä¾‹æ—¶,æ‚¨è¿˜å¯ä»¥é€‰æ‹©æŒ‡å®š *HA ç»„*. HA ç»„è¡¨ç¤ºé›†ç¾¤ä¸­çš„ä¸€ä¸ªé€»è¾‘èŠ‚ç‚¹ç»„. åªæœ‰å…·æœ‰ç›¸åŒ HA ç»„çš„èŠ‚ç‚¹æ‰ä¼šæ•…éšœè½¬ç§»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Š. å¦‚æœæ‚¨æœªæŒ‡å®š HA ç»„,åˆ™ä½¿ç”¨é»˜è®¤ç»„ `__DEFAULT__`.

è¦æŒ‡å®š HA ç»„,æ‚¨å¯ä»¥åœ¨è¿è¡Œ verticle æ—¶ä½¿ç”¨ `-hagroup` å¼€å…³,ä¾‹å¦‚

```bash
vertx run my-verticle.js -ha -hagroup my-group
```

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­:

åœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯:

```bash
vertx run my-verticle.js -ha -hagroup g1
```

åœ¨ç¬¬äºŒä¸ªç»ˆç«¯ä¸­,è®©æˆ‘ä»¬ä½¿ç”¨åŒä¸€ç»„è¿è¡Œå¦ä¸€ä¸ª Verticle:

```bash
vertx run my-other-verticle.js -ha -hagroup g1
```

æœ€å,åœ¨ç¬¬ä¸‰ä¸ªç»ˆç«¯ä¸­,ä½¿ç”¨ä¸åŒçš„ç»„å¯åŠ¨å¦ä¸€ä¸ª Verticle:

```bash
vertx run yet-another-verticle.js -ha -hagroup g2
```

å¦‚æœæˆ‘ä»¬æ€æ­»ç»ˆç«¯ 1 ä¸­çš„å®ä¾‹,å®ƒå°†æ•…éšœè½¬ç§»åˆ°ç»ˆç«¯ 2 ä¸­çš„å®ä¾‹,è€Œä¸æ˜¯ç»ˆç«¯ 3 ä¸­çš„å®ä¾‹,å› ä¸ºå®ƒå…·æœ‰ä¸åŒçš„ç»„.

å¦‚æœæˆ‘ä»¬åœ¨ç»ˆç«¯ 3 ä¸­ç»ˆæ­¢å®ä¾‹,å®ƒä¸ä¼šå‘ç”Ÿæ•…éšœè½¬ç§»,å› ä¸ºè¯¥ç»„ä¸­æ²¡æœ‰å…¶ä»– vert.x å®ä¾‹.

### å¤„ç†ç½‘ç»œåˆ†åŒº - Quora(æ³•å®šäººæ•°)

HA å®ç°ä¹Ÿæ”¯æŒ quora. æ³•å®šäººæ•°æ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ä¸ºäº†è¢«å…è®¸åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ‰§è¡Œæ“ä½œè€Œå¿…é¡»è·å¾—çš„æœ€å°æŠ•ç¥¨æ•°.

å¯åŠ¨ Vert.x å®ä¾‹æ—¶,æ‚¨å¯ä»¥æŒ‡ç¤ºå®ƒåœ¨éƒ¨ç½²ä»»ä½• HA éƒ¨ç½²ä¹‹å‰éœ€è¦ä¸€ä¸ª `quorum`. åœ¨è¿™ç§æƒ…å†µä¸‹,ä»²è£æ˜¯é›†ç¾¤ä¸­ç‰¹å®šç»„çš„æœ€å°èŠ‚ç‚¹æ•°. é€šå¸¸,æ‚¨å°†ä»²è£å¤§å°é€‰æ‹©ä¸º`Q = 1 + N/2`,å…¶ä¸­`N`æ˜¯ç»„ä¸­çš„èŠ‚ç‚¹æ•°. å¦‚æœé›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ•°å°‘äº"Q"ä¸ª,HA éƒ¨ç½²å°†å–æ¶ˆéƒ¨ç½². å¦‚æœ/å½“é‡æ–°è¾¾åˆ°æ³•å®šäººæ•°æ—¶,ä»–ä»¬å°†å†æ¬¡é‡æ–°éƒ¨ç½². é€šè¿‡è¿™æ ·åš,æ‚¨å¯ä»¥é˜²æ­¢ç½‘ç»œåˆ†åŒº,ä¹Ÿå°±æ˜¯*è£‚è„‘*.

æœ‰æ›´å¤šå…³äº quora çš„ä¿¡æ¯ [è¿™é‡Œ](https://en.wikipedia.org/wiki/Quorum_(distributed_computing)).

è¦ä½¿ç”¨ä»²è£è¿è¡Œ vert.x å®ä¾‹,è¯·åœ¨å‘½ä»¤è¡Œä¸ŠæŒ‡å®š `-quorum`,ä¾‹å¦‚

åœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯:

```bash
vertx run my-verticle.js -ha -quorum 3
```

æ­¤æ—¶ Vert.x å®ä¾‹å°†å¯åŠ¨ä½†å°šæœªéƒ¨ç½²æ¨¡å—,å› ä¸ºé›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹,è€Œä¸æ˜¯ 3 ä¸ª.

åœ¨ç¬¬äºŒä¸ªç»ˆç«¯:

```bash
vertx run my-other-verticle.js -ha -quorum 3
```

æ­¤æ—¶ Vert.x å®ä¾‹å°†å¯åŠ¨ä½†å°šæœªéƒ¨ç½²æ¨¡å—,å› ä¸ºé›†ç¾¤ä¸­åªæœ‰ä¸¤ä¸ªèŠ‚ç‚¹,è€Œä¸æ˜¯ 3 ä¸ª.

åœ¨ç¬¬ä¸‰ä¸ªæ§åˆ¶å°ä¸­,æ‚¨å¯ä»¥å¯åŠ¨å¦ä¸€ä¸ª vert.x å®ä¾‹:

```bash
vertx run yet-another-verticle.js -ha -quorum 3
```

è€¶! - æˆ‘ä»¬æœ‰ä¸‰ä¸ªèŠ‚ç‚¹,æ­¤æ—¶ç¬¦åˆæ³•å®šäººæ•°äº†. æ­¤æ—¶,æ¨¡å—å°†è‡ªåŠ¨éƒ¨ç½²åœ¨æ‰€æœ‰å®ä¾‹ä¸Š.

å¦‚æœæˆ‘ä»¬ç°åœ¨å…³é—­æˆ–æ€æ­»å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹,æ¨¡å—å°†è‡ªåŠ¨å–æ¶ˆéƒ¨ç½²åœ¨å…¶ä»–èŠ‚ç‚¹ä¸Š,å› ä¸ºä¸å†æœ‰ä»²è£.

Quora ä¹Ÿå¯ä»¥ä¸ ha ç»„ä¸€èµ·ä½¿ç”¨. åœ¨è¿™ç§æƒ…å†µä¸‹,ä¼šä¸ºæ¯ä¸ªç‰¹å®šç»„è§£æ quora.

## æœ¬æœºä¼ è¾“

Vert.x å¯ä»¥åœ¨ BSD (OSX) å’Œ Linux ä¸Šä½¿ç”¨ [native transports](http://netty.io/wiki/native-transports.html)(å¦‚æœå¯ç”¨)è¿è¡Œ:

```java
Vertx vertx = Vertx.vertx(new VertxOptions().
  setPreferNativeTransport(true)
);

// True when native is available
boolean usingNative = vertx.isNativeTransportEnabled();
System.out.println("Running with native: " + usingNative);
```

> **ğŸ·æ³¨æ„:** é¦–é€‰æœ¬æœºä¼ è¾“ä¸ä¼šé˜»æ­¢åº”ç”¨ç¨‹åºæ‰§è¡Œ(ä¾‹å¦‚,å¦‚æœç¼ºå°‘ JAR). å¦‚æœæ‚¨çš„åº”ç”¨ç¨‹åºéœ€è¦æœ¬åœ°ä¼ è¾“,åˆ™éœ€è¦æ£€æŸ¥ `isNativeTransportEnabled`.

### æœ¬æœº Linux ä¼ è¾“

æ‚¨éœ€è¦åœ¨ç±»è·¯å¾„ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–é¡¹:

```xml
<dependency>
 <groupId>io.netty</groupId>
 <artifactId>netty-transport-native-epoll</artifactId>
 <classifier>linux-x86_64</classifier>
 <!--<version>Should align with netty version that Vert.x uses</version>-->
</dependency>
```

Linux ä¸Šçš„ Native ä¸ºæ‚¨æä¾›äº†é¢å¤–çš„ç½‘ç»œé€‰é¡¹:

- `SO_REUSEPORT`
- `TCP_QUICKACK`
- `TCP_CORK`
- `TCP_FASTOPEN`

```java
vertx.createHttpServer(new HttpServerOptions()
  .setTcpFastOpen(fastOpen)
  .setTcpCork(cork)
  .setTcpQuickAck(quickAck)
  .setReusePort(reusePort)
);
```

### æœ¬æœº BSD ä¼ è¾“

æ‚¨éœ€è¦åœ¨ç±»è·¯å¾„ä¸­æ·»åŠ ä»¥ä¸‹ä¾èµ–é¡¹:

```xml
<dependency>
 <groupId>io.netty</groupId>
 <artifactId>netty-transport-native-kqueue</artifactId>
 <classifier>osx-x86_64</classifier>
 <!--<version>Should align with netty version that Vert.x uses</version>-->
</dependency>
```

æ”¯æŒ MacOS Sierra åŠæ›´é«˜ç‰ˆæœ¬.

BSD ä¸Šçš„æœ¬æœºä¸ºæ‚¨æä¾›äº†é¢å¤–çš„ç½‘ç»œé€‰é¡¹:

- `SO_REUSEPORT`

```java
vertx.createHttpServer(new HttpServerOptions().setReusePort(reusePort));
```

### åŸŸå¥—æ¥å­—

Natives ä¸ºæœåŠ¡å™¨æä¾›åŸŸå¥—æ¥å­—æ”¯æŒ:

```java
vertx.createNetServer().connectHandler(so -> {
  // Handle application
}).listen(SocketAddress.domainSocketAddress("/var/tmp/myservice.sock"));
```

æˆ– http:

```java
vertx.createHttpServer().requestHandler(req -> {
  // Handle application
}).listen(SocketAddress.domainSocketAddress("/var/tmp/myservice.sock"), ar -> {
  if (ar.succeeded()) {
    // Bound to socket
  } else {
    ar.cause().printStackTrace();
  }
});
```

ä»¥åŠå®¢æˆ·ç«¯:

```java
NetClient netClient = vertx.createNetClient();

// Only available on BSD and Linux
SocketAddress addr = SocketAddress.domainSocketAddress("/var/tmp/myservice.sock");

// Connect to the server
netClient.connect(addr, ar -> {
  if (ar.succeeded()) {
    // Connected
  } else {
    ar.cause().printStackTrace();
  }
});
```

æˆ– http:

```java
HttpClient httpClient = vertx.createHttpClient();

// Only available on BSD and Linux
SocketAddress addr = SocketAddress.domainSocketAddress("/var/tmp/myservice.sock");

// Send request to the server
httpClient.request(new RequestOptions()
  .setServer(addr)
  .setHost("localhost")
  .setPort(8080)
  .setURI("/"))
  .onSuccess(request -> {
    request.send().onComplete(response -> {
      // Process response
    });
  });
```
<a name="_security_notes"></a>
## å®‰å…¨è¯´æ˜

Vert.x æ˜¯ä¸€ä¸ªå·¥å…·åŒ…,è€Œä¸æ˜¯ä¸€ä¸ªå›ºæ‰§å·±è§çš„æ¡†æ¶,æˆ‘ä»¬å¼ºè¿«ä½ ä»¥æŸç§æ–¹å¼åšäº‹. è¿™ä¸ºæ‚¨ä½œä¸ºå¼€å‘äººå‘˜æä¾›äº†å¼ºå¤§çš„åŠ›é‡,ä½†éšä¹‹è€Œæ¥çš„æ˜¯å·¨å¤§çš„è´£ä»».

ä¸ä»»ä½•å·¥å…·åŒ…ä¸€æ ·,å¯èƒ½ä¼šç¼–å†™ä¸å®‰å…¨çš„åº”ç”¨ç¨‹åº,å› æ­¤åœ¨å¼€å‘åº”ç”¨ç¨‹åºæ—¶åº”å§‹ç»ˆå°å¿ƒè°¨æ…,å°¤å…¶æ˜¯å½“å®ƒå‘å…¬ä¼—å…¬å¼€æ—¶(ä¾‹å¦‚é€šè¿‡äº’è”ç½‘).

### Web åº”ç”¨ç¨‹åº

å¦‚æœç¼–å†™ Web åº”ç”¨ç¨‹åº,å¼ºçƒˆå»ºè®®æ‚¨ç›´æ¥ä½¿ç”¨ Vert.x-Web è€Œä¸æ˜¯ Vert.x coreæ¥æä¾›èµ„æºå’Œå¤„ç†æ–‡ä»¶ä¸Šä¼ .

Vert.x-Web è§„èŒƒåŒ–è¯·æ±‚ä¸­çš„è·¯å¾„,ä»¥é˜²æ­¢æ¶æ„å®¢æˆ·ç«¯åˆ¶ä½œ URL ä»¥è®¿é—® Web æ ¹ç›®å½•ä¹‹å¤–çš„èµ„æº.

åŒæ ·,å¯¹äºæ–‡ä»¶ä¸Šä¼ ,Vert.x-Web æä¾›äº†ä¸Šä¼ åˆ°ç£ç›˜ä¸Šå·²çŸ¥ä½ç½®çš„åŠŸèƒ½,å¹¶ä¸”ä¸ä¾èµ–äºå®¢æˆ·ç«¯åœ¨ä¸Šä¼ ä¸­æä¾›çš„æ–‡ä»¶å,è¯¥æ–‡ä»¶åå¯ä»¥è¢«ç²¾å¿ƒè®¾è®¡ä¸ºä¸Šä¼ åˆ°ç£ç›˜ä¸Šçš„ä¸åŒä½ç½®.

Vert.x æ ¸å¿ƒæœ¬èº«ä¸æä¾›æ­¤ç±»æ£€æŸ¥,å› æ­¤ä½œä¸ºå¼€å‘äººå‘˜,æ‚¨å¯ä»¥è‡ªå·±å®ç°å®ƒä»¬.

### é›†ç¾¤äº‹ä»¶æ€»çº¿é€šä¿¡

åœ¨ç½‘ç»œä¸Šçš„ä¸åŒ Vert.x èŠ‚ç‚¹ä¹‹é—´å¯¹äº‹ä»¶æ€»çº¿è¿›è¡Œé›†ç¾¤æ—¶,é€šè¿‡çº¿è·¯å‘é€çš„æµé‡æœªåŠ å¯†,å› æ­¤å¦‚æœæ‚¨æœ‰æœºå¯†æ•°æ®è¦å‘é€å¹¶ä¸”æ‚¨çš„ Vert.x èŠ‚ç‚¹ä¸åœ¨å—ä¿¡ä»»çš„ç½‘ç»œä¸Š,è¯·ä¸è¦ä½¿ç”¨å®ƒ .

### æ ‡å‡†å®‰å…¨æœ€ä½³å®è·µ

æ— è®ºæ˜¯ä½¿ç”¨ Vert.x è¿˜æ˜¯ä»»ä½•å…¶ä»–å·¥å…·åŒ…ç¼–å†™çš„ä»»ä½•æœåŠ¡éƒ½å¯èƒ½å­˜åœ¨æ½œåœ¨æ¼æ´,å› æ­¤è¯·å§‹ç»ˆéµå¾ªå®‰å…¨æœ€ä½³å®è·µ,å°¤å…¶æ˜¯åœ¨æ‚¨çš„æœåŠ¡é¢å‘å…¬ä¼—çš„æƒ…å†µä¸‹.

ä¾‹å¦‚,æ‚¨åº”è¯¥å§‹ç»ˆåœ¨ DMZ ä¸­ä½¿ç”¨å…·æœ‰æœ‰é™æƒé™çš„ç”¨æˆ·å¸æˆ·è¿è¡Œå®ƒä»¬,ä»¥ä¾¿åœ¨æœåŠ¡å—åˆ°æŸå®³æ—¶é™åˆ¶æŸåç¨‹åº¦.

## Vert.x å‘½ä»¤è¡Œæ¥å£ API

Vert.x Core æä¾›äº†ä¸€ä¸ª API ç”¨äºè§£æä¼ é€’ç»™ç¨‹åºçš„å‘½ä»¤è¡Œå‚æ•°. å®ƒè¿˜èƒ½å¤Ÿæ‰“å°å¸®åŠ©æ¶ˆæ¯,è¯¦ç»†è¯´æ˜å¯ç”¨äºå‘½ä»¤è¡Œå·¥å…·çš„é€‰é¡¹. å³ä½¿è¿™äº›åŠŸèƒ½ä¸ Vert.x çš„æ ¸å¿ƒä¸»é¢˜ç›¸å»ç”šè¿œ,è¿™ä¸ª API ä¹Ÿå¯ä»¥åœ¨ `Launcher` ç±»ä¸­ä½¿ç”¨,æ‚¨å¯ä»¥åœ¨ *fat-jar* å’Œ `vertx` å‘½ä»¤è¡Œå·¥å…·ä¸­ä½¿ç”¨å®ƒ. æ­¤å¤–,å®ƒæ˜¯å¤šè¯­è¨€çš„(å¯ä»¥ä»ä»»ä½•å—æ”¯æŒçš„è¯­è¨€ä¸­ä½¿ç”¨)å¹¶ä¸”åœ¨ Vert.x Shell ä¸­ä½¿ç”¨.

Vert.x CLI æä¾›äº†ä¸€ä¸ªæ¨¡å‹æ¥æè¿°ä½ çš„å‘½ä»¤è¡Œç•Œé¢,åŒæ—¶ä¹Ÿæä¾›äº†ä¸€ä¸ªè§£æå™¨. æ­¤è§£æå™¨æ”¯æŒä¸åŒç±»å‹çš„è¯­æ³•:

- ç±»ä¼¼ POSIX çš„é€‰é¡¹ (ä¾‹å¦‚. `tar -zxvf foo.tar.gz`)
- ç±»ä¼¼ GNU çš„é•¿é€‰é¡¹ (ä¾‹å¦‚. `du --human-readable --max-depth=1`)
- ç±»ä¼¼ Java çš„é€‰é¡¹ (ä¾‹å¦‚. `java -Djava.awt.headless=true -Djava.net.useSystemProxies=true Foo`)
- æœ‰é™„åŠ å€¼çš„çŸ­é€‰é¡¹ (ä¾‹å¦‚. `gcc -O2 foo.c`)
- å¸¦æœ‰å•è¿å­—ç¬¦çš„é•¿é€‰é¡¹ (ä¾‹å¦‚. `ant -projecthelp`)

ä½¿ç”¨ CLI api æ˜¯ä¸€ä¸ª 3 ä¸ªæ­¥éª¤çš„è¿‡ç¨‹:

1.å‘½ä»¤è¡Œç•Œé¢çš„å®šä¹‰
2.ç”¨æˆ·å‘½ä»¤è¡Œçš„è§£æ
3.æŸ¥è¯¢/å®¡è®¯

### å®šä¹‰é˜¶æ®µ

æ¯ä¸ªå‘½ä»¤è¡Œç•Œé¢éƒ½å¿…é¡»å®šä¹‰å°†ä½¿ç”¨çš„ä¸€ç»„é€‰é¡¹å’Œå‚æ•°. å®ƒè¿˜éœ€è¦ä¸€ä¸ªåå­—. CLI API ä½¿ç”¨ `Option` å’Œ `Argument` ç±»æ¥æè¿°é€‰é¡¹å’Œå‚æ•°:

```java
CLI cli = CLI.create("copy")
    .setSummary("A command line interface to copy files.")
    .addOption(new Option()
        .setLongName("directory")
        .setShortName("R")
        .setDescription("enables directory support")
        .setFlag(true))
    .addArgument(new Argument()
        .setIndex(0)
        .setDescription("The source")
        .setArgName("source"))
    .addArgument(new Argument()
        .setIndex(1)
        .setDescription("The destination")
        .setArgName("target"));
```

å¦‚æ‚¨æ‰€è§,æ‚¨å¯ä»¥ä½¿ç”¨ `CLI.create` åˆ›å»ºä¸€ä¸ªæ–°çš„ `CLI`. ä¼ é€’çš„å­—ç¬¦ä¸²æ˜¯ CLI çš„åç§°. åˆ›å»ºå,æ‚¨å¯ä»¥è®¾ç½®æ‘˜è¦å’Œæè¿°. æ‘˜è¦æ—¨åœ¨ç®€çŸ­(ä¸€è¡Œ),è€Œæè¿°å¯ä»¥åŒ…å«æ›´å¤šç»†èŠ‚. æ¯ä¸ªé€‰é¡¹å’Œå‚æ•°ä¹Ÿä½¿ç”¨ `addArgument` å’Œ `addOption` æ–¹æ³•æ·»åŠ åˆ° `CLI` å¯¹è±¡ä¸Š.

#### é€‰é¡¹

`Option` æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°,ç”±ç”¨æˆ·å‘½ä»¤è¡Œä¸­çš„ *key* æ ‡è¯†. é€‰é¡¹å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªé•¿åç§°æˆ–ä¸€ä¸ªçŸ­åç§°. é•¿åç§°é€šå¸¸ä½¿ç”¨ `--` å‰ç¼€,è€ŒçŸ­åç§°ä½¿ç”¨å•ä¸ª `-`.åç§°åŒºåˆ†å¤§å°å†™; ä½†æ˜¯,å¦‚æœæ²¡æœ‰æ‰¾åˆ°å®Œå…¨åŒ¹é…,å°†åœ¨ [æŸ¥è¯¢/è¯¢é—®é˜¶æ®µ](#query_interrogation_stage) æœŸé—´ä½¿ç”¨ä¸åŒºåˆ†å¤§å°å†™çš„åç§°åŒ¹é…. é€‰é¡¹å¯ä»¥è·å¾—ä½¿ç”¨ä¸­æ˜¾ç¤ºçš„æè¿°(è§ä¸‹æ–‡). é€‰é¡¹å¯ä»¥æ¥æ”¶ 0,1 æˆ–å¤šä¸ªå€¼. æ¥æ”¶ 0 å€¼çš„é€‰é¡¹æ˜¯ä¸€ä¸ª `flag`,å¿…é¡»ä½¿ç”¨ `setFlag` å£°æ˜. é»˜è®¤æƒ…å†µä¸‹,é€‰é¡¹æ¥æ”¶å•ä¸ªå€¼,ä½†æ˜¯,æ‚¨å¯ä»¥ä½¿ç”¨ `setMultiValued` é…ç½®é€‰é¡¹ä»¥æ¥æ”¶å¤šä¸ªå€¼:

```java
CLI cli = CLI.create("some-name")
    .setSummary("A command line interface illustrating the options valuation.")
    .addOption(new Option()
        .setLongName("flag").setShortName("f").setFlag(true).setDescription("a flag"))
    .addOption(new Option()
        .setLongName("single").setShortName("s").setDescription("a single-valued option"))
    .addOption(new Option()
        .setLongName("multiple").setShortName("m").setMultiValued(true)
        .setDescription("a multi-valued option"));
```

é€‰é¡¹å¯ä»¥æ ‡è®°ä¸ºå¿…å¡«é¡¹. æœªåœ¨ç”¨æˆ·å‘½ä»¤è¡Œä¸­è®¾ç½®çš„å¼ºåˆ¶é€‰é¡¹åœ¨è§£ææœŸé—´ä¼šå¼•å‘å¼‚å¸¸:

```java
CLI cli = CLI.create("some-name")
    .addOption(new Option()
        .setLongName("mandatory")
        .setRequired(true)
        .setDescription("a mandatory option"));
```

éå¼ºåˆ¶æ€§é€‰é¡¹å¯ä»¥æœ‰ä¸€ä¸ª*é»˜è®¤å€¼*. å¦‚æœç”¨æˆ·æœªåœ¨å‘½ä»¤è¡Œä¸­è®¾ç½®é€‰é¡¹,åˆ™å°†ä½¿ç”¨æ­¤å€¼:

```java
CLI cli = CLI.create("some-name")
    .addOption(new Option()
        .setLongName("optional")
        .setDefaultValue("hello")
        .setDescription("an optional option with a default value"));
```

ä½¿ç”¨ `setHidden` æ–¹æ³•å¯ä»¥*éšè—* é€‰é¡¹. éšè—é€‰é¡¹æœªåœ¨ç”¨æ³•ä¸­åˆ—å‡º,ä½†ä»å¯åœ¨ç”¨æˆ·å‘½ä»¤è¡Œä¸­ä½¿ç”¨(å¯¹äºé«˜çº§ç”¨æˆ·).

å¦‚æœé€‰é¡¹å€¼è¢«é™åˆ¶åœ¨ä¸€ä¸ªå›ºå®šçš„é›†åˆä¸­,ä½ å¯ä»¥è®¾ç½®ä¸åŒçš„å¯æ¥å—çš„é€‰æ‹©:

```java
CLI cli = CLI.create("some-name")
    .addOption(new Option()
        .setLongName("color")
        .setDefaultValue("green")
        .addChoice("blue").addChoice("red").addChoice("green")
        .setDescription("a color"));
```

é€‰é¡¹ä¹Ÿå¯ä»¥ä»JSONä¸­å®ä¾‹åŒ–.

#### å‚æ•°

ä¸é€‰é¡¹ä¸åŒ,å‚æ•°æ²¡æœ‰ *key* å¹¶ä¸”ç”±å®ƒä»¬çš„ *index* æ ‡è¯†. ä¾‹å¦‚,åœ¨ `java com.acme.Foo` ä¸­,`com.acme.Foo` æ˜¯ä¸€ä¸ªå‚æ•°.

å‚æ•°æ²¡æœ‰åç§°,ä½¿ç”¨ä» 0 å¼€å§‹çš„ç´¢å¼•æ¥æ ‡è¯†. ç¬¬ä¸€ä¸ªå‚æ•°çš„ç´¢å¼•ä¸º`0`:

```java
CLI cli = CLI.create("some-name")
    .addArgument(new Argument()
        .setIndex(0)
        .setDescription("the first argument")
        .setArgName("arg1"))
    .addArgument(new Argument()
        .setIndex(1)
        .setDescription("the second argument")
        .setArgName("arg2"));
```

å¦‚æœæ‚¨ä¸è®¾ç½®å‚æ•°ç´¢å¼•,å®ƒä¼šä½¿ç”¨å£°æ˜é¡ºåºè‡ªåŠ¨è®¡ç®—å®ƒ.

```java
CLI cli = CLI.create("some-name")
    // will have the index 0
    .addArgument(new Argument()
        .setDescription("the first argument")
        .setArgName("arg1"))
    // will have the index 1
    .addArgument(new Argument()
        .setDescription("the second argument")
        .setArgName("arg2"));
```

`argName`æ˜¯å¯é€‰çš„,åœ¨ç”¨æ³•æ¶ˆæ¯ä¸­ä½¿ç”¨.

ä½œä¸ºé€‰é¡¹,`Argument` å¯ä»¥:

- ä½¿ç”¨ `setHidden` éšè—
- å¿…é¡»ä½¿ç”¨ `setRequired`
- ä½¿ç”¨ `setDefaultValue` æœ‰ä¸€ä¸ªé»˜è®¤å€¼
- ä½¿ç”¨ `setMultiValued` æ¥æ”¶å¤šä¸ªå€¼ - åªæœ‰æœ€åä¸€ä¸ªå‚æ•°å¯ä»¥æ˜¯å¤šå€¼çš„.

å‚æ•°ä¹Ÿå¯ä»¥ä»JSONä¸­å®ä¾‹åŒ–.

#### ç”Ÿæˆ Usage æ¶ˆæ¯

é…ç½®å¥½ `CLI` å®ä¾‹å,æ‚¨å¯ä»¥ç”Ÿæˆ *usage* æ¶ˆæ¯:

```java
CLI cli = CLI.create("copy")
    .setSummary("A command line interface to copy files.")
    .addOption(new Option()
        .setLongName("directory")
        .setShortName("R")
        .setDescription("enables directory support")
        .setFlag(true))
    .addArgument(new Argument()
        .setIndex(0)
        .setDescription("The source")
        .setArgName("source"))
    .addArgument(new Argument()
        .setIndex(0)
        .setDescription("The destination")
        .setArgName("target"));

StringBuilder builder = new StringBuilder();
cli.usage(builder);
```

å®ƒä¼šç”Ÿæˆè¿™æ ·ä¸€æ¡ä½¿ç”¨æ¶ˆæ¯:

```
Usage: copy [-R] source target

A command line interface to copy files.

 -R,--directory   enables directory support
```

å¦‚æœæ‚¨éœ€è¦è°ƒæ•´ä½¿ç”¨æ¶ˆæ¯,è¯·æ£€æŸ¥ `UsageMessageFormatter` ç±».

### è§£æé˜¶æ®µ

ä¸€æ—¦é…ç½®äº†`CLI`å®ä¾‹,å°±å¯ä»¥è§£æç”¨æˆ·å‘½ä»¤è¡Œæ¥è¯„ä¼°æ¯ä¸ªé€‰é¡¹å’Œå‚æ•°:

```java
CommandLine commandLine = cli.parse(userCommandLineArguments);
```

`parse` æ–¹æ³•è¿”å›ä¸€ä¸ªåŒ…å«å€¼çš„`CommandLine` å¯¹è±¡. é»˜è®¤æƒ…å†µä¸‹,å®ƒä¼šéªŒè¯ç”¨æˆ·å‘½ä»¤è¡Œå¹¶æ£€æŸ¥æ¯ä¸ªå¼ºåˆ¶é€‰é¡¹å’Œå‚æ•°æ˜¯å¦å·²è®¾ç½®ä»¥åŠæ¯ä¸ªé€‰é¡¹æ¥æ”¶çš„å€¼çš„æ•°é‡. æ‚¨å¯ä»¥é€šè¿‡ä¼ é€’ `false` ä½œä¸º `parse` çš„ç¬¬äºŒä¸ªå‚æ•°æ¥ç¦ç”¨éªŒè¯. å¦‚æœæ‚¨æƒ³æ£€æŸ¥å‚æ•°æˆ–é€‰é¡¹æ˜¯å¦å­˜åœ¨,å³ä½¿è§£æçš„å‘½ä»¤è¡Œæ— æ•ˆ,è¿™ä¹Ÿå¾ˆæœ‰ç”¨.

æ‚¨å¯ä»¥ä½¿ç”¨ `isValid` æ£€æŸ¥ `CommandLine` æ˜¯å¦æœ‰æ•ˆ.

<a name="query_interrogation_stage"></a>
### æŸ¥è¯¢/è¯¢é—®é˜¶æ®µ

è§£æå,æ‚¨å¯ä»¥ä» `parse` æ–¹æ³•è¿”å›çš„ `CommandLine` å¯¹è±¡ä¸­æ£€ç´¢é€‰é¡¹å’Œå‚æ•°çš„å€¼:

```java
CommandLine commandLine = cli.parse(userCommandLineArguments);
String opt = commandLine.getOptionValue("my-option");
boolean flag = commandLine.isFlagEnabled("my-flag");
String arg0 = commandLine.getArgumentValue(0);
```

æ‚¨çš„é€‰é¡¹ä¹‹ä¸€å¯ä»¥æ ‡è®°ä¸º"å¸®åŠ©". å¦‚æœç”¨æˆ·å‘½ä»¤è¡Œå¯ç”¨äº†"å¸®åŠ©"é€‰é¡¹,éªŒè¯ä¸ä¼šå¤±è´¥,ä½†æ‚¨æœ‰æœºä¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¯·æ±‚å¸®åŠ©:

```java
CLI cli = CLI.create("test")
    .addOption(
        new Option().setLongName("help").setShortName("h").setFlag(true).setHelp(true))
    .addOption(
        new Option().setLongName("mandatory").setRequired(true));

CommandLine line = cli.parse(Collections.singletonList("-h"));

// The parsing does not fail and let you do:
if (!line.isValid() && line.isAskingForHelp()) {
  StringBuilder builder = new StringBuilder();
  cli.usage(builder);
  stream.print(builder.toString());
}
```

### ç±»å‹åŒ–é€‰é¡¹å’Œå‚æ•°

æ‰€æè¿°çš„ `Option` å’Œ `Argument` ç±»æ˜¯ *untyped* çš„,è¿™æ„å‘³ç€åªèƒ½è·å– String å€¼. `TypedOption` å’Œ `TypedArgument` è®©æ‚¨æŒ‡å®š *type*,å› æ­¤ (String) åŸå§‹å€¼è½¬æ¢ä¸ºæŒ‡å®šç±»å‹.

åœ¨ `CLI` å®šä¹‰ä¸­ä½¿ç”¨ `TypedOption` å’Œ `TypedArgument` ä»£æ›¿ `Option` å’Œ `Argument`:

```java
CLI cli = CLI.create("copy")
    .setSummary("A command line interface to copy files.")
    .addOption(new TypedOption<Boolean>()
        .setType(Boolean.class)
        .setLongName("directory")
        .setShortName("R")
        .setDescription("enables directory support")
        .setFlag(true))
    .addArgument(new TypedArgument<File>()
        .setType(File.class)
        .setIndex(0)
        .setDescription("The source")
        .setArgName("source"))
    .addArgument(new TypedArgument<File>()
        .setType(File.class)
        .setIndex(1)
        .setDescription("The destination")
        .setArgName("target"));
```

ç„¶åæ‚¨å¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼æ£€ç´¢è½¬æ¢åçš„å€¼:

```java
CommandLine commandLine = cli.parse(userCommandLineArguments);
boolean flag = commandLine.getOptionValue("R");
File source = commandLine.getArgumentValue("source");
File target = commandLine.getArgumentValue("target");
```

vert.x CLI èƒ½å¤Ÿè½¬æ¢ä¸ºç±»:

- æœ‰ä¸€ä¸ªå¸¦æœ‰å•ä¸ª `String` å‚æ•°çš„æ„é€ å‡½æ•°,ä¾‹å¦‚ `File` æˆ– `JsonObject`
- ä½¿ç”¨é™æ€ `from` æˆ– `fromString` æ–¹æ³•
- ä½¿ç”¨é™æ€çš„ `valueOf` æ–¹æ³•,ä¾‹å¦‚åŸå§‹ç±»å‹å’Œæšä¸¾

æ­¤å¤–,æ‚¨å¯ä»¥å®ç°è‡ªå·±çš„ `Converter` å¹¶æŒ‡ç¤º CLI ä½¿ç”¨æ­¤è½¬æ¢å™¨:

```java
CLI cli = CLI.create("some-name")
    .addOption(new TypedOption<Person>()
        .setType(Person.class)
        .setConverter(new PersonConverter())
        .setLongName("person"));
```

å¯¹äºå¸ƒå°”å€¼,`on`,`yes`,`1`,`true`è¢«è¯„ä¼°ä¸º `true`.

å¦‚æœæ‚¨çš„ä¸€ä¸ªé€‰é¡¹æœ‰ä¸€ä¸ª"æšä¸¾"ç±»å‹,å®ƒä¼šè‡ªåŠ¨è®¡ç®—ä¸€ç»„é€‰é¡¹.

### ä½¿ç”¨æ³¨è§£

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨æ³¨è§£å®šä¹‰ CLI. å®šä¹‰æ˜¯ä½¿ç”¨ç±»å’Œ *setter* æ–¹æ³•ä¸Šçš„æ³¨è§£å®Œæˆçš„:

```java
@Name("some-name")
@Summary("some short summary.")
@Description("some long description")
public class AnnotatedCli {

 private boolean flag;
 private String name;
 private String arg;

@Option(shortName = "f", flag = true)
public void setFlag(boolean flag) {
  this.flag = flag;
}

@Option(longName = "name")
public void setName(String name) {
  this.name = name;
}

@Argument(index = 0)
public void setArg(String arg) {
 this.arg = arg;
}
}
```

æ³¨è§£å,æ‚¨å¯ä»¥å®šä¹‰`CLI`å¹¶ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ³¨å…¥å€¼:

```java
CLI cli = CLI.create(AnnotatedCli.class);
CommandLine commandLine = cli.parse(userCommandLineArguments);
AnnotatedCli instance = new AnnotatedCli();
CLIConfigurator.inject(commandLine, instance);
```

## vert.x çš„å¯åŠ¨å™¨(Launcher)

vert.x `Launcher` åœ¨ *fat jar* ä¸­ç”¨ä½œä¸»ç±»,å¹¶ç”± `vertx` å‘½ä»¤è¡Œå®ç”¨ç¨‹åºä½¿ç”¨. å®ƒæ‰§è¡Œä¸€ç»„*commands*,ä¾‹å¦‚*run*,*bare*,*start*â€¦

<a name="_extending_the_vert_x_launcher"></a>
### æ‰©å±• vert.x å¯åŠ¨å™¨

æ‚¨å¯ä»¥é€šè¿‡å®ç°è‡ªå·±çš„`Command`æ¥æ‰©å±•å‘½ä»¤é›†(ä»…é™ Java):

```java
@Name("my-command")
@Summary("A simple hello command.")
public class MyCommand extends DefaultCommand {

 private String name;

 @Option(longName = "name", required = true)
 public void setName(String n) {
   this.name = n;
 }

 @Override
 public void run() throws CLIException {
   System.out.println("Hello " + name);
 }
}
```

ä½ è¿˜éœ€è¦ä¸€ä¸ª `CommandFactory` çš„å®ç°:

```java
public class HelloCommandFactory extends DefaultCommandFactory<HelloCommand> {
 public HelloCommandFactory() {
  super(HelloCommand.class);
 }
}
```

ç„¶å,åˆ›å»º `src/main/resources/META-INF/services/io.vertx.core.spi.launcher.CommandFactory` å¹¶æ·»åŠ ä¸€è¡ŒæŒ‡ç¤ºå·¥å‚çš„å®Œå…¨é™å®šåç§°:

```
io.vertx.core.launcher.example.HelloCommandFactory
```

æ„å»ºåŒ…å«å‘½ä»¤çš„ jar. ç¡®ä¿åŒ…å« SPI æ–‡ä»¶(`META-INF/services/io.vertx.core.spi.launcher.CommandFactory`).

ç„¶å,å°†åŒ…å«å‘½ä»¤çš„ jar æ”¾å…¥ fat-jar çš„ç±»è·¯å¾„(æˆ–å°†å…¶åŒ…å«åœ¨å…¶ä¸­)æˆ– vert.x å‘è¡Œç‰ˆçš„ `lib` ç›®å½•ä¸­,æ‚¨å°†èƒ½å¤Ÿæ‰§è¡Œ:

```bash
vertx hello vert.x
java -jar my-fat-jar.jar hello vert.x
```

### åœ¨fat jarsä¸­ä½¿ç”¨å¯åŠ¨å™¨

è¦åœ¨ *fat-jar* ä¸­ä½¿ç”¨ `Launcher` ç±»,åªéœ€å°† *MANIFEST* çš„ `Main-Class` è®¾ç½®ä¸º `io.vertx.core.Launcher`. æ­¤å¤–,å°† `Main-Verticle` æ¡ç›®è®¾ç½®ä¸ºæ‚¨çš„ä¸» Verticle çš„åç§°.

é»˜è®¤æƒ…å†µä¸‹,å®ƒæ‰§è¡Œ `run` å‘½ä»¤. ä½†æ˜¯,æ‚¨å¯ä»¥é€šè¿‡è®¾ç½® `Main-Command` *MANIFEST* æ¡ç›®æ¥é…ç½®é»˜è®¤å‘½ä»¤. å¦‚æœ *fat jar* åœ¨æ²¡æœ‰å‘½ä»¤çš„æƒ…å†µä¸‹å¯åŠ¨,åˆ™ä½¿ç”¨é»˜è®¤å‘½ä»¤.

### å­ç±»åŒ–å¯åŠ¨å™¨

æ‚¨è¿˜å¯ä»¥åˆ›å»ºä¸€ä¸ª `Launcher` çš„å­ç±»æ¥å¯åŠ¨æ‚¨çš„åº”ç”¨ç¨‹åº. è¯¥ç±»è¢«è®¾è®¡ä¸ºæ˜“äºæ‰©å±•.

`Launcher` å­ç±»å¯ä»¥:

- åœ¨ `beforeStartingVertx` ä¸­è‡ªå®šä¹‰ vert.x é…ç½®
- é€šè¿‡è¦†ç›– `afterStartingVertx` æ£€ç´¢ç”±"run"æˆ–"bare"å‘½ä»¤åˆ›å»ºçš„ vert.x å®ä¾‹
- ä½¿ç”¨ `getMainVerticle` å’Œ `getDefaultCommand` é…ç½®é»˜è®¤verticleå’Œå‘½ä»¤
- ä½¿ç”¨ `register` å’Œ `unregister` æ·»åŠ /åˆ é™¤å‘½ä»¤

### å¯åŠ¨å™¨å’Œé€€å‡ºä»£ç 

å½“æ‚¨ä½¿ç”¨ `Launcher` ç±»ä½œä¸ºä¸»ç±»æ—¶,å®ƒä½¿ç”¨ä»¥ä¸‹é€€å‡ºä»£ç :

- `0` å¦‚æœè¿›ç¨‹é¡ºåˆ©ç»“æŸ,æˆ–è€…å¦‚æœæŠ›å‡ºæœªæ•è·çš„é”™è¯¯
- `1` è¡¨ç¤ºé€šç”¨é”™è¯¯
- `11` å¦‚æœ Vert.x æ— æ³•åˆå§‹åŒ–
- `12` å¦‚æœç”Ÿæˆè¿‡ç¨‹æ— æ³•å¯åŠ¨,æ‰¾åˆ°æˆ–åœæ­¢. `start` å’Œ `stop` å‘½ä»¤ä½¿ç”¨æ­¤é”™è¯¯ä»£ç 
- `14` å¦‚æœç³»ç»Ÿé…ç½®ä¸æ»¡è¶³ç³»ç»Ÿè¦æ±‚(shc as java not found)
- `15` å¦‚æœæ— æ³•éƒ¨ç½²ä¸»verticle

## é…ç½® Vert.x ç¼“å­˜

å½“ Vert.x éœ€è¦ä»ç±»è·¯å¾„ä¸­è¯»å–æ–‡ä»¶æ—¶(åµŒå…¥åˆ° fat jar ä¸­,ä»¥ jar å½¢å¼çš„ç±»è·¯å¾„æˆ–ç±»è·¯å¾„ä¸Šçš„æ–‡ä»¶),å®ƒä¼šå°†å…¶å¤åˆ¶åˆ°ç¼“å­˜ç›®å½•ä¸­. è¿™èƒŒåçš„åŸå› å¾ˆç®€å•:ä» jar æˆ–è¾“å…¥æµä¸­è¯»å–æ–‡ä»¶æ˜¯é˜»å¡çš„. å› æ­¤,ä¸ºäº†é¿å…æ¯æ¬¡éƒ½ä»˜å‡ºä»£ä»·,Vert.x å°†æ–‡ä»¶å¤åˆ¶åˆ°å…¶ç¼“å­˜ç›®å½•å¹¶åœ¨æ¯æ¬¡åç»­è¯»å–æ—¶ä»é‚£é‡Œè¯»å–. å¯ä»¥é…ç½®æ­¤è¡Œä¸º.

é¦–å…ˆ,é»˜è®¤æƒ…å†µä¸‹,Vert.x ä½¿ç”¨ `$CWD/.vertx` ä½œä¸ºç¼“å­˜ç›®å½•. å®ƒåœ¨æ­¤ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªå”¯ä¸€ç›®å½•ä»¥é¿å…å†²çª. å¯ä»¥ä½¿ç”¨ `vertx.cacheDirBase` ç³»ç»Ÿå±æ€§æ¥é…ç½®æ­¤ä½ç½®. ä¾‹å¦‚,å¦‚æœå½“å‰å·¥ä½œç›®å½•ä¸å¯å†™(ä¾‹å¦‚åœ¨ä¸å¯å˜çš„å®¹å™¨ä¸Šä¸‹æ–‡ä¸­),è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯åŠ¨æ‚¨çš„åº”ç”¨ç¨‹åº:

```bash
vertx run my.Verticle -Dvertx.cacheDirBase=/tmp/vertx-cache
# or
java -jar my-fat.jar vertx.cacheDirBase=/tmp/vertx-cache
```

> **âš é‡è¦:** æ­¤ç›®å½•å¿…é¡»æ˜¯**å¯å†™çš„**.

å½“æ‚¨ç¼–è¾‘ HTML,CSS æˆ– JavaScript ç­‰èµ„æºæ—¶,è¿™ç§ç¼“å­˜æœºåˆ¶å¯èƒ½å¾ˆçƒ¦äºº,å› ä¸ºå®ƒåªæä¾›æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬(å› æ­¤,å¦‚æœæ‚¨é‡æ–°åŠ è½½é¡µé¢,æ‚¨å°†çœ‹ä¸åˆ°æ‚¨çš„ç¼–è¾‘).
è¦é¿å…è¿™ç§è¡Œä¸º,è¯·ä½¿ç”¨ `-Dvertx.disableFileCaching=true` å¯åŠ¨æ‚¨çš„åº”ç”¨ç¨‹åº.ä½¿ç”¨æ­¤è®¾ç½®,Vert.xä»ç„¶ä½¿ç”¨ç¼“å­˜,ä½†æ€»æ˜¯ç”¨åŸå§‹æºåˆ·æ–°ç¼“å­˜ä¸­å­˜å‚¨çš„ç‰ˆæœ¬.å› æ­¤,å¦‚æœç¼–è¾‘ä»ç±»è·¯å¾„æä¾›çš„æ–‡ä»¶å¹¶åˆ·æ–°æµè§ˆå™¨,Vert.xå°†ä»ç±»è·¯å¾„è¯»å–è¯¥æ–‡ä»¶,å°†å…¶å¤åˆ¶åˆ°ç¼“å­˜ç›®å½•å¹¶ä»é‚£é‡Œæä¾›è¯¥æ–‡ä»¶.<mark>**ä¸è¦åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨æ­¤è®¾ç½®,å®ƒä¼šæ‰¼æ€æ€§èƒ½.**</mark>

æœ€å,æ‚¨å¯ä»¥ä½¿ç”¨ `-Dvertx.disableFileCPResolving=true` å®Œå…¨ç¦ç”¨ç¼“å­˜. è¿™ç§è®¾ç½®å¹¶éæ²¡æœ‰åæœ. Vert.x å°†æ— æ³•ä»ç±»è·¯å¾„ä¸­è¯»å–ä»»ä½•æ–‡ä»¶(åªèƒ½ä»æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–). ä½¿ç”¨æ­¤è®¾ç½®æ—¶è¦éå¸¸å°å¿ƒ.

